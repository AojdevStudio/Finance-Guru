#!/usr/bin/env bash
set -euo pipefail

# Finance Guru — Overstory wrapper CLI
#
# Goal:
# - `guru init` starts Cassandra (Overstory coordinator) in tmux
# - `guru quant|teacher|analyst|market|strategy|compliance|builder|qa` spawns/attaches to persona agents
# - Uses a shared tree (no per-agent worktrees required for the coordinator; workers still use worktrees via Overstory)
#
# NOTE: Overstory workers ALWAYS run in git worktrees (that’s how Overstory isolates changes).
# The user’s requested “shared tree” is interpreted as “single canonical repo + consistent shared context”; Overstory
# will still create worktrees under .overstory/worktrees.

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

usage() {
  cat <<'EOF'
Finance Guru — Team CLI (Overstory wrapper)

Usage:
  guru init                         Start Cassandra (coordinator) + optional lead
  guru attach                       Attach to Cassandra tmux session
  guru status                       Show Overstory agent status
  guru stop [coordinator|all]        Stop Cassandra or everything

  # Spawn/attach to persona agents (each runs in its own tmux session)
  guru quant|teacher|analyst|market|strategy|compliance|builder|qa

  # Low-level helpers
  guru setup                        Ensure .overstory is initialized + configured for Finance Guru
  guru mail [args...]               Pass-through to: overstory mail ...

Requirements:
  - claude (Claude Code) in PATH
  - tmux in PATH
  - overstory in PATH

Docs:
  - docs/guru.md
EOF
}

need() {
  local bin="$1"
  if ! command -v "$bin" >/dev/null 2>&1; then
    echo "Missing dependency: $bin" >&2
    exit 1
  fi
}

# Write Finance Guru specific coordinator system prompt used by `overstory coordinator start`.
write_cassandra_prompt() {
  mkdir -p .overstory/agent-defs
  cat > .overstory/agent-defs/coordinator.md <<'EOF'
# Finance Guru — Cassandra Holt (Coordinator)

You are **Cassandra Holt**, the Finance Guru™ Master Portfolio Orchestrator.

## Non‑negotiable behavior
- You do **not** do analysis work yourself.
- You **only**: clarify the user’s intent → create a delegation plan → dispatch tasks to specialists → monitor progress → return a concise synthesis.
- If the user asks you to “just do it”, you still delegate. No exceptions.

## Finance Guru shared context (must treat as ground truth)
- Load: `fin-guru/config.yaml`
- Load: `fin-guru/data/system-context.md`
- Treat: `fin-guru-private/` as the user’s private strategies and personal data (read carefully; do not leak).

## Delegation model (Overstory)
- You are the **Overstory coordinator**. You may spawn **lead** agents; leads may spawn builders/reviewers.
- Preferred pattern:
  1) Ensure a lead exists (name: `fg-lead`). If not, spawn it.
  2) Send a dispatch mail to the lead telling it which persona worker(s) to spawn and what to do.

## Specialists (personas)
When delegating, you may request the lead spawn any of these persona workers:
- quant (Quant Analyst)
- teacher (Teaching Specialist)
- analyst (Market/Portfolio Analyst)
- market (Market Researcher)
- strategy (Strategy Advisor)
- compliance (Compliance Officer)
- builder (Artifact/Report Builder)
- qa (Quality Assurance Advisor)

## How to communicate
- Use `overstory mail send` to communicate with agents.
- Use `overstory status` to check running sessions.
- Use `overstory mail check --agent coordinator` to pull inbound updates.

## Output rules
- Every major recommendation must include: **educational-only / not investment advice** disclaimer.
- Always ask for missing constraints (time horizon, risk tolerance, deliverable type) before delegating.
EOF
}

write_lead_prompt() {
  mkdir -p .overstory/agent-defs
  # Keep Overstory's default lead behavior but add Finance Guru context + persona spawning instructions.
  # This gets appended as system prompt (base agent-defs/lead.md), and task overlays carry the WHAT.
  # We do NOT replace lead.md here; we add a small “finance guru addendum” spec used at spawn time.
  :
}

write_config() {
  mkdir -p .overstory
  cat > .overstory/config.yaml <<'EOF'
# Finance Guru — Overstory configuration
# This file is intentionally conservative: we disable beads + mulch to avoid requiring extra CLIs.

project:
  name: finance-guru
  root: ""
  canonicalBranch: main

agents:
  manifestPath: .overstory/agent-manifest.json
  baseDir: .overstory/agent-defs
  maxConcurrent: 25
  staggerDelayMs: 2000
  maxDepth: 2

worktrees:
  baseDir: .overstory/worktrees

beads:
  enabled: false

mulch:
  enabled: false
  domains: []
  primeFormat: markdown

merge:
  aiResolveEnabled: true
  reimagineEnabled: false

watchdog:
  tier0Enabled: true
  tier0IntervalMs: 30000
  tier1Enabled: false
  tier2Enabled: false
  staleThresholdMs: 300000
  zombieThresholdMs: 600000
  nudgeIntervalMs: 60000

logging:
  verbose: false
  redactSecrets: true
EOF

  # Patch root to absolute path (Overstory expects it)
  # Using python for portability/clarity.
  python3 - <<PY
import pathlib, re
p = pathlib.Path('.overstory/config.yaml')
text = p.read_text()
root = str(pathlib.Path('.').resolve())
text = re.sub(r'\nproject:\n(  name: .*\n  root: )""', f"\nproject:\n  name: finance-guru\n  root: \"{root}\"", text)
p.write_text(text)
PY
}

setup_overstory() {
  need overstory
  need tmux
  need claude

  if [[ ! -d .overstory ]]; then
    overstory init
  fi

  # Always enforce our config choices (idempotent)
  write_config
  write_cassandra_prompt

  # Ensure hooks are installed into the coordinator tmux session only.
  # Coordinator start will deploy hooks automatically.

  # Sanity check
  overstory doctor --category dependencies >/dev/null 2>&1 || true
}

# Create a tiny spec file that just boots a persona agent and waits for user input.
# Overstory requires a task-id; with beads disabled, it can be any string.
# We keep these in .overstory/specs for easy inspection.
write_persona_spec() {
  local persona="$1"   # quant|teacher|...
  local spec_path="$2"

  mkdir -p .overstory/specs

  cat > "$spec_path" <<SPEC
# Finance Guru Persona Session — ${persona}

You are running as the Finance Guru persona: **${persona}**.

## Shared context (load into working memory)
- fin-guru/config.yaml
- fin-guru/data/system-context.md
- fin-guru-private/ (private strategies; treat as sensitive)

## Operating rules
- Run \`date\` and \`date +"%Y-%m-%d"\` at startup and include it in any time-sensitive research.
- If you are asked for investment advice, include: educational-only / not investment advice.

## Collaboration
- If you need other specialists, message Cassandra (coordinator) rather than spawning directly.
  Use: \`overstory mail send --to coordinator --subject ... --body ...\`

## Mode
This is an _interactive chat_ session.
- Greet in-character.
- Show a short menu of what you can do.
- Then WAIT for the user.
SPEC
}

start_coordinator() {
  setup_overstory
  overstory coordinator start --watchdog
}

attach_coordinator() {
  setup_overstory
  # tmux name pattern: overstory-<project>-coordinator
  # project name comes from config.yaml project.name (finance-guru)
  tmux attach -t "overstory-finance-guru-coordinator"
}

spawn_persona() {
  setup_overstory

  local persona="$1"   # quant|teacher|...
  local agent_name="$2" # e.g. quant
  local task_id="chat-${persona}"
  local spec_path=".overstory/specs/${task_id}.md"

  write_persona_spec "$persona" "$spec_path"

  # Spawn as capability=builder so it can write artifacts if needed.
  # We bypass coordinator hierarchy restrictions for direct CLI access.
  overstory sling "$task_id" \
    --capability builder \
    --name "$agent_name" \
    --spec "$spec_path" \
    --force-hierarchy

  tmux attach -t "overstory-finance-guru-${agent_name}"
}

status_cmd() {
  setup_overstory
  overstory status
}

stop_cmd() {
  setup_overstory
  local what="${1:-coordinator}"
  case "$what" in
    coordinator)
      overstory coordinator stop
      ;;
    all)
      overstory coordinator stop || true
      overstory clean --completed || true
      ;;
    *)
      echo "Unknown stop target: $what" >&2
      exit 1
      ;;
  esac
}

cmd="${1:-}" || true
case "$cmd" in
  -h|--help|help|"") usage ;;
  setup) setup_overstory ;;
  init) start_coordinator ;;
  attach) attach_coordinator ;;
  status) status_cmd ;;
  stop) shift; stop_cmd "${1:-coordinator}" ;;
  mail) shift; setup_overstory; overstory mail "$@" ;;

  quant) spawn_persona quant quant ;;
  teacher) spawn_persona teacher teacher ;;
  analyst) spawn_persona analyst analyst ;;
  market) spawn_persona market market ;;
  strategy) spawn_persona strategy strategy ;;
  compliance) spawn_persona compliance compliance ;;
  builder) spawn_persona builder builder ;;
  qa) spawn_persona qa qa ;;

  *)
    echo "Unknown command: $cmd" >&2
    usage
    exit 1
    ;;
 esac
