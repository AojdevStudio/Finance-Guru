---
phase: 05-agent-readiness-hardening
plan: 04
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - .pre-commit-config.yaml
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "Making a git commit triggers ruff, mypy, and gitleaks pre-commit hooks"
    - "A commit with lint errors is blocked by pre-commit hooks"
    - "pre-commit run --all-files passes all three hooks"
  artifacts:
    - path: ".pre-commit-config.yaml"
      provides: "Pre-commit hook configuration with ruff, mypy, gitleaks"
      contains: "ruff-pre-commit"
    - path: ".pre-commit-config.yaml"
      provides: "Local mypy hook"
      contains: "id: mypy"
  key_links:
    - from: ".pre-commit-config.yaml"
      to: ".git/hooks/pre-commit"
      via: "pre-commit install"
      pattern: "pre-commit"
    - from: ".pre-commit-config.yaml ruff hook"
      to: "pyproject.toml [tool.ruff]"
      via: "ruff reads config from pyproject.toml"
      pattern: "ruff-pre-commit"
---

<objective>
Create and install a pre-commit hook configuration with ruff, mypy, and gitleaks hooks so that every commit is automatically validated.

Purpose: Success criterion 2 of Phase 5 -- pre-commit hooks enforce linting, type checking, and secret scanning on every commit.
Output: .pre-commit-config.yaml installed and verified with all three hooks passing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-agent-readiness-hardening/05-03-SUMMARY.md
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pre-commit config and install hooks</name>
  <files>
    .pre-commit-config.yaml
    pyproject.toml
  </files>
  <action>
  1. Install pre-commit as a uv tool (NOT as a project dependency):
     ```bash
     uv tool install pre-commit --with pre-commit-uv --force-reinstall
     ```

  2. Create `.pre-commit-config.yaml` at project root:
     ```yaml
     repos:
       - repo: https://github.com/astral-sh/ruff-pre-commit
         rev: v0.15.0
         hooks:
           - id: ruff
             args: [--fix]

       - repo: local
         hooks:
           - id: mypy
             name: mypy
             entry: uv run mypy
             language: system
             types: [python]
             args: ["--ignore-missing-imports"]
             pass_filenames: false

       - repo: https://github.com/gitleaks/gitleaks
         rev: v8.24.0
         hooks:
           - id: gitleaks
     ```

  IMPORTANT: Use `repo: local` with `language: system` for mypy (NOT mirrors-mypy). This avoids maintaining duplicate dependencies in the hook's virtualenv. The hook runs `uv run mypy` which uses the project's dev dependency.

  IMPORTANT: Check the latest gitleaks tag available. Use v8.24.0 or whatever is current. Do NOT use v8.30.0 if it does not exist yet -- verify with `pre-commit try-repo https://github.com/gitleaks/gitleaks --ref v8.24.0` or check the releases page.

  IMPORTANT: Check the latest ruff-pre-commit tag. Use the version matching the ruff version in pyproject.toml dev deps.

  3. Install the hooks into .git/hooks/:
     ```bash
     pre-commit install
     ```

  4. Add mypy configuration to pyproject.toml if not already present:
     ```toml
     [tool.mypy]
     python_version = "3.12"
     ignore_missing_imports = true
     check_untyped_defs = false
     ```

  5. Run hooks against all files to verify they pass:
     ```bash
     pre-commit run --all-files
     ```

  6. Verify hooks trigger on commit by making a small test commit (e.g., add a comment to a test file, commit, then revert).
  </action>
  <verify>
  - `test -f .pre-commit-config.yaml && echo "Config exists"`
  - `test -f .git/hooks/pre-commit && echo "Hooks installed"`
  - `pre-commit run --all-files` passes with all hooks succeeding (ruff, mypy, gitleaks)
  </verify>
  <done>Pre-commit config exists with ruff, mypy, and gitleaks hooks. Hooks are installed in .git/hooks/. `pre-commit run --all-files` passes clean.</done>
</task>

</tasks>

<verification>
1. `.pre-commit-config.yaml` exists with ruff, mypy, and gitleaks hooks
2. `pre-commit run --all-files` passes all three hooks
3. `.git/hooks/pre-commit` exists (hooks installed)
4. pyproject.toml has [tool.mypy] section
</verification>

<success_criteria>
Pre-commit hooks (ruff + mypy + gitleaks) are installed and run successfully on every commit. `pre-commit run --all-files` passes clean.
</success_criteria>

<output>
After completion, create `.planning/phases/05-agent-readiness-hardening/05-04-SUMMARY.md`
</output>
