---
phase: 05-agent-readiness-hardening
plan: 05
type: execute
wave: 3
depends_on: ["05-04"]
files_modified:
  - tests/python/test_backtester.py
  - tests/python/test_optimizer.py
  - tests/python/test_itc_risk.py
  - tests/python/test_options.py
  - pyproject.toml
  - .github/workflows/ci.yml
  - .pre-commit-config.yaml
autonomous: true

must_haves:
  truths:
    - "`uv run pytest --cov=src --cov-fail-under=80` passes (coverage >= 80%)"
    - "Pre-commit hook enforces coverage threshold on every commit"
    - "CI workflow enforces 80% coverage on push/PR to main"
    - "All 550+ tests pass (old + new from Plan 04 + new from this plan)"
  artifacts:
    - path: "tests/python/test_backtester.py"
      provides: "Tests for backtester calculator"
      contains: "def test_"
    - path: "tests/python/test_optimizer.py"
      provides: "Tests for optimizer calculator"
      contains: "def test_"
    - path: "pyproject.toml"
      provides: "Coverage enforcement config"
      contains: "cov-fail-under=80"
  key_links:
    - from: "pyproject.toml"
      to: ".github/workflows/ci.yml"
      via: "Both enforce --cov-fail-under=80"
      pattern: "cov-fail-under=80"
    - from: ".pre-commit-config.yaml"
      to: "pyproject.toml"
      via: "Local pytest hook reads coverage config"
      pattern: "pytest.*--cov"
---

<objective>
Write remaining tests to reach 80% coverage, then enable coverage enforcement in pre-commit and CI.

Purpose: Close the coverage gap and lock in the 80% floor. After this plan, every commit and CI run enforces minimum coverage, preventing regression.
Output: Additional test files, coverage enforcement enabled in pyproject.toml, CI, and pre-commit.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-agent-readiness-hardening/05-RESEARCH.md
@.planning/phases/05-agent-readiness-hardening/05-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write tests for remaining uncovered modules</name>
  <files>
    tests/python/test_backtester.py
    tests/python/test_optimizer.py
    tests/python/test_itc_risk.py
    tests/python/test_options.py
  </files>
  <action>
First, run `uv run pytest --cov=src --cov-report=term-missing` to identify which modules still need coverage to reach 80%.

Based on RESEARCH.md, the remaining large uncovered modules are likely:
- src/strategies/backtester.py (strategy backtesting)
- src/strategies/optimizer.py (portfolio optimization)
- src/analysis/itc_risk.py (ITC risk scoring)
- src/analysis/options.py (Black-Scholes, Greeks)

For each uncovered module above 0%:
1. Read the source to understand the API
2. Create test file with synthetic data
3. Test public methods: happy path, edge cases, known-answer
4. Use mocks for any external dependencies (yfinance, API calls)

**Additionally**, check if any models, utils, or config modules need tests. Write tests for any module that pulls overall coverage below 80%.

**Coverage tuning:**
- If after writing all reasonable tests, coverage is still below 80%, expand the `omit` list in `[tool.coverage.run]` to exclude genuinely untestable code:
  - `src/ui/*` (TUI components)
  - `src/*_cli.py` (already planned)
  - Any experimental/prototype files

The goal is 80% coverage of _testable_ code, not 80% of every file including CLI wrappers and UI.

Run `uv run pytest --cov=src --cov-report=term-missing --cov-fail-under=80` to verify the threshold is met.
  </action>
  <verify>
`uv run pytest --cov=src --cov-report=term-missing --cov-fail-under=80` exits 0 (coverage >= 80%). All tests pass.
  </verify>
  <done>Coverage is at or above 80%. All new tests pass alongside existing tests. Remaining uncovered code is in excluded categories (CLI wrappers, UI).</done>
</task>

<task type="auto">
  <name>Task 2: Enable coverage enforcement in pre-commit and CI</name>
  <files>
    pyproject.toml
    .pre-commit-config.yaml
    .github/workflows/ci.yml
  </files>
  <action>
Now that coverage is above 80%, enable enforcement everywhere:

**pyproject.toml** -- Update pytest addopts to include coverage:
```toml
[tool.pytest.ini_options]
addopts = "-v --tb=short --cov=src --cov-report=term-missing --cov-fail-under=80"
```

Add coverage config:
```toml
[tool.coverage.run]
branch = true
source = ["src"]
omit = [
    "src/*_cli.py",
    "src/ui/*",
]

[tool.coverage.report]
precision = 1
show_missing = true
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise NotImplementedError",
    "if __name__ == .__main__.:",
    "if TYPE_CHECKING:",
]
```

**pre-commit -- Add local pytest hook:**
Add a `local` repo entry to `.pre-commit-config.yaml`:
```yaml
  - repo: local
    hooks:
      - id: pytest-coverage
        name: pytest with coverage
        entry: uv run pytest --cov=src --cov-fail-under=80 --cov-report=term-missing -q
        language: system
        types: [python]
        pass_filenames: false
        always_run: true
```

Using `language: system` so it runs in the project venv with all dependencies.

**CI workflow** -- Update the coverage threshold:
In `.github/workflows/ci.yml`, change `--cov-fail-under=0` (or the TODO placeholder) to `--cov-fail-under=80`.

After making all changes, verify:
```bash
pre-commit run pytest-coverage --all-files
uv run pytest --cov=src --cov-fail-under=80
```
  </action>
  <verify>
`uv run pytest` passes with coverage enforcement. `pre-commit run pytest-coverage --all-files` passes. `grep "cov-fail-under=80" .github/workflows/ci.yml` returns a match. `grep "cov-fail-under=80" pyproject.toml` returns a match.
  </verify>
  <done>Coverage enforcement is active in pytest addopts, pre-commit hook, and CI workflow. 80% floor is locked in everywhere.</done>
</task>

</tasks>

<verification>
1. `uv run pytest --cov=src --cov-fail-under=80` passes
2. `pre-commit run --all-files` passes (including pytest-coverage hook)
3. `.github/workflows/ci.yml` contains `--cov-fail-under=80`
4. `pyproject.toml` contains `--cov-fail-under=80` in addopts
5. All tests pass (550+ total)
6. `uv run ruff check .` still clean (new test files pass lint)
</verification>

<success_criteria>
Coverage is at or above 80% and enforced in pre-commit, pytest addopts, and CI. Every future commit and PR is blocked if coverage drops below 80%.
</success_criteria>

<output>
After completion, create `.planning/phases/05-agent-readiness-hardening/05-05-SUMMARY.md`
</output>
