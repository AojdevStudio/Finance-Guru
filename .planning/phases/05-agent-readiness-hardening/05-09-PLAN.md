---
phase: 05-agent-readiness-hardening
plan: 09
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - tests/python/test_backtester_cli.py
  - tests/python/test_optimizer_cli.py
  - tests/python/test_correlation_cli.py
  - tests/python/test_risk_metrics_cli.py
  - tests/python/test_itc_risk_cli_cov.py
  - tests/python/test_screener_cli.py
  - tests/python/test_data_validator_cli.py
autonomous: true

must_haves:
  truths:
    - "backtester_cli.py has test coverage above 75%"
    - "optimizer_cli.py has test coverage above 75%"
    - "correlation_cli.py has test coverage above 75%"
    - "risk_metrics_cli.py has test coverage above 75%"
    - "itc_risk_cli.py has test coverage above 75%"
    - "screener_cli.py has test coverage above 75%"
    - "data_validator_cli.py has test coverage above 75%"
  artifacts:
    - path: "tests/python/test_backtester_cli.py"
      provides: "Tests for backtester CLI"
      contains: "class TestBacktesterCLI"
    - path: "tests/python/test_optimizer_cli.py"
      provides: "Tests for optimizer CLI"
      contains: "class TestOptimizerCLI"
    - path: "tests/python/test_correlation_cli.py"
      provides: "Tests for correlation CLI"
      contains: "class TestCorrelationCLI"
    - path: "tests/python/test_risk_metrics_cli.py"
      provides: "Tests for risk metrics CLI"
      contains: "class TestRiskMetricsCLI"
    - path: "tests/python/test_itc_risk_cli_cov.py"
      provides: "Tests for ITC risk CLI"
      contains: "class TestITCRiskCLI"
    - path: "tests/python/test_screener_cli.py"
      provides: "Tests for screener CLI"
      contains: "class TestScreenerCLI"
    - path: "tests/python/test_data_validator_cli.py"
      provides: "Tests for data validator CLI"
      contains: "class TestDataValidatorCLI"
  key_links:
    - from: "tests/python/test_backtester_cli.py"
      to: "src/strategies/backtester_cli.py"
      via: "import and test CLI"
      pattern: "backtester_cli"
    - from: "tests/python/test_correlation_cli.py"
      to: "src/analysis/correlation_cli.py"
      via: "import and test CLI"
      pattern: "correlation_cli"
---

<objective>
Write test suites for the remaining seven CLI scripts (backtester, optimizer, correlation, risk_metrics, itc_risk, screener, data_validator) to bring them from 0% to 75%+ coverage each.

Purpose: These are the analysis and strategy CLIs. Testing them contributes ~1,290 statements toward the 80% coverage target, completing the CLI coverage sweep.
Output: Seven new test files in tests/python/.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md
@.planning/codebase/CONVENTIONS.md
@src/strategies/backtester_cli.py
@src/strategies/optimizer_cli.py
@src/analysis/correlation_cli.py
@src/analysis/risk_metrics_cli.py
@src/analysis/itc_risk_cli.py
@src/utils/screener_cli.py
@src/utils/data_validator_cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write tests for backtester_cli.py, optimizer_cli.py, and correlation_cli.py</name>
  <files>
    tests/python/test_backtester_cli.py
    tests/python/test_optimizer_cli.py
    tests/python/test_correlation_cli.py
  </files>
  <action>
  Read the three CLI files and write test suites following the standard CLI testing pattern.

  **Standard CLI test pattern (same for all CLIs):**
  1. Test parse_args() with valid argument combinations
  2. Mock the Layer 2 calculator + yfinance
  3. Test main() happy path with text output
  4. Test main() with JSON output
  5. Test error handling (invalid ticker, calculator error)
  6. Use capsys or redirect stdout to capture and assert output

  **For test_backtester_cli.py (188 stmts):**
  - Test args: ticker, --strategy [rsi, sma_cross, buy_hold], --capital, --commission, --slippage, --days
  - Mock Backtester class, test output formatting for each strategy type
  - Test invalid strategy name handling

  **For test_optimizer_cli.py (199 stmts):**
  - Test args: multiple tickers, --method [max_sharpe, risk_parity, min_variance, mean_var], --max-position
  - Mock PortfolioOptimizer, test weight output formatting
  - Test Black-Litterman --view flag if present
  - Test with 2 tickers (minimum) and 5 tickers

  **For test_correlation_cli.py (163 stmts):**
  - Test args: 2+ tickers required, --rolling, --days
  - Mock correlation calculator and yfinance
  - Test correlation matrix display formatting
  - Test with exactly 2 tickers and with 4+ tickers
  - Test error when only 1 ticker provided

  **Mock structure:**
  ```python
  class TestBacktesterCLI:
      def _mock_prices(self, n=100):
          return pd.DataFrame({
              'Close': 100 + np.cumsum(np.random.randn(n)),
              'Open': ..., 'High': ..., 'Low': ..., 'Volume': ...
          }, index=pd.date_range('2025-01-01', periods=n))

      @patch("src.strategies.backtester_cli.yf.Ticker")
      @patch("src.strategies.backtester_cli.Backtester")
      def test_main_rsi_strategy(self, mock_bt, mock_yf):
          mock_yf.return_value.history.return_value = self._mock_prices()
          mock_bt.return_value.run.return_value = self._mock_results()
          # Test output
  ```
  </action>
  <verify>
  - `uv run pytest tests/python/test_backtester_cli.py tests/python/test_optimizer_cli.py tests/python/test_correlation_cli.py -v` passes
  - Each CLI module at >= 75% coverage
  </verify>
  <done>Three CLI test files written and passing. backtester_cli.py, optimizer_cli.py, and correlation_cli.py each at 75%+.</done>
</task>

<task type="auto">
  <name>Task 2: Write tests for risk_metrics_cli.py, itc_risk_cli.py, screener_cli.py, and data_validator_cli.py</name>
  <files>
    tests/python/test_risk_metrics_cli.py
    tests/python/test_itc_risk_cli_cov.py
    tests/python/test_screener_cli.py
    tests/python/test_data_validator_cli.py
  </files>
  <action>
  Read the four CLI files and write test suites.

  **For test_risk_metrics_cli.py (131 stmts):**
  - Test args: ticker, --days, --benchmark, --output, --confidence, --save-to
  - Mock RiskCalculator and market data
  - Test all risk metrics display in text and JSON modes
  - Test benchmark comparison output

  **For test_itc_risk_cli_cov.py (113 stmts):**
  - NOTE: test_itc_risk.py already exists (tests the ITCRiskCalculator class). Name this test_itc_risk_cli_cov.py to test the CLI layer.
  - Test args: ticker, --universe [crypto, tradfi], --full-table, --list-supported
  - Mock ITCRiskCalculator (mock the API call layer)
  - Test output formatting for risk score display
  - Test --list-supported flag output

  **For test_screener_cli.py (186 stmts):**
  - Test args: tickers (multiple), --criteria, screening flags
  - Mock Screener class and yfinance
  - Test table/ranking output format
  - Test with multiple tickers passing/failing criteria

  **For test_data_validator_cli.py (166 stmts):**
  - Test args: ticker, --days
  - Mock DataValidator and market data
  - Test clean data output (all checks pass)
  - Test dirty data output (anomalies detected)
  - Test error when ticker not found

  **All four follow the same mechanical pattern.** Focus on:
  1. parse_args coverage
  2. main() happy path (mock calculator returns valid result)
  3. main() error path (mock raises ValueError)
  4. Output formatting (text mode)
  5. JSON output mode
  </action>
  <verify>
  - `uv run pytest tests/python/test_risk_metrics_cli.py tests/python/test_itc_risk_cli_cov.py tests/python/test_screener_cli.py tests/python/test_data_validator_cli.py -v` passes
  - Each CLI module at >= 75% coverage
  </verify>
  <done>Four CLI test files written and passing. risk_metrics_cli.py, itc_risk_cli.py, screener_cli.py, and data_validator_cli.py each at 75%+.</done>
</task>

</tasks>

<verification>
1. All seven new test files pass
2. Each CLI module has >= 75% coverage
3. Full test suite still passes: `uv run pytest -x -q`
</verification>

<success_criteria>
Seven new CLI test files written and passing. All analysis and strategy CLIs at 75%+ test coverage.
</success_criteria>

<output>
After completion, create `.planning/phases/05-agent-readiness-hardening/05-09-SUMMARY.md`
</output>
