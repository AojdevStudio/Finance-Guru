---
phase: 05-agent-readiness-hardening
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - .pre-commit-config.yaml
  - pyproject.toml
  - src/models/dashboard_inputs.py
  - src/models/itc_risk_inputs.py
  - src/models/yaml_generation_inputs.py
  - src/analysis/correlation.py
  - src/analysis/itc_risk.py
  - src/analysis/options_chain_cli.py
  - src/strategies/backtester.py
  - src/ui/services/portfolio_loader.py
  - src/ui/app.py
  - src/utils/input_validation.py
  - src/utils/moving_averages.py
  - src/utils/moving_averages_cli.py
  - src/utils/screener.py
  - src/utils/volatility.py
  - src/utils/yaml_generator_cli.py
autonomous: true

must_haves:
  truths:
    - "Running uv run mypy src/ --ignore-missing-imports exits with zero errors"
    - "Making a git commit triggers ruff, mypy, and gitleaks pre-commit hooks"
    - "A commit with lint errors is blocked by pre-commit hooks"
  artifacts:
    - path: ".pre-commit-config.yaml"
      provides: "Pre-commit hook configuration with ruff, mypy, gitleaks"
      contains: "ruff-pre-commit"
    - path: ".pre-commit-config.yaml"
      provides: "Local mypy hook"
      contains: "id: mypy"
  key_links:
    - from: ".pre-commit-config.yaml"
      to: ".git/hooks/pre-commit"
      via: "pre-commit install"
      pattern: "pre-commit"
    - from: ".pre-commit-config.yaml ruff hook"
      to: "pyproject.toml [tool.ruff]"
      via: "ruff reads config from pyproject.toml"
      pattern: "ruff-pre-commit"
---

<objective>
Fix all 50 mypy type errors across 18 source files, then create and install a pre-commit hook configuration with ruff, mypy, and gitleaks hooks.

Purpose: Success criterion 2 of Phase 5 -- pre-commit hooks enforce linting, type checking, and secret scanning on every commit.
Output: Zero mypy errors, .pre-commit-config.yaml installed and verified.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-agent-readiness-hardening/05-01-SUMMARY.md
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix all 50 mypy type errors across 18 files</name>
  <files>
    src/config.py
    src/models/dashboard_inputs.py
    src/models/itc_risk_inputs.py
    src/models/yaml_generation_inputs.py
    src/analysis/correlation.py
    src/analysis/itc_risk.py
    src/analysis/options_chain_cli.py
    src/strategies/backtester.py
    src/ui/services/portfolio_loader.py
    src/ui/app.py
    src/utils/input_validation.py
    src/utils/moving_averages.py
    src/utils/moving_averages_cli.py
    src/utils/screener.py
    src/utils/volatility.py
    src/utils/yaml_generator_cli.py
  </files>
  <action>
  Fix all 50 mypy errors by category. Run `uv run mypy src/ --ignore-missing-imports` to get the current error list, then fix each:

  **Category 1: import-untyped (2 errors)**
  - src/config.py line 14: Add `types-PyYAML` to dev deps: `uv add --dev types-PyYAML types-requests`
  - src/analysis/itc_risk.py line 34: Covered by types-requests above

  **Category 2: prop-decorator (8 errors in dashboard_inputs.py)**
  - Lines 242-272, 388, 403: Pydantic's `@computed_field` stacked with `@property` is not supported by mypy. Fix by either:
    a. Removing the `@property` decorator (Pydantic v2 computed_field already acts as property), OR
    b. Adding `# type: ignore[prop-decorator]` if removing @property breaks Pydantic behavior

  **Category 3: arg-type for Literal mismatches (18+ errors)**
  - These occur when a plain `str` is passed where a `Literal[...]` type is expected.
  - Fix each by casting the string to the appropriate Literal type, or by using explicit type annotations.
  - Files affected: screener.py (5x), moving_averages.py (3x), options_chain_cli.py (2x), volatility.py (1x), input_validation.py (4x), backtester.py (1x), portfolio_loader.py (1x), moving_averages_cli.py (1x)
  - Pattern: Where a variable holds a computed string that should be a Literal, add type annotation or cast. Example:
    ```python
    # Before (mypy error):
    regime = "high" if vol > threshold else "low"
    return VolatilityMetricsOutput(volatility_regime=regime)

    # After (fixed):
    regime: Literal["low", "normal", "high", "extreme"] = "high" if vol > threshold else "low"
    return VolatilityMetricsOutput(volatility_regime=regime)
    ```

  **Category 4: operator errors (5 errors)**
  - itc_risk_inputs.py:291: None operand -- add None guard before arithmetic
  - moving_averages.py:474: None comparison -- add None guard
  - moving_averages_cli.py:162, 295: None operand -- add None guards

  **Category 5: var-annotated (2 errors in correlation.py)**
  - Lines 156, 231: Add type annotation to dict comprehensions:
    ```python
    corr_dict: dict[str, dict[str, float]] = {}
    ```

  **Category 6: call-arg errors (6 errors)**
  - screener.py lines 362, 398, 432, 461, 559: `prices` is not a valid kwarg for MomentumDataInput. Check the model definition and use the correct field name.
  - yaml_generator_cli.py:263: Missing required `mcp_json` arg -- add the missing argument.

  **Category 7: assignment (2 errors in ui/app.py)**
  - Lines 173, 194: Variable typed as None but assigned PortfolioSnapshotInput. Fix: declare with `Optional[PortfolioSnapshotInput] = None` or `PortfolioSnapshotInput | None = None`.

  After all fixes, run: `uv run mypy src/ --ignore-missing-imports`
  Confirm: "Success: no issues found" or 0 errors.
  </action>
  <verify>
  - `uv run mypy src/ --ignore-missing-imports` exits with 0 errors
  - `uv run pytest -x -q` passes (no regressions from type fixes)
  </verify>
  <done>All 50 mypy errors resolved. `uv run mypy src/ --ignore-missing-imports` reports zero errors. All existing tests still pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create pre-commit config and install hooks</name>
  <files>
    .pre-commit-config.yaml
    pyproject.toml
  </files>
  <action>
  1. Install pre-commit as a uv tool (NOT as a project dependency):
     ```bash
     uv tool install pre-commit --with pre-commit-uv --force-reinstall
     ```

  2. Create `.pre-commit-config.yaml` at project root:
     ```yaml
     repos:
       - repo: https://github.com/astral-sh/ruff-pre-commit
         rev: v0.15.0
         hooks:
           - id: ruff
             args: [--fix]

       - repo: local
         hooks:
           - id: mypy
             name: mypy
             entry: uv run mypy
             language: system
             types: [python]
             args: ["--ignore-missing-imports"]
             pass_filenames: false

       - repo: https://github.com/gitleaks/gitleaks
         rev: v8.24.0
         hooks:
           - id: gitleaks
     ```

  IMPORTANT: Use `repo: local` with `language: system` for mypy (NOT mirrors-mypy). This avoids maintaining duplicate dependencies in the hook's virtualenv. The hook runs `uv run mypy` which uses the project's dev dependency.

  IMPORTANT: Check the latest gitleaks tag available. Use v8.24.0 or whatever is current. Do NOT use v8.30.0 if it does not exist yet -- verify with `pre-commit try-repo https://github.com/gitleaks/gitleaks --ref v8.24.0` or check the releases page.

  IMPORTANT: Check the latest ruff-pre-commit tag. Use the version matching the ruff version in pyproject.toml dev deps.

  3. Install the hooks into .git/hooks/:
     ```bash
     pre-commit install
     ```

  4. Add mypy configuration to pyproject.toml if not already present:
     ```toml
     [tool.mypy]
     python_version = "3.12"
     ignore_missing_imports = true
     check_untyped_defs = false
     ```

  5. Run hooks against all files to verify they pass:
     ```bash
     pre-commit run --all-files
     ```

  6. Verify hooks trigger on commit by making a small test commit (e.g., add a comment to a test file, commit, then revert).
  </action>
  <verify>
  - `test -f .pre-commit-config.yaml && echo "Config exists"`
  - `test -f .git/hooks/pre-commit && echo "Hooks installed"`
  - `pre-commit run --all-files` passes with all hooks succeeding (ruff, mypy, gitleaks)
  </verify>
  <done>Pre-commit config exists with ruff, mypy, and gitleaks hooks. Hooks are installed in .git/hooks/. `pre-commit run --all-files` passes clean.</done>
</task>

</tasks>

<verification>
1. `uv run mypy src/ --ignore-missing-imports` exits with zero errors
2. `.pre-commit-config.yaml` exists with ruff, mypy, and gitleaks hooks
3. `pre-commit run --all-files` passes all three hooks
4. `uv run pytest -x -q` passes (no regressions)
</verification>

<success_criteria>
All mypy errors resolved. Pre-commit hooks (ruff + mypy + gitleaks) run successfully on every commit.
</success_criteria>

<output>
After completion, create `.planning/phases/05-agent-readiness-hardening/05-03-SUMMARY.md`
</output>
