---
phase: 05-agent-readiness-hardening
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - .pre-commit-config.yaml
  - pyproject.toml
  - setup.sh
autonomous: true

must_haves:
  truths:
    - "Running `pre-commit run --all-files` passes all hooks (ruff, mypy, gitleaks, hygiene)"
    - "Running `pre-commit install` chains existing bd hooks as .legacy (not destroyed)"
    - "mypy in pre-commit runs with pydantic and types-requests stubs (no missing import errors)"
    - "setup.sh auto-installs pre-commit hooks when .pre-commit-config.yaml exists"
  artifacts:
    - path: ".pre-commit-config.yaml"
      provides: "Pre-commit framework hook definitions"
      contains: "ruff-pre-commit"
    - path: "pyproject.toml"
      provides: "mypy configuration section"
      contains: "[tool.mypy]"
  key_links:
    - from: ".pre-commit-config.yaml"
      to: "pyproject.toml"
      via: "ruff and mypy hooks read config from pyproject.toml"
      pattern: "--config-file=pyproject.toml"
    - from: "setup.sh"
      to: ".pre-commit-config.yaml"
      via: "setup.sh calls pre-commit install when config exists"
      pattern: "pre-commit install"
---

<objective>
Configure the pre-commit framework with ruff, mypy, gitleaks, and hygiene hooks. Add mypy config to pyproject.toml. Integrate pre-commit install into setup.sh.

Purpose: Automate code quality enforcement on every commit. The pre-commit framework manages hook environments, versions, and chaining with existing bd hooks.
Output: .pre-commit-config.yaml, mypy config in pyproject.toml, setup.sh pre-commit integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-agent-readiness-hardening/05-RESEARCH.md
@.planning/phases/05-agent-readiness-hardening/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .pre-commit-config.yaml and add mypy config</name>
  <files>
    .pre-commit-config.yaml
    pyproject.toml
  </files>
  <action>
**Create .pre-commit-config.yaml** with these hook repos in order:

1. **pre-commit-hooks v5.0.0** -- Baseline hygiene:
   - trailing-whitespace
   - end-of-file-fixer
   - check-yaml
   - check-added-large-files (args: ['--maxkb=500'])

2. **ruff-pre-commit v0.15.1** -- Linter + formatter:
   - ruff-check with args: [--fix, --exit-non-zero-on-fix]
   - ruff-format

3. **mirrors-mypy v1.19.1** -- Type checking:
   - mypy with additional_dependencies: [pydantic>=2.10.6, types-requests, types-PyYAML]
   - args: [--config-file=pyproject.toml]

4. **gitleaks v8.24.2** -- Secret scanning:
   - gitleaks hook

Use the exact config from RESEARCH.md Pattern 2.

**Add mypy config to pyproject.toml:**

```toml
[tool.mypy]
python_version = "3.12"
warn_return_any = true
warn_unused_configs = true
warn_unused_ignores = true
disallow_untyped_defs = false
check_untyped_defs = true
ignore_missing_imports = false

[[tool.mypy.overrides]]
module = [
    "yfinance.*",
    "streamlit.*",
    "textual.*",
    "sklearn.*",
    "scipy.*",
    "matplotlib.*",
    "plotly.*",
    "reportlab.*",
    "openpyxl.*",
    "xlsxwriter.*",
    "questionary.*",
]
ignore_missing_imports = true
```

CRITICAL: Do NOT use `--strict` mode for mypy. Standard mode catches obvious errors without requiring full type annotations on the 23k-line codebase.
  </action>
  <verify>
`.pre-commit-config.yaml` exists and is valid YAML. `pyproject.toml` contains `[tool.mypy]` section. Run `pre-commit run --all-files` and verify all hooks pass (or identify and fix remaining issues).
  </verify>
  <done>.pre-commit-config.yaml defines ruff, mypy, gitleaks, and hygiene hooks. mypy config in pyproject.toml with standard mode and third-party overrides.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate pre-commit install into setup.sh</name>
  <files>setup.sh</files>
  <action>
Add an `install_pre_commit_hooks()` function to setup.sh. Insert it AFTER the Python dependency installation step (`uv sync`).

The function should:
1. Check if `.pre-commit-config.yaml` exists (skip if not)
2. Check if `pre-commit` is available (try `command -v pre-commit`)
3. If not available, install via `uv tool install pre-commit`
4. Run `pre-commit install` (default migration mode -- NOT --overwrite)
5. Log success

Use the exact pattern from RESEARCH.md "setup.sh Integration" section.

CRITICAL: Do NOT use `--overwrite` flag. Default migration mode backs up existing bd hooks as `.legacy` and chains them. This preserves bd hook functionality.

After adding the function, call it in the main setup flow.

Also install pre-commit hooks locally now for this development session:
```bash
pre-commit install
```

Verify bd hooks still work by checking `.git/hooks/pre-commit.legacy` exists after install.
  </action>
  <verify>
`grep -q "install_pre_commit_hooks" setup.sh` succeeds. `pre-commit run --all-files` passes. If `.git/hooks/pre-commit.legacy` exists, bd hooks are preserved. Run a test commit to verify both pre-commit framework and bd hooks execute.
  </verify>
  <done>setup.sh auto-installs pre-commit hooks during first-run setup. pre-commit framework coexists with bd hooks via migration mode.</done>
</task>

</tasks>

<verification>
1. `pre-commit run --all-files` passes all hooks
2. `.pre-commit-config.yaml` contains ruff-check, ruff-format, mypy, gitleaks hooks
3. `pyproject.toml` contains `[tool.mypy]` with standard mode config
4. `grep "install_pre_commit_hooks" setup.sh` finds the function
5. bd hooks are preserved (`.git/hooks/pre-commit.legacy` exists or bd hooks still function)
</verification>

<success_criteria>
Pre-commit framework is configured and installed. All hooks pass on the current codebase. mypy runs in standard mode with third-party stubs. setup.sh auto-installs hooks. Existing bd hooks are preserved.
</success_criteria>

<output>
After completion, create `.planning/phases/05-agent-readiness-hardening/05-03-SUMMARY.md`
</output>
