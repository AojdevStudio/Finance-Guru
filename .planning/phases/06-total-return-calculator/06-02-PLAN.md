---
phase: 06-total-return-calculator
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/analysis/total_return_cli.py
  - tests/python/test_total_return.py
autonomous: true

must_haves:
  truths:
    - "uv run python src/analysis/total_return_cli.py SCHD --days 252 outputs price return, dividend return, and total return as three distinct numbers"
    - "uv run python src/analysis/total_return_cli.py SCHD JEPI VYM --days 252 shows side-by-side comparison table"
    - "DRIP mode is the default; --no-drip flag disables it and shows simple total return"
    - "--output json produces valid JSON array with all TickerReturn fields serialized"
    - "--help shows complete usage examples including multi-ticker and DRIP examples"
    - "Output includes educational disclaimer: 'For educational purposes only. Not investment advice.'"
    - "Data quality warnings appear when dividend data has gaps"
    - "Known-answer tests pass for price return, dividend return, total return, and DRIP calculations"
  artifacts:
    - path: "src/analysis/total_return_cli.py"
      provides: "CLI interface for total return analysis (Layer 3)"
      exports: ["main", "parse_args", "format_human_output", "format_comparison_table", "format_json_output"]
    - path: "tests/python/test_total_return.py"
      provides: "Known-answer unit tests for TotalReturnCalculator"
      contains: "test_price_return_known_answer"
  key_links:
    - from: "src/analysis/total_return_cli.py"
      to: "src/analysis/total_return.py"
      via: "import TotalReturnCalculator, fetch_ticker_data"
      pattern: "from src\\.analysis\\.total_return import"
    - from: "src/analysis/total_return_cli.py"
      to: "src/models/total_return_inputs.py"
      via: "import TickerReturn for type hints"
      pattern: "from src\\.models\\.total_return_inputs import"
    - from: "tests/python/test_total_return.py"
      to: "src/analysis/total_return.py"
      via: "import TotalReturnCalculator"
      pattern: "from src\\.analysis\\.total_return import"
---

<objective>
Build the total return CLI interface (Layer 3) and known-answer test suite.

Purpose: The CLI is how users and agents invoke the total return calculator. The tests ensure calculations are correct with deterministic synthetic data. Together they complete the Phase 6 deliverable: a working `total_return_cli.py` that meets all five success criteria.

Output:
- `src/analysis/total_return_cli.py` with argparse, multi-ticker support, human/JSON output, DRIP default, educational disclaimer
- `tests/python/test_total_return.py` with known-answer tests for all calculator methods
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-total-return-calculator/06-RESEARCH.md
@.planning/phases/06-total-return-calculator/06-01-SUMMARY.md

# Pattern references (read these for exact conventions)
@src/analysis/correlation_cli.py
@src/analysis/risk_metrics_cli.py
@src/analysis/total_return.py
@tests/python/test_risk_metrics.py
@src/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create total_return_cli.py with multi-ticker comparison and dual output formats</name>
  <files>src/analysis/total_return_cli.py</files>
  <action>
Create `src/analysis/total_return_cli.py` following the exact Layer 3 conventions from `correlation_cli.py` and `risk_metrics_cli.py`.

**File structure:**
1. Shebang `#!/usr/bin/env python3`
2. Module docstring with:
   - "Total Return CLI for Finance Guru" header
   - WHAT/WHY/ARCHITECTURE note (Layer 3 of 3)
   - USAGE section with examples:
     ```
     # Single ticker total return (DRIP enabled by default)
     uv run python src/analysis/total_return_cli.py SCHD --days 252

     # Multi-ticker comparison
     uv run python src/analysis/total_return_cli.py SCHD JEPI VYM --days 252

     # Without DRIP reinvestment
     uv run python src/analysis/total_return_cli.py SCHD --days 252 --no-drip

     # JSON output for programmatic use
     uv run python src/analysis/total_return_cli.py SCHD JEPI --days 252 --output json
     ```
   - AGENT USE CASES section listing Strategy Advisor, Quant Analyst, Market Researcher use cases
3. Imports: `argparse`, `json`, `sys`, `from pathlib import Path`, `from datetime import datetime`
4. Project root path setup (same as correlation_cli.py)
5. Import from src: `from src.analysis.total_return import TotalReturnCalculator, fetch_ticker_data`, `from src.models.total_return_inputs import TickerReturn`

**EDUCATIONAL_DISCLAIMER constant:**
```python
EDUCATIONAL_DISCLAIMER = (
    "DISCLAIMER: For educational purposes only. Not investment advice. "
    "Past returns do not guarantee future results. Consult a qualified "
    "financial advisor before making investment decisions."
)
```

**parse_args() function:**
```python
def parse_args():
    parser = argparse.ArgumentParser(
        description='Calculate total returns (price + dividends) with optional DRIP modeling',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  %(prog)s SCHD --days 252              Single ticker, 1 year, DRIP enabled
  %(prog)s SCHD JEPI VYM --days 252     Compare three dividend ETFs
  %(prog)s SCHD --days 252 --no-drip    Price + dividend return without reinvestment
  %(prog)s SCHD --output json           JSON output for programmatic parsing
  %(prog)s SCHD --days 90               Quarterly analysis (may miss some dividends)
        """,
    )
    parser.add_argument(
        'tickers', type=str, nargs='+',
        help='Stock ticker symbol(s) (e.g., SCHD JEPI VYM)'
    )
    parser.add_argument(
        '--days', type=int, default=252,
        help='Number of calendar days of history (default: 252, ~1 year)'
    )
    parser.add_argument(
        '--no-drip', action='store_true', default=False,
        help='Disable DRIP modeling (show simple price + dividend return)'
    )
    parser.add_argument(
        '--output', choices=['text', 'json'], default='text',
        help='Output format (default: text)'
    )
    return parser.parse_args()
```

**format_single_ticker(result: TickerReturn, include_drip: bool) -> str:**
Format a single ticker's results as human-readable text:
```
======================================================================
TOTAL RETURN ANALYSIS: SCHD
Period: 2025-01-02 to 2026-01-02 (365 days)
======================================================================

Price Return:          12.45%
Dividend Return:        3.52%
Total Return:          15.97%

DRIP Analysis:
  DRIP Total Return:   16.23%
  Final Shares:         1.034 (from 1.000)
  Share Growth:          3.40%
  Dividends Received:   4

[Data quality warnings if any]

DISCLAIMER: ...
======================================================================
```

**format_comparison_table(results: list[TickerReturn], include_drip: bool) -> str:**
Follow the exact pattern from the research section "Human-Readable Multi-Ticker Comparison Output":
- Header row with ticker names as columns
- Rows: Price Return, Dividend Return, Total Return, Annualized Return
- If DRIP: additional rows for DRIP Total Return, DRIP Share Growth
- Data quality warnings section at bottom (per-ticker)
- Disclaimer at bottom
- Use f-string formatting with `:>12` alignment for columns, `:.2%` for percentages

**format_json_output(results: list[TickerReturn]) -> str:**
```python
def format_json_output(results: list[TickerReturn]) -> str:
    return json.dumps(
        [r.model_dump() for r in results],
        indent=2,
        default=str,  # Handles date serialization
    )
```

**main() function:**
1. Parse args
2. Uppercase all tickers: `tickers = [t.upper() for t in args.tickers]`
3. Include DRIP: `include_drip = not args.no_drip`
4. Loop per ticker:
   ```python
   results = []
   for ticker in tickers:
       try:
           prices, dates, dividends = fetch_ticker_data(ticker, args.days)
           calc = TotalReturnCalculator(
               prices=prices, dates=dates, dividends=dividends,
               ticker=ticker, include_drip=include_drip,
           )
           result = calc.calculate_all()
           results.append(result)
       except Exception as e:
           print(f"Error fetching {ticker}: {e}", file=sys.stderr)
           sys.exit(1)
   ```
5. Output formatting:
   ```python
   if args.output == 'json':
       print(format_json_output(results))
   elif len(results) == 1:
       print(format_single_ticker(results[0], include_drip))
   else:
       print(format_comparison_table(results, include_drip))
   ```
6. `if __name__ == '__main__': main()`

**Key formatting details:**
- Percentages displayed as `12.45%` (2 decimal places)
- Share counts displayed with 3 decimal places (e.g., `1.034`)
- Annualized return computed from `_annualize()` method (already in calculator from Plan 01). If TickerReturn doesn't have an `annualized_return` field, compute it in the CLI: `annualized = (1 + result.total_return) ** (365 / period_days) - 1`
- Data quality warnings printed as bullet list after the table
- Single ticker gets detailed view; multi-ticker gets comparison table
  </action>
  <verify>
Verify CLI help:
```bash
uv run python src/analysis/total_return_cli.py --help
```
Should show description, positional tickers arg, --days, --no-drip, --output, and epilog examples.

Verify single ticker execution (requires network):
```bash
uv run python src/analysis/total_return_cli.py SCHD --days 90
```
Should output three distinct numbers: price return, dividend return, total return. Should include DRIP section. Should include disclaimer.

Verify multi-ticker comparison:
```bash
uv run python src/analysis/total_return_cli.py SCHD JEPI --days 90
```
Should show side-by-side comparison table.

Verify JSON output:
```bash
uv run python src/analysis/total_return_cli.py SCHD --days 90 --output json | python -m json.tool
```
Must be valid JSON.

Verify --no-drip flag:
```bash
uv run python src/analysis/total_return_cli.py SCHD --days 90 --no-drip
```
Should show price return + dividend return = total return (no DRIP section).
  </verify>
  <done>
total_return_cli.py exists with:
- argparse with tickers (nargs='+'), --days, --no-drip, --output json/text
- --help showing complete usage examples
- Single-ticker detailed view and multi-ticker comparison table
- JSON output via model_dump() with date serialization
- Educational disclaimer on all text output
- Data quality warnings displayed when present
- DRIP enabled by default, disabled with --no-drip
  </done>
</task>

<task type="auto">
  <name>Task 2: Create known-answer test suite for TotalReturnCalculator</name>
  <files>tests/python/test_total_return.py</files>
  <action>
Create `tests/python/test_total_return.py` following the established test pattern from `test_risk_metrics.py`.

**File structure:**
1. Module docstring: "Tests for Finance Guru total return calculations."
2. Imports: `pytest`, `numpy as np`, `from datetime import date, timedelta`, `from src.analysis.total_return import TotalReturnCalculator, EXPECTED_DIVIDEND_FREQUENCIES`, `from src.models.total_return_inputs import DividendRecord, TickerReturn`

**Test class 1: TestPriceReturn**

`test_price_return_known_answer`:
- Prices: [100.0, 110.0], dates: 2 consecutive days
- Expected: 0.10 (10%)
- Assert: `abs(calc.calculate_price_return() - 0.10) < 0.0001`

`test_price_return_negative`:
- Prices: [100.0, 90.0]
- Expected: -0.10 (-10%)

`test_price_return_zero`:
- Prices: [100.0, 100.0]
- Expected: 0.0

`test_price_return_multi_day`:
- Prices: [100.0, 105.0, 98.0, 112.0] (4 days)
- Expected: 0.12 (only start and end matter)

**Test class 2: TestDividendReturn**

`test_dividend_return_single_dividend`:
- Prices: [100.0, 110.0], one dividend of $2.00
- Expected: 0.02 (2% of starting price)

`test_dividend_return_multiple_dividends`:
- Prices: [100.0, ..., 110.0] across 4 quarters
- Four dividends of $0.50 each = $2.00 total
- Expected: 0.02 (2% of $100 starting price)

`test_dividend_return_no_dividends`:
- Prices: [100.0, 110.0], no dividends
- Expected: 0.0

**Test class 3: TestTotalReturn**

`test_total_return_is_sum_of_components`:
- Prices: [100.0, 110.0], one $2 dividend
- price_return = 0.10, dividend_return = 0.02
- total_return should equal 0.12

`test_total_return_no_dividends_equals_price_return`:
- With zero dividends, total_return == price_return

**Test class 4: TestDripReturn**

`test_drip_basic_reinvestment`:
- Prices: [100.0, 105.0, 110.0], dates: day 0, day 1, day 2
- One dividend of $2.00 on day 1 when price is $105
- New shares from DRIP: $2.00 / $105 = 0.01905 shares
- Total shares: 1.01905
- Final value: 1.01905 * $110 = $112.095
- DRIP return: ($112.095 - $100) / $100 = 0.12095
- Assert: `abs(drip_return - 0.12095) < 0.001`

`test_drip_multiple_reinvestments`:
- 4 quarterly dividends of $0.50 at different prices
- Verify shares accumulate correctly with each reinvestment
- Final shares > 1.0

`test_drip_no_dividends_equals_price_return`:
- With zero dividends, DRIP return should still work (just price return with 1.0 shares)

`test_drip_share_growth_positive`:
- With dividends, final_shares > initial_shares

**Test class 5: TestDataQualityValidation**

`test_warns_missing_dividends_for_known_ticker`:
- Ticker "SCHD" with 0 dividends over 252 days
- validate_dividend_data() should return warnings containing "SCHD"

`test_no_warning_for_unknown_ticker`:
- Ticker "XYZTST" (not in EXPECTED_DIVIDEND_FREQUENCIES) with 0 dividends
- Should NOT warn about expected frequency (might warn about short period)

`test_warns_split_artifact`:
- Three dividends: $0.50, $0.55, $5.00 (last one is 10x median)
- Should warn about possible split artifact for the $5.00 record

`test_warns_short_period`:
- Ticker "SCHD" with 0 dividends over 30 days
- Should warn that period may be too short for dividend analysis

`test_no_warnings_for_healthy_data`:
- Ticker "SCHD" with 4 dividends over 365 days, all similar amounts
- Should return empty warnings list

**Test class 6: TestCalculateAll**

`test_calculate_all_returns_ticker_return_model`:
- Use synthetic data, call calculate_all()
- Assert result is TickerReturn instance
- Assert all fields populated (price_return, dividend_return, total_return, etc.)

`test_calculate_all_with_drip`:
- Verify final_shares > 1.0 when DRIP enabled with dividends

`test_calculate_all_without_drip`:
- Set include_drip=False
- Verify total_return == price_return + dividend_return (simple sum)

**Test class 7: TestAnnualization**

`test_annualize_one_year`:
- 365 day period, 10% return
- Annualized should be ~10% (since it's already one year)

`test_annualize_half_year`:
- 182 day period, 5% return
- Annualized should be ~10.25% ((1.05)^(365/182) - 1)

**Testing conventions (from test_risk_metrics.py):**
- Use `class Test*:` grouping (not standalone functions)
- Given/When/Then comments in each test
- Use `abs(actual - expected) < tolerance` for float comparisons
- All test data is synthetic (no network calls)
- No `@pytest.mark.integration` needed (pure unit tests)
  </action>
  <verify>
Run all tests:
```bash
uv run pytest tests/python/test_total_return.py -v
```
All tests must pass.

Run with coverage for total_return module:
```bash
uv run pytest tests/python/test_total_return.py -v --tb=short 2>&1 | tail -20
```
Verify at least 15 test cases pass (across 7 test classes).
  </verify>
  <done>
test_total_return.py exists with:
- 7 test classes covering all calculator methods
- Known-answer tests with deterministic synthetic data
- DRIP reinvestment test verifying correct share accumulation
- Data quality validation tests for all warning scenarios
- At least 15 individual test cases
- All tests pass via `uv run pytest tests/python/test_total_return.py -v`
  </done>
</task>

</tasks>

<verification>
Run the complete Phase 6 verification:

1. **Success Criterion 1** - Single ticker output:
```bash
uv run python src/analysis/total_return_cli.py SCHD --days 252
```
Must show price return, dividend return, and total return as three distinct numbers.

2. **Success Criterion 2** - Multi-ticker comparison:
```bash
uv run python src/analysis/total_return_cli.py SCHD JEPI VYM --days 252
```
Must show side-by-side comparison table.

3. **Success Criterion 3** - DRIP mode:
```bash
uv run python src/analysis/total_return_cli.py SCHD --days 252
```
Must show growing share count and DRIP return.

4. **Success Criterion 4** - Data quality warning:
```bash
uv run python src/analysis/total_return_cli.py SCHD --days 30
```
Short period should trigger data quality warning about potential missing dividends.

5. **Success Criterion 5** - JSON output and help:
```bash
uv run python src/analysis/total_return_cli.py SCHD --days 90 --output json | python -m json.tool
uv run python src/analysis/total_return_cli.py --help
```
JSON must be valid. Help must show examples.

6. **All unit tests pass:**
```bash
uv run pytest tests/python/test_total_return.py -v
```

7. **No regressions:**
```bash
uv run pytest tests/python/ -v --tb=short
```
</verification>

<success_criteria>
1. `uv run python src/analysis/total_return_cli.py SCHD --days 252` outputs three distinct numbers: price return, dividend return, total return
2. `uv run python src/analysis/total_return_cli.py SCHD JEPI VYM --days 252` shows side-by-side comparison
3. DRIP mode enabled by default, --no-drip disables it
4. Data quality warnings appear for short periods or known dividend payers with missing data
5. `--output json` produces valid JSON, `--help` shows complete examples
6. All tests in test_total_return.py pass with known-answer validation
7. Educational disclaimer on all text output
</success_criteria>

<output>
After completion, create `.planning/phases/06-total-return-calculator/06-02-SUMMARY.md`
</output>
