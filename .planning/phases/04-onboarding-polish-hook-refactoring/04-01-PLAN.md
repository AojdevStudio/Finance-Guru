---
phase: 04-onboarding-polish-hook-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/settings.json
  - .claude/hooks/CONFIG.md
  - .claude/hooks/tests/test_hook_performance.test.ts
autonomous: true

must_haves:
  truths:
    - "All three hooks (load-fin-core-config, skill-activation-prompt, post-tool-use-tracker) are invoked directly as Bun TypeScript with no bash wrappers in the call chain"
    - "Each hook completes execution in under 500ms as verified by test assertions with warmup"
    - "No dead .sh hook files (skill-activation-prompt.sh, post-tool-use-tracker.sh) exist on disk"
    - "CONFIG.md reflects the current .ts-only hook architecture with no references to deleted .sh files"
    - "All 97+ existing Bun hook tests still pass after settings.json and file changes"
  artifacts:
    - path: ".claude/settings.json"
      provides: "UserPromptSubmit hook command updated to direct bun run .ts invocation"
      contains: "bun run.*skill-activation-prompt.ts"
    - path: ".claude/hooks/tests/test_hook_performance.test.ts"
      provides: "Performance test suite asserting all 3 hooks complete in < 500ms"
      min_lines: 50
    - path: ".claude/hooks/CONFIG.md"
      provides: "Updated configuration guide reflecting .ts-only hook architecture"
      contains: "skill-activation-prompt.ts"
  key_links:
    - from: ".claude/settings.json"
      to: ".claude/hooks/skill-activation-prompt.ts"
      via: "bun run direct invocation (replacing .sh wrapper)"
      pattern: "bun run.*skill-activation-prompt\\.ts"
    - from: ".claude/hooks/tests/test_hook_performance.test.ts"
      to: ".claude/hooks/load-fin-core-config.ts"
      via: "child_process spawn with timing measurement"
      pattern: "load-fin-core-config\\.ts"
    - from: ".claude/hooks/tests/test_hook_performance.test.ts"
      to: ".claude/hooks/skill-activation-prompt.ts"
      via: "child_process spawn with timing measurement"
      pattern: "skill-activation-prompt\\.ts"
    - from: ".claude/hooks/tests/test_hook_performance.test.ts"
      to: ".claude/hooks/post-tool-use-tracker.ts"
      via: "child_process spawn with timing measurement"
      pattern: "post-tool-use-tracker\\.ts"
---

<objective>
Complete the Bun TypeScript hook migration by removing the last bash wrapper, deleting dead shell files, updating documentation, and writing a performance test suite that asserts all three hooks execute in under 500ms.

Purpose: Research confirmed that 80%+ of the hook migration is already done -- all three hooks are fully ported to TypeScript. What remains is configuration hygiene (settings.json still calls skill-activation-prompt through a bash wrapper), cleanup (two dead .sh files on disk), and verification (no performance test suite exists). This plan closes all four hook requirements (ONBD-10, ONBD-11, ONBD-12, ONBD-13).

Output: Updated settings.json with direct .ts invocation, two dead .sh files deleted, CONFIG.md updated, and a new performance test file proving all hooks run under 500ms.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-onboarding-polish-hook-refactoring/04-RESEARCH.md

# Key codebase files for this plan
@.claude/settings.json
@.claude/hooks/CONFIG.md
@.claude/hooks/skill-activation-prompt.sh
@.claude/hooks/skill-activation-prompt.ts
@.claude/hooks/post-tool-use-tracker.sh
@.claude/hooks/post-tool-use-tracker.ts
@.claude/hooks/load-fin-core-config.ts
@.claude/hooks/tests/test_load_fin_core_config.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update settings.json, delete dead .sh files, update CONFIG.md</name>
  <files>
    .claude/settings.json
    .claude/hooks/skill-activation-prompt.sh
    .claude/hooks/post-tool-use-tracker.sh
    .claude/hooks/CONFIG.md
  </files>
  <action>
    **Step 1: Update settings.json UserPromptSubmit hook**

    In `.claude/settings.json`, replace the UserPromptSubmit hook command:

    FROM: `"command": "$CLAUDE_PROJECT_DIR/.claude/hooks/skill-activation-prompt.sh"`
    TO: `"command": "bun run $CLAUDE_PROJECT_DIR/.claude/hooks/skill-activation-prompt.ts"`

    This matches the exact pattern already working for load-fin-core-config.ts in the SessionStart hook (line 8 of settings.json). The .ts file already reads stdin using process.stdin events (lines 57-83 of skill-activation-prompt.ts) -- the bash wrapper (`cat | bun skill-activation-prompt.ts`) was just piping stdin, which `bun run` does natively since Claude Code pipes hook input to stdin automatically.

    Do NOT add a second entry. Replace the existing command in-place. Do NOT change any other hooks in settings.json (SessionStart, PostToolUse, Stop -- leave them all untouched).

    **Step 2: Delete dead shell files**

    Delete these two files:
    - `.claude/hooks/skill-activation-prompt.sh` (6 lines -- bash wrapper that just pipes to .ts)
    - `.claude/hooks/post-tool-use-tracker.sh` (177 lines -- fully replaced by .ts port)

    Use `git rm` so git tracks the deletion.

    **Step 3: Update CONFIG.md**

    In `.claude/hooks/CONFIG.md`, make these targeted replacements:

    a) In the Quick Start Configuration section (### 1. Register Hooks), update the example settings.json:
       - Change `skill-activation-prompt.sh` to `bun run $CLAUDE_PROJECT_DIR/.claude/hooks/skill-activation-prompt.ts`
       - Change `post-tool-use-tracker.sh` to `$CLAUDE_PROJECT_DIR/.claude/hooks/post-tool-use-tracker.ts` (this one is ALREADY correct in actual settings.json but CONFIG.md shows the old .sh path)

    b) In the ### 3. Set Execute Permissions section, change the heading and content to reflect that only Stop hooks still use .sh files:
       - Keep `chmod +x .claude/hooks/*.sh` but add a note that this is only needed for Stop hooks (stop-build-check-enhanced.sh, error-handling-reminder.sh, trigger-build-resolver.sh)

    c) In sections that reference `post-tool-use-tracker.sh` for customization (### Adding Custom Directory Patterns, ### Customizing Build Commands, ### Custom TypeScript Configs), update the reference to `post-tool-use-tracker.ts` and change the code examples from bash syntax to TypeScript syntax showing the equivalent functions in the .ts file (detectRepo switch case, getBuildCommand function, getTscCommand function). Keep the examples concise -- just show where to edit, not full reimplementations.

    d) In the Minimal Setup example near the bottom, update `skill-activation-prompt.sh` to the `bun run .ts` pattern.

    e) In the Build Checking Only example, update `post-tool-use-tracker.sh` to `post-tool-use-tracker.ts`.

    f) In the Formatting Only example, update `post-tool-use-tracker.sh` to `post-tool-use-tracker.ts`.

    **Step 4: Run existing hook tests**

    Run the existing Bun hook test suite to confirm nothing broke:
    ```bash
    cd .claude/hooks && bun test
    ```

    All 97+ existing tests must pass.
  </action>
  <verify>
    1. `grep -r "skill-activation-prompt.sh" .claude/settings.json` returns no matches
    2. `grep "skill-activation-prompt.ts" .claude/settings.json` returns the new bun run command
    3. `ls .claude/hooks/skill-activation-prompt.sh` returns "No such file"
    4. `ls .claude/hooks/post-tool-use-tracker.sh` returns "No such file"
    5. `grep -c "skill-activation-prompt.sh" .claude/hooks/CONFIG.md` returns 0
    6. `cd .claude/hooks && bun test` -- all existing tests pass
  </verify>
  <done>
    settings.json UserPromptSubmit calls skill-activation-prompt.ts directly via bun run. Both dead .sh files are deleted from disk and git. CONFIG.md reflects the .ts-only architecture. All existing hook tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write Bun performance test suite for all 3 hooks</name>
  <files>
    .claude/hooks/tests/test_hook_performance.test.ts
  </files>
  <action>
    Create `.claude/hooks/tests/test_hook_performance.test.ts` -- a dedicated performance test file that spawns each of the 3 hooks as child processes and asserts they complete in under 500ms.

    **Structure:**

    Use the existing `runHook()` spawn pattern from the other test files (see test_load_fin_core_config.test.ts for the proven pattern). Extend it with `performance.now()` timing.

    Create a reusable `timeHook(hookPath, input)` helper that:
    1. Records `performance.now()` before spawn
    2. Spawns `bun <hookPath>` as child process
    3. Writes JSON input to stdin, closes stdin
    4. Waits for process close
    5. Records `performance.now()` after close
    6. Returns `{ stdout, stderr, exitCode, durationMs }`

    **Test cases (inside a single `describe("Hook Performance (< 500ms)")`):**

    1. **Warmup test** -- runs load-fin-core-config.ts once to prime Bun's transpile cache. This is labeled "warmup: prime bun transpile cache" and does not assert timing. It only asserts exit code 0.

    2. **load-fin-core-config.ts performance** -- spawn with input `{ session_id: "perf-test", event: "session_start" }`. Assert `exitCode === 0` and `durationMs < 500`.

    3. **skill-activation-prompt.ts performance** -- spawn with input `{ session_id: "perf-test", transcript_path: "/tmp/test-transcript.txt", cwd: process.cwd(), permission_mode: "normal", prompt: "test prompt for performance measurement" }`. Assert `exitCode === 0` and `durationMs < 500`.

    4. **post-tool-use-tracker.ts performance** -- spawn with input `{ tool_name: "Edit", tool_input: { file_path: "/tmp/test-file.ts" }, session_id: "perf-test" }`. Assert `exitCode === 0` and `durationMs < 500`.

    **Important implementation details:**
    - Use `import { spawn } from "child_process"` (NOT Bun's native spawn -- match the existing test pattern)
    - Use `import { join } from "path"` to resolve hook paths relative to `import.meta.dir`
    - Set `HOOKS_DIR = join(import.meta.dir, "..")` as the base for hook resolution
    - Pass `env: { ...process.env }` to spawn so hooks have access to needed environment variables
    - The 500ms constant should be defined as `const MAX_EXECUTION_MS = 500` at the top of the file
    - Use `import { describe, it, expect } from "bun:test"` for the test framework

    **Run the new test:**
    ```bash
    cd .claude/hooks && bun test tests/test_hook_performance.test.ts
    ```

    All 4 tests (warmup + 3 performance) must pass.

    Then run the full suite to confirm no interference:
    ```bash
    cd .claude/hooks && bun test
    ```
  </action>
  <verify>
    1. `ls .claude/hooks/tests/test_hook_performance.test.ts` -- file exists
    2. `cd .claude/hooks && bun test tests/test_hook_performance.test.ts` -- all 4 tests pass
    3. `cd .claude/hooks && bun test` -- full suite passes (97+ existing tests + 4 new performance tests)
    4. `grep "500" .claude/hooks/tests/test_hook_performance.test.ts` -- confirms 500ms threshold is defined
  </verify>
  <done>
    Performance test suite exists at `.claude/hooks/tests/test_hook_performance.test.ts` with warmup + 3 timed tests. All three hooks complete in under 500ms. Full hook test suite passes with no regressions.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Hook invocation chain verified:**
   ```bash
   # All 3 hooks are .ts files invoked directly (no .sh in the chain)
   grep -E "\.sh" .claude/settings.json | grep -v "stop-build-check\|error-handling-reminder"
   # Should return empty (only Stop hooks still use .sh, which are NOT part of this migration)
   ```

2. **Dead files confirmed deleted:**
   ```bash
   ls .claude/hooks/*.sh
   # Should show: error-handling-reminder.sh, run-tests.sh, stop-build-check-enhanced.sh, trigger-build-resolver.sh, tsc-check.sh
   # Should NOT show: skill-activation-prompt.sh, post-tool-use-tracker.sh
   ```

3. **Performance verified:**
   ```bash
   cd .claude/hooks && bun test tests/test_hook_performance.test.ts
   # All 4 tests pass, each hook under 500ms
   ```

4. **No regressions:**
   ```bash
   cd .claude/hooks && bun test
   # Full suite passes (97+ existing + 4 new)
   ```
</verification>

<success_criteria>
- settings.json calls all 3 hooks as Bun TypeScript directly (ONBD-10, ONBD-11, ONBD-12 complete)
- Performance test suite proves all hooks run under 500ms (ONBD-13 complete)
- No dead .sh files for migrated hooks
- CONFIG.md is accurate to current architecture
- Zero test regressions in existing hook test suite
</success_criteria>

<output>
After completion, create `.planning/phases/04-onboarding-polish-hook-refactoring/04-01-SUMMARY.md`
</output>
