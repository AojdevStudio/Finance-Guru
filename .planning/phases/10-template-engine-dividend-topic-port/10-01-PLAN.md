---
phase: 10-template-engine-dividend-topic-port
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - bun.lock
  - src/explorer/schemas/topic-schema.ts
  - src/explorer/topics/dividend-strategy.json
  - src/explorer/template/template.html
  - src/explorer/template/styles.css
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Zod validation succeeds on well-formed topic JSON and fails with clear field-level error messages on malformed JSON"
    - "Topic JSON for dividend strategy contains all 21 concepts, 22 edges, 6 categories, 5 presets, and prompt template fragments from the prototype"
    - "Build pipeline can inject CSS, topic data, and application JS into the HTML template via string replacement of named placeholders"
    - "CSS file defines dark theme variables and a #cy container with explicit dimensions sufficient for Cytoscape rendering"
  artifacts:
    - path: "src/explorer/schemas/topic-schema.ts"
      provides: "Zod schema and exported TypeScript types for topic JSON"
      exports: ["TopicSchema", "TopicData", "NodeSchema", "EdgeSchema", "CategorySchema", "PresetSchema"]
    - path: "src/explorer/topics/dividend-strategy.json"
      provides: "Complete dividend strategy topic data ported from prototype"
      contains: "21 nodes with id, label, category, description, knowledge, tags"
    - path: "src/explorer/template/template.html"
      provides: "HTML shell template with injection placeholders"
      contains: "__INJECT_CSS__"
    - path: "src/explorer/template/styles.css"
      provides: "Explorer dark theme styles"
      contains: "--bg: #0d1117"
  key_links:
    - from: "src/explorer/schemas/topic-schema.ts"
      to: "src/explorer/topics/dividend-strategy.json"
      via: "Schema defines structure that topic JSON conforms to"
      pattern: "TopicSchema.safeParse"
    - from: "src/explorer/template/template.html"
      to: "src/explorer/template/styles.css"
      via: "CSS is injected into template at build time"
      pattern: "__INJECT_CSS__"
---

<objective>
Set up the data foundation for the explorer build pipeline: install dependencies, define the topic JSON schema, port the dividend strategy data from the prototype, and create the HTML template shell with CSS.

Purpose: All subsequent work (explorer application logic and build pipeline) depends on having the schema types, topic data, and template/styles in place. This plan creates all non-application-logic artifacts.

Output: Zod schema with TypeScript types, complete dividend-strategy.json, HTML template with injection points, dark theme CSS, and cytoscape.js installed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-template-engine-dividend-topic-port/10-RESEARCH.md
@.dev/playgrounds/dividend-strategy-explorer.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Cytoscape.js and create Zod topic schema</name>
  <files>
    package.json
    bun.lock
    src/explorer/schemas/topic-schema.ts
  </files>
  <action>
    **Step 1: Install dependencies**
    ```bash
    cd {project-root}
    bun add cytoscape
    bun add -d @types/cytoscape
    ```
    Note: Zod is already in project dependencies (used by plaid-dashboard). Verify with `bun pm ls | grep zod`. If NOT present, also `bun add zod`.

    Do NOT install cytoscape-fcose yet -- start with built-in cose layout (per research recommendation).

    **Step 2: Create the Zod schema**
    Create `src/explorer/schemas/topic-schema.ts` with:

    1. `CategorySchema`: id (kebab-case regex `^[a-z][a-z0-9-]*$`), label (min 1), color (hex `^#[0-9a-fA-F]{6}$`)
    2. `NodeSchema`: id (kebab-case), label (min 1), category (string), description (min 1), knowledge (enum "know"/"fuzzy"/"unknown", default "fuzzy"), tags (array of strings, default [])
    3. `EdgeSchema`: source (string), target (string), label (min 1), type (string, optional)
    4. `PresetSchema`: id (string), label (min 1), filter (union of: `{ tags: string[] }`, `{ categories: string[] }`, `{ nodeIds: string[] }`, or literal `"all"`)
    5. `PromptTemplateSchema`: intro (string), knowPrefix (string), fuzzyPrefix (string), unknownPrefix (string), edgePrefix (string), outro (string)
    6. `TopicSchema`: metadata ({ title, slug (kebab-case), version (default "1.0.0"), description (optional) }), categories (array min 1), nodes (array min 1), edges (array), presets (array, default []), promptTemplate (optional PromptTemplateSchema)

    Export: `TopicSchema`, `TopicData` (z.infer of TopicSchema), and all sub-schemas.

    Use exact patterns from the research Zod example (validated against Zod docs).
  </action>
  <verify>
    ```bash
    # Verify cytoscape installed
    bun pm ls 2>/dev/null | grep cytoscape
    # Verify schema file compiles
    bun build src/explorer/schemas/topic-schema.ts --outdir /tmp/schema-check --target node 2>&1 | head -5
    ```
    The schema file must export TopicSchema and TopicData without TypeScript errors.
  </verify>
  <done>
    cytoscape and @types/cytoscape are in package.json. topic-schema.ts compiles without errors and exports TopicSchema (Zod object) and TopicData (TypeScript type).
  </done>
</task>

<task type="auto">
  <name>Task 2: Port dividend strategy data to topic JSON</name>
  <files>src/explorer/topics/dividend-strategy.json</files>
  <action>
    Port ALL data from `.dev/playgrounds/dividend-strategy-explorer.html` into `src/explorer/topics/dividend-strategy.json` following the schema structure.

    **metadata:**
    ```json
    {
      "title": "Dividend Investment Strategy Explorer",
      "slug": "dividend-strategy",
      "version": "1.0.0",
      "description": "Interactive knowledge graph for dividend investment strategies"
    }
    ```

    **categories (6):** Port from the prototype's `CATEGORIES` object:
    - foundation: #58a6ff
    - strategy: #3fb950
    - portfolio: #d29922
    - risk: #f85149
    - advanced: #bc8cff
    - implementation: #39d2c0

    **nodes (21):** Port ALL 21 nodes from `nodesData` array. Map fields:
    - `id` -> `id`
    - `label` -> `label` (keep `\n` in labels for multi-line display)
    - `category` -> `category`
    - `desc` -> `description`
    - `knowledge` -> `knowledge` (all default to "fuzzy")
    - `tags` -> `tags`

    **edges (22):** Port ALL 22 edges from `edgesData` array. Map fields:
    - `from` -> `source`
    - `to` -> `target`
    - `label` -> `label`
    - `type` -> `type`

    **presets (5):** Port from the prototype's `PRESETS` object:
    - "all": filter "all" (literal)
    - "core": filter { tags: ["core"] }
    - "risk": filter { tags: ["risk"], categories: ["risk"] } -- actually the prototype uses `n.tags.includes('risk') || n.category === 'risk'`. Represent this as { tags: ["risk"] } since the schema supports tag-based filtering (the app code will also check category).
    - "implementation": filter { tags: ["implementation"] } -- same logic
    - "advanced": filter { tags: ["advanced"] } -- same logic

    Note: The preset filter in the prototype combines tags OR category matching. The schema's PresetSchema supports `{ tags: [...] }` which the explorer app will interpret as "show nodes matching ANY of these tags OR belonging to categories with these ids." This logic lives in the explorer app, not the JSON.

    **promptTemplate:** Extract the prompt logic from `updatePrompt()` into declarative fragments:
    ```json
    {
      "intro": "I'm studying advanced dividend investment strategies for financial independence.",
      "knowPrefix": "I already understand:",
      "fuzzyPrefix": "I'm fuzzy on:",
      "unknownPrefix": "I don't understand:",
      "edgePrefix": "Key relationships I want to understand:",
      "outro": "Please explain the fuzzy and unknown concepts, building on what I already know. Use concrete numbers, real portfolio examples, and specific fund tickers (CLM, CRF, QQQY, SPYI, XDTE). Include risk considerations for each concept."
    }
    ```

    **Validate:** After creating the JSON, write a quick validation script:
    ```bash
    bun -e "
      import { TopicSchema } from './src/explorer/schemas/topic-schema';
      const data = await Bun.file('./src/explorer/topics/dividend-strategy.json').json();
      const result = TopicSchema.safeParse(data);
      if (result.success) {
        console.log('VALID:', result.data.nodes.length, 'nodes,', result.data.edges.length, 'edges');
      } else {
        console.error('INVALID:', result.error.format());
        process.exit(1);
      }
    "
    ```

    **Cross-validate edges:** Ensure every edge source/target references a valid node id. The build pipeline will also check this, but catch errors early.
  </action>
  <verify>
    ```bash
    # Validate JSON against schema
    bun -e "
      import { TopicSchema } from './src/explorer/schemas/topic-schema';
      const data = await Bun.file('./src/explorer/topics/dividend-strategy.json').json();
      const r = TopicSchema.safeParse(data);
      if (!r.success) { console.error(r.error.format()); process.exit(1); }
      const nodeIds = new Set(r.data.nodes.map(n => n.id));
      for (const e of r.data.edges) {
        if (!nodeIds.has(e.source)) { console.error('Bad source:', e.source); process.exit(1); }
        if (!nodeIds.has(e.target)) { console.error('Bad target:', e.target); process.exit(1); }
      }
      console.log('OK:', r.data.nodes.length, 'nodes,', r.data.edges.length, 'edges,', r.data.categories.length, 'categories,', r.data.presets.length, 'presets');
    "
    ```
    Must output: `OK: 21 nodes, 22 edges, 6 categories, 5 presets`
  </verify>
  <done>
    dividend-strategy.json contains all 21 nodes, 22 edges, 6 categories, 5 presets, and prompt template from the prototype. Validates against the Zod schema with zero errors. All edge source/target IDs reference existing nodes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create HTML template shell and dark theme CSS</name>
  <files>
    src/explorer/template/template.html
    src/explorer/template/styles.css
    .gitignore
  </files>
  <action>
    **Step 1: Create template.html**

    Create `src/explorer/template/template.html` as the HTML shell with injection points. Structure:

    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>__TOPIC_TITLE__</title>
      <style>/* __INJECT_CSS__ */</style>
    </head>
    <body>
      <!-- Header with title, stats, preset buttons -->
      <div class="header">
        <h1><span>$</span> <span id="topic-title">__TOPIC_TITLE__</span></h1>
        <div class="header-controls">
          <div class="stats">
            <span class="stat" id="stat-know"><strong>0</strong> know</span>
            <span class="stat" id="stat-fuzzy"><strong>0</strong> fuzzy</span>
            <span class="stat" id="stat-unknown"><strong>0</strong> unknown</span>
          </div>
          <div id="preset-buttons"></div>
        </div>
      </div>

      <!-- Main area: sidebar + graph -->
      <div class="main">
        <div class="sidebar">
          <div class="sidebar-section">
            <h3>How to Use</h3>
            <div class="instructions">
              <kbd>Click</kbd> a node to cycle knowledge: Know / Fuzzy / Unknown.
              <kbd>Drag</kbd> nodes to arrange. Use presets to focus.
              The prompt below updates live based on your gaps.
            </div>
          </div>
          <div class="sidebar-section">
            <h3>Categories</h3>
            <div class="legend" id="category-legend"></div>
          </div>
          <div class="sidebar-section">
            <h3>Concepts</h3>
            <div class="node-list" id="node-list"></div>
          </div>
          <div class="sidebar-section">
            <h3>Actions</h3>
            <div class="action-row" id="action-buttons">
              <button class="action-btn" id="btn-layout">Auto-Layout</button>
              <button class="action-btn" id="btn-all-know">All Know</button>
              <button class="action-btn" id="btn-all-fuzzy">All Fuzzy</button>
              <button class="action-btn" id="btn-all-unknown">All Unknown</button>
              <button class="action-btn" id="btn-reset">Reset</button>
            </div>
          </div>
        </div>

        <!-- Cytoscape container - MUST have explicit dimensions -->
        <div class="graph-container">
          <div id="cy"></div>
        </div>
      </div>

      <!-- Prompt panel -->
      <div class="prompt-panel">
        <div class="prompt-header">
          <span>Learning Prompt</span>
          <button class="copy-btn" id="copy-btn">Copy</button>
        </div>
        <div class="prompt-text" id="prompt-text">
          Mark your knowledge levels to generate a targeted learning prompt...
        </div>
      </div>

      <script>
        /* __INJECT_TOPIC_DATA__ */
        /* __INJECT_APP_JS__ */
      </script>
    </body>
    </html>
    ```

    Key differences from prototype:
    - Uses `#cy` div for Cytoscape.js (not `<canvas>`)
    - Preset buttons and category legend are generated dynamically from topic data (not hardcoded)
    - Has `__INJECT_*__` placeholders for build pipeline
    - `__TOPIC_TITLE__` placeholder in `<title>` and `<h1>`

    **Step 2: Create styles.css**

    Port CSS from the prototype's `<style>` block (lines 8-308 of the prototype). Key adaptations:
    - Keep all CSS custom properties (--bg, --surface, --border, --text, etc.)
    - Replace `.canvas-container` with `.graph-container` and add `#cy` styles:
      ```css
      .graph-container {
        flex: 1;
        position: relative;
        overflow: hidden;
      }
      #cy {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
      }
      ```
    - Keep all other styles (header, sidebar, preset-btn, knowledge-badge, tooltip, prompt-panel, etc.)
    - Remove the `canvas` CSS rule (Cytoscape uses a div, not canvas element directly)

    CRITICAL: The `#cy` container MUST have explicit dimensions (per research pitfall #1). The absolute positioning with 100% width/height ensures this.

    **Step 3: Add dist/ to .gitignore**

    Add `src/explorer/dist/` to .gitignore so generated HTML files are not committed.
  </action>
  <verify>
    ```bash
    # Verify files exist
    test -f src/explorer/template/template.html && echo "template.html: OK" || echo "template.html: MISSING"
    test -f src/explorer/template/styles.css && echo "styles.css: OK" || echo "styles.css: MISSING"

    # Verify injection points (each grep -q checks presence, echo reports result)
    grep -q "__INJECT_CSS__" src/explorer/template/template.html && echo "INJECT_CSS: OK" || echo "INJECT_CSS: MISSING"
    grep -q "__INJECT_TOPIC_DATA__" src/explorer/template/template.html && echo "INJECT_TOPIC_DATA: OK" || echo "INJECT_TOPIC_DATA: MISSING"
    grep -q "__INJECT_APP_JS__" src/explorer/template/template.html && echo "INJECT_APP_JS: OK" || echo "INJECT_APP_JS: MISSING"
    grep -q "__TOPIC_TITLE__" src/explorer/template/template.html && echo "TOPIC_TITLE: OK" || echo "TOPIC_TITLE: MISSING"

    # Verify cy container has explicit dimensions
    grep -q "#cy" src/explorer/template/styles.css && echo "CY_STYLES: OK" || echo "CY_STYLES: MISSING"

    # Verify dist is gitignored
    git check-ignore src/explorer/dist/test.html && echo "GITIGNORE: OK" || echo "GITIGNORE: MISSING"
    ```
  </verify>
  <done>
    template.html has 4 injection points (__INJECT_CSS__, __INJECT_TOPIC_DATA__, __INJECT_APP_JS__, __TOPIC_TITLE__). styles.css has dark theme with explicit #cy container dimensions. src/explorer/dist/ is in .gitignore.
  </done>
</task>

</tasks>

<verification>
All foundation artifacts exist and are consistent:
```bash
# Schema compiles
bun build src/explorer/schemas/topic-schema.ts --outdir /tmp/verify-10-01 --target node 2>&1

# Topic JSON validates
bun -e "
  import { TopicSchema } from './src/explorer/schemas/topic-schema';
  const d = await Bun.file('./src/explorer/topics/dividend-strategy.json').json();
  const r = TopicSchema.safeParse(d);
  console.log(r.success ? 'PASS' : 'FAIL');
"

# Template has injection points
grep "__INJECT_" src/explorer/template/template.html | wc -l  # Must be >= 3

# CSS has cy container
grep "#cy" src/explorer/template/styles.css | wc -l  # Must be >= 1

# Dependencies installed
bun pm ls 2>/dev/null | grep cytoscape
```
</verification>

<success_criteria>
1. cytoscape and @types/cytoscape installed in package.json
2. topic-schema.ts exports TopicSchema and TopicData, compiles without errors
3. dividend-strategy.json validates against schema: 21 nodes, 22 edges, 6 categories, 5 presets
4. template.html has all 4 injection placeholders
5. styles.css has dark theme CSS variables and #cy container with explicit dimensions
6. src/explorer/dist/ is in .gitignore
</success_criteria>

<output>
After completion, create `.planning/phases/10-template-engine-dividend-topic-port/10-01-SUMMARY.md`
</output>
