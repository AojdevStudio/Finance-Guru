---
phase: 10-template-engine-dividend-topic-port
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/explorer/template/explorer.ts
autonomous: true

must_haves:
  truths:
    - "Cytoscape.js renders all topic nodes with category-colored styling and knowledge-level visual indicators"
    - "Clicking a node cycles its knowledge state through know/fuzzy/unknown and updates the sidebar and prompt"
    - "Preset filter buttons show/hide subsets of nodes based on tag or category matching"
    - "Hovering a node shows a tooltip with description and category, and highlights connected edges with labels"
    - "The learning prompt panel generates context-aware text based on current knowledge states and relationships"
    - "Copy button copies the generated prompt to clipboard"
    - "Auto-layout button re-runs the Cytoscape CoSE layout"
    - "Set-all-knowledge buttons and reset button work correctly"
  artifacts:
    - path: "src/explorer/template/explorer.ts"
      provides: "Complete Cytoscape.js application with all 14 prototype features"
      exports: []
      min_lines: 200
  key_links:
    - from: "src/explorer/template/explorer.ts"
      to: "TOPIC_DATA global constant"
      via: "Application reads injected topic data at runtime"
      pattern: "TOPIC_DATA"
    - from: "src/explorer/template/explorer.ts"
      to: "cytoscape npm package"
      via: "Import and initialization"
      pattern: "import cytoscape from"
    - from: "src/explorer/template/explorer.ts"
      to: "src/explorer/template/template.html DOM elements"
      via: "getElementById for cy, node-list, prompt-text, stat-*, preset-buttons, etc."
      pattern: "document.getElementById"
---

<objective>
Build the complete Cytoscape.js explorer application with full feature parity to the prototype's 14 interactive features.

Purpose: This is the core application logic that transforms static topic data into an interactive knowledge graph. It is the most complex piece of Phase 10 and must implement all 14 features identified in the prototype analysis.

Output: A single `explorer.ts` file that, when bundled as IIFE and injected into the template HTML alongside topic data, produces a fully interactive knowledge explorer.

**Scope note:** This plan has a single task implementing 14 features in 200+ lines. This is intentional -- NOT split -- because all 14 features are tightly coupled through: (1) a shared Cytoscape instance (`cy`), (2) shared state-update functions (`updateSidebar`, `updatePrompt`, `updateStats`) called after every interaction, and (3) shared DOM element references. Splitting into separate tasks within the same file would create artificial boundaries requiring repeated context loading of the same shared state. Feature 13 (node drag) is zero-code (Cytoscape default). Features 3 and 11 are under 10 lines each. The natural unit of work is one file producing one module.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-template-engine-dividend-topic-port/10-RESEARCH.md
@.planning/phases/10-template-engine-dividend-topic-port/10-01-SUMMARY.md
@.dev/playgrounds/dividend-strategy-explorer.html
@src/explorer/schemas/topic-schema.ts
@src/explorer/template/template.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Cytoscape.js explorer application with all 14 features</name>
  <files>src/explorer/template/explorer.ts</files>
  <action>
    Create `src/explorer/template/explorer.ts` implementing ALL 14 features from the prototype. The file will be bundled as IIFE format by Bun and injected into the HTML template. It expects `TOPIC_DATA` to exist as a global constant (injected by the build pipeline before this script).

    **Important runtime context:**
    - `TOPIC_DATA` is a global const matching the `TopicData` type (from topic-schema.ts). Do NOT import the schema at runtime -- the types are for build-time only. Use `declare const TOPIC_DATA: any;` or define an inline interface for type hints.
    - The Cytoscape.js library IS imported (it will be bundled into the IIFE by Bun).
    - All DOM element IDs match template.html: `cy`, `node-list`, `prompt-text`, `stat-know`, `stat-fuzzy`, `stat-unknown`, `copy-btn`, `preset-buttons`, `category-legend`, `btn-layout`, `btn-all-know`, `btn-all-fuzzy`, `btn-all-unknown`, `btn-reset`, `topic-title`.

    **Structure the file as follows:**

    ```typescript
    import cytoscape from "cytoscape";

    // Declare the injected topic data
    declare const TOPIC_DATA: {
      metadata: { title: string; slug: string };
      categories: Array<{ id: string; label: string; color: string }>;
      nodes: Array<{ id: string; label: string; category: string; description: string; knowledge: string; tags: string[] }>;
      edges: Array<{ source: string; target: string; label: string; type?: string }>;
      presets: Array<{ id: string; label: string; filter: any }>;
      promptTemplate?: { intro: string; knowPrefix: string; fuzzyPrefix: string; unknownPrefix: string; edgePrefix: string; outro: string };
    };
    ```

    **Feature 1: Graph visualization with category-colored nodes**
    - Build a color map from `TOPIC_DATA.categories`: `{ [categoryId]: color }`
    - Transform nodes to Cytoscape elements with `data.categoryColor` set from the color map
    - Style nodes: circle shape, 72x72px, `background-color: data(categoryColor)`, border matches category color, label centered with text-wrap, white text (#e6edf3) on dark background (#161b22)
    - Style edges: bezier curves, dark gray (#30363d), triangle target arrows, labels with autorotate and dark background padding

    **Feature 2: Knowledge level badges with click-to-cycle**
    - Store knowledge state on each node's data: `data.knowledge` (know/fuzzy/unknown)
    - On node tap, cycle: fuzzy -> know -> unknown -> fuzzy
    - Visual indicator: use `border-width` and `border-color` to reflect knowledge state:
      - know: green border (#3fb950)
      - fuzzy: yellow border (#d29922)
      - unknown: red border (#f85149)
    - After cycling, update sidebar list and prompt

    **Feature 3: Category legend in sidebar**
    - On init, populate `#category-legend` with colored dots and labels from `TOPIC_DATA.categories`
    - Same visual as prototype: small colored circle + label text

    **Feature 4: Concept list in sidebar with knowledge badges**
    - Populate `#node-list` with all visible nodes
    - Each item: colored dot (category color) + label + clickable knowledge badge
    - Clicking the badge cycles knowledge (same as tapping the node)
    - Clicking the node name focuses/highlights it in the graph

    **Feature 5: Preset filter buttons**
    - Generate preset buttons from `TOPIC_DATA.presets` into `#preset-buttons`
    - Each button: styled as `.preset-btn`, active state on current preset
    - Filter logic for each preset type:
      - `"all"`: show all nodes
      - `{ tags: [...] }`: show nodes whose tags array contains ANY of the filter tags, OR whose category matches any of the filter tags
      - `{ categories: [...] }`: show nodes whose category matches any in the list
      - `{ nodeIds: [...] }`: show specific node IDs
    - When filtering: hide non-matching nodes and their edges using `cy.batch()` and `node.hide()`/`node.show()`
    - Update sidebar and prompt after filtering

    **Feature 6: Auto-layout button**
    - `#btn-layout` click runs `cy.layout({ name: 'cose', ... }).run()`
    - Use CoSE layout parameters from research:
      ```
      name: 'cose', animate: false, fit: true, padding: 40,
      nodeDimensionsIncludeLabels: true, randomize: true,
      idealEdgeLength: () => 120, nodeRepulsion: () => 8000,
      gravity: 0.25, numIter: 2000
      ```

    **Feature 7: Set all knowledge buttons**
    - `#btn-all-know`: set all VISIBLE nodes to "know"
    - `#btn-all-fuzzy`: set all VISIBLE nodes to "fuzzy"
    - `#btn-all-unknown`: set all VISIBLE nodes to "unknown"
    - Update sidebar and prompt after

    **Feature 8: Reset button**
    - `#btn-reset`: reset all nodes to "fuzzy", show all nodes, re-run layout, reset to "all" preset

    **Feature 9: Hover tooltips with description and category**
    - On node mouseover: create/show a positioned HTML tooltip (NOT Cytoscape's built-in extension)
    - Tooltip content: node label (title), description, category name + knowledge level
    - Position: offset from the node's rendered position, clamped to viewport
    - On mouseout: hide tooltip
    - Implementation: create a tooltip div dynamically or use one from template. Position using `cy.container().getBoundingClientRect()` and `node.renderedPosition()`

    **Feature 10: Dynamic learning prompt generation**
    - On any knowledge change, generate a prompt based on:
      - If promptTemplate exists in topic data, use its fragments
      - Otherwise, use hardcoded defaults matching the prototype
    - Logic (mirror prototype's `updatePrompt()`):
      - All known: show "everything known" message
      - All unknown: show beginner intro prompt
      - Mixed: compose from knowPrefix + known concepts, fuzzyPrefix + fuzzy concepts, unknownPrefix + unknown concepts, edgePrefix + relevant edges, outro
    - Relevant edges: edges where at least one endpoint is not "know"
    - Limit to 8 most relevant edges
    - Update `#prompt-text` textContent

    **Feature 11: Copy prompt button**
    - `#copy-btn` click: copy `#prompt-text` textContent to clipboard via `navigator.clipboard.writeText()`
    - On success: change button text to "Copied!" for 1.5 seconds
    - Fallback for older browsers: try `document.execCommand('copy')` with a temporary textarea

    **Feature 12: Stats display**
    - After any knowledge change, update:
      - `#stat-know`: count of visible nodes with knowledge "know"
      - `#stat-fuzzy`: count of visible nodes with knowledge "fuzzy"
      - `#stat-unknown`: count of visible nodes with knowledge "unknown"

    **Feature 13: Node drag interaction**
    - Cytoscape.js handles this by default. Ensure it is NOT disabled.
    - `autoungrabify: false` (default) allows node dragging.

    **Feature 14: Edge labels shown on hover**
    - Default: edge labels are hidden or low opacity (set `text-opacity: 0` on edges)
    - When a node is hovered: show labels on connected edges
    - Implementation: on node mouseover, select connected edges and apply a class that sets `text-opacity: 1`. On mouseout, remove the class.
    - Cytoscape style for edges with the hover class:
      ```
      selector: 'edge.hover-connected',
      style: { 'text-opacity': 1, 'line-color': '#58a6ff', 'target-arrow-color': '#58a6ff', width: 2 }
      ```

    **Initialization flow:**
    ```
    DOMContentLoaded -> {
      1. Build category color map from TOPIC_DATA
      2. Transform TOPIC_DATA nodes/edges to Cytoscape elements
      3. Initialize Cytoscape with container, elements, style, layout
      4. Render category legend
      5. Render preset buttons
      6. Render sidebar node list
      7. Bind event handlers (node tap, mouseover, mouseout, button clicks)
      8. Update stats and prompt
    }
    ```

    **Cytoscape.js initialization parameters:**
    - container: `document.getElementById('cy')`
    - minZoom: 0.3, maxZoom: 3, wheelSensitivity: 0.3
    - layout: cose with parameters from research
    - style: as described per feature

    **Edge hover highlight approach:**
    When a node is hovered (mouseover), do:
    ```typescript
    cy.on('mouseover', 'node', (evt) => {
      const node = evt.target;
      node.connectedEdges().addClass('hover-connected');
      // Also dim non-connected nodes
      showTooltip(node);
    });
    cy.on('mouseout', 'node', (evt) => {
      const node = evt.target;
      node.connectedEdges().removeClass('hover-connected');
      hideTooltip();
    });
    ```

    **Node knowledge cycling approach:**
    ```typescript
    const KNOWLEDGE_LEVELS = ['fuzzy', 'know', 'unknown'] as const;
    cy.on('tap', 'node', (evt) => {
      const node = evt.target;
      const current = node.data('knowledge');
      const idx = KNOWLEDGE_LEVELS.indexOf(current);
      const next = KNOWLEDGE_LEVELS[(idx + 1) % KNOWLEDGE_LEVELS.length];
      node.data('knowledge', next);
      // Update border color based on knowledge
      updateNodeKnowledgeStyle(node);
      updateSidebar();
      updatePrompt();
      updateStats();
    });
    ```

    For `updateNodeKnowledgeStyle`, apply a class or directly set style based on knowledge level. Preferred: use Cytoscape style selectors with data-based conditions:
    ```
    selector: 'node[knowledge = "know"]',   style: { 'border-color': '#3fb950' }
    selector: 'node[knowledge = "fuzzy"]',  style: { 'border-color': '#d29922' }
    selector: 'node[knowledge = "unknown"]', style: { 'border-color': '#f85149' }
    ```
    This way knowledge styling is automatic via Cytoscape's data-driven stylesheet.

    **Label multi-line handling:**
    The prototype uses `\n` in labels. Cytoscape.js with `text-wrap: 'wrap'` and `text-max-width: '80px'` will handle wrapping. Test whether explicit `\n` characters work. If not, preprocess labels to replace `\n` with spaces and rely on text-max-width wrapping.
  </action>
  <verify>
    ```bash
    # Verify file exists and has substantial content (200+ lines)
    LINES=$(wc -l < src/explorer/template/explorer.ts)
    test "$LINES" -ge 200 && echo "LINES: OK ($LINES)" || echo "LINES: FAIL ($LINES, need 200+)"

    # Verify it imports cytoscape
    grep -q "import cytoscape" src/explorer/template/explorer.ts && echo "IMPORT: OK" || echo "IMPORT: FAIL"

    # Verify it references TOPIC_DATA
    grep -q "TOPIC_DATA" src/explorer/template/explorer.ts && echo "TOPIC_DATA: OK" || echo "TOPIC_DATA: FAIL"

    # Verify it compiles as IIFE (the build format used by build.ts)
    bun build src/explorer/template/explorer.ts --format iife --target browser --outdir /tmp/explorer-check 2>&1 && echo "COMPILE: OK" || echo "COMPILE: FAIL"
    ```
    Every check must print OK. COMPILE: FAIL means TypeScript errors that must be fixed before proceeding.
  </verify>
  <done>
    explorer.ts implements all 14 features: (1) category-colored graph, (2) knowledge cycling on tap, (3) category legend, (4) sidebar concept list with badges, (5) preset filters, (6) auto-layout, (7) set-all-knowledge, (8) reset, (9) hover tooltips, (10) prompt generation, (11) copy prompt, (12) stats display, (13) node drag, (14) edge labels on hover. Compiles as IIFE without errors.
  </done>
</task>

</tasks>

<verification>
```bash
# File exists with substantial content
test -f src/explorer/template/explorer.ts && echo "PASS" || echo "FAIL"
wc -l src/explorer/template/explorer.ts  # 200+ lines

# Compiles as IIFE
bun build src/explorer/template/explorer.ts --format iife --target browser --outdir /tmp/verify-10-02 2>&1

# All 14 features present (check for key patterns)
grep -c "cytoscape(" src/explorer/template/explorer.ts          # Cytoscape init
grep -c "knowledge" src/explorer/template/explorer.ts           # Knowledge cycling
grep -c "tooltip" src/explorer/template/explorer.ts             # Tooltips
grep -c "clipboard" src/explorer/template/explorer.ts           # Copy
grep -c "cose" src/explorer/template/explorer.ts                # Layout
grep -c "preset" src/explorer/template/explorer.ts              # Presets
grep -c "TOPIC_DATA" src/explorer/template/explorer.ts          # Data reference
```
</verification>

<success_criteria>
1. explorer.ts compiles as IIFE format targeting browser without errors
2. All 14 features from the prototype feature checklist are implemented
3. Application reads from TOPIC_DATA global constant (not hardcoded data)
4. Cytoscape.js is imported and initialized with CoSE layout
5. DOM interactions bind to element IDs matching template.html
6. Knowledge cycling updates node style, sidebar, stats, and prompt simultaneously
</success_criteria>

<output>
After completion, create `.planning/phases/10-template-engine-dividend-topic-port/10-02-SUMMARY.md`
</output>
