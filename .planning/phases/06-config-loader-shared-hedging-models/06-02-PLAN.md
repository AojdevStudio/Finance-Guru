---
phase: 06-config-loader-shared-hedging-models
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config/__init__.py
  - src/config/config_loader.py
  - fin-guru-private/hedging/positions.yaml
  - fin-guru-private/hedging/roll-history.yaml
  - fin-guru-private/hedging/budget-tracker.yaml
autonomous: true

must_haves:
  truths:
    - "load_hedge_config() returns a validated HedgeConfig when user-profile.yaml exists with a hedging section"
    - "load_hedge_config() returns HedgeConfig with Pydantic defaults when user-profile.yaml is missing (CFG-03 graceful fallback)"
    - "load_hedge_config(cli_overrides={'monthly_budget': 800}) overrides YAML and default values (CFG-02)"
    - "CLI overrides with None values are ignored (only non-None values override)"
    - "fin-guru-private/hedging/ contains three YAML template files with commented examples"
  artifacts:
    - path: "src/config/config_loader.py"
      provides: "HedgeConfig model and load_hedge_config() function"
      exports: ["HedgeConfig", "load_hedge_config"]
    - path: "src/config/__init__.py"
      provides: "Re-exports from config_loader"
      contains: "load_hedge_config"
    - path: "fin-guru-private/hedging/positions.yaml"
      provides: "Empty positions template with commented example"
      contains: "positions:"
    - path: "fin-guru-private/hedging/roll-history.yaml"
      provides: "Empty roll history template with commented example"
      contains: "rolls:"
    - path: "fin-guru-private/hedging/budget-tracker.yaml"
      provides: "Budget tracker template with initial values"
      contains: "budget:"
  key_links:
    - from: "src/config/config_loader.py"
      to: "fin-guru-private/data/user-profile.yaml"
      via: "yaml.safe_load with path search"
      pattern: "user-profile\\.yaml"
    - from: "src/config/__init__.py"
      to: "src/config/config_loader.py"
      via: "import statement"
      pattern: "from src\\.config\\.config_loader import"
---

<objective>
Build the config bridge (config_loader.py) that all four hedging CLIs share, and scaffold the private hedging data directory.

Purpose: This is the DRY bridge that prevents each CLI from duplicating YAML parsing and override logic. It also creates the data directory that Phase 8 (rolling tracker, hedge sizer) will read from and write to.

Output:
- `src/config/config_loader.py` with HedgeConfig model + load_hedge_config() function
- `src/config/__init__.py` with re-exports
- `fin-guru-private/hedging/` with positions.yaml, roll-history.yaml, budget-tracker.yaml templates
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-config-loader-shared-hedging-models/06-RESEARCH.md

# Pattern references
@src/config.py
@fin-guru/data/user-profile.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config_loader.py with HedgeConfig and load_hedge_config()</name>
  <files>src/config/__init__.py, src/config/config_loader.py</files>
  <action>
**First:** Create `src/config/` directory as a Python package.

**Create `src/config/__init__.py`:**
```python
"""
Finance Guru Config Package

Provides validated configuration loading for hedging and portfolio tools.
"""

from src.config.config_loader import HedgeConfig, load_hedge_config

__all__ = ["HedgeConfig", "load_hedge_config"]
```

**Create `src/config/config_loader.py`:**

Module docstring with ARCHITECTURE NOTE explaining this is the DRY bridge between user-profile.yaml and all hedging CLIs. Explain the priority chain: CLI flags > YAML file > Pydantic defaults.

Imports: `from pathlib import Path`, `import yaml`, `from pydantic import BaseModel, Field, field_validator`

**HedgeConfig model:**
- `monthly_budget: float` -- Field(default=500.0, ge=0.0, description="Monthly hedge budget in dollars")
- `roll_window_days: int` -- Field(default=7, ge=1, le=30, description="Days before expiry to trigger roll suggestion")
- `underlying_weights: dict[str, float]` -- Field(default_factory=lambda: {"QQQ": 1.0}, description="Hedge allocation weights by underlying ticker")
- `max_otm_pct: float` -- Field(default=15.0, ge=1.0, le=50.0, description="Maximum out-of-the-money percentage")
- `min_otm_pct: float` -- Field(default=10.0, ge=0.0, le=50.0, description="Minimum out-of-the-money percentage")
- `target_dte_min: int` -- Field(default=60, ge=7, description="Minimum days to expiry for new positions")
- `target_dte_max: int` -- Field(default=90, ge=14, description="Maximum days to expiry for new positions")
- `sqqq_allocation_pct: float` -- Field(default=0.06, ge=0.0, le=1.0, description="SQQQ allocation as fraction of hedge budget")
- field_validator for `underlying_weights`: all keys must be uppercase, all values must be positive, values should sum to approximately 1.0 (warn via ValueError if sum deviates by >0.05 from 1.0)
- model_validator(mode="after"): target_dte_min must be less than target_dte_max; min_otm_pct must be less than max_otm_pct
- model_config with json_schema_extra example
- Docstring with WHAT/WHY/VALIDATES

**PROJECT_ROOT constant:**
```python
PROJECT_ROOT = Path(__file__).parent.parent.parent
```

**_PROFILE_SEARCH_PATHS list:**
```python
_PROFILE_SEARCH_PATHS = [
    PROJECT_ROOT / "fin-guru-private" / "data" / "user-profile.yaml",
    PROJECT_ROOT / "fin-guru" / "data" / "user-profile.yaml",
]
```

**load_hedge_config() function:**
```python
def load_hedge_config(
    profile_path: Path | None = None,
    cli_overrides: dict | None = None,
) -> HedgeConfig:
```

Implementation steps (follow the research Pattern 2 exactly):
1. Initialize `config_data: dict = {}`
2. Resolve profile_path: if None, search _PROFILE_SEARCH_PATHS for first existing file
3. If profile_path found and file exists:
   - Open and yaml.safe_load
   - Extract the `hedging:` section: `config_data = data.get("hedging", {})` if data is dict
   - Wrap in try/except for any YAML parse error -- log warning, use empty dict
4. Apply CLI overrides: `config_data.update({k: v for k, v in cli_overrides.items() if v is not None})` -- only non-None values
5. Return `HedgeConfig(**config_data)` -- Pydantic fills defaults for any missing keys

This is approximately 40-50 lines of implementation. Do NOT overcomplicate it.

**Important:** The function MUST NOT crash when:
- user-profile.yaml does not exist (returns defaults)
- user-profile.yaml exists but has no `hedging:` section (returns defaults)
- user-profile.yaml is malformed YAML (returns defaults)
- cli_overrides contains None values (they are filtered out)
  </action>
  <verify>
Run: `uv run python -c "from src.config import HedgeConfig, load_hedge_config; print('Import OK')"` -- must succeed.

Test graceful fallback (no YAML file):
```bash
uv run python -c "
from src.config.config_loader import load_hedge_config
config = load_hedge_config(profile_path=None, cli_overrides=None)
print(f'Budget: {config.monthly_budget}')
print(f'Roll window: {config.roll_window_days}')
print(f'Weights: {config.underlying_weights}')
assert config.monthly_budget == 500.0, 'Default budget should be 500'
assert config.roll_window_days == 7, 'Default roll window should be 7'
print('Graceful fallback OK')
"
```

Test CLI overrides:
```bash
uv run python -c "
from src.config.config_loader import load_hedge_config
config = load_hedge_config(cli_overrides={'monthly_budget': 800, 'roll_window_days': None})
assert config.monthly_budget == 800, 'CLI override should take effect'
assert config.roll_window_days == 7, 'None override should be ignored (default used)'
print('CLI override OK')
"
```
  </verify>
  <done>config_loader.py exists with HedgeConfig + load_hedge_config(), importable from src.config, handles YAML-missing gracefully, CLI overrides work with None filtering</done>
</task>

<task type="auto">
  <name>Task 2: Create fin-guru-private/hedging/ directory with three YAML templates</name>
  <files>fin-guru-private/hedging/positions.yaml, fin-guru-private/hedging/roll-history.yaml, fin-guru-private/hedging/budget-tracker.yaml</files>
  <action>
Create the `fin-guru-private/hedging/` directory and three YAML template files.

**positions.yaml:**
```yaml
# Finance Guru - Active Hedge Positions
# Managed by rolling_tracker_cli.py -- do not edit manually
#
# Each entry represents one active hedge position.
# See src/models/hedging_inputs.py HedgePosition for field definitions.

positions: []

# Example entry (uncomment to use):
# positions:
#   - ticker: QQQ
#     hedge_type: put
#     strike: 420.00
#     expiry: "2026-04-17"
#     quantity: 2
#     premium_paid: 8.50
#     entry_date: "2026-02-01"
#     contract_symbol: "QQQ260417P00420000"
```

**roll-history.yaml:**
```yaml
# Finance Guru - Historical Roll Records
# Appended by rolling_tracker_cli.py on each roll
#
# Each entry records closing one position and opening another.

rolls: []

# Example entry (uncomment to use):
# rolls:
#   - date: "2026-02-01"
#     closed_position:
#       contract_symbol: "QQQ260321P00400000"
#       premium_paid: 6.80
#       premium_received: 2.10
#     opened_position:
#       contract_symbol: "QQQ260417P00420000"
#       premium_paid: 8.50
#     net_cost: 6.40
```

**budget-tracker.yaml:**
```yaml
# Finance Guru - Monthly Hedge Budget Tracking
# Updated by hedge_sizer_cli.py on each purchase
#
# Tracks spending against monthly hedge budget.

budget:
  monthly_limit: 500
  current_month: "2026-02"
  spent_this_month: 0.00
  remaining: 500.00

history: []

# Example history entry (uncomment to use):
# history:
#   - month: "2026-01"
#     budgeted: 500.00
#     spent: 485.00
#     positions_opened: 2
```

**Note:** Use 500 as the default budget (matches HedgeConfig default), not 800 (which is the user's specific override value from their profile). Templates should match the Pydantic defaults.

**IMPORTANT:** Verify that `fin-guru-private/` is in `.gitignore`. If not, warn but do NOT modify .gitignore (that's Phase 1 territory). The templates are private data that should not be committed.
  </action>
  <verify>
```bash
ls -la fin-guru-private/hedging/
# Should list: positions.yaml, roll-history.yaml, budget-tracker.yaml

uv run python -c "
import yaml
from pathlib import Path
for f in ['positions.yaml', 'roll-history.yaml', 'budget-tracker.yaml']:
    path = Path('fin-guru-private/hedging') / f
    assert path.exists(), f'{f} missing'
    with open(path) as fh:
        data = yaml.safe_load(fh)
    assert isinstance(data, dict), f'{f} should parse as dict'
    print(f'{f}: OK ({list(data.keys())})')
print('All templates valid')
"
```
  </verify>
  <done>fin-guru-private/hedging/ directory exists with three parseable YAML templates (positions.yaml, roll-history.yaml, budget-tracker.yaml), each with commented examples</done>
</task>

</tasks>

<verification>
Full integration check:

```bash
# 1. Config package imports
uv run python -c "from src.config import HedgeConfig, load_hedge_config; print('Config imports OK')"

# 2. Graceful fallback with non-existent path
uv run python -c "
from pathlib import Path
from src.config.config_loader import load_hedge_config
config = load_hedge_config(profile_path=Path('/nonexistent/path.yaml'))
assert config.monthly_budget == 500.0
print('Non-existent path fallback OK')
"

# 3. YAML templates parseable
uv run python -c "
import yaml
from pathlib import Path
for name in ['positions', 'roll-history', 'budget-tracker']:
    with open(f'fin-guru-private/hedging/{name}.yaml') as f:
        yaml.safe_load(f)
print('All YAML templates parseable')
"

# 4. HedgeConfig validation
uv run python -c "
from pydantic import ValidationError
from src.config.config_loader import HedgeConfig
try:
    HedgeConfig(target_dte_min=100, target_dte_max=50)
    print('ERROR: should have raised ValidationError')
except ValidationError as e:
    print(f'Validation caught: dte_min > dte_max')
print('Validation OK')
"
```
</verification>

<success_criteria>
1. `src/config/config_loader.py` exists with HedgeConfig model and load_hedge_config() function
2. `src/config/__init__.py` re-exports HedgeConfig and load_hedge_config
3. load_hedge_config() returns defaults when YAML is missing (CFG-03)
4. load_hedge_config() merges CLI overrides, filtering None values (CFG-02)
5. fin-guru-private/hedging/ has three YAML template files that parse without errors (HEDG-08)
6. HedgeConfig validates field constraints (dte ordering, otm ordering, weight sum)
</success_criteria>

<output>
After completion, create `.planning/phases/06-config-loader-shared-hedging-models/06-02-SUMMARY.md`
</output>
