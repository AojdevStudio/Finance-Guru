---
phase: 06-config-loader-shared-hedging-models
plan: 03
type: tdd
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - tests/python/test_hedging_inputs.py
  - tests/python/test_total_return_inputs.py
  - tests/python/test_config_loader.py
autonomous: true

must_haves:
  truths:
    - "HedgePosition rejects lowercase ticker, zero strike, missing strike for puts"
    - "RollSuggestion rejects past suggested_expiry"
    - "HedgeSizeRequest rejects empty underlyings list, negative portfolio_value"
    - "TotalReturnInput rejects end_date before start_date"
    - "DividendRecord rejects zero/negative amount"
    - "TickerReturn stores dividends list and data_quality_warnings"
    - "load_hedge_config returns defaults when YAML missing"
    - "load_hedge_config merges CLI overrides over YAML values"
    - "load_hedge_config ignores None CLI overrides"
    - "HedgeConfig rejects dte_min > dte_max and otm_min > otm_max"
    - "All existing tests still pass (zero regressions)"
  artifacts:
    - path: "tests/python/test_hedging_inputs.py"
      provides: "Validation tests for HedgePosition, RollSuggestion, HedgeSizeRequest"
      min_lines: 80
    - path: "tests/python/test_total_return_inputs.py"
      provides: "Validation tests for TotalReturnInput, DividendRecord, TickerReturn"
      min_lines: 60
    - path: "tests/python/test_config_loader.py"
      provides: "Config loading tests including YAML, fallback, and CLI override chain"
      min_lines: 80
  key_links:
    - from: "tests/python/test_hedging_inputs.py"
      to: "src/models/hedging_inputs.py"
      via: "import"
      pattern: "from src\\.models\\.hedging_inputs import"
    - from: "tests/python/test_total_return_inputs.py"
      to: "src/models/total_return_inputs.py"
      via: "import"
      pattern: "from src\\.models\\.total_return_inputs import"
    - from: "tests/python/test_config_loader.py"
      to: "src/config/config_loader.py"
      via: "import + YAML fixtures"
      pattern: "from src\\.config\\.config_loader import"
---

<objective>
Write TDD test suites that validate all six Pydantic models and the config loader override chain.

Purpose: These tests are the acceptance gate for Phase 6. They verify every success criterion: model validation, config loading, graceful fallback, and CLI override behavior. Phase 7-9 executors need confidence that the foundation is solid.

Output:
- `tests/python/test_hedging_inputs.py` -- tests for HedgePosition, RollSuggestion, HedgeSizeRequest
- `tests/python/test_total_return_inputs.py` -- tests for TotalReturnInput, DividendRecord, TickerReturn
- `tests/python/test_config_loader.py` -- tests for HedgeConfig, load_hedge_config() with YAML fixtures
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-config-loader-shared-hedging-models/06-RESEARCH.md

# Plan outputs this depends on
@.planning/phases/06-config-loader-shared-hedging-models/06-01-SUMMARY.md
@.planning/phases/06-config-loader-shared-hedging-models/06-02-SUMMARY.md

# Test pattern reference (read for exact conventions)
@tests/python/test_options_chain.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write test_hedging_inputs.py and test_total_return_inputs.py</name>
  <files>tests/python/test_hedging_inputs.py, tests/python/test_total_return_inputs.py</files>
  <action>
Follow the exact test conventions from `tests/python/test_options_chain.py`: class-based organization, descriptive method names, `pytest.raises(ValidationError)` for rejection tests.

**test_hedging_inputs.py structure:**

```python
"""Tests for hedging Pydantic models (Phase 6, HEDG-02)."""
import pytest
from datetime import date, timedelta
from pydantic import ValidationError
from src.models.hedging_inputs import HedgePosition, RollSuggestion, HedgeSizeRequest
```

**class TestHedgePosition:**
- `test_valid_put_position` -- Create a valid put with all fields, assert ticker, strike, hedge_type
- `test_valid_inverse_etf_position` -- Create SQQQ with hedge_type="inverse_etf", strike=None, expiry=None
- `test_ticker_must_be_uppercase` -- "qqq" should raise ValidationError
- `test_strike_must_be_positive` -- strike=0 or strike=-1 should raise
- `test_put_requires_strike_and_expiry` -- hedge_type="put" with strike=None should raise (model_validator)
- `test_inverse_etf_allows_none_strike` -- hedge_type="inverse_etf" with strike=None should pass
- `test_quantity_must_be_positive` -- quantity=0 should raise
- `test_premium_paid_allows_zero` -- premium_paid=0.0 should pass (free positions are valid)

**class TestRollSuggestion:**
- `test_valid_roll_suggestion` -- Create with valid HedgePosition + future expiry, assert fields
- `test_suggested_expiry_must_be_future` -- Past date should raise
- `test_estimated_cost_must_be_non_negative` -- Negative should raise
- `test_reason_must_not_be_empty` -- Empty string should raise

**class TestHedgeSizeRequest:**
- `test_valid_size_request` -- Create with portfolio_value=200000, underlyings=["QQQ","SPY"], budget=500
- `test_underlyings_must_be_uppercase` -- ["qqq"] should raise
- `test_underlyings_must_not_be_empty` -- Empty list should raise
- `test_portfolio_value_must_be_positive` -- 0 or negative should raise
- `test_target_contracts_optional` -- None is valid, positive int is valid

**test_total_return_inputs.py structure:**

```python
"""Tests for total return Pydantic models (Phase 6, HEDG-03)."""
import pytest
from datetime import date
from pydantic import ValidationError
from src.models.total_return_inputs import TotalReturnInput, DividendRecord, TickerReturn
```

**class TestDividendRecord:**
- `test_valid_dividend` -- Create with ex_date, amount=0.65, shares_at_ex=100
- `test_amount_must_be_positive` -- 0 or negative should raise
- `test_shares_at_ex_must_be_positive` -- 0 should raise
- `test_payment_date_optional` -- None is valid

**class TestTotalReturnInput:**
- `test_valid_input` -- ticker="SCHD", start before end, include_drip=True
- `test_ticker_must_be_uppercase` -- "schd" should raise
- `test_end_date_must_be_after_start_date` -- end <= start should raise (model_validator)
- `test_include_drip_defaults_true` -- Omitting include_drip should default to True
- `test_initial_shares_defaults_one` -- Omitting should default to 1.0

**class TestTickerReturn:**
- `test_valid_return` -- Create with all fields, assert total_return
- `test_dividends_list_can_contain_records` -- Pass list of DividendRecord objects
- `test_data_quality_warnings_defaults_empty` -- Omitting should give empty list
- `test_final_shares_must_be_positive` -- 0 should raise

For each test, use concrete values (not random). Use dates in 2025-2026 range. Keep assertions specific.
  </action>
  <verify>
```bash
uv run pytest tests/python/test_hedging_inputs.py tests/python/test_total_return_inputs.py -v
```
All tests must pass. Count should be approximately 20-24 tests.
  </verify>
  <done>test_hedging_inputs.py has 8+ tests covering all three models' valid/invalid cases. test_total_return_inputs.py has 9+ tests covering all three models. All pass.</done>
</task>

<task type="auto">
  <name>Task 2: Write test_config_loader.py with YAML fixtures and override chain tests</name>
  <files>tests/python/test_config_loader.py</files>
  <action>
This is the CRITICAL test file -- it validates the full config loading chain that all four hedging CLIs depend on.

Follow the test conventions from test_options_chain.py. Use `tmp_path` pytest fixture for YAML file creation.

```python
"""Tests for config loader (Phase 6, CFG-01/02/03)."""
import pytest
import yaml
from pathlib import Path
from pydantic import ValidationError
from src.config.config_loader import HedgeConfig, load_hedge_config
```

**class TestHedgeConfig:**
- `test_defaults` -- `HedgeConfig()` with no args should give monthly_budget=500, roll_window_days=7, weights={"QQQ":1.0}
- `test_custom_values` -- Pass explicit values, all should be set
- `test_dte_min_must_be_less_than_max` -- dte_min=100, dte_max=50 should raise
- `test_otm_min_must_be_less_than_max` -- min_otm_pct=20, max_otm_pct=10 should raise
- `test_underlying_weights_must_be_uppercase` -- {"qqq": 1.0} should raise
- `test_underlying_weights_must_sum_near_one` -- {"QQQ": 0.5, "SPY": 0.3} (sum=0.8) should raise
- `test_sqqq_allocation_range` -- 0.06 valid, 1.5 should raise

**class TestLoadHedgeConfig:**
- `test_returns_defaults_when_no_yaml(tmp_path)` -- Pass nonexistent path, should return defaults
- `test_loads_from_yaml(tmp_path)`:
  - Create a temp user-profile.yaml with `hedging:` section containing `monthly_budget: 800`
  - Call load_hedge_config(profile_path=...)
  - Assert monthly_budget==800 and other fields use defaults
- `test_ignores_missing_hedging_section(tmp_path)`:
  - Create user-profile.yaml WITHOUT `hedging:` section
  - Should return defaults (not crash)
- `test_handles_malformed_yaml(tmp_path)`:
  - Write invalid YAML content to a file
  - Should return defaults (not crash)
- `test_cli_overrides_take_priority(tmp_path)`:
  - Create YAML with monthly_budget=800
  - Call with cli_overrides={"monthly_budget": 1000}
  - Assert monthly_budget==1000 (CLI wins over YAML)
- `test_none_cli_overrides_are_ignored(tmp_path)`:
  - Create YAML with monthly_budget=800
  - Call with cli_overrides={"monthly_budget": None, "roll_window_days": 14}
  - Assert monthly_budget==800 (None ignored, YAML kept)
  - Assert roll_window_days==14 (non-None override applied)
- `test_cli_overrides_with_no_yaml`:
  - No YAML file, cli_overrides={"monthly_budget": 1200}
  - Assert monthly_budget==1200 (CLI override over default)

**YAML fixture helper** (inside the test file or as a fixture):
```python
def _write_profile(tmp_path: Path, hedging_data: dict | None = None) -> Path:
    """Write a user-profile.yaml with optional hedging section."""
    profile = {}
    if hedging_data is not None:
        profile["hedging"] = hedging_data
    path = tmp_path / "user-profile.yaml"
    with open(path, "w") as f:
        yaml.dump(profile, f)
    return path
```

Keep tests focused on the override chain. Do NOT test network/yfinance (Phase 6 is pure models and config).
  </action>
  <verify>
```bash
uv run pytest tests/python/test_config_loader.py -v
```
All tests must pass. Count should be approximately 12-15 tests.

Then run full test suite to confirm zero regressions:
```bash
uv run pytest --tb=short -q
```
Must show same pass count as before (365+ existing) plus the new tests.
  </verify>
  <done>test_config_loader.py has 12+ tests covering: HedgeConfig validation, YAML loading, graceful fallback, and the full CLI override chain. All pass with zero regressions to existing tests.</done>
</task>

</tasks>

<verification>
Run full Phase 6 acceptance gate:

```bash
# 1. Run all Phase 6 tests
uv run pytest tests/python/test_hedging_inputs.py tests/python/test_total_return_inputs.py tests/python/test_config_loader.py -v

# 2. Run full test suite (zero regressions)
uv run pytest --tb=short -q

# 3. Verify test count
uv run pytest tests/python/test_hedging_inputs.py tests/python/test_total_return_inputs.py tests/python/test_config_loader.py --co -q | tail -1
# Should show 30+ tests collected
```
</verification>

<success_criteria>
1. test_hedging_inputs.py covers valid construction + all validation rejection cases for HedgePosition, RollSuggestion, HedgeSizeRequest
2. test_total_return_inputs.py covers valid construction + all validation rejection cases for TotalReturnInput, DividendRecord, TickerReturn
3. test_config_loader.py covers: defaults, YAML loading, missing YAML, malformed YAML, CLI overrides, None filtering
4. All Phase 6 tests pass
5. Full test suite passes with zero regressions (365+ existing tests still green)
</success_criteria>

<output>
After completion, create `.planning/phases/06-config-loader-shared-hedging-models/06-03-SUMMARY.md`
</output>
