---
phase: 02-setup-automation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - setup.sh
autonomous: true

must_haves:
  truths:
    - "Running ./setup.sh on a machine with all prerequisites completes without errors and creates the fin-guru-private/ directory structure"
    - "Running ./setup.sh creates fin-guru-private/ with analysis/, strategies/, guides/, and tickets/ subdirectories"
    - "Running ./setup.sh a second time detects existing files/directories and only reports them as existing (no overwrites, no errors)"
    - "Running ./setup.sh after deleting one subdirectory recreates only the missing subdirectory and verifies the rest"
    - "Running ./setup.sh writes .setup-progress after each completed step and resumes from last completed step on re-run"
    - "Running ./setup.sh prompts 'Overwrite? [y/N]' (default no) when existing config files are found"
    - "When existing directories are found, setup.sh verifies expected subdirectories exist and creates any missing ones"
    - "The setup flow is: dependency check (check-all-then-fail) -> directory creation -> config scaffolding -> python deps -> next steps message"
    - "When dependencies are missing, setup.sh shows exact install commands, offers prompted auto-install, and exits without modifying the system if user declines all"
  artifacts:
    - path: "setup.sh"
      provides: "Complete setup orchestration with check-all-then-fail deps, prompted auto-install, idempotent directory creation, .setup-progress tracking, overwrite prompts, and config scaffolding"
      contains: "check_all_deps"
    - path: "fin-guru-private/"
      provides: "Private data directory structure (created by setup.sh at runtime)"
    - path: ".setup-progress"
      provides: "Step completion tracker for idempotent re-runs (created by setup.sh at runtime)"
  key_links:
    - from: "setup.sh (main flow)"
      to: "setup.sh (check_all_deps)"
      via: "check-all-then-fail: check_all_deps || exit 1 before any directory creation or file scaffolding"
      pattern: "check_all_deps.*\\|\\|.*exit"
    - from: "setup.sh (directory creation)"
      to: "fin-guru-private/"
      via: "create_dir calls with idempotent mkdir -p and subdirectory verification"
      pattern: "create_dir.*fin-guru-private"
    - from: "setup.sh (step completion)"
      to: ".setup-progress"
      via: "mark_step_complete writes step name after each phase completes"
      pattern: "mark_step_complete"
---

<objective>
Restructure setup.sh orchestration flow with check-all-then-fail dependency behavior, streamline directory creation with structure verification, add .setup-progress tracking for resumable re-runs, add overwrite prompts for existing config files, and produce a clean end-to-end first-time setup experience.

Purpose: Plan 01 added the dependency checker with OS detection and prompted auto-install. This plan wires it into a clean orchestration flow: deps check first (exit if fail), then directory creation with structure verification, then config scaffolding with overwrite prompts, then clear next-steps guidance. The existing setup.sh has 11 steps with mixed concerns -- this plan restructures into a logical progression that a new user can follow, with .setup-progress tracking for idempotent re-runs.

Output: A fully rewritten setup.sh that satisfies all Phase 2 success criteria: works on fresh machine, fails clearly on missing deps with auto-install prompts, creates correct directory structure, verifies structure of existing directories, tracks progress for resumable re-runs, prompts before overwriting existing config files, and is idempotent on re-run.

**Scope boundary (SC4 clarification):** setup.sh idempotency operates at the file/directory level -- it detects existing files and skips them (with overwrite prompt for config files). Field-level diffing (e.g., "only prompt for missing YAML fields") is Phase 3 onboarding wizard scope (ONBD-06). setup.sh does NOT inspect file contents or merge partial configs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-setup-automation/02-CONTEXT.md
@.planning/phases/02-setup-automation/02-01-SUMMARY.md
@setup.sh
@.gitignore
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract functions, add progress tracking, and restructure setup.sh flow</name>
  <files>setup.sh</files>
  <action>
Restructure setup.sh into a clean function-based orchestration flow. The dependency checker from Plan 01 stays intact. This task extracts functions, adds .setup-progress tracking, and wires the main flow.

**New setup.sh flow** (5 phases, not 11 steps):

```
Phase 1: Parse CLI arguments (--check-deps-only, --help)
Phase 2: Check dependencies (check-all-then-fail -- exit 1 if any missing after prompted install)
Phase 3: Create directory structure (fin-guru-private/ and subdirs, with structure verification)
Phase 4: Scaffold configuration files (user-profile template, .env, README -- with overwrite prompts)
Phase 5: Install Python dependencies (uv sync)
Done: Print next steps with summary
```

**Specific changes:**

1. **Add .setup-progress tracking functions:**

   Create `is_step_complete()` function:
   - Arguments: step name (string, e.g., "deps_checked", "dirs_created", "config_scaffolded", "python_deps_installed")
   - Check if step name exists in `.setup-progress` file
   - Return 0 if found (step already completed), 1 if not
   ```bash
   is_step_complete() {
     [ -f ".setup-progress" ] && grep -q "^$1$" ".setup-progress"
   }
   ```

   Create `mark_step_complete()` function:
   - Arguments: step name
   - Append step name to `.setup-progress` file (one per line)
   ```bash
   mark_step_complete() {
     echo "$1" >> ".setup-progress"
   }
   ```

   At script start (after argument parsing), check if .setup-progress exists. If it does, print: "Resuming from last completed step..." and show which steps are already done.

2. **Wire check-all-then-fail dependency check in main flow.** After CLI argument parsing and the --check-deps-only early exit, add this in the main flow:
   ```bash
   # Phase 2: Check dependencies (check-all-then-fail)
   if is_step_complete "deps_checked"; then
     echo -e "${YELLOW}Dependencies already verified (skipping)${NC}"
   else
     check_all_deps || exit 1
     mark_step_complete "deps_checked"
   fi
   ```
   This ensures that if check_all_deps returns non-zero, setup exits immediately BEFORE any directory creation or file scaffolding occurs. On re-run, deps check is skipped if already passed.

3. **Extract `create_directory_structure()` function** from old Steps 1-3:
   - Directories to create:
     - fin-guru-private/
     - fin-guru-private/fin-guru/
     - fin-guru-private/fin-guru/strategies/
     - fin-guru-private/fin-guru/strategies/active/
     - fin-guru-private/fin-guru/strategies/archive/
     - fin-guru-private/fin-guru/strategies/risk-management/
     - fin-guru-private/fin-guru/tickets/
     - fin-guru-private/fin-guru/analysis/
     - fin-guru-private/fin-guru/analysis/reports/
     - fin-guru-private/fin-guru/reports/
     - fin-guru-private/fin-guru/archive/
     - fin-guru-private/guides/
     - fin-guru/data/ (for user profile)
   - Keep the existing create_dir() helper that handles idempotency (checks if dir exists, prints "Exists:" or "Created:").
   - **Add structure verification:** When the top-level directory (fin-guru-private/) already exists, verify that ALL expected subdirectories exist. For each missing subdirectory, create it and report. For each existing subdirectory, report "Verified:". This means even on re-run, if someone deleted a subdirectory, it gets recreated.
   - After completing directory creation: `mark_step_complete "dirs_created"`
   - On re-run when "dirs_created" is already in progress file: still run the function (to verify structure), but print "Verifying directory structure..." instead of "Creating directory structure..."

4. **Extract `scaffold_config_files()` function** from old Steps 4-6:
   - Create user-profile.yaml template in fin-guru/data/ (with overwrite prompt if exists)
   - Create fin-guru-private/README.md (with overwrite prompt if exists)
   - Copy .env from .env.example (with overwrite prompt if exists)
   - **Overwrite prompt behavior:** For each file, if it already exists:
     - Print: `"$filename already exists. Overwrite? [y/N] "`
     - Read user input (default to "N" if empty or non-interactive)
     - If user says yes: overwrite the file, print "Overwritten: $filename"
     - If user says no: skip, print "Kept existing: $filename"
   - After completing config scaffolding: `mark_step_complete "config_scaffolded"`
   - On re-run when "config_scaffolded" is in progress file: skip entirely with message "Configuration files already scaffolded (skipping)"

5. **Extract `install_python_deps()` function**:
   - Simply runs `uv sync` (uv already verified in Phase 2)
   - No need for the old `if command -v uv` guard since deps check already passed
   - After completing: `mark_step_complete "python_deps_installed"`
   - On re-run when "python_deps_installed" is in progress file: skip with message "Python dependencies already installed (skipping). Run 'uv sync' manually to update."

6. **Remove scattered dependency checks** from old Steps 7, 10, 11. All dep checking is now consolidated in check_all_deps (from Plan 01). Remove the old `if command -v uv` and `if command -v bun` blocks that were embedded mid-flow.

**Important constraints:**
- Preserve `set -e` at the top
- Preserve color variables (with the tty/dumb detection from Plan 01)
- .setup-progress file should be gitignored (verify it's covered by existing .gitignore patterns or add it)
  </action>
  <verify>
```bash
# 1. Syntax check
bash -n setup.sh

# 2. Verify function definitions exist
grep -q "create_directory_structure" setup.sh
grep -q "scaffold_config_files" setup.sh
grep -q "install_python_deps" setup.sh

# 3. Verify check-all-then-fail wiring exists
grep -q "check_all_deps.*||.*exit" setup.sh

# 4. Verify old scattered dep checks are removed
! grep -q "if command -v uv" setup.sh || echo "WARNING: old uv check still present"

# 5. Verify .setup-progress tracking functions exist
grep -q "is_step_complete" setup.sh
grep -q "mark_step_complete" setup.sh

# 6. Verify overwrite prompt logic exists
grep -q "Overwrite" setup.sh

# 7. Verify structure verification exists
grep -q "Verif" setup.sh
```
  </verify>
  <done>
  - setup.sh has three new functions: create_directory_structure(), scaffold_config_files(), install_python_deps()
  - Main flow explicitly calls `check_all_deps || exit 1` before any directory/file creation
  - Old scattered dependency checks (if command -v uv/bun mid-flow) are removed
  - .setup-progress tracking: is_step_complete() and mark_step_complete() functions exist
  - Re-runs skip completed steps with "skipping" messages and resume from last completed step
  - Overwrite prompts added for existing config files (default to no)
  - Directory structure verification checks for expected subdirectories when parent exists
  - `bash -n setup.sh` passes with no syntax errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove old Steps 8-11, add completion summary, and wire progress tracking</name>
  <files>setup.sh</files>
  <action>
Remove deferred functionality, add completion summary with recap, and ensure .setup-progress is properly wired.

1. **Remove old Steps 8-11 entirely:**
   - Step 8 (symlink commands to ~/.claude/) -- Remove. Creates global side effects. Onboarding wizard (Phase 3) handles this.
   - Step 9 (symlink skills to ~/.claude/) -- Remove. Same reason.
   - Step 10 (run onboarding wizard) -- Remove. Onboarding is Phase 3. setup.sh should NOT call `bun scripts/onboarding/index.ts`.
   - Step 11 (MCP Launchpad check) -- Remove. MCP setup is optional and belongs in onboarding, not setup.

2. **Add completion summary** at the end of setup. This should recap what was done during this run:
   - Print a "Setup Summary" section showing:
     - Dependencies: verified (or "verified and installed X via prompt")
     - Directories: created N new, verified M existing
     - Config files: created N new, skipped M existing
     - Python deps: installed (or skipped)
   - Then print "Next steps":
     - Step 1: Run the onboarding wizard (Phase 3 will create this)
     - Step 2: Configure MCP servers (optional, links to docs)
     - Step 3: Start Finance Guru with /finance-orchestrator
     - Keep the note about yfinance working without API keys

3. **Verify no references to removed steps remain:**
   - No references to `symlink`, `mcpl`, `bun run scripts/onboarding` in setup.sh

4. **Ensure .setup-progress is gitignored:**
   - Check if .gitignore already covers it (e.g., via a pattern like `.setup-*` or explicit `.setup-progress`)
   - If not covered: add `.setup-progress` to .gitignore

5. **Wire the complete main flow** (after all functions are defined):
   ```bash
   # Main flow
   detect_os

   # Phase 1: Parse arguments (already done above)

   # Phase 2: Check dependencies
   if is_step_complete "deps_checked"; then
     echo -e "${YELLOW}Dependencies already verified (skipping)${NC}"
   else
     check_all_deps || exit 1
     mark_step_complete "deps_checked"
   fi

   # Phase 3: Create directory structure
   create_directory_structure
   # Note: always runs for structure verification, but marks complete

   # Phase 4: Scaffold configuration files
   if is_step_complete "config_scaffolded"; then
     echo -e "${YELLOW}Configuration files already scaffolded (skipping)${NC}"
   else
     scaffold_config_files
     mark_step_complete "config_scaffolded"
   fi

   # Phase 5: Install Python dependencies
   if is_step_complete "python_deps_installed"; then
     echo -e "${YELLOW}Python dependencies already installed (skipping). Run 'uv sync' manually to update.${NC}"
   else
     install_python_deps
     mark_step_complete "python_deps_installed"
   fi

   # Done: Print summary and next steps
   print_summary
   ```
  </action>
  <verify>
```bash
# 1. Verify old steps are gone
! grep -q "symlink" setup.sh && echo "OK: symlinks removed"
! grep -q "mcpl\|mcp.launchpad\|MCP Launchpad" setup.sh && echo "OK: MCP launchpad removed"
! grep -q "bun run scripts/onboarding" setup.sh && echo "OK: onboarding call removed"

# 2. Verify completion summary exists
grep -q "Next steps\|Next Steps\|next steps" setup.sh && echo "OK: next steps message exists"
grep -q "Summary\|summary" setup.sh && echo "OK: summary section exists"

# 3. Verify .setup-progress is gitignored
grep -q "setup-progress" .gitignore && echo "OK: .setup-progress is gitignored"

# 4. Syntax check still passes
bash -n setup.sh
```
  </verify>
  <done>
  - Steps 8-11 (symlinks, onboarding wizard, MCP Launchpad) are completely removed
  - A completion summary recaps what was done (deps, dirs, configs, python deps)
  - A clear "Next steps" message is printed at end of setup
  - .setup-progress is gitignored
  - No auto-install without user consent, no onboarding execution, no MCP configuration in setup.sh
  - `bash -n setup.sh` still passes
  </done>
</task>

<task type="auto">
  <name>Task 3: End-to-end verification against Phase 2 success criteria</name>
  <files>setup.sh</files>
  <action>
Run the four Phase 2 success criteria as explicit verification tests. This task is PURE VERIFICATION -- run each test, report pass/fail, and stop. Do not fix issues discovered here (that is Task 1 and Task 2's responsibility).

**Success Criterion 1:** "Running `./setup.sh` on a machine with prerequisites installed completes without errors and creates the fin-guru-private/ directory structure"
```bash
# Clean slate test: remove fin-guru-private, run setup, verify structure
rm -rf /tmp/setup-test && mkdir /tmp/setup-test
cp setup.sh /tmp/setup-test/
cp .env.example /tmp/setup-test/
mkdir -p /tmp/setup-test/fin-guru
cd /tmp/setup-test
bash setup.sh
test -d fin-guru-private/fin-guru/analysis && echo "PASS: SC1" || echo "FAIL: SC1"
cd -
rm -rf /tmp/setup-test
```

**Success Criterion 2:** "Running `./setup.sh` on a machine missing Python 3.12+, uv, or Bun shows the exact install command for each missing dependency and exits with a non-zero code"
```bash
# Test with manipulated PATH to simulate missing deps
output=$(env PATH="/usr/bin:/bin" bash setup.sh --check-deps-only 2>&1)
exit_code=$?
echo "$output" | tail -20
if [ "$exit_code" -ne 0 ]; then
  echo "PASS: SC2 (exit code: $exit_code)"
else
  echo "FAIL: SC2 (exit code was 0, expected non-zero)"
fi
# Verify all three deps are reported (check-all-then-fail)
echo "$output" | grep -c "MISSING\|not found" | xargs -I{} echo "Missing deps reported: {}"
```

**Success Criterion 3:** "Running `./setup.sh --check-deps-only` performs a dry-run dependency check without creating files or starting onboarding"
```bash
tmpdir=$(mktemp -d)
cp setup.sh "$tmpdir/"
cd "$tmpdir"
bash setup.sh --check-deps-only
count=$(ls -1 | wc -l | tr -d ' ')
cd -
rm -rf "$tmpdir"
if [ "$count" = "1" ]; then
  echo "PASS: SC3 (only setup.sh in dir, count=$count)"
else
  echo "FAIL: SC3 (expected 1 file, found $count)"
fi
```

**Success Criterion 4:** "Running `./setup.sh` a second time detects existing configuration and skips existing files/directories (idempotent)"

Verify at file/directory level:
```bash
# Run setup.sh twice in a temp environment
rm -rf /tmp/setup-idem && mkdir /tmp/setup-idem
cp setup.sh /tmp/setup-idem/
cp .env.example /tmp/setup-idem/
mkdir -p /tmp/setup-idem/fin-guru
cd /tmp/setup-idem

# First run
bash setup.sh

# Second run -- capture output
output=$(bash setup.sh 2>&1)
echo "$output"

# Verify idempotent markers exist
if echo "$output" | grep -qE "Exists:|skipping|already|Verified:"; then
  echo "PASS: SC4 (idempotent re-run shows skip/exists messages)"
else
  echo "FAIL: SC4 (no idempotent markers found in output)"
fi

# Verify .setup-progress tracking works
if [ -f ".setup-progress" ]; then
  echo "PASS: SC4b (.setup-progress file exists)"
  cat .setup-progress
else
  echo "FAIL: SC4b (.setup-progress file not found)"
fi

cd -
rm -rf /tmp/setup-idem
```

**Additional verification -- structure verification on partial delete:**
```bash
rm -rf /tmp/setup-struct && mkdir /tmp/setup-struct
cp setup.sh /tmp/setup-struct/
cp .env.example /tmp/setup-struct/
mkdir -p /tmp/setup-struct/fin-guru
cd /tmp/setup-struct

# First run
bash setup.sh

# Delete one subdirectory
rm -rf fin-guru-private/fin-guru/tickets

# Re-run -- should recreate only the missing subdir
output=$(bash setup.sh 2>&1)
if test -d fin-guru-private/fin-guru/tickets; then
  echo "PASS: SC4c (missing subdirectory recreated)"
else
  echo "FAIL: SC4c (missing subdirectory NOT recreated)"
fi

cd -
rm -rf /tmp/setup-struct
```

Report all results. Do NOT attempt to fix failures -- this is a verification-only task.
  </action>
  <verify>
All Phase 2 success criteria verification results reported:
1. SC1: Fresh setup creates fin-guru-private/ structure -- PASS or FAIL
2. SC2: Missing deps shows install commands and exits non-zero, all deps reported -- PASS or FAIL
3. SC3: --check-deps-only creates no files -- PASS or FAIL
4. SC4: Second run is idempotent (file/directory level, .setup-progress tracking, structure verification) -- PASS or FAIL
  </verify>
  <done>
  - All four Phase 2 success criteria from ROADMAP.md are verified (pass/fail reported)
  - Verification is pure reporting -- no fixes attempted in this task
  - SC4 verified at file/directory level with .setup-progress tracking
  - Structure verification verified (deleted subdir recreated on re-run)
  </done>
</task>

</tasks>

<verification>
Phase-level verification for Plan 02:

1. **ONBD-05 coverage:** setup.sh orchestrates the full first-time setup flow: dependency check (with prompted auto-install) -> directory creation (with structure verification) -> config scaffold (with overwrite prompts) -> dependency install -> next steps summary.

2. **ONBD-06 coverage:** Re-running setup.sh detects existing directories (via create_dir) and existing files (via overwrite prompts with default=no). .setup-progress tracks completed steps for resumable re-runs. **Scope boundary:** Field-level diffing within config files (e.g., "only prompt for missing YAML fields") is Phase 3 onboarding wizard scope, not setup.sh scope. setup.sh idempotency = skip existing files/directories, verify directory structure, prompt before overwriting config files.

3. **SETUP-01 coverage:** Dependency checker verifies Python 3.12+, uv, and Bun. Shows OS-specific install commands on failure. Checks ALL deps before failing (check-all-then-fail). Offers prompted auto-install when deps missing.

4. **SETUP-02 coverage:** setup.sh creates fin-guru-private/ with all required subdirectories (strategies, analysis, tickets, guides, etc.). Verifies structure of existing directories and recreates missing subdirectories.

5. **SETUP-03 coverage:** --check-deps-only flag runs dependency check only, exits without creating files or prompting for install.

6. **CONTEXT.md compliance:**
   - .setup-progress tracking for resumable re-runs (Idempotency decision)
   - Overwrite prompts for existing config files with default=no (Idempotency decision)
   - Structure verification for existing directories (Idempotency decision)
   - Step-by-step verbose output with color (Output & messaging decision)
   - Full summary at the end (Output & messaging decision)
   - Prompted auto-install (Platform & prerequisites decision, overrides M1-X07)
</verification>

<success_criteria>
- `bash setup.sh` completes end-to-end without errors on a machine with all prerequisites
- fin-guru-private/ directory structure matches expected layout
- Second run of setup.sh is fully idempotent at file/directory level (no errors, no overwrites without consent)
- .setup-progress file tracks completed steps and enables resumable re-runs
- Existing config files trigger overwrite prompts (default=no)
- Existing directories are verified for expected subdirectory structure
- All four Phase 2 success criteria from ROADMAP.md are verified
- No symlink creation, no onboarding wizard execution, no MCP configuration (deferred to Phase 3)
- Completion summary recaps what was done during the run
</success_criteria>

<output>
After completion, create `.planning/phases/02-setup-automation/02-02-SUMMARY.md`
</output>
