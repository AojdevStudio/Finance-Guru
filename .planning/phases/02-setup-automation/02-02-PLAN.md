---
phase: 02-setup-automation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - setup.sh
autonomous: true

must_haves:
  truths:
    - "Running ./setup.sh on a machine with all prerequisites completes without errors and creates the fin-guru-private/ directory structure"
    - "Running ./setup.sh creates fin-guru-private/ with analysis/, strategies/, guides/, and hedging/ subdirectories"
    - "Running ./setup.sh a second time detects existing files/directories and only reports them as existing (no overwrites, no errors)"
    - "Running ./setup.sh after deleting one subdirectory recreates only the missing subdirectory"
    - "The setup flow is: dependency check (fail-fast) -> directory creation -> config scaffolding -> next steps message"
    - "When dependencies are missing, setup.sh shows exact install commands and exits without modifying the system"
  artifacts:
    - path: "setup.sh"
      provides: "Complete setup orchestration with fail-fast deps, idempotent directory creation, and config scaffolding"
      contains: "check_all_deps"
    - path: "fin-guru-private/"
      provides: "Private data directory structure (created by setup.sh at runtime)"
  key_links:
    - from: "setup.sh (main flow)"
      to: "setup.sh (check_all_deps)"
      via: "fail-fast: check_all_deps || exit 1 before any directory creation or file scaffolding"
      pattern: "check_all_deps.*\\|\\|.*exit"
    - from: "setup.sh (directory creation)"
      to: "fin-guru-private/"
      via: "create_dir calls with idempotent mkdir -p"
      pattern: "create_dir.*fin-guru-private"
---

<objective>
Restructure setup.sh orchestration flow to fail-fast on dependency failures, streamline directory creation, ensure full idempotency, and produce a clean end-to-end first-time setup experience.

Purpose: Plan 01 added the dependency checker. This plan wires it into a clean orchestration flow: deps check first (exit if fail), then directory creation, then config scaffolding, then clear next-steps guidance. The existing setup.sh has 11 steps with mixed concerns and no fail-fast -- this plan restructures into a logical progression that a new user can follow.

Output: A fully rewritten setup.sh that satisfies all Phase 2 success criteria: works on fresh machine, fails clearly on missing deps, creates correct directory structure, and is idempotent on re-run.

**Scope boundary (SC4 clarification):** setup.sh idempotency operates at the file/directory level -- it detects existing files and skips them. Field-level diffing (e.g., "only prompt for missing YAML fields") is Phase 3 onboarding wizard scope (ONBD-06). setup.sh does NOT inspect file contents or merge partial configs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-setup-automation/02-01-SUMMARY.md
@setup.sh
@.gitignore
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract functions and restructure setup.sh flow</name>
  <files>setup.sh</files>
  <action>
Restructure setup.sh into a clean function-based orchestration flow. The dependency checker from Plan 01 stays intact. This task extracts functions and wires the main flow.

**New setup.sh flow** (5 phases, not 11 steps):

```
Phase 1: Parse CLI arguments (--check-deps-only, --help)
Phase 2: Check dependencies (fail-fast -- exit 1 if any missing)
Phase 3: Create directory structure (fin-guru-private/ and subdirs)
Phase 4: Scaffold configuration files (user-profile template, .env, README)
Phase 5: Install Python dependencies (uv sync)
Done: Print next steps
```

**Specific changes:**

1. **Wire fail-fast dependency check in main flow.** After CLI argument parsing and the --check-deps-only early exit, add this explicit line in the main flow:
   ```bash
   # Phase 2: Check dependencies (fail-fast)
   check_all_deps || exit 1
   ```
   This ensures that if check_all_deps returns non-zero, setup exits immediately BEFORE any directory creation or file scaffolding occurs.

2. **Extract `create_directory_structure()` function** from old Steps 1-3:
   - fin-guru-private/
   - fin-guru-private/fin-guru/
   - fin-guru-private/fin-guru/strategies/
   - fin-guru-private/fin-guru/strategies/active/
   - fin-guru-private/fin-guru/strategies/archive/
   - fin-guru-private/fin-guru/strategies/risk-management/
   - fin-guru-private/fin-guru/tickets/
   - fin-guru-private/fin-guru/analysis/
   - fin-guru-private/fin-guru/analysis/reports/
   - fin-guru-private/fin-guru/reports/
   - fin-guru-private/fin-guru/archive/
   - fin-guru-private/guides/
   - fin-guru/data/ (for user profile)
   - Keep the existing create_dir() helper that handles idempotency (checks if dir exists).

3. **Extract `scaffold_config_files()` function** from old Steps 4-6:
   - Create user-profile.yaml template in fin-guru/data/ (only if not exists)
   - Create fin-guru-private/README.md (only if not exists)
   - Copy .env from .env.example (only if not exists)
   - Each file creation checks existence first = idempotent

4. **Extract `install_python_deps()` function**:
   - Simply runs `uv sync` (uv already verified in Phase 2)
   - No need for the old `if command -v uv` guard since deps check already passed

5. **Remove scattered dependency checks** from old Steps 7, 10, 11. All dep checking is now consolidated in check_all_deps (from Plan 01). Remove the old `if command -v uv` and `if command -v bun` blocks that were embedded mid-flow.

**Important constraints:**
- Do NOT auto-install anything (anti-feature M1-X07). Only show install commands.
- Preserve `set -e` at the top
- Preserve existing color variables
  </action>
  <verify>
```bash
# 1. Syntax check
bash -n setup.sh

# 2. Verify function definitions exist
grep -q "create_directory_structure" setup.sh
grep -q "scaffold_config_files" setup.sh
grep -q "install_python_deps" setup.sh

# 3. Verify fail-fast wiring exists
grep -q "check_all_deps.*||.*exit" setup.sh

# 4. Verify old scattered dep checks are removed
! grep -q "if command -v uv" setup.sh || echo "WARNING: old uv check still present"
```
  </verify>
  <done>
  - setup.sh has three new functions: create_directory_structure(), scaffold_config_files(), install_python_deps()
  - Main flow explicitly calls `check_all_deps || exit 1` before any directory/file creation
  - Old scattered dependency checks (if command -v uv/bun mid-flow) are removed
  - `bash -n setup.sh` passes with no syntax errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove old Steps 8-11 and add next-steps message</name>
  <files>setup.sh</files>
  <action>
Remove deferred functionality and replace with a clean completion message.

1. **Remove old Steps 8-11 entirely:**
   - Step 8 (symlink commands to ~/.claude/) -- Remove. Creates global side effects. Onboarding wizard (Phase 3) handles this.
   - Step 9 (symlink skills to ~/.claude/) -- Remove. Same reason.
   - Step 10 (run onboarding wizard) -- Remove. Onboarding is Phase 3. setup.sh should NOT call `bun scripts/onboarding/index.ts`.
   - Step 11 (MCP Launchpad check) -- Remove. MCP setup is optional and belongs in onboarding, not setup.

2. **Add "Next steps" completion message** at the end:
   - Step 1: Run the onboarding wizard (Phase 3 will create this)
   - Step 2: Configure MCP servers (optional, links to docs)
   - Step 3: Start Finance Guru with /finance-orchestrator
   - Keep the note about yfinance working without API keys

3. **Verify no references to removed steps remain:**
   - No references to `symlink`, `mcpl`, `bun run scripts/onboarding` in setup.sh

**Anti-features that must NOT be present (out of scope):**
- Auto-install of any dependency (M1-X07)
- Running onboarding wizard (Phase 3)
- MCP server configuration (Phase 3)
- Symlink creation to ~/.claude/ (Phase 3)
- Field-level diffing of config files (Phase 3 onboarding wizard scope)
  </action>
  <verify>
```bash
# 1. Verify old steps are gone
! grep -q "symlink" setup.sh && echo "OK: symlinks removed"
! grep -q "mcpl\|mcp.launchpad\|MCP Launchpad" setup.sh && echo "OK: MCP launchpad removed"
! grep -q "bun run scripts/onboarding" setup.sh && echo "OK: onboarding call removed"

# 2. Verify next-steps message exists
grep -q "Next steps\|Next Steps\|next steps" setup.sh && echo "OK: next steps message exists"

# 3. Syntax check still passes
bash -n setup.sh
```
  </verify>
  <done>
  - Steps 8-11 (symlinks, onboarding wizard, MCP Launchpad) are completely removed
  - A clear "Next steps" completion message is printed at end of setup
  - No auto-install, no onboarding execution, no MCP configuration in setup.sh
  - `bash -n setup.sh` still passes
  </done>
</task>

<task type="auto">
  <name>Task 3: End-to-end verification against Phase 2 success criteria</name>
  <files>setup.sh</files>
  <action>
Run the four Phase 2 success criteria as explicit tests:

**Success Criterion 1:** "Running `./setup.sh` on a machine with prerequisites installed completes without errors and creates the fin-guru-private/ directory structure"
```bash
# Clean slate test: remove fin-guru-private, run setup, verify structure
rm -rf /tmp/setup-test && mkdir /tmp/setup-test
cp setup.sh /tmp/setup-test/
cp .env.example /tmp/setup-test/
mkdir -p /tmp/setup-test/fin-guru
cd /tmp/setup-test
bash setup.sh
test -d fin-guru-private/fin-guru/analysis && echo "PASS: SC1"
cd -
rm -rf /tmp/setup-test
```

**Success Criterion 2:** "Running `./setup.sh` on a machine missing Python 3.12+, uv, or Bun shows the exact install command for each missing dependency and exits with a non-zero code"
```bash
# Test with manipulated PATH to simulate missing deps
(export PATH="/usr/bin:/bin"; bash setup.sh 2>&1; echo "Exit: $?") | tail -20
# Should show install commands and "Exit: 1"
```

**Success Criterion 3:** "Running `./setup.sh --check-deps-only` performs a dry-run dependency check without creating files or starting onboarding"
```bash
tmpdir=$(mktemp -d)
cp setup.sh "$tmpdir/"
cd "$tmpdir"
bash setup.sh --check-deps-only
count=$(ls -1 | wc -l)
cd -
rm -rf "$tmpdir"
# count should be 1 (only setup.sh)
echo "Files after --check-deps-only: $count (expected: 1)"
```

**Success Criterion 4:** "Running `./setup.sh` a second time detects existing configuration and skips existing files/directories (idempotent)"

**SC4 scope note:** Idempotency at setup.sh level means file/directory detection and skip. "Only prompts for missing fields" refers to the Phase 3 onboarding wizard, not setup.sh. Verify:
```bash
# Run setup.sh twice, second run should show "Exists:" messages
bash setup.sh > /dev/null 2>&1
bash setup.sh 2>&1 | grep "Exists:" | head -5
echo "PASS: SC4 (idempotent re-run shows Exists messages for existing files/dirs)"
```

If any criterion fails, fix setup.sh and re-test until all four pass.

Note: Success Criterion 2 test may vary by machine -- PATH manipulation approach depends on where python3/uv/bun are installed. The key verification is that the error message includes install commands (grep for "curl" or "python.org" in output).
  </action>
  <verify>
All four Phase 2 success criteria produce PASS:
1. SC1: Fresh setup creates fin-guru-private/ structure
2. SC2: Missing deps shows install commands and exits non-zero
3. SC3: --check-deps-only creates no files
4. SC4: Second run is idempotent (file/directory level -- skips existing, no overwrites)
  </verify>
  <done>
  - All four Phase 2 success criteria from ROADMAP.md are verified
  - setup.sh handles both fresh-machine and repeat-run scenarios correctly
  - No regressions in existing fin-guru-private/ structure
  - SC4 verified at file/directory level (field-level diffing is Phase 3 scope)
  </done>
</task>

</tasks>

<verification>
Phase-level verification for Plan 02:

1. **ONBD-05 coverage:** setup.sh orchestrates the full first-time setup flow: dependency check -> directory creation -> config scaffold -> dependency install -> next steps.

2. **ONBD-06 coverage:** Re-running setup.sh detects existing directories (via create_dir) and existing files (via `test -f` guards). No data is overwritten. "Exists:" messages confirm detection. **Scope boundary:** Field-level diffing within config files (e.g., "only prompt for missing YAML fields") is Phase 3 onboarding wizard scope, not setup.sh scope. setup.sh idempotency = skip existing files/directories entirely.

3. **SETUP-01 coverage:** Dependency checker verifies Python 3.12+, uv, and Bun. Shows exact install commands on failure. Fails fast with non-zero exit code.

4. **SETUP-02 coverage:** setup.sh creates fin-guru-private/ with all required subdirectories (strategies, analysis, tickets, guides, etc.).

5. **SETUP-03 coverage:** --check-deps-only flag runs dependency check only, exits without creating files.

6. **Anti-feature M1-X07:** When dependencies are missing, setup.sh shows exact install commands and exits without modifying the system. No auto-installation occurs.
</verification>

<success_criteria>
- `bash setup.sh` completes end-to-end without errors on a machine with all prerequisites
- fin-guru-private/ directory structure matches expected layout
- Second run of setup.sh is fully idempotent at file/directory level (no errors, no overwrites)
- All four Phase 2 success criteria from ROADMAP.md are verified
- No symlink creation, no onboarding wizard execution, no MCP configuration (deferred to Phase 3)
</success_criteria>

<output>
After completion, create `.planning/phases/02-setup-automation/02-02-SUMMARY.md`
</output>
