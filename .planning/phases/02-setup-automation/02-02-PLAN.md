---
phase: 02-setup-automation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - setup.sh
  - .gitignore
  - tests/integration/test_setup_onboarding_integration.sh
autonomous: true

must_haves:
  truths:
    - "Running ./setup.sh creates fin-guru-private/ with all expected subdirectories (fin-guru/strategies/active, fin-guru/strategies/archive, fin-guru/strategies/risk-management, fin-guru/tickets, fin-guru/analysis, fin-guru/analysis/reports, fin-guru/reports, fin-guru/archive, guides)"
    - "Running ./setup.sh creates fin-guru/data/user-profile.yaml from template, .env from .env.example, and fin-guru-private/README.md"
    - "Running ./setup.sh a second time skips completed steps, shows 'Resuming from step N/M', and only prompts for missing config files"
    - "Running ./setup.sh a second time with existing user-profile.yaml prompts 'Overwrite? [y/N]' and defaults to keeping the existing file"
    - "A full summary prints at the end showing what was installed, created, skipped, and the next command to run"
    - ".setup-progress is NOT committed to git (gitignored)"
  artifacts:
    - path: "setup.sh"
      provides: "Complete setup orchestration with directory creation, config scaffolding, progress tracking, Python dep installation, and summary"
      contains: "create_directory_structure"
    - path: ".gitignore"
      provides: ".setup-progress exclusion"
      contains: ".setup-progress"
    - path: "tests/integration/test_setup_onboarding_integration.sh"
      provides: "Updated integration test covering new setup.sh behavior"
      contains: "check-deps-only"
  key_links:
    - from: "setup.sh:create_directory_structure"
      to: "setup.sh:create_dir"
      via: "mkdir -p with idempotent reporting"
      pattern: "create_dir"
    - from: "setup.sh:scaffold_config_files"
      to: "setup.sh:scaffold_file"
      via: "overwrite prompt with tty check"
      pattern: "scaffold_file"
    - from: "setup.sh:main"
      to: "setup.sh:.setup-progress"
      via: "is_step_complete and mark_step_complete"
      pattern: "setup-progress"
---

<objective>
Complete setup.sh by adding directory creation, config file scaffolding with overwrite prompts, .setup-progress tracking for resumable re-runs, Python dependency installation via uv sync, and a full summary at the end. Also update .gitignore to exclude .setup-progress and rewrite the integration test to match new behavior.

Purpose: This plan makes setup.sh a complete, idempotent setup experience. A new user clones the repo, runs ./setup.sh, and gets a working environment. On re-run, completed steps are skipped and only missing items are addressed.

Output: A fully functional setup.sh, updated .gitignore, and an updated integration test that validates the new behavior.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-setup-automation/02-CONTEXT.md
@.planning/phases/02-setup-automation/02-RESEARCH.md
@.planning/phases/02-setup-automation/02-01-SUMMARY.md
@setup.sh
@tests/integration/test_setup_onboarding_integration.sh
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add progress tracking, directory creation, config scaffolding, Python deps, and summary to setup.sh</name>
  <files>setup.sh, .gitignore</files>
  <action>
Edit setup.sh to replace the placeholder section from Plan 01 with the full implementation. Add the following functions and main flow steps:

**1. Progress tracking functions** (from RESEARCH.md Pattern 4 + Example 3):

Add these functions after the existing utility functions:

```bash
PROGRESS_FILE="$PROJECT_ROOT/.setup-progress"

is_step_complete() {
  [ -f "$PROGRESS_FILE" ] && grep -q "^$1$" "$PROGRESS_FILE"
}

mark_step_complete() {
  echo "$1" >> "$PROGRESS_FILE"
}
```

Add a `show_progress()` function that:
- If .setup-progress exists, counts completed steps vs total (5 steps: deps_checked, dirs_created, dirs_verified, config_scaffolded, python_deps_installed)
- Prints "Resuming setup... (N/5 steps completed)" in yellow
- Lists each completed step with a green [done] prefix

**2. create_dir() function:**

Keep the existing pattern but use `printf` instead of `echo -e`:
```bash
create_dir() {
  if [ ! -d "$1" ]; then
    mkdir -p "$1"
    printf "  ${GREEN}Created:${NC} %s\n" "$1"
  else
    printf "  ${YELLOW}Already exists:${NC} %s\n" "$1"
  fi
}
```

**3. create_directory_structure() function:**

Creates the fin-guru-private/ tree. Use the directory list from the existing setup.sh (lines 36-47 in current script) PLUS these additional directories from SETUP-02:
- `$PROJECT_ROOT/fin-guru-private`
- `$PROJECT_ROOT/fin-guru-private/fin-guru`
- `$PROJECT_ROOT/fin-guru-private/fin-guru/strategies`
- `$PROJECT_ROOT/fin-guru-private/fin-guru/strategies/active`
- `$PROJECT_ROOT/fin-guru-private/fin-guru/strategies/archive`
- `$PROJECT_ROOT/fin-guru-private/fin-guru/strategies/risk-management`
- `$PROJECT_ROOT/fin-guru-private/fin-guru/tickets`
- `$PROJECT_ROOT/fin-guru-private/fin-guru/analysis`
- `$PROJECT_ROOT/fin-guru-private/fin-guru/analysis/reports`
- `$PROJECT_ROOT/fin-guru-private/fin-guru/reports`
- `$PROJECT_ROOT/fin-guru-private/fin-guru/archive`
- `$PROJECT_ROOT/fin-guru-private/guides`
- `$PROJECT_ROOT/fin-guru/data`

Also create the notebooks directories from the existing script:
- `$PROJECT_ROOT/notebooks`
- `$PROJECT_ROOT/notebooks/updates`
- `$PROJECT_ROOT/notebooks/retirement-accounts`
- `$PROJECT_ROOT/notebooks/transactions`
- `$PROJECT_ROOT/notebooks/tools-needed`
- `$PROJECT_ROOT/notebooks/tools-needed/done`

Also create the hedging directories from SETUP-02:
- `$PROJECT_ROOT/fin-guru-private/hedging`

**4. verify_directory_structure() function:**

Called on re-run when dirs_created is already in .setup-progress. Checks that all expected subdirectories of fin-guru-private/ exist. If any are missing, recreates them. Changes messaging from "Creating..." to "Verifying..." per CONTEXT.md decision.

**5. scaffold_file() function** (from RESEARCH.md Pattern 5):

Takes target path, description, and content (via heredoc or function):
- If file exists AND stdin is a tty (`[ -t 0 ]`): prompt "filename already exists. Overwrite? [y/N]", default to no
- If file exists AND NOT a tty: skip with "Kept existing: filename (non-interactive)"
- If file does not exist: create it
- Always report what happened (Created / Kept existing / Overwritten)

**6. scaffold_config_files() function:**

Uses scaffold_file() for each config file:

a. **user-profile.yaml** at `$PROJECT_ROOT/fin-guru/data/user-profile.yaml`:
   - Use the YAML template content from the existing setup.sh (lines 76-127)
   - This is the template that onboarding (Phase 3) will fill in

b. **.env** from .env.example:
   - If .env.example exists, copy it to .env using scaffold_file()
   - If .env.example does not exist, skip with warning

c. **fin-guru-private/README.md**:
   - Use the README content from the existing setup.sh (lines 140-174)

**7. install_python_deps() function:**

- Verify `pyproject.toml` exists at PROJECT_ROOT (RESEARCH.md Pitfall 7)
- If missing: warn and skip
- Run `cd "$PROJECT_ROOT" && uv sync`
- Report success or failure
- NOTE: uv was already verified present in the dependency check phase, so this should succeed

**8. print_summary() function:**

Print a full summary at the end with:
- Section border (=== lines)
- "Setup Complete!" header in green
- **Created** section: list directories and files created in this run
- **Skipped** section: list items that already existed
- **Installed** section: list Python deps installed (or "already up to date")
- **Next steps:**
  1. "Edit .env to add your API keys (optional)"
  2. "Run the onboarding wizard: uv run python scripts/onboarding/main.py" (placeholder -- Phase 3 will create this)
  3. "After onboarding: /finance-orchestrator"

**9. Update main flow:**

Replace the placeholder comments with the actual execution flow:

```bash
# Show resume status if re-running
show_progress

# Step 1: Check dependencies (already done above)
# mark_step_complete is called after check_all_deps succeeds

# Step 2: Create directory structure
if is_step_complete "dirs_created"; then
  header "Verifying directory structure..."
  verify_directory_structure
  mark_step_complete "dirs_verified"
else
  header "Creating directory structure..."
  create_directory_structure
  mark_step_complete "dirs_created"
fi

# Step 3: Scaffold config files
if is_step_complete "config_scaffolded"; then
  header "Verifying config files..."
  # Still run scaffold_config_files -- it handles overwrite prompts internally
  scaffold_config_files
else
  header "Scaffolding config files..."
  scaffold_config_files
  mark_step_complete "config_scaffolded"
fi

# Step 4: Install Python dependencies
if is_step_complete "python_deps_installed"; then
  header "Python dependencies..."
  printf "  ${GREEN}[done]${NC} Python dependencies already installed\n"
else
  header "Installing Python dependencies..."
  install_python_deps
  mark_step_complete "python_deps_installed"
fi

# Step 5: Summary
print_summary
```

**10. Update .gitignore:**

Add `.setup-progress` to the .gitignore file. Place it in the "Family Office" section near the other setup-related entries (near `.onboarding-state.json`):

```
# Setup progress tracking (user-specific)
.setup-progress
```

RESEARCH.md Pitfall 5 confirmed `.setup-progress` is NOT currently gitignored. This must be fixed.

**Important implementation notes:**
- Use `printf` for all colored output, never `echo -e`
- Always use `$PROJECT_ROOT` prefix for paths, never relative paths
- The `scaffold_file` overwrite prompt MUST check `[ -t 0 ]` per RESEARCH.md Pitfall 4
- mark_step_complete "deps_checked" should be called right after check_all_deps succeeds in the main flow
- Do NOT include Steps 8-11 from the old script (symlinks, onboarding, MCP Launchpad)
  </action>
  <verify>
```bash
# 1. Script syntax check
bash -n setup.sh && echo "SYNTAX OK"

# 2. Full run creates expected directories
./setup.sh
test -d fin-guru-private/fin-guru/strategies/active && echo "DIR OK"
test -d fin-guru-private/hedging && echo "HEDGING DIR OK"
test -d fin-guru/data && echo "DATA DIR OK"

# 3. Config files created
test -f fin-guru/data/user-profile.yaml && echo "PROFILE OK"
test -f fin-guru-private/README.md && echo "README OK"

# 4. .setup-progress created and populated
test -f .setup-progress && echo "PROGRESS FILE OK"
grep -q "deps_checked" .setup-progress && echo "DEPS TRACKED"
grep -q "dirs_created" .setup-progress && echo "DIRS TRACKED"
grep -q "config_scaffolded" .setup-progress && echo "CONFIG TRACKED"
grep -q "python_deps_installed" .setup-progress && echo "PYTHON TRACKED"

# 5. .gitignore updated
grep -q ".setup-progress" .gitignore && echo "GITIGNORE OK"

# 6. git check-ignore confirms .setup-progress is ignored
git check-ignore .setup-progress && echo "GIT IGNORE CONFIRMED"

# 7. Summary printed
./setup.sh 2>&1 | grep -q "Setup Complete" && echo "SUMMARY OK"
```
  </verify>
  <done>
- setup.sh creates all fin-guru-private/ subdirectories (strategies/active, strategies/archive, strategies/risk-management, tickets, analysis, analysis/reports, reports, archive, guides, hedging)
- setup.sh creates fin-guru/data/ and notebooks/ directories
- setup.sh scaffolds user-profile.yaml, .env, and README.md with overwrite prompts
- .setup-progress tracks completed steps
- .gitignore includes .setup-progress
- Summary prints at the end with created/skipped/installed/next-steps sections
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement idempotent re-run behavior and verify SC4</name>
  <files>setup.sh</files>
  <action>
Test and fix the idempotent re-run behavior to satisfy Success Criterion 4:

1. **First run:** Run `./setup.sh` from scratch (delete .setup-progress first if it exists). Capture output. Verify:
   - All directories created
   - All config files created
   - .setup-progress contains all step names
   - Summary shows items as "Created"

2. **Second run:** Run `./setup.sh` again without deleting anything. Verify:
   - Output shows "Resuming setup... (N/5 steps completed)"
   - Each step shows [done] or "Already exists" instead of "Created"
   - No errors or failures
   - .setup-progress is unchanged (no duplicate entries)
   - Existing config files are NOT overwritten (default to "N" when not interactive)

3. **Partial re-run:** Delete .setup-progress, but leave directories in place. Run `./setup.sh`. Verify:
   - Dependency check runs (no cached result)
   - Directory creation says "Already exists" for each dir (mkdir -p is idempotent)
   - Config scaffolding prompts for overwrite (or skips in non-interactive)
   - .setup-progress is rebuilt with all steps

4. **Verify structure validation:** Delete one subdirectory (e.g., `fin-guru-private/hedging`), run `./setup.sh` on re-run. Verify:
   - Missing subdirectory is recreated
   - Other directories show "Already exists"

Fix any issues discovered during testing. The key behaviors are:
- .setup-progress prevents re-executing completed steps
- verify_directory_structure catches and fixes missing subdirs
- scaffold_file respects existing files (no silent overwrite)
- No duplicate entries in .setup-progress
  </action>
  <verify>
```bash
# Clean state
rm -f .setup-progress

# First run
./setup.sh 2>&1 | tee /tmp/setup-first.log
grep -c "Created:" /tmp/setup-first.log

# Second run (idempotent)
./setup.sh 2>&1 | tee /tmp/setup-second.log
grep -q "Resuming" /tmp/setup-second.log && echo "RESUME OK"
grep -c "Already exists:" /tmp/setup-second.log

# Verify no duplicate progress entries
sort .setup-progress | uniq -d | wc -l | xargs test 0 -eq && echo "NO DUPLICATES"

# Partial re-run
rm -rf fin-guru-private/hedging
./setup.sh 2>&1 | grep "hedging" | grep -q "Created" && echo "RECREATED OK"
```
  </verify>
  <done>
- Second run shows "Resuming" with step count
- Completed steps are skipped on re-run
- Existing config files are not overwritten without consent
- Missing directories are detected and recreated on re-run
- .setup-progress has no duplicate entries
  </done>
</task>

<task type="auto">
  <name>Task 3: Update integration test for new setup.sh behavior</name>
  <files>tests/integration/test_setup_onboarding_integration.sh</files>
  <action>
Rewrite `tests/integration/test_setup_onboarding_integration.sh` to test the new setup.sh behavior. The existing test (196 lines) tests the old script with onboarding integration, mock bun, and .onboarding-state.json -- all of which are no longer relevant.

**New test structure:**

1. **Setup:** Create a temp directory, copy setup.sh, pyproject.toml, .env.example, and fin-guru/data/ skeleton into it. Set PATH to include the real uv/python3/bun locations.

2. **Test 1 - First run creates everything:**
   - Run `bash setup.sh` in the temp dir
   - Assert: fin-guru-private/ and all subdirectories exist
   - Assert: fin-guru/data/user-profile.yaml created
   - Assert: .env created (if .env.example was present)
   - Assert: fin-guru-private/README.md created
   - Assert: .setup-progress exists with all step names

3. **Test 2 - --check-deps-only does not modify filesystem:**
   - Create a fresh temp dir with just setup.sh
   - Run `bash setup.sh --check-deps-only`
   - Assert: exit code 0 (assuming deps are installed)
   - Assert: no fin-guru-private/ directory created
   - Assert: no .setup-progress created
   - Assert: no .env created

4. **Test 3 - Idempotent re-run:**
   - In the same temp dir from Test 1, run `bash setup.sh` again
   - Assert: exit code 0
   - Assert: output contains "Resuming" or "Already exists"
   - Assert: no errors in output
   - Assert: directory structure still intact
   - Assert: .setup-progress has no duplicate entries

5. **Test 4 - Missing directory detected on re-run:**
   - Delete fin-guru-private/hedging from Test 1 temp dir
   - Run `bash setup.sh` again
   - Assert: hedging/ directory recreated
   - Assert: other directories unchanged

6. **Test 5 - --help flag:**
   - Run `bash setup.sh --help`
   - Assert: exit code 0
   - Assert: output contains "Usage:"

7. **Cleanup:** Remove temp directory (via trap EXIT).

**Important:** The test must NOT reference:
- .onboarding-state.json (removed)
- Mock bun onboarding CLI (removed)
- Symlinks to ~/.claude/ (removed)
- MCP Launchpad (removed)

The test SHOULD be non-interactive (pipe stdin from /dev/null or set stdin to non-tty) to avoid hanging on prompts.
  </action>
  <verify>
```bash
# Run the integration test
bash tests/integration/test_setup_onboarding_integration.sh
echo "Exit code: $?"
```
  </verify>
  <done>
- Integration test passes with exit code 0
- Tests cover: first run, --check-deps-only, idempotent re-run, missing dir detection, --help flag
- No references to old onboarding/symlink/MCP behavior
- Test cleans up its temp directory
  </done>
</task>

</tasks>

<verification>
Phase 2 success criteria coverage:
- SC1: ./setup.sh completes without errors and creates fin-guru-private/ directory structure (Task 1 + Task 2)
- SC2: Covered by Plan 01 (dependency checker) -- this plan ensures deps pass before proceeding
- SC3: Covered by Plan 01 (--check-deps-only flag) -- Test 2 in integration test validates no filesystem changes
- SC4: ./setup.sh second run detects existing configuration and only prompts for missing fields (Task 2 + Task 3)

Requirements covered:
- ONBD-05: setup.sh orchestrates full first-time setup (dependency checks, directory creation, config generation)
- ONBD-06: setup.sh is idempotent -- re-run updates missing fields only
- SETUP-01: Dependency checker verifies prerequisites (covered by Plan 01, consumed by this plan)
- SETUP-02: setup.sh creates fin-guru-private/ directory structure with hedging/, strategies/, analysis/
- SETUP-03: --check-deps-only flag for dry-run (covered by Plan 01, tested by this plan)

Research findings incorporated:
- [x] .setup-progress added to .gitignore (Pitfall 5)
- [x] scaffold_file checks [ -t 0 ] before prompting (Pitfall 4)
- [x] uv sync runs from PROJECT_ROOT with pyproject.toml check (Pitfall 7)
- [x] Progress file uses line-per-step format (not JSON)
- [x] No references to removed steps (symlinks, onboarding, MCP Launchpad)
</verification>

<success_criteria>
- ./setup.sh creates all fin-guru-private/ subdirectories including hedging/
- ./setup.sh scaffolds user-profile.yaml, .env, and README.md
- Second run resumes from progress file and skips completed steps
- Existing config files prompt before overwrite, default to keep
- .setup-progress is gitignored
- Integration test passes covering all new behaviors
- Full summary prints with created/skipped/installed/next-steps
</success_criteria>

<output>
After completion, create `.planning/phases/02-setup-automation/02-02-SUMMARY.md`
</output>
