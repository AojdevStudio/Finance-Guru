---
phase: 02-setup-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - setup.sh
autonomous: true

must_haves:
  truths:
    - "Running ./setup.sh on a machine missing Python 3.12+ shows the exact OS-specific install command and exits non-zero"
    - "Running ./setup.sh on a machine missing uv shows the exact install command and exits non-zero"
    - "Running ./setup.sh on a machine missing Bun shows the exact install command and exits non-zero"
    - "Running ./setup.sh checks ALL three dependencies before exiting -- it does not stop at the first missing one"
    - "When a dependency is missing, setup.sh prompts 'Install via X? [y/N]' and runs the install if user agrees"
    - "Running ./setup.sh --check-deps-only checks all dependencies and exits without creating files or directories"
    - "Running ./setup.sh --check-deps-only when all deps are present exits with code 0"
    - "Running ./setup.sh --check-deps-only when any dep is missing exits with non-zero code"
    - "Running ./setup.sh --check-deps-only shows checklist format: [checkmark] Python 3.12.1 (>= 3.12 required)"
    - "Color output is disabled when terminal does not support it (not a tty or TERM=dumb)"
  artifacts:
    - path: "setup.sh"
      provides: "Dependency checker with check-all-then-fail behavior, prompted auto-install, OS detection, and --check-deps-only flag"
      contains: "check_all_deps"
  key_links:
    - from: "setup.sh (CLI arg parser)"
      to: "setup.sh (check_all_deps function)"
      via: "--check-deps-only flag triggers check_all_deps and exits"
      pattern: "check-deps-only"
    - from: "setup.sh (detect_os function)"
      to: "setup.sh (check_dependency function)"
      via: "OS detection determines install commands shown per dependency"
      pattern: "detect_os"
---

<objective>
Rewrite the dependency checking subsystem in setup.sh to validate all prerequisites (Python 3.12+, uv, Bun) with check-all-then-fail behavior, show OS-specific install commands on failure with prompted auto-install, and support a --check-deps-only flag for dry-run verification.

Purpose: Without proper dependency checking, new users hit cryptic errors when prerequisites are missing. The current setup.sh checks uv/bun late in the flow and continues on failure instead of stopping. This plan makes dependency validation the FIRST thing that happens, checks ALL dependencies before reporting, and offers to install missing ones with user consent.

Output: A rewritten setup.sh with a robust check_all_deps() function at the top, CLI argument parsing for --check-deps-only, OS detection for platform-specific install commands, terminal color detection, and check-all-then-fail behavior that blocks the rest of setup when any prerequisite is missing.

**Behavioral clarification:** "check-all-then-fail" means: check ALL three dependencies, accumulate results, show a complete report, THEN exit non-zero if any are missing. This is fail-fast at the SETUP FLOW level (deps fail -> don't proceed to directory creation), but NOT at the INDIVIDUAL DEPENDENCY level (don't stop checking after the first missing dep).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-setup-automation/02-CONTEXT.md
@setup.sh
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build dependency checker function with OS detection, color fallback, and CLI argument parser</name>
  <files>setup.sh</files>
  <action>
Rewrite setup.sh with these changes (keep existing directory creation and config scaffolding logic intact for Plan 02 to restructure):

1. **Add terminal color support detection** immediately after `set -e`:
   - Check if stdout is a tty: `test -t 1`
   - Check if TERM is "dumb": `[ "$TERM" = "dumb" ]`
   - If either condition fails: set ALL color variables to empty string
   - If terminal supports color: define GREEN, YELLOW, BLUE, RED, NC as ANSI escape codes
   ```bash
   if [ -t 1 ] && [ "$TERM" != "dumb" ]; then
     GREEN='\033[0;32m'
     YELLOW='\033[1;33m'
     BLUE='\033[0;34m'
     RED='\033[0;31m'
     NC='\033[0m'
   else
     GREEN=''
     YELLOW=''
     BLUE=''
     RED=''
     NC=''
   fi
   ```

2. **Create `detect_os()` function** at the top (after color definitions):
   - Use `uname -s` to detect kernel (Darwin, Linux)
   - Check for WSL: `grep -qi microsoft /proc/version 2>/dev/null`
   - Set a global variable `DETECTED_OS` to one of: "macos", "linux", "wsl"
   - Default to "linux" if unknown
   ```bash
   detect_os() {
     local kernel
     kernel=$(uname -s)
     case "$kernel" in
       Darwin) DETECTED_OS="macos" ;;
       Linux)
         if grep -qi microsoft /proc/version 2>/dev/null; then
           DETECTED_OS="wsl"
         else
           DETECTED_OS="linux"
         fi
         ;;
       *) DETECTED_OS="linux" ;;
     esac
   }
   ```

3. **Create `get_install_command()` helper function** that returns the OS-specific install command for a dependency:
   - Arguments: dependency name ("python", "uv", "bun")
   - For Python:
     - macos: `brew install python@3.12`
     - linux/wsl: `sudo apt update && sudo apt install python3.12`
     - Fallback: `Visit https://www.python.org/downloads/ or use pyenv: pyenv install 3.12`
   - For uv:
     - All platforms: `curl -LsSf https://astral.sh/uv/install.sh | sh`
   - For Bun:
     - All platforms: `curl -fsSL https://bun.sh/install | bash`

4. **Create `prompt_install()` function** that prompts user to install a missing dependency:
   - Arguments: dependency display name, install command
   - Prompt: `"$dep_name not found. Install via $install_method? [y/N] "`
   - Read user input (default to "N" if empty or non-interactive)
   - If user agrees (y/Y): run the install command, then re-check if dependency is now available
   - If user declines: return 1 (still missing)
   - If install succeeds and dep now found: return 0 (resolved)
   - If install fails: print error, return 1
   - Note: In --check-deps-only mode, do NOT prompt -- just report missing

5. **Add CLI argument parser** (after color and OS detection):
   - Parse `--check-deps-only` flag
   - Parse `--help` / `-h` flag
   - Store in `CHECK_DEPS_ONLY` variable (default: false)
   - Show usage help when `--help` is passed (include --check-deps-only description)

6. **Create `check_dependency()` helper function** that checks a single dependency:
   - Arguments: command name, display name, minimum version (optional)
   - Uses `command -v` to check existence
   - For Python: parse `python3 --version` output and compare major.minor >= 3.12
   - For uv: check existence, capture version via `uv --version`
   - For Bun: check existence, capture version via `bun --version`
   - On success: print checklist line with checkmark and version found
     Format: `[checkmark] Python 3.12.1 (>= 3.12 required)` or `[checkmark] uv 0.1.6`
   - On failure: print checklist line with X mark
     Format: `[X] Python (not found)` or `[X] Python 3.10.1 (>= 3.12 required, found 3.10.1)`
   - Returns 0 on success, 1 on failure
   - Use unicode characters for checkmark/X: checkmark = "\xe2\x9c\x93" or plain "[OK]" / "[MISSING]" when no color support. Simplest approach: use printf with escape or just the characters directly.

7. **Create `check_all_deps()` function** that checks ALL three prerequisites before failing:
   - **CRITICAL: check-all-then-fail behavior.** Do NOT return early after the first missing dependency. Check all three, accumulate results, then report.
   - Initialize `missing_count=0` and `missing_deps=()` array
   - Call check_dependency for each (Python 3.12+, uv, Bun)
   - For each missing dep: increment missing_count, add to missing_deps array
   - After ALL checks complete:
     - If missing_count == 0: print success message with all found versions, return 0
     - If missing_count > 0 AND NOT in --check-deps-only mode: for each missing dep, call prompt_install to offer auto-install
     - After install prompts: re-count remaining missing deps
     - If still missing after prompts: print summary of what's still missing with install commands, return 1
     - If all resolved via prompts: print success, return 0
   - In --check-deps-only mode: never prompt, just report and return 0 or 1

8. **Wire --check-deps-only** into the script flow:
   - After argument parsing, call detect_os
   - Then call check_all_deps
   - If `CHECK_DEPS_ONLY=true`: exit with the return code from check_all_deps (0 if all pass, 1 if any missing)
   - If `CHECK_DEPS_ONLY=false`: if check_all_deps fails, exit 1; if passes, continue to rest of setup

9. **Important constraints:**
   - Keep `set -e` at the top
   - Use the existing banner style but update step numbering (dependency check becomes Step 1)
   - The existing Steps 1-11 content should remain in the file but will be restructured by Plan 02. For now, just insert the dependency checker BEFORE the existing steps and make the existing `uv sync` step a no-op if deps already validated.

10. **Python version comparison logic** (bash-native, no external deps):
   ```bash
   python_version=$(python3 --version 2>&1 | grep -oE '[0-9]+\.[0-9]+' | head -1)
   python_major=$(echo "$python_version" | cut -d. -f1)
   python_minor=$(echo "$python_version" | cut -d. -f2)
   if [ "$python_major" -ge 3 ] && [ "$python_minor" -ge 12 ]; then
     # OK
   fi
   ```
   Note: Use `grep -oE` instead of `grep -oP` for macOS compatibility (no PCRE on default macOS grep). Pattern: `[0-9]+\.[0-9]+`
  </action>
  <verify>
Run these verification commands:
```bash
# 1. Check --help works
bash setup.sh --help

# 2. Check --check-deps-only exits cleanly when deps are present
bash setup.sh --check-deps-only
echo "Exit code: $?"

# 3. Verify no files were created by --check-deps-only
# (compare directory listing before and after)

# 4. Check the script is valid bash
bash -n setup.sh

# 5. Verify check_all_deps function exists
grep -q "check_all_deps" setup.sh

# 6. Verify --check-deps-only flag is parsed
grep -q "check-deps-only" setup.sh

# 7. Verify Python version check exists
grep -q "python3 --version" setup.sh

# 8. Verify install commands are present for all three deps
grep -q "astral.sh/uv/install" setup.sh
grep -q "bun.sh/install" setup.sh
grep -q "python.org/downloads" setup.sh

# 9. Verify detect_os function exists
grep -q "detect_os" setup.sh

# 10. Verify color fallback detection exists
grep -q 'TERM.*dumb\|test -t 1' setup.sh

# 11. Verify checklist format characters exist (checkmark or OK marker)
grep -qE 'OK|MISSING|✓|✗' setup.sh

# 12. Verify prompt_install function exists
grep -q "prompt_install" setup.sh

# 13. Verify OS-specific install commands (brew for macOS, apt for Linux)
grep -q "brew install" setup.sh
grep -q "apt.*install" setup.sh
```
  </verify>
  <done>
  - `bash setup.sh --check-deps-only` exits 0 when Python 3.12+, uv, and Bun are all installed
  - `bash setup.sh --check-deps-only` shows checklist format: [OK] Python 3.12.x (>= 3.12 required) for each dep
  - `bash setup.sh --check-deps-only` would exit 1 and show install commands when any dependency is missing
  - When a dep is missing in normal mode (not --check-deps-only), setup.sh prompts "Install via X? [y/N]"
  - `bash setup.sh --help` shows usage information including --check-deps-only flag description
  - `bash -n setup.sh` passes (no syntax errors)
  - detect_os() function detects macOS, Linux, and WSL
  - Install commands are OS-specific (brew on macOS, apt on Linux/WSL)
  - Color output is disabled when not a tty or TERM=dumb
  - The dependency check runs BEFORE any directory creation or file modification
  - check_all_deps checks ALL three deps before failing (check-all-then-fail)
  </done>
</task>

<task type="auto">
  <name>Task 2: Test dependency checker with simulated missing dependencies</name>
  <files>setup.sh</files>
  <action>
Create a verification script (temporary, run inline in bash) that tests the dependency checker under controlled conditions:

1. **Test --check-deps-only with all deps present:**
   ```bash
   bash setup.sh --check-deps-only
   ```
   Expected: exit 0, prints checklist with checkmarks/OK and found versions for each dep

2. **Test --check-deps-only with simulated missing Python:**
   ```bash
   # Use PATH manipulation to hide python3
   env PATH="/usr/bin:/bin" bash setup.sh --check-deps-only 2>&1
   ```
   Expected: exit 1, shows Python with X/MISSING mark, shows OS-specific install command, does NOT prompt for install (--check-deps-only suppresses prompts)

3. **Test --check-deps-only with simulated missing uv:**
   ```bash
   # Use a subshell with modified PATH that excludes uv
   (export PATH=$(echo "$PATH" | tr ':' '\n' | grep -v cargo | grep -v uv | tr '\n' ':'); bash setup.sh --check-deps-only 2>&1)
   ```
   Expected: exit 1, shows uv with MISSING mark, shows install command

4. **Test --check-deps-only does NOT create files:**
   ```bash
   # Create a temp directory, copy setup.sh there, run it
   tmpdir=$(mktemp -d)
   cp setup.sh "$tmpdir/"
   cd "$tmpdir"
   bash setup.sh --check-deps-only
   # Verify no new files/dirs were created (only setup.sh should exist)
   ls -la "$tmpdir"
   rm -rf "$tmpdir"
   ```

5. **Test --help flag:**
   ```bash
   bash setup.sh --help
   ```
   Expected: shows usage with description of --check-deps-only

6. **Test checklist output format:**
   ```bash
   bash setup.sh --check-deps-only 2>&1 | head -20
   ```
   Expected: output contains lines like `[OK] Python 3.x.x (>= 3.12 required)` or similar checklist format

7. **Test color disabled in non-tty context:**
   ```bash
   bash setup.sh --check-deps-only 2>&1 | cat
   ```
   Expected: no ANSI escape codes in piped output (since pipe makes it not a tty)

8. **Test check-all-then-fail behavior (checks ALL deps, not just first missing):**
   ```bash
   # Hide all deps to verify all three appear in output
   env PATH="/usr/bin:/bin" bash setup.sh --check-deps-only 2>&1
   ```
   Expected: output contains MISSING/X markers for ALL three deps (Python, uv, Bun), not just the first one

9. If any test fails, fix the issue in setup.sh and re-run the test.

Note: These tests are run inline during execution, NOT persisted as test files. They verify the behavior described in SETUP-01 and SETUP-03 success criteria plus the CONTEXT.md locked decisions.
  </action>
  <verify>
All 8 test scenarios pass:
1. `bash setup.sh --check-deps-only` exits 0 (all deps present on this machine)
2. PATH-manipulated run shows missing dependency messages with OS-specific install commands
3. Another PATH-manipulated run shows different missing dependency
4. --check-deps-only in a temp dir creates NO files
5. --help shows usage
6. Checklist output format is present (checkmark/X or OK/MISSING with versions)
7. Color is disabled when output is piped (not a tty)
8. All three deps are reported when all are missing (check-all-then-fail, not stop-at-first)
  </verify>
  <done>
  - Dependency checker correctly identifies present and missing dependencies
  - Missing dependency output includes the exact OS-specific install command (not just "install X")
  - --check-deps-only flag creates no files, no directories, triggers no setup steps, suppresses install prompts
  - Checklist format with checkmark/X (or OK/MISSING) and version info is displayed
  - Color output is disabled when piped or TERM=dumb
  - check-all-then-fail: all three deps reported even when multiple are missing
  - All tests pass on macOS (the target platform)
  </done>
</task>

</tasks>

<verification>
Phase-level verification for Plan 01:

1. **SETUP-01 coverage:** `bash setup.sh --check-deps-only` checks Python 3.12+, uv, and Bun. Shows OS-specific install commands on failure. Checks ALL deps before exiting (check-all-then-fail). Exits non-zero when any dependency is missing.

2. **SETUP-03 coverage:** `--check-deps-only` flag exists and performs a dry-run dependency check without creating files, starting onboarding, or prompting for auto-install.

3. **CONTEXT.md compliance:**
   - Checklist format with checkmark/X and versions (Output & messaging decision)
   - Check ALL deps before failing (Failure behavior decision)
   - OS-specific install commands (Failure behavior decision)
   - Terminal color detection with fallback (Output & messaging decision)
   - Prompted auto-install when dep missing in normal mode (Platform & prerequisites decision)

4. **No regressions:** Existing setup.sh directory creation and config scaffolding logic is preserved (will be restructured by Plan 02).
</verification>

<success_criteria>
- `bash setup.sh --check-deps-only` exits 0 when all prerequisites are installed
- `bash setup.sh --check-deps-only` exits 1 and shows checklist with exact OS-specific install commands when any prerequisite is missing
- `bash setup.sh --check-deps-only` checks ALL three deps before failing (check-all-then-fail)
- `bash setup.sh --check-deps-only` output uses checklist format: [OK]/[MISSING] with versions
- `bash setup.sh --check-deps-only` suppresses install prompts
- `bash setup.sh` (normal mode) prompts to install missing deps: "Install via X? [y/N]"
- `bash setup.sh --help` shows usage including --check-deps-only description
- No files or directories are created when --check-deps-only is used
- Color output is disabled when not a tty or TERM=dumb
- OS detection works for macOS, Linux, and WSL
- `bash -n setup.sh` passes with no syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-setup-automation/02-01-SUMMARY.md`
</output>
