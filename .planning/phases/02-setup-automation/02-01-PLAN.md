---
phase: 02-setup-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - setup.sh
autonomous: true

must_haves:
  truths:
    - "Running ./setup.sh on a machine missing Python 3.12+ shows the exact install command and exits non-zero"
    - "Running ./setup.sh on a machine missing uv shows the exact install command and exits non-zero"
    - "Running ./setup.sh on a machine missing Bun shows the exact install command and exits non-zero"
    - "Running ./setup.sh --check-deps-only checks all dependencies and exits without creating files or directories"
    - "Running ./setup.sh --check-deps-only when all deps are present exits with code 0"
    - "Running ./setup.sh --check-deps-only when any dep is missing exits with non-zero code"
  artifacts:
    - path: "setup.sh"
      provides: "Dependency checker with fail-fast behavior and --check-deps-only flag"
      contains: "check_deps"
  key_links:
    - from: "setup.sh (CLI arg parser)"
      to: "setup.sh (check_deps function)"
      via: "--check-deps-only flag triggers check_deps and exits"
      pattern: "check-deps-only"
---

<objective>
Rewrite the dependency checking subsystem in setup.sh to validate all prerequisites (Python 3.12+, uv, Bun) with fail-fast behavior, show exact install commands on failure, and support a --check-deps-only flag for dry-run verification.

Purpose: Without proper dependency checking, new users hit cryptic errors when prerequisites are missing. The current setup.sh checks uv/bun late in the flow and continues on failure instead of stopping. This plan makes dependency validation the FIRST thing that happens, with clear guidance when anything is missing.

Output: A rewritten setup.sh with a robust check_deps() function at the top, CLI argument parsing for --check-deps-only, and fail-fast behavior that blocks the rest of setup when any prerequisite is missing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@setup.sh
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build dependency checker function and CLI argument parser</name>
  <files>setup.sh</files>
  <action>
Rewrite setup.sh with these changes (keep existing directory creation and config scaffolding logic intact for Plan 02 to restructure):

1. **Add CLI argument parser** at the top of the script (after set -e and color definitions):
   - Parse `--check-deps-only` flag
   - Parse `--help` / `-h` flag
   - Store in `CHECK_DEPS_ONLY` variable (default: false)
   - Show usage help when `--help` is passed

2. **Create `check_dependency()` helper function** that checks a single dependency:
   - Arguments: command name, minimum version (optional), install command
   - Uses `command -v` to check existence
   - For Python: parse `python3 --version` output and compare major.minor >= 3.12
   - For uv: just check existence (any version is fine)
   - For Bun: just check existence (any version is fine)
   - Returns 0 on success, 1 on failure
   - On failure: prints the exact install command in a clearly formatted message

3. **Create `check_all_deps()` function** that checks all three prerequisites:
   - Calls check_dependency for each:
     - Python 3.12+: install command = "Visit https://www.python.org/downloads/ or use pyenv: pyenv install 3.12"
     - uv: install command = "curl -LsSf https://astral.sh/uv/install.sh | sh"
     - Bun: install command = "curl -fsSL https://bun.sh/install | bash"
   - Tracks a `missing_count` variable
   - After all checks: if missing_count > 0, print summary of what's missing and exit 1
   - If all present: print success message with found versions

4. **Wire --check-deps-only** into the script flow:
   - After argument parsing, call `check_all_deps`
   - If `CHECK_DEPS_ONLY=true`: exit with the return code from check_all_deps (0 if all pass, 1 if any missing)
   - If `CHECK_DEPS_ONLY=false`: if check_all_deps fails, exit 1; if passes, continue to rest of setup

5. **Important constraints:**
   - Do NOT auto-install anything (anti-feature M1-X07). Only show install commands.
   - Keep `set -e` at the top
   - Keep existing color variables (GREEN, YELLOW, BLUE, RED, NC)
   - Add RED color for errors: `RED='\033[0;31m'`
   - Use the existing banner style but update step numbering (dependency check becomes Step 1)
   - The existing Steps 1-11 content should remain in the file but will be restructured by Plan 02. For now, just insert the dependency checker BEFORE the existing steps and make the existing `uv sync` step a no-op if deps already validated.

6. **Python version comparison logic** (bash-native, no external deps):
   ```bash
   python_version=$(python3 --version 2>&1 | grep -oP '\d+\.\d+' | head -1)
   python_major=$(echo "$python_version" | cut -d. -f1)
   python_minor=$(echo "$python_version" | cut -d. -f2)
   if [ "$python_major" -ge 3 ] && [ "$python_minor" -ge 12 ]; then
     # OK
   fi
   ```
   Note: Use `grep -oE` instead of `grep -oP` for macOS compatibility (no PCRE on default macOS grep). Pattern: `[0-9]+\.[0-9]+`
  </action>
  <verify>
Run these verification commands:
```bash
# 1. Check --help works
bash setup.sh --help

# 2. Check --check-deps-only exits cleanly when deps are present
bash setup.sh --check-deps-only
echo "Exit code: $?"

# 3. Verify no files were created by --check-deps-only
# (compare directory listing before and after)

# 4. Check the script is valid bash
bash -n setup.sh

# 5. Verify check_all_deps function exists
grep -q "check_all_deps" setup.sh

# 6. Verify --check-deps-only flag is parsed
grep -q "check-deps-only" setup.sh

# 7. Verify Python version check exists
grep -q "python3 --version" setup.sh

# 8. Verify install commands are present for all three deps
grep -q "astral.sh/uv/install" setup.sh
grep -q "bun.sh/install" setup.sh
grep -q "python.org/downloads" setup.sh
```
  </verify>
  <done>
  - `bash setup.sh --check-deps-only` exits 0 when Python 3.12+, uv, and Bun are all installed
  - `bash setup.sh --check-deps-only` would exit 1 and show install commands when any dependency is missing (tested by temporarily renaming a binary or using PATH manipulation)
  - `bash setup.sh --help` shows usage information including --check-deps-only flag description
  - `bash -n setup.sh` passes (no syntax errors)
  - The dependency check runs BEFORE any directory creation or file modification
  </done>
</task>

<task type="auto">
  <name>Task 2: Test dependency checker with simulated missing dependencies</name>
  <files>setup.sh</files>
  <action>
Create a verification script (temporary, run inline in bash) that tests the dependency checker under controlled conditions:

1. **Test --check-deps-only with all deps present:**
   ```bash
   bash setup.sh --check-deps-only
   ```
   Expected: exit 0, prints found versions

2. **Test --check-deps-only with simulated missing Python:**
   ```bash
   # Use PATH manipulation to hide python3
   env PATH="/usr/bin:/bin" bash setup.sh --check-deps-only 2>&1
   ```
   Expected: exit 1, shows Python install command

3. **Test --check-deps-only with simulated missing uv:**
   ```bash
   # Use a subshell with modified PATH that excludes uv
   (export PATH=$(echo "$PATH" | tr ':' '\n' | grep -v cargo | grep -v uv | tr '\n' ':'); bash setup.sh --check-deps-only 2>&1)
   ```
   Expected: exit 1, shows uv install command

4. **Test --check-deps-only does NOT create files:**
   ```bash
   # Create a temp directory, copy setup.sh there, run it
   tmpdir=$(mktemp -d)
   cp setup.sh "$tmpdir/"
   cd "$tmpdir"
   bash setup.sh --check-deps-only
   # Verify no new files/dirs were created (only setup.sh should exist)
   ls -la "$tmpdir"
   rm -rf "$tmpdir"
   ```

5. **Test --help flag:**
   ```bash
   bash setup.sh --help
   ```
   Expected: shows usage with description of --check-deps-only

6. If any test fails, fix the issue in setup.sh and re-run the test.

Note: These tests are run inline during execution, NOT persisted as test files. They verify the behavior described in SETUP-01 and SETUP-03 success criteria.
  </action>
  <verify>
All 5 test scenarios pass:
1. `bash setup.sh --check-deps-only` exits 0 (all deps present on this machine)
2. PATH-manipulated run shows missing dependency messages with install commands
3. Another PATH-manipulated run shows different missing dependency
4. --check-deps-only in a temp dir creates NO files
5. --help shows usage
  </verify>
  <done>
  - Dependency checker correctly identifies present and missing dependencies
  - Missing dependency output includes the exact install command (not just "install X")
  - --check-deps-only flag creates no files, no directories, triggers no setup steps
  - All tests pass on macOS (the target platform)
  </done>
</task>

</tasks>

<verification>
Phase-level verification for Plan 01:

1. **SETUP-01 coverage:** `bash setup.sh --check-deps-only` checks Python 3.12+, uv, and Bun. Shows exact install commands on failure. Exits non-zero when any dependency is missing.

2. **SETUP-03 coverage:** `--check-deps-only` flag exists and performs a dry-run dependency check without creating files or starting onboarding.

3. **No regressions:** Existing setup.sh directory creation and config scaffolding logic is preserved (will be restructured by Plan 02).
</verification>

<success_criteria>
- `bash setup.sh --check-deps-only` exits 0 when all prerequisites are installed
- `bash setup.sh --check-deps-only` exits 1 and shows exact install commands when any prerequisite is missing
- `bash setup.sh --help` shows usage including --check-deps-only description
- No files or directories are created when --check-deps-only is used
- `bash -n setup.sh` passes with no syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-setup-automation/02-01-SUMMARY.md`
</output>
