---
phase: 02-setup-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - setup.sh
autonomous: true

must_haves:
  truths:
    - "Running ./setup.sh --check-deps-only shows a checklist of Python 3.12+, uv, and Bun with version found and pass/fail status"
    - "Running ./setup.sh on a machine missing Python 3.12+ shows the exact install command for the detected OS and exits non-zero"
    - "Running ./setup.sh --help shows usage information with all supported flags"
    - "Output is color-coded (green/red/yellow) in interactive terminals and plain text in pipes/CI"
    - "All three dependencies are checked before any failure exit (check-all-then-fail)"
  artifacts:
    - path: "setup.sh"
      provides: "Dependency checker with OS detection, version comparison, color output, CLI args, auto-install prompts"
      contains: "check_all_deps"
  key_links:
    - from: "setup.sh:detect_os"
      to: "setup.sh:get_install_command"
      via: "DETECTED_OS and PKG_MANAGER globals"
      pattern: "DETECTED_OS|PKG_MANAGER"
    - from: "setup.sh:check_dependency"
      to: "setup.sh:version_gte"
      via: "sort -V comparison"
      pattern: "sort -V"
---

<objective>
Rewrite setup.sh from scratch with a robust dependency checker, OS detection, terminal color support, CLI argument parsing, and the --check-deps-only flag. This plan creates the script skeleton and all utility functions that Plan 02 will call for directory creation and config scaffolding.

Purpose: The dependency checker is the gatekeeper -- it must run BEFORE any filesystem modifications and report ALL missing dependencies in a single pass, not fail on the first one. This is the foundation that makes the rest of setup.sh safe to run.

Output: A functional setup.sh that can check dependencies, detect the OS, show colored output, parse --check-deps-only and --help flags, and offer to auto-install missing dependencies. The script will have placeholder calls for directory creation, config scaffolding, and Python dep installation that Plan 02 will fill in.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-setup-automation/02-CONTEXT.md
@.planning/phases/02-setup-automation/02-RESEARCH.md
@setup.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite setup.sh with header, color detection, utility functions, and CLI args</name>
  <files>setup.sh</files>
  <action>
Replace the entire contents of setup.sh with a new script structured as follows. Use the existing script as reference for directory lists and template content that will be needed by Plan 02, but do NOT keep Steps 8-11 (symlinks, onboarding, MCP Launchpad) -- those are out of scope.

**Script structure (top to bottom):**

1. **Shebang and header:**
   - `#!/bin/bash`
   - Comment block: "Finance Guru Setup Script -- checks dependencies, creates directories, scaffolds config"
   - `set -e`

2. **Path setup:**
   - `SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"`
   - `PROJECT_ROOT="$SCRIPT_DIR"`

3. **Terminal color detection** (from RESEARCH.md Pattern 2):
   - Check `[ -t 1 ] && [ "${TERM:-dumb}" != "dumb" ]` -- NOTE: use `${TERM:-dumb}` NOT `"$TERM"` to handle unset TERM in CI/cron
   - If true: set GREEN, RED, YELLOW, BLUE, BOLD, NC with ANSI escape codes
   - If false: set all color vars to empty strings
   - Use `printf` for all colored output (not `echo -e`)

4. **Output helper functions:**
   - `info()` -- prints message in default color with "  " prefix
   - `success()` -- prints with green checkmark: `printf "  ${GREEN}[OK]${NC} %s\n" "$1"`
   - `warn()` -- prints with yellow warning: `printf "  ${YELLOW}[WARN]${NC} %s\n" "$1"`
   - `error()` -- prints with red X: `printf "  ${RED}[FAIL]${NC} %s\n" "$1"`
   - `header()` -- prints section header with BOLD: `printf "\n${BOLD}%s${NC}\n" "$1"`

5. **OS detection function** (from RESEARCH.md Pattern 3 + Example 4):
   - `detect_os()` sets two globals: `DETECTED_OS` (macos/linux/wsl) and `PKG_MANAGER` (brew/apt/none)
   - On macOS: check `command -v brew` to set PKG_MANAGER
   - On Linux: check `/proc/version` for "microsoft" (WSL), then check `command -v apt`
   - Default fallback: linux + none

6. **Version comparison function** (from RESEARCH.md Example 1):
   - `version_gte()` using `sort -V`: `[ "$(printf '%s\n' "$1" "$2" | sort -V | head -1)" = "$2" ]`
   - CRITICAL: Do NOT use the buggy `[ "$major" -ge 3 ] && [ "$minor" -ge 12 ]` pattern (see RESEARCH.md Pitfall 1)

7. **Install command function:**
   - `get_install_command()` takes a dependency name and returns the OS-specific install command
   - For Python:
     - macOS + brew: `brew install python@3.12`
     - macOS + no brew: `Install Homebrew first: /bin/bash -c "$(curl -fsSL ...)" then: brew install python@3.12`
     - linux/wsl + apt: `sudo apt update && sudo apt install python3.12`
     - linux/wsl + no apt: `Visit https://www.python.org/downloads/`
   - For uv: `curl -LsSf https://astral.sh/uv/install.sh | sh` (same on all platforms)
   - For Bun: `curl -fsSL https://bun.sh/install | bash` (same on all platforms)

8. **Auto-install prompt function:**
   - `prompt_install()` takes dep name and install command
   - Check `[ -t 0 ]` before prompting (RESEARCH.md Pitfall 4) -- if not a tty, skip with message "Skipped: $name (non-interactive)"
   - Prompt: `printf "%s not found. Install now? [y/N] " "$name"` then `read -r response`
   - If `[[ "$response" =~ ^[Yy]$ ]]`: run the install command with `eval`, then re-check with `command -v`
   - If declined: `printf "  ${YELLOW}Skipped:${NC} %s (user declined)\n" "$name"`

9. **Single dependency check function** (from RESEARCH.md Example 2):
   - `check_dependency()` takes: cmd, display_name, min_version (optional)
   - First check `command -v "$cmd"` -- if missing, print `[MISSING] $name (not found)` with install command, return 1
   - Extract version using `case` on cmd:
     - python3: `python3 --version 2>&1 | grep -oE '[0-9]+\.[0-9]+' | head -1`
     - uv: `uv --version 2>&1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1`
     - bun: `bun --version 2>&1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1`
   - If min_version specified: use `version_gte` to compare. If fails, print `[MISSING] $name $found (>= $min required)` with install command, return 1
   - On success: print `[OK] $name $version` (with `(>= $min required)` if min_version was specified)
   - Return 0 on success, 1 on failure

10. **Check-all-deps function** (from RESEARCH.md Pattern 1):
    - `check_all_deps()` uses `|| { missing=$((missing + 1)); }` pattern to accumulate failures without triggering `set -e`
    - Checks in order: python3 (min 3.12), uv (no min), bun (no min)
    - After all checks: if `$missing -gt 0`, return 1
    - Store results in arrays for the summary (which deps passed, which failed, which install commands)

11. **CLI argument parsing:**
    - Parse `$@` in a while loop
    - `--check-deps-only`: set `CHECK_DEPS_ONLY=true`
    - `--help` / `-h`: print usage and exit 0
    - Unknown flags: print "Unknown option: $1" and exit 1
    - Usage text:
      ```
      Usage: ./setup.sh [OPTIONS]

      Options:
        --check-deps-only    Check dependencies without modifying anything
        --help, -h           Show this help message

      Setup creates fin-guru-private/ directory structure, scaffolds config
      files, and installs Python dependencies. Run after cloning the repo.
      ```

12. **Main flow (bottom of script):**
    - Print banner: "Finance Guru Setup" with `========` borders
    - Call `detect_os` and print detected OS
    - Call `header "Checking dependencies..."`
    - Call `check_all_deps`
    - If `check_all_deps` fails AND `CHECK_DEPS_ONLY` is true: exit 1
    - If `check_all_deps` fails AND `CHECK_DEPS_ONLY` is false: offer auto-install for each missing dep (loop through failed deps, call `prompt_install`), then re-run `check_all_deps` -- if still failing, print "Please install missing dependencies and re-run setup.sh" and exit 1
    - If `CHECK_DEPS_ONLY` is true and all deps pass: print summary checklist and exit 0
    - **Placeholder section** (Plan 02 fills these in):
      ```bash
      # --- Phase functions (Plan 02) ---
      # create_directory_structure
      # scaffold_config_files
      # install_python_deps
      # print_summary
      ```
    - For now, after the dependency check passes (and we're not in --check-deps-only mode), print: "Dependencies verified. Directory creation and config scaffolding coming in next plan."

**Important implementation notes:**
- Use `printf` for all output (not `echo -e`) per RESEARCH.md recommendation
- Use `command -v` (not `which`) per RESEARCH.md
- Use `grep -oE` (not `grep -oP`) for macOS compatibility per RESEARCH.md
- Do NOT include any of the removed steps: symlinks (Steps 8-9), onboarding (Step 10), MCP Launchpad (Step 11)
- The script must be executable (`chmod +x`)
  </action>
  <verify>
Run these verification commands:

```bash
# 1. Script is syntactically valid
bash -n setup.sh && echo "SYNTAX OK"

# 2. Script is executable
test -x setup.sh && echo "EXECUTABLE OK"

# 3. --help flag works
./setup.sh --help

# 4. --check-deps-only runs without modifying filesystem
./setup.sh --check-deps-only

# 5. Color detection works (should show colors in terminal)
./setup.sh --check-deps-only

# 6. Piped output has no ANSI codes
./setup.sh --check-deps-only 2>&1 | cat -v | grep -c '\033' | xargs test 0 -eq && echo "NO ANSI IN PIPE"

# 7. version_gte function works correctly (inline test)
bash -c 'source setup.sh --help 2>/dev/null; version_gte "3.14" "3.12" && echo "3.14 >= 3.12 PASS"; version_gte "3.10" "3.12" && echo "FAIL" || echo "3.10 < 3.12 PASS"; version_gte "4.1" "3.12" && echo "4.1 >= 3.12 PASS"'
```
  </verify>
  <done>
- setup.sh --check-deps-only shows checklist with [OK] or [MISSING] for Python 3.12+, uv, and Bun
- setup.sh --help shows usage text and exits 0
- setup.sh checks ALL dependencies before failing (not just the first)
- Output is color-coded in terminal, plain in pipes
- OS detection correctly identifies macOS/Linux/WSL
- version_gte correctly handles 3.14 >= 3.12, 3.10 < 3.12, and 4.1 >= 3.12
- Auto-install prompt appears for missing deps (only in interactive mode)
- Script has placeholder comments for Plan 02 functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify dependency checker against all four success criteria paths</name>
  <files>setup.sh</files>
  <action>
Run setup.sh through each of the four Phase 2 success criteria paths that this plan covers:

1. **SC1 partial (deps pass):** Run `./setup.sh` on the dev machine. Verify all three deps show [OK] and the script reaches the "Dependencies verified" placeholder message without errors. (Full SC1 validation happens in Plan 02 when directory creation is added.)

2. **SC2 (missing deps):** Simulate a missing dependency by temporarily aliasing python3 away or testing in a subshell with modified PATH:
   ```bash
   env PATH="/usr/bin:/bin" bash setup.sh --check-deps-only 2>&1
   ```
   Verify: Shows [MISSING] with exact install command for each missing dep, exits with non-zero code.

3. **SC3 (--check-deps-only):** Run `./setup.sh --check-deps-only`. Verify: Shows dependency checklist, does NOT create any files or directories, exits with code 0 if all deps present.

4. **Piped output test:** Run `./setup.sh --check-deps-only | cat`. Verify: No ANSI escape codes in output.

If any test fails, fix the script and re-run the failing test.
  </action>
  <verify>
```bash
# All four paths exercised:
./setup.sh --check-deps-only && echo "SC3 PASS"
./setup.sh 2>&1 | grep -q "Dependencies verified" && echo "SC1-partial PASS"
./setup.sh --check-deps-only 2>&1 | cat -v | grep -c '\033' | xargs test 0 -eq && echo "PIPE TEST PASS"
```
  </verify>
  <done>
- setup.sh --check-deps-only exits 0 when all deps present, exits 1 when any missing
- setup.sh without flags passes dependency check and reaches placeholder
- No ANSI codes leak into piped output
- Install commands shown match detected OS (brew on macOS, apt on Linux)
  </done>
</task>

</tasks>

<verification>
Phase 2 success criteria coverage by this plan:
- SC1 (partial): Dependencies pass check, script continues to placeholder
- SC2: Missing deps show exact install commands, exits non-zero
- SC3: --check-deps-only performs dry-run check, no filesystem modifications
- SC4: Not covered (idempotency -- Plan 02 scope)

Research findings incorporated:
- [x] version_gte with sort -V (not buggy arithmetic comparison)
- [x] ${TERM:-dumb} for TERM unset edge case
- [x] command -v (not which)
- [x] grep -oE (not grep -oP for macOS)
- [x] printf (not echo -e) for ANSI output
- [x] [ -t 0 ] check before read prompts
- [x] [ -t 1 ] check for color detection
- [x] command -v brew before offering brew install
- [x] set -e + || guards for check-all-then-fail
- [x] No references to removed steps (symlinks, onboarding, MCP Launchpad)
</verification>

<success_criteria>
- setup.sh --check-deps-only shows pass/fail for Python 3.12+, uv, and Bun
- setup.sh --help shows usage text
- Color output in terminals, plain text in pipes
- All deps checked before any failure exit
- OS-specific install commands shown for missing deps
- Auto-install prompt works in interactive mode, skips in non-interactive
</success_criteria>

<output>
After completion, create `.planning/phases/02-setup-automation/02-01-SUMMARY.md`
</output>
