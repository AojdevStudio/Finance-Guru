---
phase: 07-total-return-calculator
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/analysis/total_return_cli.py
  - tests/python/test_total_return.py
  - CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "CLI accepts single ticker: `uv run python src/analysis/total_return_cli.py SCHD --days 252` outputs price return, dividend return, and total return"
    - "CLI accepts multiple tickers: `SCHD JEPI VYM --days 252` shows side-by-side comparison ranked by total return"
    - "Verdict narrative line appears when price return is negative but total return flips positive"
    - "Dollar amounts shown alongside percentages when portfolio CSV is found"
    - "DRIP and non-DRIP columns appear side-by-side by default"
    - "Period breakdown lists every individual dividend event with date, amount, shares acquired, running total"
    - "League table summary at bottom ranks tickers: #1 JEPI +12.3%, #2 CLM +4.2%, etc."
    - "Tickers where price is negative but total return is positive are marked 'Price misleading'"
    - "--output json produces structured JSON"
    - "--help shows complete usage examples"
    - "--force flag overrides data quality refusal"
    - "Educational disclaimer appears in all output"
    - "Finnhub used for current prices when FINNHUB_API_KEY is set, yfinance fallback otherwise"
  artifacts:
    - path: "src/analysis/total_return_cli.py"
      provides: "Layer 3 CLI interface with argparse, multi-ticker comparison, verdict display, league table"
      min_lines: 300
  key_links:
    - from: "src/analysis/total_return_cli.py"
      to: "src/analysis/total_return.py"
      via: "import TotalReturnCalculator, TotalReturnResult, DividendDataError"
      pattern: "from src\\.analysis\\.total_return import"
    - from: "src/analysis/total_return_cli.py"
      to: "src/utils/market_data.py"
      via: "import get_prices for Finnhub real-time prices"
      pattern: "from src\\.utils\\.market_data import"
    - from: "src/analysis/total_return_cli.py"
      to: "notebooks/updates/Portfolio_Positions_*.csv"
      via: "glob for latest CSV to read share counts"
      pattern: "Portfolio_Positions_"
---

<objective>
Build the total return CLI interface (Layer 3) with all presentation features: multi-ticker comparison, verdict display, dollar amounts, DRIP side-by-side, period breakdown, league table, Finnhub integration, and JSON output.

Purpose: This plan creates the user-facing CLI tool that agents and the user invoke directly. It translates raw calculator output into the rich display format specified in CONTEXT.md -- including the "Sean insight" verdict line, dollar amounts from portfolio CSV, and ranked league table.

Output: Working `total_return_cli.py` that satisfies all 5 Success Criteria from the roadmap, plus CLI-level tests and CLAUDE.md tool reference update.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-total-return-calculator/07-CONTEXT.md
@.planning/phases/07-total-return-calculator/07-RESEARCH.md
@.planning/phases/07-total-return-calculator/07-01-SUMMARY.md

@src/CLAUDE.md
@src/models/total_return_inputs.py
@src/analysis/total_return.py
@src/analysis/risk_metrics_cli.py
@src/analysis/correlation_cli.py
@src/utils/market_data.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create total_return_cli.py with all presentation features</name>
  <files>
    src/analysis/total_return_cli.py
  </files>
  <action>
Create the Layer 3 CLI following the established pattern from `risk_metrics_cli.py` and `correlation_cli.py`. This file handles ALL I/O: data fetching, portfolio CSV reading, formatting, and display. NO business logic -- that lives in `total_return.py`.

**CONTEXT.md decisions to implement (ALL LOCKED -- do not skip any):**

**1. argparse setup:**
```python
parser.add_argument("tickers", type=str, nargs="+", help="Ticker symbols (e.g., SCHD JEPI VYM)")
parser.add_argument("--days", type=int, default=252, help="Number of days (default: 252 = 1 year)")
parser.add_argument("--output", choices=["human", "json"], default="human")
parser.add_argument("--force", action="store_true", help="Override data quality refusal")
parser.add_argument("--save-to", type=str, default=None, help="Save output to file")
```

Add `formatter_class=argparse.RawDescriptionHelpFormatter` and a comprehensive `epilog` with usage examples (STD-03):
```
Examples:
  # Single ticker total return
  %(prog)s SCHD --days 252

  # Multi-ticker comparison (ranked by total return)
  %(prog)s SCHD JEPI VYM CLM --days 252

  # JSON output for programmatic use
  %(prog)s SCHD --days 252 --output json

  # Override data quality warnings
  %(prog)s MSTY --days 252 --force

  # Short period analysis
  %(prog)s JEPI --days 90

Agent Use Cases:
  - Strategy Advisor: Compare income funds by total return
  - Quant Analyst: Evaluate DRIP compounding effects
  - Market Researcher: Identify "price misleading" funds
```

**2. Data fetching function `fetch_ticker_data()`:**
- Use `yf.Ticker(symbol).history()` for synchronized price+dividend data (per-ticker, NOT batch yf.download())
- Extract raw Close prices (NOT Adj Close -- avoids double-counting dividends)
- Extract non-zero dividend records with ex-date and close price
- Build DividendRecord list with `shares_at_ex=initial_shares` (DRIP adjusts this in calculator)
- Fetch 1.5x calendar days to account for weekends/holidays

**3. Finnhub real-time price integration (CONTEXT.md: "Finnhub for current real-time prices"):**
- Try to import and use `get_prices()` from `src/utils/market_data.py` for current price
- If FINNHUB_API_KEY not set or import fails, gracefully fall back to yfinance last close
- Use current price as the "ending price" (replaces last close for more accurate current-day return)
- Print status to stderr: "Using real-time price from Finnhub: $XXX.XX" or "Using end-of-day price from yfinance"

**4. Portfolio CSV auto-read for dollar amounts (CONTEXT.md: "Dollar amounts require share count -- auto-read from latest Portfolio_Positions CSV"):**
```python
def load_portfolio_shares(tickers: list[str]) -> dict[str, float]:
    """Read share counts from latest Portfolio_Positions CSV in notebooks/updates/.

    Glob for notebooks/updates/Portfolio_Positions_*.csv, sort by filename (date in name),
    take the latest file. Parse CSV to find share counts for requested tickers.

    Returns dict of {ticker: shares}. Missing tickers not included.
    Returns empty dict if no CSV found (fallback to per-share math).
    """
```
- CSV format: look for columns like "Symbol" and "Quantity" (inspect the actual CSV at notebooks/updates/ to confirm exact column names)
- Graceful fallback: if no CSV found or ticker not in CSV, use 1.0 shares (per-share math)

**5. Human-readable output formatting -- `format_human_output()`:**

Structure for SINGLE ticker:
```
======================================================================
TOTAL RETURN ANALYSIS: SCHD
Period: 2025-02-17 to 2026-02-17 (365 days)
Shares: 150 (from Portfolio_Positions_Dec-18-2025.csv)
======================================================================

RETURN BREAKDOWN
----------------------------------------------------------------------
                        Without DRIP    With DRIP
Price Return               +5.23%         +5.23%
Dividend Return            +3.48%         +3.48%
Total Return               +8.71%         +9.02%
Annualized Return          +8.71%         +9.02%
Final Shares              150.000        154.235

Dollar Impact (150 shares at $75.00 start):
  Starting Value:                         $11,250.00
  Distributions Received:                    $522.00 (+4.6%)
  Ending Value (without DRIP):            $12,230.62
  Ending Value (with DRIP):               $12,265.55
  DRIP Compounding Benefit:                   $34.93

DIVIDEND HISTORY (every event)
----------------------------------------------------------------------
  Date          Div/Share   Shares Before   Cash    New Shares   Total Shares
  2025-03-15     $0.87        150.000      $130.50    1.682       151.682
  2025-06-14     $0.89        151.682      $135.00    1.702       153.384
  2025-09-13     $0.86        153.384      $131.91    1.693       155.077
  2025-12-13     $0.86        155.077      $133.37    1.712       156.789

======================================================================
DISCLAIMER: For educational purposes only. Not investment advice.
Consult a qualified financial professional before making investment decisions.
======================================================================
```

Structure for MULTI-TICKER (ranked by total return):
```
======================================================================
TOTAL RETURN COMPARISON
Period: 2025-02-17 to 2026-02-17 (365 days)
======================================================================

                         JEPI         SCHD          CLM         MSTY
----------------------------------------------------------------------
Price Return           +2.15%       +5.23%       -3.95%      -50.37%
Dividend Return        +9.82%       +3.48%       +8.42%      +62.15%
Total Return (no DRIP)+11.97%       +8.71%       +4.47%      +11.78%
Total Return (DRIP)   +12.45%       +9.02%       +4.68%      +12.31%
Annualized            +12.45%       +9.02%       +4.68%      +12.31%

  > CLM: Price return is misleading -- price is down -3.95% but distributions
    of $824 (+8.4%) flip total return to +4.47%.

  > MSTY: Price return is misleading -- price is down -50.37% but distributions
    of $3,107 (+62.2%) flip total return to +11.78%.

LEAGUE TABLE (ranked by total return with DRIP)
----------------------------------------------------------------------
  #1  JEPI    +12.45%
  #2  MSTY    +12.31%  ** Price misleading
  #3  SCHD     +9.02%
  #4  CLM      +4.68%  ** Price misleading

======================================================================
DISCLAIMER: For educational purposes only. Not investment advice.
Consult a qualified financial professional before making investment decisions.
======================================================================
```

**Key formatting rules from CONTEXT.md:**
- **Verdict narrative**: Only trigger when price_return < 0 AND total_return > 0 (sign flip). Show dollar amounts AND percentages.
- **"Price misleading" indicator**: Mark in league table for tickers with sign flip.
- **League table**: Ranked by total return with DRIP (best first, worst last). Appears AFTER individual breakdowns.
- **DRIP and non-DRIP side-by-side**: Both columns always shown (CONTEXT.md: "Show both with DRIP and without DRIP side-by-side by default").
- **Period breakdown**: Every individual dividend event, even for weekly payers. Show date, dividend/share, shares acquired, running total.
- **Dollar amounts**: Only when portfolio CSV provides share count. Format as "$X,XXX.XX". Fallback: per-share math if no CSV.

**6. JSON output -- `format_json_output()`:**
```python
def format_json_output(results, portfolio_shares) -> str:
    """Structured JSON with all data.

    Schema per ticker:
    {
        "ticker": "SCHD",
        "period": {"start": "2025-02-17", "end": "2026-02-17", "days": 365},
        "shares_from_csv": 150.0,
        "returns": {
            "price_return": 0.0523,
            "dividend_return": 0.0348,
            "total_return_no_drip": 0.0871,
            "total_return_drip": 0.0902,
            "annualized_return": 0.0902,
            "final_shares_drip": 154.235
        },
        "dollar_impact": {  // only if shares_from_csv > 1
            "starting_value": 11250.00,
            "distributions_received": 522.00,
            "ending_value_no_drip": 12230.62,
            "ending_value_drip": 12265.55
        },
        "verdict": {
            "price_misleading": true,
            "narrative": "Price down -3.95% but distributions of $824 (+8.4%) flip total return to +4.47%"
        },
        "dividend_events": [...],
        "data_quality_warnings": [...]
    }
    ```
Include `"disclaimer": "For educational purposes only. Not investment advice."` in the JSON root.

**7. Error handling:**
- DividendDataError from calculator: catch and display count of missing records, suggest --force flag. Print to stderr and exit 1.
- yfinance fetch failure: clear error message per ticker, skip ticker in comparison (or exit if single ticker)
- Keyboard interrupt: clean exit with message, exit code 130
- All status/progress messages to stderr, formatted output to stdout

**8. Educational disclaimer (STD-02, XC-05):**
Include at the end of both human and JSON output.

**9. main() flow:**
```
1. Parse args
2. Load dividend schedules (from fin-guru-private/dividend-schedules.yaml)
3. Load portfolio shares from CSV (for dollar amounts)
4. For each ticker:
   a. Fetch price+dividend data from yfinance
   b. Optionally get real-time price from Finnhub
   c. Create TotalReturnCalculator with schedules, force flag
   d. Call calculate_all() (catches DividendDataError if not --force)
   e. Collect result
5. Sort results by total return (DRIP) descending
6. Format output (human or JSON) -- pass portfolio_shares for dollar amounts
7. Display or save
```

Commit: `feat(07-02): add total return CLI with verdict display, league table, and DRIP comparison`
  </action>
  <verify>
    `uv run python src/analysis/total_return_cli.py --help` -- shows complete usage with examples
    `uv run ruff check src/analysis/total_return_cli.py` -- clean
    `python -c "import src.analysis.total_return_cli"` -- imports without error
  </verify>
  <done>
    - `src/analysis/total_return_cli.py` exists with 300+ lines
    - argparse with tickers (nargs="+"), --days, --output, --force, --save-to flags
    - --help shows complete examples (STD-03)
    - Human output shows DRIP/non-DRIP side-by-side, verdict narrative, dollar amounts, period breakdown, league table
    - JSON output includes all fields including verdict and dollar_impact
    - Finnhub integration with graceful yfinance fallback
    - Portfolio CSV auto-read for share counts
    - Educational disclaimer in all output (STD-02)
    - "Price misleading" indicator on sign-flip tickers
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CLI integration tests and update CLAUDE.md tool reference</name>
  <files>
    tests/python/test_total_return.py
    CLAUDE.md
  </files>
  <action>
**Append CLI-level tests to `tests/python/test_total_return.py`** (the file already has calculator tests from Plan 01 -- add new test classes at the bottom):

These tests verify the CLI layer works correctly with mocked data. Use `unittest.mock.patch` to mock yfinance calls so tests remain offline.

**Test classes to add:**

1. **TestCLIArgParsing:**
   - `test_help_flag`: verify parser creation and epilog content
   - `test_single_ticker_accepted`: parser accepts `["SCHD", "--days", "252"]`
   - `test_multiple_tickers_accepted`: parser accepts `["SCHD", "JEPI", "VYM"]`
   - `test_json_output_flag`: parser accepts `["SCHD", "--output", "json"]`
   - `test_force_flag`: parser accepts `["SCHD", "--force"]`

2. **TestPortfolioCSVReader:**
   - `test_load_portfolio_shares_from_csv`: Create a temp CSV with known ticker/quantity columns using tmp_path, verify shares dict returned
   - `test_missing_csv_returns_empty_dict`: Point to empty directory -> returns {}
   - `test_latest_csv_selected`: Create two CSV files with different date-stamped names, verify the latest one is read

3. **TestVerdictFormatting:**
   - `test_verdict_triggers_on_sign_flip`: Create a mock TotalReturnResult where price_return = -0.05, total_return = 0.03. Format output and verify "misleading" appears in the text.
   - `test_verdict_absent_when_no_sign_flip`: price_return = 0.05, total_return = 0.08. Verify "misleading" does NOT appear.
   - `test_league_table_ranked_by_total_return`: Create 3 mock results with different total returns, format league table, verify ordering (#1 is highest)
   - `test_disclaimer_present_in_output`: Verify "educational purposes only" appears in formatted text output
   - `test_json_output_valid_json`: Format as JSON, `json.loads()` succeeds without error. Verify "disclaimer" key exists.

4. **TestFinnhubIntegration:**
   - `test_finnhub_fallback_graceful`: Mock get_prices to raise an exception, verify the CLI does not crash (falls back to yfinance price)

**Update root `CLAUDE.md` tool reference table** to include the new total return CLI.

Find the `[Financial Analysis Tools]` section and add a new row:
```
Total Return|src/analysis/total_return_cli.py|Price return, Dividend return, Total return, DRIP modeling, Multi-ticker comparison|--days, --force, --output json, --save-to|
```

Find the `[Agent-Tool Matrix]` section and update these agents:
- Market Researcher: add `Total Return` to the tool list. Use cases: "Income fund evaluation, price vs total return comparison"
- Quant Analyst: add `Total Return` to the tool list. Use cases: "DRIP analysis, return decomposition, compounding effects"
- Strategy Advisor: add `Total Return` to the tool list. Use cases: "Fund comparison, portfolio income analysis, dividend assessment"

Commit: `test(07-02): add CLI integration tests and update CLAUDE.md tool reference`
  </action>
  <verify>
    `uv run pytest tests/python/test_total_return.py -v` -- all tests pass (both Plan 01 calculator tests and new CLI tests)
    `uv run pytest` -- full test suite passes (no regressions)
    `uv run ruff check tests/python/test_total_return.py` -- clean
    Verify CLAUDE.md has Total Return in both the tool table and the agent-tool matrix
  </verify>
  <done>
    - 12+ new CLI-level tests appended to test_total_return.py
    - Portfolio CSV reader tested with temp files
    - Verdict display logic tested (sign-flip trigger, absence when no flip)
    - League table ranking verified
    - Finnhub fallback tested
    - JSON output validity tested
    - CLAUDE.md updated with total return tool in Financial Analysis Tools table and Agent-Tool Matrix
    - Full test suite passes with zero regressions
  </done>
</task>

</tasks>

<verification>
Run all 5 Success Criteria from the roadmap:

1. **SC1**: `uv run python src/analysis/total_return_cli.py SCHD --days 252` -- outputs three distinct numbers: price return, dividend return, and total return
2. **SC2**: `uv run python src/analysis/total_return_cli.py SCHD JEPI VYM --days 252` -- compares all three tickers side-by-side, ranked by total return
3. **SC3**: DRIP mode shows growing share count -- verify "Final Shares" > initial shares in output, and period breakdown shows shares acquired per dividend
4. **SC4**: When yfinance dividend data has gaps, output includes data quality warning (or refuses with DividendDataError suggesting --force)
5. **SC5**: `uv run python src/analysis/total_return_cli.py SCHD --output json` produces valid JSON; `--help` shows complete examples

Additional CONTEXT.md verification:
6. Verdict narrative appears for tickers where price < 0 and total > 0 (sign flip only)
7. Dollar amounts shown when portfolio CSV is found, per-share math when not found
8. League table ranks tickers by total return with DRIP (best first, worst last)
9. "Price misleading" indicator on sign-flip tickers in league table
10. DRIP and non-DRIP shown side-by-side by default
11. Period breakdown lists every individual dividend event
12. Finnhub used when FINNHUB_API_KEY set, yfinance fallback otherwise
13. --force flag overrides data quality refusal
14. Educational disclaimer present in all output

Quality gates:
15. `uv run pytest` -- full suite passes
16. `uv run ruff check src/ tests/` -- clean
17. `uv run mypy src/analysis/total_return_cli.py` -- clean (or pre-existing ignores only)
</verification>

<success_criteria>
- All 5 roadmap Success Criteria met
- All CONTEXT.md locked decisions implemented (verdict, dollar amounts, CSV auto-read, DRIP side-by-side, period breakdown, Finnhub, ranked results, Price misleading, league table, dividend schedules, --force)
- CLI follows established patterns from risk_metrics_cli.py and correlation_cli.py
- Full test suite passes with zero regressions
- CLAUDE.md tool reference updated with Total Return in both tables
</success_criteria>

<output>
After completion, create `.planning/phases/07-total-return-calculator/07-02-SUMMARY.md`
</output>
