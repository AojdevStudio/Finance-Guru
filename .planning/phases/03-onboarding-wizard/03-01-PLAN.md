---
phase: 03-onboarding-wizard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/models/onboarding_inputs.py
  - src/utils/onboarding_validators.py
  - src/utils/onboarding_sections.py
autonomous: true

must_haves:
  truths:
    - "Each of the 8 onboarding sections can collect user financial data via questionary prompts"
    - "Invalid dollar amounts, percentages, and integers are rejected with clear error messages"
    - "After 3 failed validation attempts the user is offered a skip option with a sensible default"
    - "Section data maps cleanly to existing Pydantic models in yaml_generation_inputs.py"
  artifacts:
    - path: "src/models/onboarding_inputs.py"
      provides: "OnboardingState, SectionName enum, section data structures for wizard progress tracking"
      min_lines: 40
    - path: "src/utils/onboarding_validators.py"
      provides: "ask_with_retry wrapper, validate_currency, validate_percentage, validate_positive_integer domain validators"
      min_lines: 80
    - path: "src/utils/onboarding_sections.py"
      provides: "8 section runner functions (run_liquid_assets_section through run_summary_section)"
      min_lines: 200
  key_links:
    - from: "src/utils/onboarding_sections.py"
      to: "src/utils/onboarding_validators.py"
      via: "import ask_with_retry and domain validators"
      pattern: "from src\\.utils\\.onboarding_validators import"
    - from: "src/utils/onboarding_sections.py"
      to: "src/models/onboarding_inputs.py"
      via: "import OnboardingState and section models"
      pattern: "from src\\.models\\.onboarding_inputs import"
    - from: "src/utils/onboarding_validators.py"
      to: "questionary"
      via: "questionary.confirm for skip prompt after 3 retries"
      pattern: "questionary\\.confirm"
---

<objective>
Build the Layer 1 models and Layer 2 business logic for the onboarding wizard: the OnboardingState model for tracking wizard progress, the retry-with-skip validation wrapper around questionary, domain-specific validators (currency, percentage, integer), and all 8 section runner functions that prompt users through the financial profile collection.

Purpose: This is the engine that powers the wizard. The section runners implement the exact question flow from the TypeScript scaffold (scripts/onboarding/sections/) but in Python using questionary. The validators enforce the "3 retries then skip" requirement (ONBD-02). The models track wizard state without duplicating existing yaml_generation_inputs.py models.

Output: Three new files (onboarding_inputs.py, onboarding_validators.py, onboarding_sections.py) that can be imported and orchestrated by the wizard CLI in Plan 02.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-onboarding-wizard/03-RESEARCH.md

# Existing Layer 1 models (DO NOT modify, reuse at generation step)
@src/models/yaml_generation_inputs.py

# Existing Layer 2 generator (understand output contract)
@src/utils/yaml_generator.py

# TypeScript section scaffold (REFERENCE for question flow, NOT executed)
@scripts/onboarding/sections/liquid-assets.ts
@scripts/onboarding/sections/investment-portfolio.ts
@scripts/onboarding/sections/cash-flow.ts
@scripts/onboarding/sections/debt-profile.ts
@scripts/onboarding/sections/preferences.ts
@scripts/onboarding/sections/broker-selection.ts
@scripts/onboarding/sections/env-setup.ts
@scripts/onboarding/sections/summary.ts

# Codebase conventions
@src/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Onboarding models and retry-with-skip validators</name>
  <files>
    src/models/onboarding_inputs.py
    src/utils/onboarding_validators.py
  </files>
  <action>
**First, install questionary:**
```bash
uv add questionary
```

**File 1: src/models/onboarding_inputs.py (Layer 1)**

Create wizard-specific models. Do NOT duplicate or modify existing yaml_generation_inputs.py models.

Contents:
- `SectionName` enum with values: `liquid_assets`, `investments`, `cash_flow`, `debt`, `preferences`, `broker`, `env_setup`, `summary`
- `OnboardingState` BaseModel with:
  - `current_section: SectionName` (default: liquid_assets)
  - `completed_sections: list[SectionName]` (default: empty)
  - `data: dict[str, Any]` (holds raw section data before conversion to UserDataInput)
  - `started_at: str` (ISO timestamp)
  - Class method `create_new()` that returns a fresh state with started_at = now
  - Method `is_section_complete(section: SectionName) -> bool`
  - Method `mark_complete(section: SectionName, next_section: Optional[SectionName])` that appends to completed_sections and sets current_section

Design constraint: The `data` dict holds raw collected values keyed by section name. It does NOT hold Pydantic model instances (those are created at generation time in the wizard CLI, Plan 02). This avoids coupling wizard state to yaml_generation_inputs.py validation during collection.

**File 2: src/utils/onboarding_validators.py (Layer 2)**

Create the retry-with-skip wrapper and domain validators.

Contents:

1. `ask_with_retry(prompt_fn, validator, max_retries=3, default_on_skip=None, field_name="value")`:
   - For each attempt (up to max_retries), call prompt_fn() to get raw string
   - If prompt_fn returns None (Ctrl+C), return default_on_skip immediately
   - Try validator(raw_string). On success, return validated value
   - On ValidationError or ValueError, print clear error message with remaining attempts
   - After max_retries exhausted, call `questionary.confirm(f"Skip {field_name}? (will use default: {default_on_skip})")`
   - If user confirms skip, return default_on_skip
   - If user declines skip, give one final attempt, then return default_on_skip on failure
   - Import questionary inside the function or at module level

2. `validate_currency(raw: str) -> float`:
   - Strip whitespace, remove leading "$", remove commas
   - Parse as float, reject negative values
   - Accept formats: "10000", "$10,000", "10000.50", "$10,000.50"
   - Raise ValueError with clear message on failure: "Enter a dollar amount like 10000 or $10,000.50"

3. `validate_percentage(raw: str) -> float`:
   - Strip whitespace, remove trailing "%"
   - Parse as float, reject values < 0 or > 100
   - Return the VALUE AS ENTERED (NOT divided by 100 -- the section runner handles decimal conversion because some fields want percentage and some want decimal)
   - Accept formats: "4.5", "4.5%", "0.5"
   - Raise ValueError: "Enter a percentage like 4.5 for 4.5%"

4. `validate_positive_integer(raw: str) -> int`:
   - Strip whitespace, parse as int, reject <= 0
   - Raise ValueError: "Enter a positive whole number"

5. `validate_non_empty(raw: str) -> str`:
   - Strip whitespace, reject empty string
   - Return stripped string
   - Raise ValueError: "This field cannot be empty"

All validators follow the pattern: take a raw string, return a typed value or raise ValueError.
  </action>
  <verify>
Run:
```bash
uv run python -c "from src.models.onboarding_inputs import OnboardingState, SectionName; s = OnboardingState.create_new(); print(f'State: {s.current_section}, sections: {len(SectionName)}'); assert len(SectionName) == 8"
uv run python -c "from src.utils.onboarding_validators import validate_currency, validate_percentage, validate_positive_integer; assert validate_currency('$10,000.50') == 10000.50; assert validate_percentage('4.5%') == 4.5; assert validate_positive_integer('3') == 3; print('All validators pass')"
```
Both commands exit 0 with expected output.
  </verify>
  <done>
OnboardingState model tracks wizard progress with 8 sections. All four domain validators correctly parse financial input formats. ask_with_retry wrapper exists with 3-retry-then-skip logic using questionary.confirm.
  </done>
</task>

<task type="auto">
  <name>Task 2: Eight section runner functions</name>
  <files>
    src/utils/onboarding_sections.py
  </files>
  <action>
Create `src/utils/onboarding_sections.py` with 8 section runner functions. Each function:
- Takes `OnboardingState` and returns updated `OnboardingState`
- Uses `ask_with_retry` from onboarding_validators for all validated prompts
- Uses `questionary.text()`, `questionary.select()`, `questionary.confirm()`, and `questionary.checkbox()` for prompts (individual calls, NOT questionary.prompt() dict API)
- Stores raw data in `state.data[section_name]` as a plain dict
- Calls `state.mark_complete(current, next)` on success
- Prints section headers with section number and name

**Section implementations (mirror the TypeScript scaffold for question flow):**

1. `run_liquid_assets_section(state) -> OnboardingState`:
   - Prompts: total liquid cash (currency), accounts count (integer), average yield (percentage -- divide by 100 when storing), account structure (optional text)
   - Store as: `{"total": float, "accounts_count": int, "average_yield": float_decimal, "structure": str_or_none}`
   - Next: investments

2. `run_investments_section(state) -> OnboardingState`:
   - Prompts: total portfolio value (currency), primary brokerage (text, optional), has retirement accounts (confirm), retirement value (currency, only if has_retirement), allocation strategy (select from AllocationStrategy values), risk tolerance (select from RiskTolerance values), Google Sheets ID (optional text), account number last 4 (optional text)
   - Store as dict matching InvestmentPortfolioInput fields
   - Next: cash_flow

3. `run_cash_flow_section(state) -> OnboardingState`:
   - Prompts: monthly after-tax income (currency), fixed monthly expenses (currency), variable monthly expenses (currency), current monthly savings (currency), monthly investment capacity (currency)
   - Store as dict matching CashFlowInput fields
   - Next: debt

4. `run_debt_section(state) -> OnboardingState`:
   - Prompts: has mortgage (confirm), mortgage balance + payment (currency, only if yes), has student loans (confirm), student loan balance + rate (currency + percentage, only if yes), has auto loans (confirm), auto loan balance + rate (only if yes), has credit cards (confirm), credit card balance (only if yes), weighted average debt rate (percentage, optional), other debt description (optional text)
   - Convert all percentage rates to decimal (divide by 100) when storing
   - Store as dict matching DebtProfileInput fields
   - Next: preferences

5. `run_preferences_section(state) -> OnboardingState`:
   - Prompts: investment philosophy (select from InvestmentPhilosophy values), focus areas (checkbox with choices: "Dividend income", "Growth investing", "Index investing", "Margin strategies", "Tax efficiency", "Real estate", "Options/hedging"), emergency fund target months (integer, 0-24 range)
   - Store as dict matching UserPreferencesInput fields
   - Next: broker

6. `run_broker_section(state) -> OnboardingState`:
   - This section collects broker-specific info. If brokerage was already provided in investments section, confirm or update it.
   - Prompts: primary brokerage name (text, pre-fill from investments if available), CSV export guidance note (just print info, no prompt needed)
   - Store as: `{"brokerage": str}` -- this supplements the investments data
   - Next: env_setup

7. `run_env_setup_section(state) -> OnboardingState`:
   - Prompts: user's name (text, required -- this is the key {user_name} used everywhere), preferred language (text, default "English"), has Alpha Vantage key (confirm), AV key (text, only if yes), has BrightData key (confirm), BD key (text, only if yes), Google Sheets credentials path (optional text)
   - All API keys are OPTIONAL -- make clear with messaging that skipping is fine, yfinance works without any keys
   - Store as dict with user_name, language, api key data
   - Next: summary

8. `run_summary_section(state) -> OnboardingState`:
   - Does NOT prompt for new data
   - Prints formatted summary of ALL collected data from state.data (currency formatted, percentages displayed nicely)
   - Asks questionary.confirm: "Save this profile and generate configuration files?"
   - If confirmed: mark complete, print success message
   - If declined: ask if restart from beginning (clear state) or keep for later
   - Store: `{"confirmed": bool}`
   - Next: None (end of wizard)

**Important implementation notes:**
- Import enums (RiskTolerance, AllocationStrategy, InvestmentPhilosophy) from yaml_generation_inputs.py for select choices. Present them as human-readable labels but store as enum values.
- For select prompts, use `questionary.select("Question", choices=[...]).ask()`. The choices should be human-readable strings, then map back to enum values.
- For questionary calls inside ask_with_retry, wrap with lambda: `prompt_fn=lambda: questionary.text("Your question").ask()`
- Handle None returns from .ask() (Ctrl+C) gracefully in every section -- return state as-is without marking complete.
- Print section headers: `"Section N of 8: Section Name"` with separator lines.
  </action>
  <verify>
Run:
```bash
uv run python -c "
from src.utils.onboarding_sections import (
    run_liquid_assets_section, run_investments_section,
    run_cash_flow_section, run_debt_section,
    run_preferences_section, run_broker_section,
    run_env_setup_section, run_summary_section
)
print('All 8 section runners imported successfully')
"
```
Exits 0 with "All 8 section runners imported successfully".

Also verify the module has no syntax errors:
```bash
uv run python -m py_compile src/utils/onboarding_sections.py
```
Exits 0 (no output means success).
  </verify>
  <done>
All 8 section runner functions exist in onboarding_sections.py. Each uses ask_with_retry for validated prompts, questionary for interactive input, and stores raw data in OnboardingState.data. Question flow mirrors the TypeScript scaffold. Enum values from yaml_generation_inputs.py are used for select choices. Percentage-to-decimal conversion happens at collection time for rate fields.
  </done>
</task>

</tasks>

<verification>
All three new files compile without errors:
```bash
uv run python -m py_compile src/models/onboarding_inputs.py
uv run python -m py_compile src/utils/onboarding_validators.py
uv run python -m py_compile src/utils/onboarding_sections.py
```

Existing tests still pass (no regressions from adding questionary dependency or new files):
```bash
uv run pytest tests/python/ -x -q
```
</verification>

<success_criteria>
1. questionary is installed (appears in pyproject.toml dependencies)
2. OnboardingState model has 8 SectionName values and tracks progress correctly
3. validate_currency parses "$10,000.50" to 10000.50 and rejects "abc"
4. validate_percentage parses "4.5%" to 4.5 and rejects "101"
5. ask_with_retry function exists with max_retries=3 and questionary.confirm skip logic
6. All 8 section runner functions are importable from onboarding_sections
7. Section runners use questionary (text, select, confirm, checkbox) for prompts
8. No modifications to existing yaml_generation_inputs.py or yaml_generator.py
9. Existing pytest suite passes without regressions
</success_criteria>

<output>
After completion, create `.planning/phases/03-onboarding-wizard/03-01-SUMMARY.md`
</output>
