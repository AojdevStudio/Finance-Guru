---
phase: 12-maya-integration-polish-cli
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/explorer/template/explorer.ts
  - src/explorer/template/template.html
  - .claude/commands/fin-guru/agents/teaching-specialist.md
  - fin-guru/tasks/build-learner-profile.md
autonomous: true

must_haves:
  truths:
    - "Clicking 'Export Profile' in any explorer downloads a JSON file matching Maya's learner_profile schema"
    - "Exported JSON contains topic ID, assessed_at timestamp, knowledge_state grouped by level, learning_mode_preference, suggested_teaching_order, and maya_integration section"
    - "Maya agent reads the exported learner profile at session start if the file exists in fin-guru/data/"
    - "Maya greets returning users with personalized context from the exported profile"
    - "If no learner profile file exists, Maya continues with default behavior (no crash)"
  artifacts:
    - path: "src/explorer/template/explorer.ts"
      provides: "exportLearnerProfile() function that builds Maya-compatible JSON and triggers download"
      contains: "exportLearnerProfile, learner_profile, assessed_at, knowledge_state, maya_integration"
    - path: "src/explorer/template/template.html"
      provides: "Export Profile button in header action area"
      contains: "export-profile-btn"
    - path: ".claude/commands/fin-guru/agents/teaching-specialist.md"
      provides: "Updated Maya agent that checks for and loads learner profile JSON"
      contains: "learner-profile.json, fin-guru/data"
    - path: "fin-guru/tasks/build-learner-profile.md"
      provides: "Updated profile task that incorporates explorer-exported profiles"
      contains: "learner-profile.json, explorer-exported"
  key_links:
    - from: "src/explorer/template/explorer.ts"
      to: "fin-guru/data/learner-profile.json"
      via: "exportLearnerProfile() creates JSON matching Maya's expected schema"
      pattern: "learner_profile.*knowledge_state"
    - from: ".claude/commands/fin-guru/agents/teaching-specialist.md"
      to: "fin-guru/data/learner-profile.json"
      via: "Activation step checks for file existence and loads if present"
      pattern: "learner-profile\\.json"
---

<objective>
Add Maya learner profile export to the explorer template and update Maya's agent definition to read exported profiles at session start.

Purpose: Close the loop between the explorer (browser-side self-assessment) and Maya (CLI-side teaching). Users self-assess in the explorer, export their profile, and Maya picks up where they left off. Covers EXPL-07 and EXPL-13.
Output: Enhanced template files with export functionality + updated Maya agent definition.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-self-assessment-persistence-topics/11-02-PLAN.md

Phase 11 plan 02 provides the template structure this plan modifies (explorer.ts, template.html).
Phase 11 adds localStorage persistence and 4-state knowledge cycling -- this plan builds the export on top of that persisted state.

Key reference for learner_profile schema (from spec):
```json
{
  "learner_profile": {
    "topic": "dividend-strategy",
    "assessed_at": "2026-02-02T15:30:00Z",
    "knowledge_state": {
      "unknown": ["drip-nav", "nav-arb", "put-insurance"],
      "familiar": ["three-bucket", "flywheel", "spread"],
      "confident": [],
      "mastered": ["mindset", "compound", "fire"]
    },
    "learning_mode_preference": "guided",
    "suggested_teaching_order": ["three-bucket", "flywheel", "spread", "drip-nav", "nav-arb", "put-insurance"],
    "estimated_sessions": 3,
    "maya_integration": {
      "skip_concepts": ["mindset", "compound", "fire"],
      "start_with": "three-bucket",
      "depth_needed": {
        "familiar": "review_and_reinforce",
        "unknown": "full_teaching_workflow"
      }
    }
  }
}
```

Maya agent definition: `.claude/commands/fin-guru/agents/teaching-specialist.md`
Maya profile task: `fin-guru/tasks/build-learner-profile.md`

Cross-cutting: XC-02 (integration through files -- JSON export, not cross-language imports)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add learner profile export to explorer template</name>
  <files>src/explorer/template/explorer.ts, src/explorer/template/template.html</files>
  <action>
Add a Maya learner profile export feature to the explorer template that produces a JSON file matching Maya's learner_profile schema.

**In template.html, add:**

1. **Export Profile button** in the header action area (near the existing Export/Copy buttons):
   ```html
   <button id="export-profile-btn" class="action-btn" title="Export knowledge profile for Maya teaching sessions">Export Profile</button>
   ```
   Place after the existing export-btn. Use a distinct ID (`export-profile-btn`) to differentiate from the Phase 11 `export-btn` (which exports raw localStorage progress). This button exports a structured Maya-compatible learner profile.

**In explorer.ts, add:**

2. **`buildLearnerProfile()` function** that constructs the Maya-compatible JSON:
   ```typescript
   function buildLearnerProfile(): object {
     const topicId = TOPIC_DATA.metadata.slug;
     const nodes = TOPIC_DATA.nodes;

     // Group node IDs by current knowledge state
     const knowledgeState: Record<string, string[]> = {
       unknown: [],
       familiar: [],
       confident: [],
       mastered: []
     };

     for (const node of nodes) {
       const state = getNodeKnowledge(node.id); // from Phase 11 state management
       if (state in knowledgeState) {
         knowledgeState[state].push(node.id);
       }
     }

     // Build suggested teaching order: familiar concepts first (review), then unknown (teach)
     const teachingOrder = [
       ...knowledgeState.familiar,
       ...knowledgeState.unknown
     ];

     // Estimate sessions: ~5 concepts per session, minimum 1
     const conceptsToTeach = knowledgeState.familiar.length + knowledgeState.unknown.length;
     const estimatedSessions = Math.max(1, Math.ceil(conceptsToTeach / 5));

     // Determine start_with: first familiar concept if any, else first unknown
     const startWith = knowledgeState.familiar[0] || knowledgeState.unknown[0] || null;

     return {
       learner_profile: {
         topic: topicId,
         assessed_at: new Date().toISOString(),
         knowledge_state: knowledgeState,
         learning_mode_preference: getCurrentLearningMode(), // from Phase 11
         suggested_teaching_order: teachingOrder,
         estimated_sessions: estimatedSessions,
         maya_integration: {
           skip_concepts: [...knowledgeState.confident, ...knowledgeState.mastered],
           start_with: startWith,
           depth_needed: {
             familiar: "review_and_reinforce",
             unknown: "full_teaching_workflow"
           }
         }
       }
     };
   }
   ```

3. **`exportLearnerProfile()` function** that triggers the JSON download:
   ```typescript
   function exportLearnerProfile(): void {
     const profile = buildLearnerProfile();
     const json = JSON.stringify(profile, null, 2);
     const blob = new Blob([json], { type: 'application/json' });
     const url = URL.createObjectURL(blob);

     const a = document.createElement('a');
     a.href = url;
     a.download = 'learner-profile.json'; // Fixed filename for Maya to find
     document.body.appendChild(a);
     a.click();
     document.body.removeChild(a);
     URL.revokeObjectURL(url);

     // Visual feedback
     const btn = document.getElementById('export-profile-btn');
     if (btn) {
       const original = btn.textContent;
       btn.textContent = 'Exported!';
       setTimeout(() => { btn.textContent = original; }, 1500);
     }
   }
   ```

4. **Wire the button** in the DOMContentLoaded handler:
   ```typescript
   document.getElementById('export-profile-btn')?.addEventListener('click', exportLearnerProfile);
   ```

5. **Helper functions** (if not already present from Phase 11):
   - `getNodeKnowledge(nodeId: string): string` -- returns the current knowledge state for a node ID from the Cytoscape graph or internal state map
   - `getCurrentLearningMode(): string` -- returns the active learning mode ('guided', 'standard', or 'yolo')
   - These should already exist from Phase 11's localStorage persistence and learning mode features. If they exist under different names, use the existing function names.

**IMPORTANT constraints:**
- The download filename MUST be `learner-profile.json` (not topic-specific) so Maya knows where to look
- The JSON structure MUST match the schema above exactly -- Maya parses specific keys
- Do NOT break any existing Phase 11 functionality (persistence, learning modes, clipboard, export progress)
- The `export-profile-btn` is SEPARATE from Phase 11's `export-btn` (which exports raw progress)
- All code must work generically with any TOPIC_DATA -- no topic-specific logic
  </action>
  <verify>
1. Read explorer.ts and confirm:
   - `buildLearnerProfile` function exists and returns object with `learner_profile` key
   - `exportLearnerProfile` function exists and creates Blob download
   - `learner_profile.knowledge_state` has 4 keys: unknown, familiar, confident, mastered
   - `learner_profile.maya_integration` has skip_concepts, start_with, depth_needed
   - Button click handler is wired for `export-profile-btn`

2. Read template.html and confirm:
   - Button with id `export-profile-btn` exists
   - Existing export-btn is still present (not replaced)

3. Build check:
```bash
cd /Users/ossieirondi/Documents/Irondi-Household/family-office && bun build src/explorer/template/explorer.ts --outdir /tmp/build-check-12-01 --format iife --target browser 2>&1
```
  </verify>
  <done>
- Export Profile button exists in template HTML
- buildLearnerProfile() constructs Maya-compatible JSON with all required fields
- exportLearnerProfile() triggers browser download of learner-profile.json
- JSON structure matches the learner_profile schema exactly
- TypeScript compiles without errors
- No existing Phase 11 features broken
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Maya agent to read exported learner profile</name>
  <files>.claude/commands/fin-guru/agents/teaching-specialist.md, fin-guru/tasks/build-learner-profile.md</files>
  <action>
Update Maya Brooks (Teaching Specialist) agent definition and the build-learner-profile task to check for and incorporate explorer-exported learner profiles.

**In `.claude/commands/fin-guru/agents/teaching-specialist.md`, modify:**

1. **Update the activation sequence** to check for an exported learner profile before the existing activation steps. Add a new step between step 1 and step 2:

   Current activation:
   ```xml
   <step n="1">Load learner profile if exists (max 200 tokens)</step>
   <step n="2">Greet user with personalized context from profile if available</step>
   ```

   Updated activation:
   ```xml
   <step n="1">Load learner profile if exists (max 200 tokens)</step>
   <step n="1b">Check for explorer-exported profile: read `{project-root}/fin-guru/data/learner-profile.json` if it exists. Parse the `learner_profile` object. Extract: topic, knowledge_state (which concepts are mastered/confident/familiar/unknown), learning_mode_preference, maya_integration.start_with, and maya_integration.skip_concepts. This supplements or initializes the learner profile.</step>
   <step n="2">Greet user with personalized context from profile if available. If explorer profile was found, acknowledge: "I see you've assessed your knowledge of {topic} in the explorer. You're confident in {N} concepts and want to work on {M} concepts. Let's pick up from {start_with}."</step>
   ```

2. **Update the critical-actions** to include the explorer profile check:

   Add to critical-actions:
   ```xml
   <i>Check for explorer-exported learner profile at {project-root}/fin-guru/data/learner-profile.json</i>
   ```

3. **Add explorer integration section** after the learning-modes section:

   ```xml
   <explorer-integration>
     <profile-path>{project-root}/fin-guru/data/learner-profile.json</profile-path>
     <behavior>
       If learner-profile.json exists:
       - Parse as JSON, extract learner_profile object
       - Use knowledge_state to understand what user knows vs needs to learn
       - Use learning_mode_preference to set initial learning mode
       - Use maya_integration.skip_concepts to avoid re-teaching mastered concepts
       - Use maya_integration.start_with as the first concept to teach
       - Use maya_integration.depth_needed to calibrate: "review_and_reinforce" for familiar, "full_teaching_workflow" for unknown
       - Reference suggested_teaching_order for session planning

       If learner-profile.json does NOT exist:
       - Continue with default behavior (guided mode, progressive discovery)
       - Suggest: "Want to try the Knowledge Explorer first? Run `fin-guru explore {relevant-topic}` to self-assess."
     </behavior>
   </explorer-integration>
   ```

**In `fin-guru/tasks/build-learner-profile.md`, modify:**

4. **Add explorer profile import section** after the "Profile Initialization" section:

   Add a new subsection "1b. Explorer Profile Import":
   ```
   ### 1b. Explorer Profile Import

   IF explorer profile exists at {project-root}/fin-guru/data/learner-profile.json:
     - Read and parse the JSON file
     - Extract knowledge_state: map of concept IDs to knowledge levels
     - Extract learning_mode_preference: set as initial mode
     - Use maya_integration.skip_concepts to pre-populate "known" concepts
     - Use maya_integration.start_with as first teaching topic
     - Merge with any existing profile data (explorer data takes precedence for assessed concepts)
     - Log: "Imported knowledge assessment from Explorer for {topic}"
   ```

5. **Update Integration Points** section at the bottom to add:
   ```
   - **Knowledge Explorer**: Exports learner-profile.json to fin-guru/data/ for import
   ```

**IMPORTANT constraints:**
- Do NOT change Maya's personality, communication style, or menu commands
- Do NOT remove any existing activation steps -- only add the explorer profile check
- The profile path MUST be `{project-root}/fin-guru/data/learner-profile.json` (using the path variable)
- If the file doesn't exist, behavior MUST be identical to current behavior (graceful fallback)
- Keep changes minimal -- surgical additions, not rewrites
  </action>
  <verify>
1. Read teaching-specialist.md and confirm:
   - Activation includes step checking for learner-profile.json
   - Critical-actions includes explorer profile check
   - explorer-integration section exists with correct file path
   - Existing activation steps, persona, menu, and learning-modes sections are unchanged

2. Read build-learner-profile.md and confirm:
   - Section "1b. Explorer Profile Import" exists
   - Integration Points includes Knowledge Explorer reference
   - Existing sections are unchanged

3. Verify graceful fallback:
   - Both files explicitly state "if file does NOT exist, continue with default behavior"
  </verify>
  <done>
- Maya agent checks for learner-profile.json at session start
- If profile exists: Maya acknowledges assessment, uses knowledge state to personalize teaching
- If profile missing: Maya continues with default guided mode (no crash, no error)
- Build-learner-profile task incorporates explorer exports
- All existing Maya behavior is preserved
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. TypeScript compiles: `bun build src/explorer/template/explorer.ts --format iife --target browser` succeeds
2. Template HTML has export-profile-btn (separate from export-btn)
3. explorer.ts has buildLearnerProfile() with correct schema structure
4. teaching-specialist.md references learner-profile.json in activation and explorer-integration section
5. build-learner-profile.md has Explorer Profile Import subsection
6. Both agent files have graceful fallback when profile doesn't exist
</verification>

<success_criteria>
- Explorer template produces Maya-compatible learner profile JSON on Export Profile click
- Maya agent reads and uses exported profile at session start
- Integration is file-based (XC-02): JSON file in fin-guru/data/, no cross-language imports
- All changes are additive -- zero breakage of Phase 11 features or existing Maya behavior
</success_criteria>

<output>
After completion, create `.planning/phases/12-maya-integration-polish-cli/12-01-SUMMARY.md`
</output>
