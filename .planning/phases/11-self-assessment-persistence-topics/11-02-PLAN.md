---
phase: 11-self-assessment-persistence-topics
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/explorer/template/template.html
  - src/explorer/template/styles.css
  - src/explorer/template/explorer.ts
autonomous: true

must_haves:
  truths:
    - "Clicking a node cycles through 4 knowledge states (unknown -> familiar -> confident -> mastered) with distinct border colors (red -> amber -> blue -> green)"
    - "Knowledge state and learning mode persist in localStorage keyed by topic slug and survive page refresh"
    - "Legacy 3-state values (know/fuzzy/unknown) from Phase 10 are migrated to 4-state equivalents on load"
    - "Learning mode selector (Guided | Standard | YOLO) changes prompt complexity, vocabulary, and relationship count"
    - "Copy prompt button copies text to clipboard on Chrome, Safari, and Firefox including file:// protocol"
    - "Progress bar shows confident + mastered count as fraction and visual fill"
    - "Mobile viewport has responsive sidebar collapse and touch-action: none on graph container"
    - "JSON export fallback is available when localStorage is unavailable"
  artifacts:
    - path: "src/explorer/template/explorer.ts"
      provides: "Enhanced explorer application with persistence, 4-state cycling, learning modes, clipboard, mobile support"
      min_lines: 350
    - path: "src/explorer/template/template.html"
      provides: "Updated HTML template with mode selector, progress bar, export button, viewport meta"
      contains: "mode-selector"
    - path: "src/explorer/template/styles.css"
      provides: "Updated styles with 4-state colors, responsive layout, mode selector, progress bar"
      contains: "touch-action: none"
  key_links:
    - from: "src/explorer/template/explorer.ts"
      to: "localStorage"
      via: "Safe wrapper with version-keyed storage per topic slug"
      pattern: "fin-guru-explorer"
    - from: "src/explorer/template/explorer.ts"
      to: "src/explorer/template/template.html"
      via: "DOM element IDs for mode selector, progress bar, export button"
      pattern: "getElementById"
    - from: "src/explorer/template/template.html"
      to: "src/explorer/template/styles.css"
      via: "CSS classes for mode-btn, progress-bar, knowledge state colors"
      pattern: "mode-btn"
    - from: "src/explorer/template/explorer.ts"
      to: "navigator.clipboard.writeText"
      via: "Clipboard API with textarea fallback for file:// protocol"
      pattern: "clipboard.writeText"
---

<objective>
Enhance the Phase 10 template engine with interactive self-assessment features: 4-state knowledge cycling with localStorage persistence, learning mode selector, cross-browser clipboard copy, progress visibility, mobile responsive support, and JSON export fallback.

Purpose: This transforms the explorer from a single-session tool into a persistent learning tracker. Users can track their understanding of concepts across sessions, choose prompt complexity via learning modes, and use the explorer on mobile devices. These enhancements apply to ALL topics (dividend-strategy, options-greeks, risk-management) through the shared template engine.

Output: Updated explorer.ts (major feature additions), template.html (new UI elements), and styles.css (responsive layout and state colors).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-self-assessment-persistence-topics/11-CONTEXT.md
@.planning/phases/11-self-assessment-persistence-topics/11-RESEARCH.md
@.planning/phases/10-template-engine-dividend-topic-port/10-02-PLAN.md
@src/explorer/template/explorer.ts
@src/explorer/template/template.html
@src/explorer/template/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update template.html and styles.css with Phase 11 UI elements</name>
  <files>
    src/explorer/template/template.html
    src/explorer/template/styles.css
  </files>
  <action>
    **Step 1: Update template.html**

    Modify `src/explorer/template/template.html` with the following additions. Preserve ALL existing structure -- only ADD new elements and modify the stats section.

    1. **Viewport meta tag** -- Ensure this exists in `<head>`:
       ```html
       <meta name="viewport" content="width=device-width, initial-scale=1.0">
       ```

    2. **Learning mode selector** -- Add AFTER the stats div inside `.header-controls`:
       ```html
       <div class="mode-selector">
         <button class="mode-btn active" data-mode="guided" title="Step-by-step explanations">Guided</button>
         <button class="mode-btn" data-mode="standard" title="Balanced depth">Standard</button>
         <button class="mode-btn" data-mode="yolo" title="Dense, technical">YOLO</button>
       </div>
       ```
       Note: Default active mode is "guided" in HTML; the explorer.ts init will read from localStorage and may switch to a different mode.

    3. **Progress bar** -- Add BEFORE `.main` div (between header and main content):
       ```html
       <div class="progress-container">
         <div class="progress-bar">
           <div class="progress-fill" id="progress-fill"></div>
         </div>
         <span class="progress-text" id="progress-text">0/0 concepts progressed</span>
         <button class="progress-expand-btn" id="progress-expand-btn" title="Show breakdown">&#9660;</button>
         <div class="progress-breakdown" id="progress-breakdown" style="display: none;">
           <span class="breakdown-item unknown-bg"><strong id="breakdown-unknown">0</strong> unknown</span>
           <span class="breakdown-item familiar-bg"><strong id="breakdown-familiar">0</strong> familiar</span>
           <span class="breakdown-item confident-bg"><strong id="breakdown-confident">0</strong> confident</span>
           <span class="breakdown-item mastered-bg"><strong id="breakdown-mastered">0</strong> mastered</span>
         </div>
       </div>
       ```

    4. **Update stats section** -- Replace the 3-state stats with 4-state:
       ```html
       <div class="stats">
         <span class="stat stat-unknown" id="stat-unknown"><strong>0</strong> unknown</span>
         <span class="stat stat-familiar" id="stat-familiar"><strong>0</strong> familiar</span>
         <span class="stat stat-confident" id="stat-confident"><strong>0</strong> confident</span>
         <span class="stat stat-mastered" id="stat-mastered"><strong>0</strong> mastered</span>
       </div>
       ```

    5. **Update sidebar instructions** -- Change the cycling description:
       ```html
       <kbd>Click</kbd> a node to cycle knowledge: Unknown &rarr; Familiar &rarr; Confident &rarr; Mastered.
       <kbd>Drag</kbd> nodes to arrange. Use presets to focus. Choose a learning mode above.
       The prompt below updates live based on your gaps and selected mode.
       ```

    6. **Update action buttons** -- Replace 3-state set-all buttons with 4-state + Reset All:
       ```html
       <div class="action-row" id="action-buttons">
         <button class="action-btn" id="btn-layout">Auto-Layout</button>
         <button class="action-btn" id="btn-all-mastered">All Mastered</button>
         <button class="action-btn" id="btn-all-unknown">All Unknown</button>
         <button class="action-btn" id="btn-reset-all">Reset All</button>
         <button class="action-btn" id="btn-export">Export JSON</button>
       </div>
       ```

    7. **Update prompt panel copy button** -- Add an id if it doesn't have one. Also add the `onclick` will be wired in explorer.ts. Keep existing structure.

    8. **Last studied timestamp** -- Add below the prompt panel header:
       ```html
       <span class="last-studied" id="last-studied"></span>
       ```

    **Step 2: Update styles.css**

    Add the following CSS rules to `src/explorer/template/styles.css`. Preserve ALL existing styles -- only ADD new rules.

    1. **4-state knowledge badge colors** (update or add these):
       ```css
       .stat-unknown { color: #f85149; }
       .stat-familiar { color: #d29922; }
       .stat-confident { color: #58a6ff; }
       .stat-mastered { color: #3fb950; }

       .unknown-bg { background: rgba(248,81,73,0.15); color: #f85149; }
       .familiar-bg { background: rgba(210,153,34,0.15); color: #d29922; }
       .confident-bg { background: rgba(88,166,255,0.15); color: #58a6ff; }
       .mastered-bg { background: rgba(63,185,80,0.15); color: #3fb950; }
       ```

    2. **Touch-action on Cytoscape container**:
       ```css
       #cy {
         touch-action: none;
       }
       ```
       Add to the existing `#cy` rule (do not create a duplicate selector -- merge into the existing one).

    3. **Learning mode selector**:
       ```css
       .mode-selector {
         display: flex;
         gap: 4px;
         align-items: center;
       }
       .mode-btn {
         background: var(--surface);
         color: var(--text-secondary);
         border: 1px solid var(--border);
         border-radius: 6px;
         padding: 4px 12px;
         font-size: 12px;
         cursor: pointer;
         transition: all 0.15s ease;
       }
       .mode-btn:hover {
         border-color: var(--text-secondary);
       }
       .mode-btn.active {
         background: var(--accent);
         color: #fff;
         border-color: var(--accent);
       }
       ```

    4. **Progress bar**:
       ```css
       .progress-container {
         display: flex;
         align-items: center;
         gap: 8px;
         padding: 4px 16px;
         border-bottom: 1px solid var(--border);
         flex-wrap: wrap;
       }
       .progress-bar {
         flex: 1;
         min-width: 100px;
         max-width: 300px;
         height: 8px;
         background: var(--surface);
         border-radius: 4px;
         overflow: hidden;
       }
       .progress-fill {
         height: 100%;
         background: linear-gradient(90deg, #58a6ff, #3fb950);
         border-radius: 4px;
         transition: width 0.3s ease;
         width: 0%;
       }
       .progress-text {
         font-size: 12px;
         color: var(--text-secondary);
         white-space: nowrap;
       }
       .progress-expand-btn {
         background: none;
         border: none;
         color: var(--text-secondary);
         cursor: pointer;
         font-size: 10px;
         padding: 2px 4px;
       }
       .progress-breakdown {
         width: 100%;
         display: flex;
         gap: 8px;
         padding-top: 4px;
       }
       .breakdown-item {
         font-size: 11px;
         padding: 2px 8px;
         border-radius: 4px;
       }
       ```

    5. **Last studied timestamp**:
       ```css
       .last-studied {
         font-size: 11px;
         color: var(--text-secondary);
         margin-left: auto;
       }
       ```

    6. **Responsive layout (mobile)**:
       ```css
       @media (max-width: 768px) {
         .main {
           flex-direction: column;
         }
         .sidebar {
           width: 100%;
           max-height: 40vh;
           border-right: none;
           border-bottom: 1px solid var(--border);
           order: 1;
         }
         .graph-container {
           order: 0;
           min-height: 50vh;
         }
         .prompt-panel {
           order: 2;
         }
         .header-controls {
           flex-wrap: wrap;
           gap: 4px;
         }
         .mode-selector {
           width: 100%;
           justify-content: center;
         }
         .progress-container {
           flex-wrap: wrap;
         }
         .progress-bar {
           min-width: 80px;
         }
       }
       ```
  </action>
  <verify>
    ```bash
    # Verify new elements exist in template
    grep -q "mode-selector" src/explorer/template/template.html && echo "MODE_SELECTOR: OK" || echo "MODE_SELECTOR: MISSING"
    grep -q "progress-fill" src/explorer/template/template.html && echo "PROGRESS_BAR: OK" || echo "PROGRESS_BAR: MISSING"
    grep -q "stat-unknown" src/explorer/template/template.html && echo "4_STATE_STATS: OK" || echo "4_STATE_STATS: MISSING"
    grep -q "stat-mastered" src/explorer/template/template.html && echo "MASTERED_STAT: OK" || echo "MASTERED_STAT: MISSING"
    grep -q "btn-reset-all" src/explorer/template/template.html && echo "RESET_ALL: OK" || echo "RESET_ALL: MISSING"
    grep -q "btn-export" src/explorer/template/template.html && echo "EXPORT_BTN: OK" || echo "EXPORT_BTN: MISSING"
    grep -q "last-studied" src/explorer/template/template.html && echo "LAST_STUDIED: OK" || echo "LAST_STUDIED: MISSING"
    grep -q "viewport" src/explorer/template/template.html && echo "VIEWPORT: OK" || echo "VIEWPORT: MISSING"

    # Verify new CSS rules
    grep -q "touch-action: none" src/explorer/template/styles.css && echo "TOUCH_ACTION: OK" || echo "TOUCH_ACTION: MISSING"
    grep -q "mode-btn" src/explorer/template/styles.css && echo "MODE_CSS: OK" || echo "MODE_CSS: MISSING"
    grep -q "progress-fill" src/explorer/template/styles.css && echo "PROGRESS_CSS: OK" || echo "PROGRESS_CSS: MISSING"
    grep -q "max-width: 768px" src/explorer/template/styles.css && echo "RESPONSIVE: OK" || echo "RESPONSIVE: MISSING"
    grep -q "stat-mastered" src/explorer/template/styles.css && echo "STATE_COLORS: OK" || echo "STATE_COLORS: MISSING"

    # Verify injection points still exist (not accidentally removed)
    grep -q "__INJECT_CSS__" src/explorer/template/template.html && echo "INJECT_CSS: OK" || echo "INJECT_CSS: MISSING"
    grep -q "__INJECT_TOPIC_DATA__" src/explorer/template/template.html && echo "INJECT_DATA: OK" || echo "INJECT_DATA: MISSING"
    grep -q "__INJECT_APP_JS__" src/explorer/template/template.html && echo "INJECT_JS: OK" || echo "INJECT_JS: MISSING"
    ```
    All checks must print OK.
  </verify>
  <done>
    template.html updated with: viewport meta, mode selector (Guided/Standard/YOLO), progress bar with expandable breakdown, 4-state stats, updated action buttons (All Mastered, All Unknown, Reset All, Export JSON), last studied timestamp. styles.css updated with: 4-state colors, touch-action: none, mode selector styles, progress bar styles, responsive @media queries for mobile. All injection points preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update explorer.ts with persistence, 4-state cycling, learning modes, and clipboard</name>
  <files>src/explorer/template/explorer.ts</files>
  <action>
    Modify `src/explorer/template/explorer.ts` to add ALL Phase 11 features. This is the core logic task. Reference the RESEARCH.md architecture patterns for verified code examples.

    **IMPORTANT: Preserve all 14 Phase 10 features. Phase 11 ENHANCES -- it does not replace. The following changes are ADDITIVE except where explicitly noted as replacements (knowledge cycling, stats, prompt generation).**

    **Addition 1: Constants and types**

    Add near the top of the file:
    ```typescript
    // Phase 11: 4-state knowledge model
    const KNOWLEDGE_STATES = ['unknown', 'familiar', 'confident', 'mastered'] as const;
    type KnowledgeState = typeof KNOWLEDGE_STATES[number];

    const KNOWLEDGE_COLORS: Record<string, { ring: string; badge: string; text: string }> = {
      unknown:   { ring: '#f85149', badge: 'rgba(248,81,73,0.15)', text: '#f85149' },
      familiar:  { ring: '#d29922', badge: 'rgba(210,153,34,0.15)', text: '#d29922' },
      confident: { ring: '#58a6ff', badge: 'rgba(88,166,255,0.15)', text: '#58a6ff' },
      mastered:  { ring: '#3fb950', badge: 'rgba(63,185,80,0.15)', text: '#3fb950' },
    };

    // Legacy state migration map (Phase 10 -> Phase 11)
    const STATE_MIGRATION: Record<string, string> = {
      'know': 'mastered',
      'fuzzy': 'familiar',
      'unknown': 'unknown',
    };

    // Learning modes
    const LEARNING_MODES = {
      guided: {
        label: 'Guided',
        promptStyle: {
          prefix: "I'm a beginner learning about",
          unknownVerb: "Please explain from scratch",
          familiarVerb: "Please clarify with simple examples",
          confidentVerb: "Just confirm my understanding of",
          masteredVerb: "I've mastered",
          suffix: "Use analogies, concrete numbers, and build up step-by-step. Define any technical terms before using them.",
          maxRelationships: 4,
        },
      },
      standard: {
        label: 'Standard',
        promptStyle: {
          prefix: "I'm studying",
          unknownVerb: "I need to learn",
          familiarVerb: "I need deeper understanding of",
          confidentVerb: "I want to verify my knowledge of",
          masteredVerb: "I'm confident about",
          suffix: "Explain with practical examples and show how concepts connect. Include relevant formulas where applicable.",
          maxRelationships: 8,
        },
      },
      yolo: {
        label: 'YOLO',
        promptStyle: {
          prefix: "Advanced study of",
          unknownVerb: "Cover comprehensively",
          familiarVerb: "Deepen my understanding of",
          confidentVerb: "Challenge my assumptions about",
          masteredVerb: "Push beyond mastery of",
          suffix: "Be technical and precise. Include edge cases, mathematical foundations, and real-world failure modes. Skip introductory context.",
          maxRelationships: 12,
        },
      },
    } as const;

    let currentLearningMode = 'standard';
    ```

    **Addition 2: Safe localStorage wrapper (Pattern 1 from RESEARCH.md)**

    Add the complete localStorage wrapper:
    ```typescript
    const STORAGE_PREFIX = 'fin-guru-explorer';
    const STORAGE_VERSION = 'v1';

    function storageKey(topicId: string): string {
      return `${STORAGE_PREFIX}.${STORAGE_VERSION}.${topicId}`;
    }

    function isStorageAvailable(): boolean {
      const testKey = '__storage_test__';
      try {
        localStorage.setItem(testKey, 'test');
        localStorage.removeItem(testKey);
        return true;
      } catch {
        return false;
      }
    }

    const storageAvailable = isStorageAvailable();

    interface ExplorerState {
      version: string;
      topicId: string;
      knowledge: Record<string, string>;
      learningMode: string;
      updatedAt: number;
    }

    function saveState(topicId: string, knowledge: Record<string, string>, learningMode: string): boolean {
      if (!storageAvailable) return false;
      try {
        const data: ExplorerState = { version: STORAGE_VERSION, topicId, knowledge, learningMode, updatedAt: Date.now() };
        localStorage.setItem(storageKey(topicId), JSON.stringify(data));
        return true;
      } catch { return false; }
    }

    function loadState(topicId: string): ExplorerState | null {
      if (!storageAvailable) return null;
      try {
        const raw = localStorage.getItem(storageKey(topicId));
        if (!raw) return null;
        const data = JSON.parse(raw) as ExplorerState;
        if (data.version !== STORAGE_VERSION) return null;
        return data;
      } catch { return null; }
    }
    ```

    **Addition 3: Debounce utility (Pattern 6 from RESEARCH.md)**

    ```typescript
    function debounce<T extends (...args: any[]) => void>(fn: T, delay: number): T {
      let timer: ReturnType<typeof setTimeout>;
      return ((...args: any[]) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delay);
      }) as T;
    }

    const debouncedSave = debounce(() => {
      const knowledge: Record<string, string> = {};
      cy.nodes().forEach((node: any) => {
        knowledge[node.id()] = node.data('knowledge');
      });
      saveState(TOPIC_DATA.metadata.slug, knowledge, currentLearningMode);
    }, 500);
    ```

    **Replacement 4: Update Cytoscape style selectors for 4 knowledge states**

    In the Cytoscape initialization stylesheet array, REPLACE the 3-state knowledge border styles with 4-state:
    ```typescript
    { selector: 'node[knowledge = "unknown"]',   style: { 'border-color': '#f85149', 'border-width': 2.5 } },
    { selector: 'node[knowledge = "familiar"]',  style: { 'border-color': '#d29922', 'border-width': 2.5 } },
    { selector: 'node[knowledge = "confident"]', style: { 'border-color': '#58a6ff', 'border-width': 2.5 } },
    { selector: 'node[knowledge = "mastered"]',  style: { 'border-color': '#3fb950', 'border-width': 2.5 } },
    ```
    Also keep the legacy selectors for the initial render before migration runs:
    ```typescript
    { selector: 'node[knowledge = "know"]',  style: { 'border-color': '#3fb950', 'border-width': 2.5 } },
    { selector: 'node[knowledge = "fuzzy"]', style: { 'border-color': '#d29922', 'border-width': 2.5 } },
    ```

    **Replacement 5: Update knowledge cycling from 3-state to 4-state**

    REPLACE the existing `cy.on('tap', 'node', ...)` handler with 4-state cycling:
    ```typescript
    cy.on('tap', 'node', (evt: any) => {
      const node = evt.target;
      const current = node.data('knowledge') as string;
      const idx = KNOWLEDGE_STATES.indexOf(current as any);
      // If current state is legacy or unknown, start at 'unknown' (index 0)
      const currentIdx = idx >= 0 ? idx : 0;
      const next = KNOWLEDGE_STATES[(currentIdx + 1) % KNOWLEDGE_STATES.length];
      node.data('knowledge', next);
      debouncedSave();
      updateSidebar();
      updatePrompt();
      updateStats();
      updateProgress();
    });
    ```

    **Replacement 6: Update updateStats() for 4 states**

    REPLACE the existing `updateStats()` with:
    ```typescript
    function updateStats(): void {
      const visible = cy.nodes(':visible');
      const counts = { unknown: 0, familiar: 0, confident: 0, mastered: 0 };
      visible.forEach((node: any) => {
        const k = node.data('knowledge') as string;
        if (k in counts) counts[k as keyof typeof counts]++;
      });
      const el = (id: string) => document.getElementById(id);
      const setCount = (id: string, count: number) => {
        const e = el(id);
        if (e) e.querySelector('strong')!.textContent = String(count);
      };
      setCount('stat-unknown', counts.unknown);
      setCount('stat-familiar', counts.familiar);
      setCount('stat-confident', counts.confident);
      setCount('stat-mastered', counts.mastered);
    }
    ```

    **Addition 7: updateProgress() function**

    ```typescript
    function updateProgress(): void {
      const allNodes = cy.nodes(':visible');
      const total = allNodes.length;
      let progressed = 0;
      allNodes.forEach((node: any) => {
        const k = node.data('knowledge');
        if (k === 'confident' || k === 'mastered') progressed++;
      });
      const pct = total > 0 ? (progressed / total) * 100 : 0;
      const fill = document.getElementById('progress-fill');
      const text = document.getElementById('progress-text');
      if (fill) fill.style.width = `${pct}%`;
      if (text) text.textContent = `${progressed}/${total} concepts progressed`;

      // Update breakdown counts
      const counts = { unknown: 0, familiar: 0, confident: 0, mastered: 0 };
      allNodes.forEach((node: any) => {
        const k = node.data('knowledge') as string;
        if (k in counts) counts[k as keyof typeof counts]++;
      });
      ['unknown', 'familiar', 'confident', 'mastered'].forEach(state => {
        const el = document.getElementById(`breakdown-${state}`);
        if (el) el.textContent = String(counts[state as keyof typeof counts]);
      });
    }
    ```

    **Addition 8: Progress breakdown expand/collapse**

    In the init function, wire the expand button:
    ```typescript
    const expandBtn = document.getElementById('progress-expand-btn');
    const breakdown = document.getElementById('progress-breakdown');
    if (expandBtn && breakdown) {
      expandBtn.addEventListener('click', () => {
        const visible = breakdown.style.display !== 'none';
        breakdown.style.display = visible ? 'none' : 'flex';
        expandBtn.innerHTML = visible ? '&#9660;' : '&#9650;';
      });
    }
    ```

    **Addition 9: Learning mode selector initialization and wiring**

    ```typescript
    function initModeSelector(): void {
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const mode = (btn as HTMLElement).dataset.mode;
          if (mode && mode in LEARNING_MODES) {
            setLearningMode(mode);
          }
        });
      });
    }

    function setLearningMode(mode: string): void {
      currentLearningMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', (btn as HTMLElement).dataset.mode === mode);
      });
      debouncedSave();
      updatePrompt();
    }
    ```

    **Replacement 10: Update updatePrompt() for learning modes and 4 states**

    REPLACE the existing `updatePrompt()` with mode-aware prompt generation:
    ```typescript
    function updatePrompt(): void {
      const promptEl = document.getElementById('prompt-text');
      if (!promptEl) return;

      const mode = LEARNING_MODES[currentLearningMode as keyof typeof LEARNING_MODES] || LEARNING_MODES.standard;
      const style = mode.promptStyle;
      const visible = cy.nodes(':visible');

      const groups: Record<string, string[]> = { unknown: [], familiar: [], confident: [], mastered: [] };
      visible.forEach((node: any) => {
        const k = node.data('knowledge') as string;
        const label = node.data('label').replace(/\n/g, ' ');
        if (k in groups) groups[k].push(label);
        else groups['unknown'].push(label); // Legacy fallback
      });

      // Use topic intro if available
      const intro = TOPIC_DATA.promptTemplate?.intro || `${style.prefix} this topic.`;

      const sections: string[] = [intro, ''];

      if (groups.mastered.length > 0) {
        sections.push(`${style.masteredVerb}: ${groups.mastered.join(', ')}`);
      }
      if (groups.confident.length > 0) {
        sections.push(`${style.confidentVerb}: ${groups.confident.join(', ')}`);
      }
      if (groups.familiar.length > 0) {
        sections.push(`${style.familiarVerb}: ${groups.familiar.join(', ')}`);
      }
      if (groups.unknown.length > 0) {
        sections.push(`${style.unknownVerb}: ${groups.unknown.join(', ')}`);
      }

      // Add relevant edges (limited by mode)
      const relevantEdges: string[] = [];
      cy.edges(':visible').forEach((edge: any) => {
        const srcK = edge.source().data('knowledge');
        const tgtK = edge.target().data('knowledge');
        if (srcK !== 'mastered' || tgtK !== 'mastered') {
          const srcLabel = edge.source().data('label').replace(/\n/g, ' ');
          const tgtLabel = edge.target().data('label').replace(/\n/g, ' ');
          relevantEdges.push(`${srcLabel} ${edge.data('label')} ${tgtLabel}`);
        }
      });

      if (relevantEdges.length > 0) {
        const edgePrefix = TOPIC_DATA.promptTemplate?.edgePrefix || 'Key relationships:';
        sections.push('');
        sections.push(edgePrefix);
        relevantEdges.slice(0, style.maxRelationships).forEach(e => {
          sections.push(`- ${e}`);
        });
      }

      // Use topic outro + mode suffix
      const outro = TOPIC_DATA.promptTemplate?.outro || '';
      sections.push('');
      sections.push(style.suffix);
      if (outro) sections.push(outro);

      promptEl.textContent = sections.join('\n');
    }
    ```

    **Replacement 11: Update clipboard copy with fallback (Pattern 4 from RESEARCH.md)**

    REPLACE the existing copy handler with the dual clipboard approach:
    ```typescript
    function fallbackCopy(text: string): boolean {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      textarea.style.left = '-9999px';
      document.body.appendChild(textarea);
      textarea.select();
      textarea.setSelectionRange(0, 99999);
      let success = false;
      try { success = document.execCommand('copy'); } catch { success = false; }
      document.body.removeChild(textarea);
      return success;
    }

    async function copyPrompt(): Promise<void> {
      const text = document.getElementById('prompt-text')?.textContent || '';
      const btn = document.getElementById('copy-btn');
      if (!btn) return;
      let copied = false;
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          copied = true;
        }
      } catch {}
      if (!copied) { copied = fallbackCopy(text); }
      if (copied) {
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy'; }, 1500);
      }
    }
    ```
    Wire the copy button: `document.getElementById('copy-btn')?.addEventListener('click', () => copyPrompt());`
    IMPORTANT: Call `copyPrompt()` directly from the click handler (not wrapped in additional async chains) to preserve user gesture context for Clipboard API permission.

    **Addition 12: JSON export fallback (Pattern 7 from RESEARCH.md)**

    ```typescript
    function exportStateAsJSON(): void {
      const knowledge: Record<string, string> = {};
      cy.nodes().forEach((node: any) => {
        knowledge[node.id()] = node.data('knowledge');
      });
      const state = {
        topicId: TOPIC_DATA.metadata.slug,
        knowledge,
        learningMode: currentLearningMode,
        exportedAt: new Date().toISOString(),
      };
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${TOPIC_DATA.metadata.slug}-progress.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    ```
    Wire: `document.getElementById('btn-export')?.addEventListener('click', exportStateAsJSON);`

    **Addition 13: State migration + restore on init**

    Add a `migrateKnowledgeState()` function and call it after Cytoscape init:
    ```typescript
    function migrateKnowledgeState(value: string): string {
      if (KNOWLEDGE_STATES.includes(value as any)) return value;
      return STATE_MIGRATION[value] || 'unknown';
    }

    function restoreState(): void {
      // First: migrate initial TOPIC_DATA knowledge values (Phase 10 legacy)
      cy.batch(() => {
        cy.nodes().forEach((node: any) => {
          const current = node.data('knowledge');
          const migrated = migrateKnowledgeState(current);
          if (migrated !== current) {
            node.data('knowledge', migrated);
          }
        });
      });

      // Second: apply persisted localStorage state (overrides JSON defaults)
      const state = loadState(TOPIC_DATA.metadata.slug);
      if (state) {
        cy.batch(() => {
          for (const [nodeId, knowledge] of Object.entries(state.knowledge)) {
            const node = cy.getElementById(nodeId);
            if (node.length > 0) {
              const migrated = migrateKnowledgeState(knowledge);
              node.data('knowledge', migrated);
            }
          }
        });

        if (state.learningMode && state.learningMode in LEARNING_MODES) {
          setLearningMode(state.learningMode);
        }

        // Update last studied timestamp
        if (state.updatedAt) {
          updateLastStudied(state.updatedAt);
        }
      }

      updateSidebar();
      updatePrompt();
      updateStats();
      updateProgress();
    }
    ```

    **Addition 14: Last studied timestamp**

    ```typescript
    function updateLastStudied(timestamp: number): void {
      const el = document.getElementById('last-studied');
      if (!el) return;
      const diff = Date.now() - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      let text = '';
      if (days > 0) text = `Last studied: ${days} day${days > 1 ? 's' : ''} ago`;
      else if (hours > 0) text = `Last studied: ${hours} hour${hours > 1 ? 's' : ''} ago`;
      else if (minutes > 0) text = `Last studied: ${minutes} min ago`;
      else text = 'Last studied: just now';
      el.textContent = text;
    }
    ```

    **Replacement 15: Update action button handlers**

    Replace the old set-all and reset handlers:
    ```typescript
    document.getElementById('btn-all-mastered')?.addEventListener('click', () => {
      cy.batch(() => { cy.nodes(':visible').forEach((n: any) => n.data('knowledge', 'mastered')); });
      debouncedSave(); updateSidebar(); updatePrompt(); updateStats(); updateProgress();
    });

    document.getElementById('btn-all-unknown')?.addEventListener('click', () => {
      cy.batch(() => { cy.nodes(':visible').forEach((n: any) => n.data('knowledge', 'unknown')); });
      debouncedSave(); updateSidebar(); updatePrompt(); updateStats(); updateProgress();
    });

    document.getElementById('btn-reset-all')?.addEventListener('click', () => {
      cy.batch(() => { cy.nodes().forEach((n: any) => n.data('knowledge', 'unknown')); });
      // Clear localStorage for this topic
      if (storageAvailable) {
        try { localStorage.removeItem(storageKey(TOPIC_DATA.metadata.slug)); } catch {}
      }
      // Reset learning mode to standard
      setLearningMode('standard');
      // Show all nodes, re-run layout
      cy.nodes().show();
      cy.edges().show();
      cy.layout({ name: 'cose', animate: false, fit: true, padding: 40, nodeDimensionsIncludeLabels: true, randomize: true, idealEdgeLength: () => 120, nodeRepulsion: () => 8000, gravity: 0.25, numIter: 2000 }).run();
      updateSidebar(); updatePrompt(); updateStats(); updateProgress();
    });
    ```

    **Addition 16: Update sidebar node list for 4-state knowledge badges**

    Update the `updateSidebar()` function so knowledge badges reflect the 4-state model. The badge text and color should use `KNOWLEDGE_COLORS` for the current state. Clicking the badge should cycle through the 4 states (same as tapping the node).

    **Modification 17: Update initialization flow**

    Update the `DOMContentLoaded` handler to include new initialization steps. The sequence MUST be:
    1. Build category color map from TOPIC_DATA
    2. Transform TOPIC_DATA nodes/edges to Cytoscape elements
    3. Initialize Cytoscape with container, elements, style (including 4-state selectors), layout
    4. Render category legend
    5. Render preset buttons
    6. Render sidebar node list
    7. Bind event handlers (node tap, mouseover, mouseout, button clicks)
    8. **Initialize mode selector** (NEW)
    9. **Restore persisted state** (NEW -- MUST be after Cytoscape init completes)
    10. Update stats, prompt, and **progress** (includes new progress bar)

    CRITICAL: `restoreState()` MUST be called AFTER Cytoscape initialization and initial layout. This prevents the state-before-ready pitfall (RESEARCH.md Pitfall 6).
  </action>
  <verify>
    ```bash
    # File exists and has substantial content
    LINES=$(wc -l < src/explorer/template/explorer.ts)
    test "$LINES" -ge 350 && echo "LINES: OK ($LINES)" || echo "LINES: INSUFFICIENT ($LINES, need 350+)"

    # Compiles as IIFE
    bun build src/explorer/template/explorer.ts --format iife --target browser --outdir /tmp/explorer-check-11 2>&1 && echo "COMPILE: OK" || echo "COMPILE: FAIL"

    # Key patterns present
    grep -q "KNOWLEDGE_STATES" src/explorer/template/explorer.ts && echo "4_STATE: OK" || echo "4_STATE: MISSING"
    grep -q "localStorage" src/explorer/template/explorer.ts && echo "PERSISTENCE: OK" || echo "PERSISTENCE: MISSING"
    grep -q "LEARNING_MODES" src/explorer/template/explorer.ts && echo "MODES: OK" || echo "MODES: MISSING"
    grep -q "clipboard" src/explorer/template/explorer.ts && echo "CLIPBOARD: OK" || echo "CLIPBOARD: MISSING"
    grep -q "fallbackCopy" src/explorer/template/explorer.ts && echo "FALLBACK: OK" || echo "FALLBACK: MISSING"
    grep -q "migrateKnowledgeState" src/explorer/template/explorer.ts && echo "MIGRATION: OK" || echo "MIGRATION: MISSING"
    grep -q "debouncedSave" src/explorer/template/explorer.ts && echo "DEBOUNCE: OK" || echo "DEBOUNCE: MISSING"
    grep -q "exportStateAsJSON" src/explorer/template/explorer.ts && echo "EXPORT: OK" || echo "EXPORT: MISSING"
    grep -q "updateProgress" src/explorer/template/explorer.ts && echo "PROGRESS: OK" || echo "PROGRESS: MISSING"
    grep -q "fin-guru-explorer" src/explorer/template/explorer.ts && echo "STORAGE_KEY: OK" || echo "STORAGE_KEY: MISSING"
    grep -q "restoreState" src/explorer/template/explorer.ts && echo "RESTORE: OK" || echo "RESTORE: MISSING"
    grep -q "TOPIC_DATA" src/explorer/template/explorer.ts && echo "TOPIC_DATA: OK" || echo "TOPIC_DATA: MISSING"
    ```
    All checks must print OK. COMPILE: FAIL means TypeScript errors that must be fixed.
  </verify>
  <done>
    explorer.ts enhanced with all Phase 11 features: 4-state knowledge cycling (unknown/familiar/confident/mastered), safe localStorage persistence with version-keyed storage, legacy state migration, learning mode selector (guided/standard/yolo) with per-topic persistence, mode-aware prompt generation, cross-browser clipboard copy with file:// fallback, progress bar with expandable breakdown, JSON export fallback, debounced save, last studied timestamp. All Phase 10 features preserved. Compiles as IIFE without errors.
  </done>
</task>

</tasks>

<verification>
Complete plan verification:
```bash
# All 3 files modified
test -f src/explorer/template/explorer.ts && echo "explorer.ts: EXISTS" || echo "explorer.ts: MISSING"
test -f src/explorer/template/template.html && echo "template.html: EXISTS" || echo "template.html: MISSING"
test -f src/explorer/template/styles.css && echo "styles.css: EXISTS" || echo "styles.css: MISSING"

# explorer.ts compiles
bun build src/explorer/template/explorer.ts --format iife --target browser --outdir /tmp/verify-11-02 2>&1

# Template injection points preserved
grep -c "__INJECT_" src/explorer/template/template.html  # Must be >= 3

# Feature count check (key patterns)
echo "Features present:"
for pattern in "KNOWLEDGE_STATES" "localStorage" "LEARNING_MODES" "clipboard" "fallbackCopy" "migrateKnowledgeState" "debouncedSave" "exportStateAsJSON" "updateProgress" "restoreState" "mode-selector" "touch-action" "progress-fill" "max-width: 768px"; do
  grep -rq "$pattern" src/explorer/template/ && echo "  $pattern: YES" || echo "  $pattern: NO"
done
```
</verification>

<success_criteria>
1. explorer.ts compiles as IIFE targeting browser without errors, 350+ lines
2. 4-state knowledge cycling works: unknown -> familiar -> confident -> mastered -> unknown (wrapping)
3. localStorage wrapper with version-keyed storage per topic slug
4. State migration maps legacy values: know->mastered, fuzzy->familiar, unknown->unknown
5. Learning mode selector with 3 modes affecting prompt complexity and vocabulary
6. Clipboard copy uses navigator.clipboard.writeText with textarea fallback for file://
7. Progress bar shows confident+mastered count vs total with expandable breakdown
8. Mobile responsive layout with touch-action: none and @media queries
9. JSON export fallback available
10. Template injection points preserved (no regression on Phase 10 build pipeline)
</success_criteria>

<output>
After completion, create `.planning/phases/11-self-assessment-persistence-topics/11-02-SUMMARY.md`
</output>
