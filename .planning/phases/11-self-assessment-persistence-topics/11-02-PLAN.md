---
phase: 11-self-assessment-persistence-topics
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/explorer/template/explorer.ts
  - src/explorer/template/styles.css
  - src/explorer/template/template.html
autonomous: true

must_haves:
  truths:
    - "Clicking a concept node cycles through 4 knowledge states: unknown -> familiar -> confident -> mastered -> unknown"
    - "Knowledge states and learning mode persist in localStorage and survive page refresh"
    - "Learning mode selector shows 3 options (guided/standard/yolo) and changes prompt complexity and vocabulary"
    - "Copy prompt button copies text to clipboard on Chrome, Safari, and Firefox including file:// protocol"
    - "Canvas interactions work with touch (tap to cycle, drag nodes) and mouse equally"
    - "Sidebar collapses to bottom drawer on screens narrower than 768px"
    - "localStorage failure (private browsing, quota, file:// security) degrades silently without breaking the app"
    - "Legacy 3-state localStorage data migrates to 4-state model: know->mastered, fuzzy->familiar, unknown->unknown"
  artifacts:
    - path: "src/explorer/template/explorer.ts"
      provides: "Enhanced explorer application with persistence, 4-state cycling, learning modes, clipboard, and JSON export"
      contains: "saveState, loadState, KNOWLEDGE_STATES, LEARNING_MODES, copyPrompt, fallbackCopy, exportStateAsJSON, debouncedSave"
    - path: "src/explorer/template/styles.css"
      provides: "Enhanced styles with responsive layout, 4 knowledge state colors, mode selector, and touch-action"
      contains: "@media (max-width: 768px), .mode-selector, touch-action: none"
    - path: "src/explorer/template/template.html"
      provides: "Updated HTML shell with learning mode selector, export button, and viewport meta"
      contains: "mode-selector, export-btn, viewport"
  key_links:
    - from: "src/explorer/template/explorer.ts"
      to: "localStorage"
      via: "saveState/loadState with version-keyed storage per topic slug"
      pattern: "localStorage\\.(get|set)Item.*fin-guru-explorer"
    - from: "src/explorer/template/explorer.ts"
      to: "navigator.clipboard"
      via: "copyPrompt with mandatory textarea fallback for file:// protocol"
      pattern: "navigator\\.clipboard\\.writeText"
    - from: "src/explorer/template/explorer.ts"
      to: "Cytoscape.js"
      via: "cy.on('tap', 'node') for knowledge cycling, cy.batch() for bulk updates"
      pattern: "cy\\.on.*tap.*node"
    - from: "src/explorer/template/styles.css"
      to: "src/explorer/template/template.html"
      via: "CSS classes for mode selector, knowledge badges, and responsive breakpoint"
      pattern: "mode-selector|@media.*768"
---

<objective>
Enhance the Phase 10 template engine with localStorage persistence, 4-state knowledge cycling, learning mode selector, cross-browser clipboard copy, and responsive mobile layout.

Purpose: Deliver the core interaction loop for the knowledge explorer -- users can self-assess, persist progress, choose learning depth, copy prompts, and use the explorer on mobile devices. Covers EXPL-05 (persistence), EXPL-06 (learning modes), EXPL-08 (touch/mobile), EXPL-15 (clipboard), EXPL-16 (zero external deps).
Output: Enhanced template files that produce interactive explorers with persistence when built by the Phase 10 pipeline.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-self-assessment-persistence-topics/11-RESEARCH.md
@.planning/phases/10-template-engine-dividend-topic-port/10-RESEARCH.md

Phase 11 research provides verified code patterns for ALL features. Use them directly:
- Pattern 1: Safe localStorage wrapper with version-keyed storage
- Pattern 2: 4-state knowledge cycling via Cytoscape data
- Pattern 3: Learning mode prompt generation (guided/standard/yolo)
- Pattern 4: Cross-browser clipboard with mandatory fallback
- Pattern 5: Responsive sidebar with mobile touch
- Pattern 6: Debounced save utility
- Pattern 7: JSON export fallback

Key Phase 10 integration points:
- explorer.ts: Cytoscape.js app code with cy.on("tap", "node", ...), node.data("knowledge"), updateSidebar(), updatePrompt(), updateStats()
- template.html: DOM structure with #cy, #node-list, #prompt-text, #copy-btn, #stat-*, #preset-buttons
- styles.css: Dark theme CSS with CSS variables (--bg, --border, --accent)
- TOPIC_DATA: Global constant injected at build time with metadata.slug, nodes, edges, presets, promptTemplate

Phase 10 research confirms: Cytoscape.js 3.33.x Canvas renderer, CoSE layout, data-driven styling via selectors like node[knowledge = "know"]

Research Open Question 3 -- state migration: When loading localStorage data from Phase 10's 3-state model, map: "know" -> "mastered", "fuzzy" -> "familiar", "unknown" -> "unknown". Use STORAGE_VERSION to detect old formats.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add localStorage persistence, 4-state knowledge cycling, and state migration</name>
  <files>src/explorer/template/explorer.ts, src/explorer/template/styles.css</files>
  <action>
Modify Phase 10 template files to add persistence and upgrade the knowledge model. All code patterns are from 11-RESEARCH.md -- use them directly, do not invent alternatives.

**In explorer.ts, add these features IN ORDER:**

1. **Constants and types** (add near top, after imports):
   - `STORAGE_PREFIX = 'fin-guru-explorer'` and `STORAGE_VERSION = 'v1'`
   - `KNOWLEDGE_STATES = ['unknown', 'familiar', 'confident', 'mastered'] as const`
   - `KNOWLEDGE_COLORS` record mapping each state to ring/badge/text colors from research Pattern 2: unknown=#f85149, familiar=#d29922, confident=#58a6ff, mastered=#3fb950
   - `ExplorerState` interface: { version, topicId, knowledge: Record<string, string>, learningMode, updatedAt }
   - `currentLearningMode` variable initialized to `'standard'`

2. **Safe localStorage wrapper** (from research Pattern 1):
   - `storageKey(topicId)` returns `${STORAGE_PREFIX}.${STORAGE_VERSION}.${topicId}`
   - `isStorageAvailable()` with try/catch test write/read/remove -- catches ALL failure modes
   - `const storageAvailable = isStorageAvailable()` evaluated once at module load
   - `saveState(topicId, knowledge, learningMode)` serializes to localStorage, returns boolean, never throws
   - `loadState(topicId)` deserializes, checks version, returns ExplorerState | null, never throws
   - ALL localStorage access in try/catch -- zero throws on any storage failure

3. **State migration** in loadState (from research Open Question 3):
   - After parsing JSON, check each knowledge value in the state
   - Map legacy values: "know" -> "mastered", "fuzzy" -> "familiar"
   - "unknown" stays "unknown"
   - Any unrecognized value maps to "unknown"
   - This handles users who used the Phase 10 explorer and have localStorage with old values

4. **Debounced save** (from research Pattern 6):
   - `debounce<T>(fn, delay)` generic utility
   - `debouncedSave = debounce(() => { collect all node knowledge, call saveState }, 500)`

5. **4-state knowledge cycling** (from research Pattern 2):
   - Replace Phase 10's existing 3-state cycle with the new 4-state array
   - Find the existing `cy.on('tap', 'node', ...)` handler and update it:
     - Get current knowledge from `node.data('knowledge')`
     - Find index in KNOWLEDGE_STATES, advance by 1 (modulo length)
     - Set via `node.data('knowledge', next)` -- Cytoscape auto-refreshes styles
     - Call `debouncedSave()`, `updateSidebar()`, `updatePrompt()`, `updateStats()`
   - Update Cytoscape stylesheet to use 4 data-driven selectors instead of 3:
     - `node[knowledge = "unknown"]` -> border-color: #f85149
     - `node[knowledge = "familiar"]` -> border-color: #d29922
     - `node[knowledge = "confident"]` -> border-color: #58a6ff
     - `node[knowledge = "mastered"]` -> border-color: #3fb950
   - Also add backward compatibility selectors for legacy data:
     - `node[knowledge = "know"]` -> border-color: #3fb950 (same as mastered)
     - `node[knowledge = "fuzzy"]` -> border-color: #d29922 (same as familiar)

6. **Bulk state operations** (for preset buttons like "Set All Unknown"):
   - Wrap bulk `node.data()` calls in `cy.batch(() => { ... })` to limit to 1 redraw
   - Add "Set All" buttons for each knowledge state or an "All Unknown"/"All Mastered" pair

7. **State restore on load:**
   - After Cytoscape init + layout complete, call `loadState(TOPIC_DATA.metadata.slug)`
   - If state exists: apply knowledge to nodes in `cy.batch()`, set learning mode
   - If null: keep defaults (nodes start as whatever their JSON default is)
   - CRITICAL: Render graph first, apply persisted state after (research Pitfall 6)

8. **Stats display for 4 states:**
   - Update `updateStats()` to count and display: N unknown, N familiar, N confident, N mastered
   - Use the KNOWLEDGE_COLORS for stat badges

9. **JSON export fallback** (from research Pattern 7, EXPL-05):
   - `exportStateAsJSON()` function: collect knowledge map, create Blob, trigger download as `{slug}-progress.json`
   - Uses Blob + URL.createObjectURL + anchor click pattern
   - Always available as secondary action; more prominent when `!storageAvailable`

**In styles.css, add:**

10. **4 knowledge state CSS utility classes:**
    - `.knowledge-unknown`, `.knowledge-familiar`, `.knowledge-confident`, `.knowledge-mastered`
    - Each sets `--state-color` CSS variable to the corresponding color
    - Badge styling for sidebar concept list items

**CRITICAL: Do NOT break Phase 10 functionality.** This is additive. The graph, CoSE layout, sidebar, presets, tooltips, and basic prompt generation must all continue working. Do NOT remove any existing event handlers or DOM manipulation -- extend them.

**Anti-patterns from research to AVOID:**
- Do NOT save on every pointer move -- only on knowledge change + debounce
- Do NOT block initial render on localStorage load
- Do NOT use topic-specific JavaScript -- all code works generically via TOPIC_DATA
- Do NOT add custom pointer event listeners on #cy -- Cytoscape handles its own events
  </action>
  <verify>
Read explorer.ts and confirm these functions/constants exist:
- `KNOWLEDGE_STATES` with 4 entries
- `KNOWLEDGE_COLORS` with 4 entries
- `isStorageAvailable`, `saveState`, `loadState`
- `debouncedSave`
- `exportStateAsJSON`
- State migration mapping in loadState ("know" -> "mastered", "fuzzy" -> "familiar")
- `cy.batch()` usage for bulk operations
- Cytoscape stylesheet has 4 knowledge selectors + 2 legacy selectors

Build check (TypeScript compiles):
```bash
cd /Users/ossieirondi/Documents/Irondi-Household/family-office && bun build src/explorer/template/explorer.ts --outdir /tmp/build-check --format iife --target browser 2>&1
```
  </verify>
  <done>
- 4-state knowledge cycling works via Cytoscape tap events with auto-style refresh
- localStorage persistence saves/loads state with version-keyed keys per topic slug
- Legacy 3-state data migrates to 4-state (know->mastered, fuzzy->familiar, unknown->unknown)
- Storage failures degrade silently (app works without persistence)
- Debounced save prevents excessive writes (500ms)
- Bulk updates use cy.batch() for single-redraw performance
- JSON export fallback exists for environments without localStorage
- Stats display shows all 4 knowledge states with colors
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add learning mode selector, clipboard copy, and mobile responsive layout</name>
  <files>src/explorer/template/explorer.ts, src/explorer/template/styles.css, src/explorer/template/template.html</files>
  <action>
Add the remaining three features. Use research patterns directly.

**In template.html:**

1. **Learning mode selector** (place in header-controls, between presets and action buttons):
   ```html
   <div class="mode-selector">
     <button class="mode-btn" data-mode="guided" title="Step-by-step explanations with analogies">Guided</button>
     <button class="mode-btn active" data-mode="standard" title="Balanced depth with practical examples">Standard</button>
     <button class="mode-btn" data-mode="yolo" title="Dense, technical, no hand-holding">YOLO</button>
   </div>
   ```

2. **Export button** (near the existing copy button):
   ```html
   <button id="export-btn" class="action-btn" title="Download progress as JSON">Export</button>
   ```

3. **Viewport meta** (if not already present in head):
   ```html
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   ```

**In explorer.ts:**

4. **LEARNING_MODES object** (from research Pattern 3):
   - Three tiers: guided, standard, yolo
   - Each has: label, description, promptStyle object
   - Guided promptStyle: prefix "I'm a beginner learning about", unknownVerb "Please explain from scratch", familiarVerb "Please clarify with simple examples", confidentVerb "Just confirm my understanding of", suffix about analogies and step-by-step, maxRelationships 4
   - Standard promptStyle: prefix "I'm studying", unknownVerb "I need to learn", familiarVerb "I need deeper understanding of", confidentVerb "I want to verify my knowledge of", suffix about practical examples, maxRelationships 8
   - YOLO promptStyle: prefix "Advanced study of", unknownVerb "Cover comprehensively", familiarVerb "Deepen my understanding of", confidentVerb "Challenge my assumptions about", suffix about edge cases and mathematical foundations, maxRelationships 12

5. **setLearningMode(mode):**
   - Updates `currentLearningMode`
   - Toggles `.active` class on mode buttons
   - Calls `debouncedSave()` to persist
   - Calls `updatePrompt()` to regenerate with new mode

6. **initModeSelector():**
   - `document.querySelectorAll('.mode-btn').forEach(btn => btn.addEventListener('click', ...))`
   - On click: read `data-mode`, call `setLearningMode(mode)`
   - Called after DOMContentLoaded

7. **Prompt generation integration with learning modes:**
   - Modify the existing `updatePrompt()` function:
   - Use the active learning mode's `promptStyle` for vocabulary
   - For concepts in "unknown" state: use `unknownVerb`
   - For concepts in "familiar" state: use `familiarVerb` (or Phase 10's fuzzyPrefix as fallback)
   - For concepts in "confident" state: use `confidentVerb`
   - For "mastered" concepts: omit from the prompt (user already knows them) OR use a brief "confirmed" mention
   - Use `maxRelationships` to limit how many edges are included in the prompt
   - Compose: learning mode provides vocabulary + structure, TOPIC_DATA.promptTemplate provides domain-specific context (intro/outro)
   - This is the KEY integration: learning mode vocabulary + topic-specific context = personalized learning prompt

8. **copyPrompt() async function** (from research Pattern 4):
   - CRITICAL: navigator.clipboard.writeText DOES NOT WORK on file:// protocol
   - Try `navigator.clipboard.writeText(text)` first inside try/catch
   - On failure, call `fallbackCopy(text)`
   - `fallbackCopy(text)`: create hidden textarea, position fixed off-screen, select, execCommand('copy'), remove
   - On success: update copy button text to "Copied!" for 1500ms
   - IMPORTANT: Call copyPrompt DIRECTLY from click handler, not from nested async chain, to preserve user gesture context
   - Wire: `document.getElementById('copy-btn')?.addEventListener('click', () => copyPrompt())`

9. **Wire export button:**
   - `document.getElementById('export-btn')?.addEventListener('click', exportStateAsJSON)`

**In styles.css:**

10. **Mode selector styles:**
    ```css
    .mode-selector { display: flex; gap: 2px; background: var(--surface, #21262d); border-radius: 6px; padding: 2px; }
    .mode-btn { padding: 4px 10px; font-size: 12px; border: none; background: transparent; color: var(--text-muted, #8b949e); border-radius: 4px; cursor: pointer; transition: all 0.2s; }
    .mode-btn:hover { color: var(--text, #c9d1d9); }
    .mode-btn.active { background: var(--accent, #58a6ff); color: #000; font-weight: 600; }
    ```

11. **Responsive sidebar** (from research Pattern 5):
    ```css
    #cy { touch-action: none; }

    @media (max-width: 768px) {
      .main { flex-direction: column; }
      .sidebar { width: 100%; max-height: 40vh; border-right: none; border-bottom: 1px solid var(--border); order: 1; }
      .graph-container { order: 0; min-height: 50vh; }
      .prompt-panel { order: 2; }
      .header-controls { flex-wrap: wrap; gap: 4px; }
      .mode-selector { width: 100%; justify-content: center; }
    }
    ```

**Anti-patterns from research to AVOID:**
- Do NOT mix touch + pointer event listeners on same element
- Do NOT call clipboard.writeText from inside a promise chain -- call directly in click handler
- Do NOT add custom pointerdown/pointermove on #cy -- Cytoscape manages its own input
- Do NOT reference specific topic concept IDs -- everything works generically via TOPIC_DATA
  </action>
  <verify>
Read explorer.ts and confirm:
- `LEARNING_MODES` object with guided/standard/yolo tiers
- `setLearningMode` function toggles active class and regenerates prompt
- `copyPrompt` async function with try/catch around clipboard API
- `fallbackCopy` function using textarea approach
- `updatePrompt()` integrates learning mode vocabulary + maxRelationships
- Mode button + export button click handlers wired

Read template.html and confirm:
- Mode selector div with 3 buttons exists
- Export button exists
- Viewport meta tag present

Read styles.css and confirm:
- `.mode-selector` and `.mode-btn` styles
- `#cy { touch-action: none; }`
- `@media (max-width: 768px)` responsive rules

Build check:
```bash
cd /Users/ossieirondi/Documents/Irondi-Household/family-office && bun build src/explorer/template/explorer.ts --outdir /tmp/build-check-2 --format iife --target browser 2>&1
```
  </verify>
  <done>
- Learning mode selector with 3 tiers renders in header and persists selection
- Prompt generation uses mode vocabulary (unknownVerb, familiarVerb, confidentVerb) and respects maxRelationships
- Copy button uses navigator.clipboard.writeText with mandatory textarea fallback for file://
- Export button triggers JSON download of progress
- Responsive sidebar collapses to bottom on mobile (< 768px)
- Cytoscape container has touch-action: none for gesture conflict prevention
- All features work generically with any topic JSON (no topic-specific code)
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. TypeScript compiles: `bun build src/explorer/template/explorer.ts --format iife --target browser` succeeds
2. No topic-specific references: `grep -r "delta\|sharpe\|dividend" src/explorer/template/` returns zero matches (all topic references are in topic JSONs, not template code)
3. All 7 research patterns implemented: localStorage wrapper, 4-state cycling, learning modes, clipboard copy+fallback, responsive sidebar, debounced save, JSON export
4. State migration handles Phase 10 legacy data: know->mastered, fuzzy->familiar
5. Requirements covered: EXPL-05 (localStorage + JSON export fallback), EXPL-06 (learning modes), EXPL-08 (touch + responsive), EXPL-15 (clipboard + fallback), EXPL-16 (zero external runtime deps)
</verification>

<success_criteria>
- Template engine produces explorers with persistent knowledge tracking across page refreshes
- 4 knowledge states cycle correctly via Cytoscape tap events with auto-style refresh
- 3 learning modes produce meaningfully different prompts (vocabulary, structure, relationship limits)
- Clipboard copy works on HTTPS, localhost, AND file:// protocol (via fallback)
- Explorer is usable on mobile (responsive layout, touch interactions via Cytoscape)
- Legacy Phase 10 localStorage data migrates correctly to Phase 11 4-state model
- Zero new external runtime dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/11-self-assessment-persistence-topics/11-02-SUMMARY.md`
</output>
