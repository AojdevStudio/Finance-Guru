---
phase: 11-self-assessment-persistence-topics
plan: 03
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified:
  - src/explorer/dist/dividend-strategy-explorer.html
  - src/explorer/dist/options-greeks-explorer.html
  - src/explorer/dist/risk-management-explorer.html
autonomous: false

must_haves:
  truths:
    - "All 3 explorers (dividend, options-greeks, risk-management) build successfully from the enhanced template + topic JSONs"
    - "Each built explorer is a single standalone HTML file with zero external script or stylesheet references"
    - "Each explorer loads in under 1 second from local filesystem (EXPL-16)"
    - "Knowledge state cycling persists after page refresh in each explorer (EXPL-05)"
    - "Learning mode selector changes prompt vocabulary and relationship count (EXPL-06)"
    - "Copy prompt button copies text to clipboard including on file:// protocol (EXPL-15)"
    - "Explorer layout is responsive and usable on mobile viewport (EXPL-08)"
  artifacts:
    - path: "src/explorer/dist/dividend-strategy-explorer.html"
      provides: "Rebuilt dividend explorer with Phase 11 enhancements (4-state, persistence, modes)"
      min_lines: 100
    - path: "src/explorer/dist/options-greeks-explorer.html"
      provides: "Options Greeks knowledge explorer with 20 financial concepts"
      min_lines: 100
    - path: "src/explorer/dist/risk-management-explorer.html"
      provides: "Risk Management knowledge explorer with 20 financial concepts"
      min_lines: 100
  key_links:
    - from: "src/explorer/build.ts"
      to: "src/explorer/topics/*.json"
      via: "Build pipeline reads topic JSON, validates against schema, injects into template, outputs standalone HTML"
      pattern: "build\\.ts.*\\.json"
    - from: "src/explorer/dist/*.html"
      to: "localStorage"
      via: "Embedded explorer.ts code persists knowledge state per topic slug"
      pattern: "fin-guru-explorer\\.v1"
---

<objective>
Build all 3 knowledge explorers using the Phase 10 build pipeline with Phase 11 enhanced template and topic data, then verify all success criteria through automated checks and human visual verification.

Purpose: Integration proof -- confirm that topic data (11-01) + enhanced template (11-02) produce working explorers with all Phase 11 features. This plan proves the phase delivers on its 5 success criteria.
Output: 3 standalone HTML explorer files in dist/, verified working by both automated checks and human testing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-self-assessment-persistence-topics/11-01-SUMMARY.md
@.planning/phases/11-self-assessment-persistence-topics/11-02-SUMMARY.md
@.planning/phases/10-template-engine-dividend-topic-port/10-RESEARCH.md

Plan 11-01 SUMMARY: Two topic JSONs (options-greeks, risk-management) created + Zod schema updated for 4-state model
Plan 11-02 SUMMARY: Template engine enhanced with localStorage persistence, 4-state cycling, learning modes, clipboard, responsive
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build all 3 explorers and run automated verification</name>
  <files>
    src/explorer/dist/dividend-strategy-explorer.html
    src/explorer/dist/options-greeks-explorer.html
    src/explorer/dist/risk-management-explorer.html
  </files>
  <action>
Run the Phase 10 build pipeline for all 3 topic JSON files. The build script validates topic data against the Zod schema and produces standalone HTML.

1. **Build all 3 explorers:**
```bash
cd /Users/ossieirondi/Documents/Irondi-Household/family-office

# Build dividend (rebuilt with Phase 11 template enhancements)
bun run src/explorer/build.ts src/explorer/topics/dividend-strategy.json

# Build options-greeks (new)
bun run src/explorer/build.ts src/explorer/topics/options-greeks.json

# Build risk-management (new)
bun run src/explorer/build.ts src/explorer/topics/risk-management.json
```

If any build fails, read the error output carefully:
- "Schema validation failed": check that topic JSON matches the Zod schema (knowledge values must be in the 7-value enum)
- "File not found": check file paths
- "TypeScript error": check explorer.ts for syntax issues introduced in 11-02
- Fix the root cause and re-run the failing build

2. **Verify all outputs exist:**
```bash
ls -la src/explorer/dist/*.html
```

3. **Verify standalone constraint (EXPL-16: zero external runtime dependencies):**
```bash
for f in src/explorer/dist/*.html; do
  echo "=== $(basename $f) ==="
  ext_scripts=$(grep -c '<script src=' "$f" 2>/dev/null || echo "0")
  ext_css=$(grep -c '<link.*href=.*\.css' "$f" 2>/dev/null || echo "0")
  echo "  External scripts: $ext_scripts (must be 0)"
  echo "  External CSS: $ext_css (must be 0)"
done
```
If any external references found: the build pipeline's inline logic is broken. Check build.ts.

4. **Verify file sizes are reasonable (performance budget):**
```bash
for f in src/explorer/dist/*.html; do
  size=$(wc -c < "$f" | tr -d ' ')
  kb=$((size / 1024))
  echo "$(basename $f): ${kb}KB"
  if [ "$size" -gt 1048576 ]; then
    echo "  WARNING: exceeds 1MB"
  fi
done
```
Expected: 400-700KB each (Cytoscape.js ~434KB minified + topic data + app code + CSS). Well under 1MB.

5. **Verify topic content is embedded:**
```bash
grep -l "Options Greeks Explorer" src/explorer/dist/options-greeks-explorer.html && echo "OK" || echo "MISSING"
grep -l "Risk Management Explorer" src/explorer/dist/risk-management-explorer.html && echo "OK" || echo "MISSING"
grep -l "Dividend" src/explorer/dist/dividend-strategy-explorer.html && echo "OK" || echo "MISSING"
```

6. **Verify Phase 11 features present in built output:**
```bash
for f in src/explorer/dist/*.html; do
  echo "=== $(basename $f) ==="
  echo "  localStorage: $(grep -c 'localStorage' "$f")"
  echo "  4-state: $(grep -c 'KNOWLEDGE_STATES\|unknown.*familiar.*confident.*mastered' "$f")"
  echo "  mode-selector: $(grep -c 'mode-selector' "$f")"
  echo "  clipboard: $(grep -c 'clipboard\|execCommand' "$f")"
  echo "  responsive: $(grep -c 'max-width.*768\|max-width: 768' "$f")"
  echo "  touch-action: $(grep -c 'touch-action' "$f")"
done
```
Each feature count must be >= 1 in every file.

7. **Verify concept counts in built output:**
```bash
# Options Greeks should have 20 concepts
grep -o '"id":"[^"]*"' src/explorer/dist/options-greeks-explorer.html | wc -l | tr -d ' '
# Risk Management should have 20 concepts
grep -o '"id":"[^"]*"' src/explorer/dist/risk-management-explorer.html | wc -l | tr -d ' '
```
  </action>
  <verify>
```bash
cd /Users/ossieirondi/Documents/Irondi-Household/family-office

# All 3 files exist
for name in dividend-strategy options-greeks risk-management; do
  test -f "src/explorer/dist/${name}-explorer.html" && echo "${name}: EXISTS" || echo "${name}: MISSING"
done

# Zero external dependencies
for f in src/explorer/dist/*.html; do
  ext=$(grep -c '<script src=\|<link.*href=.*\.css' "$f" 2>/dev/null || echo "0")
  echo "$(basename $f): external refs = $ext (must be 0)"
done

# Phase 11 features in every file
for f in src/explorer/dist/*.html; do
  storage=$(grep -c "localStorage" "$f")
  modes=$(grep -c "mode-selector" "$f")
  clip=$(grep -c "clipboard\|execCommand" "$f")
  resp=$(grep -c "max-width.*768\|max-width: 768" "$f")
  echo "$(basename $f): storage=$storage modes=$modes clipboard=$clip responsive=$resp (all must be >= 1)"
done
```
  </verify>
  <done>
- All 3 explorer HTML files exist in src/explorer/dist/
- Each is standalone (zero external script/CSS references)
- Each contains Phase 11 features (localStorage, 4-state, learning modes, clipboard, responsive)
- File sizes are reasonable (under 1MB each)
- Topic-specific content is embedded correctly
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Three standalone knowledge explorer HTML files with all Phase 11 interactive features:
1. **Dividend Strategy Explorer** -- rebuilt with 4-state knowledge cycling, persistence, learning modes
2. **Options Greeks Explorer** -- NEW, 20 financial concepts (delta, gamma, theta, vega, etc.)
3. **Risk Management Explorer** -- NEW, 20 financial concepts (VaR, Sharpe, position sizing, etc.)

Features to verify across all explorers:
- 4-state knowledge cycling (unknown/familiar/confident/mastered) with color-coded borders
- localStorage persistence (knowledge states survive page refresh)
- Learning mode selector (guided/standard/yolo changes prompt output)
- Copy prompt to clipboard
- Responsive mobile layout (sidebar collapses on narrow viewport)
- Sub-1-second load time
  </what-built>
  <how-to-verify>
**Open the Options Greeks Explorer first:**
```bash
open src/explorer/dist/options-greeks-explorer.html
```

**1. Knowledge cycling (SC-1):**
- Click the "Delta" node on the graph
- Watch the border color cycle: red (unknown) -> yellow (familiar) -> blue (confident) -> green (mastered) -> back to red
- Check the sidebar -- the concept's knowledge badge should update to match
- Click 3-4 different nodes to set them to different states

**2. Persistence (SC-1):**
- Note which nodes you changed and their current states
- Press Cmd+R (or F5) to refresh the page
- Verify the knowledge states are RESTORED to exactly what you set them to
- If states reset to defaults, persistence is broken

**3. Learning modes (SC-2):**
- Look at the header for the Guided / Standard / YOLO buttons
- Click "Guided" -- read the generated prompt in the prompt panel. It should use beginner language ("I'm a beginner learning about...", analogies)
- Click "YOLO" -- the prompt should use advanced language ("Advanced study of...", edge cases, mathematical foundations)
- Click "Standard" to return to default

**4. Copy prompt (SC-3):**
- Click the "Copy" button next to the prompt panel
- Open any text editor, paste (Cmd+V)
- Verify the prompt text was copied correctly
- The button should briefly show "Copied!" before reverting to "Copy"

**5. Mobile responsive (EXPL-08):**
- Open Chrome DevTools (Cmd+Option+I)
- Toggle device toolbar (Cmd+Shift+M)
- Select iPhone 14 Pro or similar
- Verify: graph canvas takes top area, sidebar collapses to a scrollable area below it
- Tap a node -- it should still cycle knowledge state

**6. Performance (SC-5):**
- Close the file and reopen it
- The graph should render fully within 1 second
- No loading spinners, no external network requests (check DevTools Network tab -- should show only the local file)

**7. Quick-check Risk Management Explorer:**
```bash
open src/explorer/dist/risk-management-explorer.html
```
- Verify concepts load (VaR, Sharpe Ratio, Max Drawdown, etc. should be visible)
- Click a node to confirm knowledge cycling works
- Confirm learning mode selector is present and functional

**8. Quick-check rebuilt Dividend Explorer:**
```bash
open src/explorer/dist/dividend-strategy-explorer.html
```
- Verify it still works with Phase 11 enhancements
- If you previously used the Phase 10 version, check that any old localStorage data was migrated (old "know" states should appear as "mastered" green)
  </how-to-verify>
  <resume-signal>Type "approved" if all features work correctly across all 3 explorers, or describe specific issues found.</resume-signal>
</task>

</tasks>

<verification>
Phase 11 success criteria mapped to verification:

| SC | Criterion | Verified By |
|----|-----------|-------------|
| SC-1 | Knowledge cycling persists after refresh | Human: click nodes, refresh, confirm states restored |
| SC-2 | Learning modes change prompt complexity | Human: switch modes, read prompt differences |
| SC-3 | Copy prompt works on Chrome/Safari/Firefox | Human: copy + paste test (Chrome minimum) |
| SC-4 | Options-greeks and risk-management explorers work | Automated: build succeeds + Human: concepts visible |
| SC-5 | Sub-1-second load, zero external deps | Automated: standalone check + Human: observe load time |

Requirement coverage:
- EXPL-05: localStorage + JSON export fallback -> SC-1 + automated localStorage grep
- EXPL-06: Learning modes -> SC-2
- EXPL-08: Touch/mobile support -> Human mobile viewport test
- EXPL-09a: Options-greeks topic -> SC-4 + concept count verification
- EXPL-09b: Risk-management topic -> SC-4 + concept count verification
- EXPL-15: Cross-browser clipboard -> SC-3
- EXPL-16: Zero external deps, sub-1s load -> SC-5
</verification>

<success_criteria>
- All 3 explorer HTML files build successfully from the pipeline
- Human verifies knowledge cycling + persistence, learning modes, clipboard, responsive layout, and load time
- All 5 Phase 11 success criteria from ROADMAP.md are satisfied
- All 7 Phase 11 requirements (EXPL-05, 06, 08, 09a, 09b, 15, 16) are delivered
</success_criteria>

<output>
After completion, create `.planning/phases/11-self-assessment-persistence-topics/11-03-SUMMARY.md`
</output>
