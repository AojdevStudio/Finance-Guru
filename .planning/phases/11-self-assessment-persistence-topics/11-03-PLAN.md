---
phase: 11-self-assessment-persistence-topics
plan: 03
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Build pipeline produces 3 standalone HTML files: dividend-strategy-explorer.html, options-greeks-explorer.html, risk-management-explorer.html"
    - "All 3 explorers have zero external dependencies (no CDN links, no script src, no link href)"
    - "All 3 explorers show 4-state knowledge cycling with correct colors and persistence"
    - "All 3 explorers have learning mode selector, progress bar, and copy prompt button"
    - "All 3 explorers load in under 1 second with zero external runtime dependencies"
    - "Human verification confirms all Phase 11 features work correctly across all topics"
  artifacts:
    - path: "src/explorer/dist/dividend-strategy-explorer.html"
      provides: "Rebuilt dividend explorer with Phase 11 features"
      contains: "KNOWLEDGE_STATES"
    - path: "src/explorer/dist/options-greeks-explorer.html"
      provides: "New options Greeks explorer with 20 concept nodes"
      contains: "options-greeks"
    - path: "src/explorer/dist/risk-management-explorer.html"
      provides: "New risk management explorer with 20 concept nodes"
      contains: "risk-management"
  key_links:
    - from: "src/explorer/build.ts"
      to: "src/explorer/topics/options-greeks.json"
      via: "Build pipeline validates and bundles options-greeks topic"
      pattern: "TopicSchema.safeParse"
    - from: "src/explorer/build.ts"
      to: "src/explorer/topics/risk-management.json"
      via: "Build pipeline validates and bundles risk-management topic"
      pattern: "TopicSchema.safeParse"
    - from: "src/explorer/dist/*.html"
      to: "src/explorer/template/explorer.ts"
      via: "All features bundled into each standalone HTML"
      pattern: "KNOWLEDGE_STATES"
---

<objective>
Build all 3 knowledge explorers using the Phase 10 build pipeline with Phase 11's enhanced template and new topic data, then verify all Phase 11 features through automated checks and human visual verification.

Purpose: This is the integration and verification plan. It confirms that the schema updates (Plan 01) and template enhancements (Plan 02) work together correctly through the existing build pipeline. Building all 3 explorers proves the template engine is truly reusable -- changing only the topic JSON produces a different explorer with all the same features.

Output: 3 standalone HTML explorer files in dist/, verified for correctness and performance.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-self-assessment-persistence-topics/11-CONTEXT.md
@.planning/phases/11-self-assessment-persistence-topics/11-RESEARCH.md
@.planning/phases/11-self-assessment-persistence-topics/11-01-SUMMARY.md
@.planning/phases/11-self-assessment-persistence-topics/11-02-SUMMARY.md
@src/explorer/build.ts
@src/explorer/schemas/topic-schema.ts
@src/explorer/template/explorer.ts
@src/explorer/template/template.html
@src/explorer/template/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build all 3 explorers and run automated verification</name>
  <files></files>
  <action>
    **Step 1: Build all 3 explorers**

    Run the build pipeline for each topic JSON:
    ```bash
    bun run src/explorer/build.ts src/explorer/topics/dividend-strategy.json
    bun run src/explorer/build.ts src/explorer/topics/options-greeks.json
    bun run src/explorer/build.ts src/explorer/topics/risk-management.json
    ```

    All 3 builds must succeed. If any fails:
    - Check the error message from the build pipeline
    - Schema validation errors: fix the topic JSON (likely a Phase 11-01 issue)
    - Compilation errors: fix explorer.ts (likely a Phase 11-02 issue)
    - Template injection errors: fix template.html placeholder names

    **Step 2: Verify standalone (zero external dependencies)**

    For each generated HTML file:
    ```bash
    for explorer in dividend-strategy options-greeks risk-management; do
      FILE="src/explorer/dist/${explorer}-explorer.html"
      echo "=== ${explorer} ==="

      # Must exist
      test -f "$FILE" && echo "  EXISTS: OK" || echo "  EXISTS: FAIL"

      # No external script or link tags
      SCRIPTS=$(grep -c '<script src=' "$FILE" 2>/dev/null || echo 0)
      LINKS=$(grep -c '<link.*href=' "$FILE" 2>/dev/null || echo 0)
      test "$SCRIPTS" = "0" && echo "  NO_EXTERNAL_SCRIPTS: OK" || echo "  NO_EXTERNAL_SCRIPTS: FAIL ($SCRIPTS found)"
      test "$LINKS" = "0" && echo "  NO_EXTERNAL_CSS: OK" || echo "  NO_EXTERNAL_CSS: FAIL ($LINKS found)"

      # Contains bundled Cytoscape
      grep -q 'cytoscape' "$FILE" && echo "  CYTOSCAPE_BUNDLED: OK" || echo "  CYTOSCAPE_BUNDLED: FAIL"

      # Contains TOPIC_DATA
      grep -q 'TOPIC_DATA' "$FILE" && echo "  TOPIC_DATA_INJECTED: OK" || echo "  TOPIC_DATA_INJECTED: FAIL"

      # Contains Phase 11 features
      grep -q 'KNOWLEDGE_STATES' "$FILE" && echo "  4_STATE_CYCLING: OK" || echo "  4_STATE_CYCLING: FAIL"
      grep -q 'localStorage' "$FILE" && echo "  PERSISTENCE: OK" || echo "  PERSISTENCE: FAIL"
      grep -q 'LEARNING_MODES' "$FILE" && echo "  LEARNING_MODES: OK" || echo "  LEARNING_MODES: FAIL"
      grep -q 'fallbackCopy' "$FILE" && echo "  CLIPBOARD_FALLBACK: OK" || echo "  CLIPBOARD_FALLBACK: FAIL"

      # File size (expect ~400-700KB with bundled Cytoscape.js)
      SIZE=$(ls -lh "$FILE" | awk '{print $5}')
      echo "  FILE_SIZE: $SIZE"
    done
    ```

    **Step 3: Verify EXPL-16 performance (sub-1-second load)**

    The performance budget from RESEARCH.md:
    - File load from local disk: <10ms
    - HTML parse + CSS apply: <50ms
    - JS execute: <100ms
    - Cytoscape CoSE layout (20 nodes, animate: false): <100ms
    - Total: well under 1 second

    Verify file sizes are reasonable (sub-1MB per explorer):
    ```bash
    for explorer in dividend-strategy options-greeks risk-management; do
      SIZE_BYTES=$(wc -c < "src/explorer/dist/${explorer}-explorer.html")
      test "$SIZE_BYTES" -lt 1048576 && echo "${explorer}: ${SIZE_BYTES} bytes - UNDER 1MB" || echo "${explorer}: ${SIZE_BYTES} bytes - OVER 1MB (investigate)"
    done
    ```

    Note: All explorers have 20 nodes. With Cytoscape.js CoSE layout using `animate: false` and `numIter: 2000`, layout computation is <100ms on any modern device. The sub-1-second load target is met by design given zero external dependencies and moderate file sizes.

    **Step 4: Cross-plan wiring verification**

    Verify the TOPIC_DATA structure in each generated HTML matches what explorer.ts expects:
    ```bash
    for explorer in dividend-strategy options-greeks risk-management; do
      bun -e "
        const html = await Bun.file('./src/explorer/dist/${explorer}-explorer.html').text();
        const match = html.match(/const TOPIC_DATA = ({.*?});/s);
        if (!match) { console.error('${explorer}: WIRING FAIL - no TOPIC_DATA'); process.exit(1); }
        const data = JSON.parse(match[1]);
        const required = ['metadata','categories','nodes','edges','presets'];
        const missing = required.filter(k => !(k in data));
        if (missing.length) { console.error('${explorer}: WIRING FAIL - missing:', missing); process.exit(1); }
        const node = data.nodes[0];
        const nodeKeys = ['id','label','category','description','knowledge','tags'];
        const missingNode = nodeKeys.filter(k => !(k in node));
        if (missingNode.length) { console.error('${explorer}: WIRING FAIL - node missing:', missingNode); process.exit(1); }
        console.log('${explorer}: WIRING OK -', data.nodes.length, 'nodes,', data.metadata.slug);
      "
    done
    ```
    Expected output:
    - `dividend-strategy: WIRING OK - 21 nodes, dividend-strategy`
    - `options-greeks: WIRING OK - 20 nodes, options-greeks`
    - `risk-management: WIRING OK - 20 nodes, risk-management`

    **Step 5: Fix any issues**

    If any check fails, trace the issue:
    - Build error -> check schema validation output
    - Missing feature in HTML -> check that explorer.ts has the feature and compiles as IIFE
    - Wiring mismatch -> check that build.ts injects TOPIC_DATA correctly
    - External dependency detected -> check template.html has no CDN links

    Iterate until ALL checks pass.
  </action>
  <verify>
    ```bash
    # All 3 explorer files exist
    ls -lh src/explorer/dist/*-explorer.html

    # Count should be 3
    COUNT=$(ls src/explorer/dist/*-explorer.html 2>/dev/null | wc -l)
    test "$COUNT" = "3" && echo "FILE_COUNT: OK (3)" || echo "FILE_COUNT: FAIL ($COUNT)"

    # All standalone (total external deps = 0)
    TOTAL_EXTERNAL=0
    for f in src/explorer/dist/*-explorer.html; do
      TOTAL_EXTERNAL=$((TOTAL_EXTERNAL + $(grep -c '<script src=' "$f" 2>/dev/null || echo 0) + $(grep -c '<link.*href=' "$f" 2>/dev/null || echo 0)))
    done
    test "$TOTAL_EXTERNAL" = "0" && echo "STANDALONE: OK" || echo "STANDALONE: FAIL ($TOTAL_EXTERNAL external refs)"

    # All contain Phase 11 features
    MISSING=0
    for f in src/explorer/dist/*-explorer.html; do
      grep -q 'KNOWLEDGE_STATES' "$f" || MISSING=$((MISSING+1))
      grep -q 'LEARNING_MODES' "$f" || MISSING=$((MISSING+1))
      grep -q 'localStorage' "$f" || MISSING=$((MISSING+1))
    done
    test "$MISSING" = "0" && echo "FEATURES: OK" || echo "FEATURES: FAIL ($MISSING missing)"
    ```
    All checks must print OK.
  </verify>
  <done>
    3 standalone HTML explorer files generated. All contain bundled Cytoscape.js, Phase 11 features (4-state cycling, persistence, learning modes, clipboard fallback), and zero external dependencies. File sizes are under 1MB. TOPIC_DATA wiring verified for all 3 topics.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Three complete knowledge explorers with Phase 11 features: 4-state knowledge cycling with localStorage persistence, learning mode selector, cross-browser clipboard copy, progress bar, and mobile responsive layout. Generated by the Phase 10 build pipeline with enhanced template engine.
  </what-built>
  <how-to-verify>
    **Open all 3 explorers for testing:**
    ```bash
    open src/explorer/dist/dividend-strategy-explorer.html
    open src/explorer/dist/options-greeks-explorer.html
    open src/explorer/dist/risk-management-explorer.html
    ```

    **Test each explorer (start with options-greeks as the primary test):**

    1. **SC-1: 4-state knowledge cycling**
       - Click any concept node. It should cycle: unknown (red border) -> familiar (amber) -> confident (blue) -> mastered (green) -> unknown (wrapping).
       - Stats in the header should update with each click.
       - Progress bar should update (confident + mastered count toward progress).

    2. **SC-1: Persistence**
       - Set 3-4 nodes to different knowledge states. Note which nodes and states.
       - Refresh the page (Cmd+R / F5).
       - The knowledge states should be restored exactly as you left them.
       - The learning mode should also be restored.

    3. **SC-2: Learning modes**
       - Click "Guided" in the mode selector. Set a node to "unknown".
       - Read the prompt -- it should use beginner language ("Please explain from scratch").
       - Click "YOLO". The prompt should change to advanced language ("Cover comprehensively") with more relationship connections listed.
       - Click "Standard" -- balanced complexity.

    4. **SC-3: Copy prompt**
       - Generate a prompt by setting some nodes to different states.
       - Click "Copy" button in the prompt panel.
       - Paste in a text editor -- the full prompt text should be there.
       - Button should briefly show "Copied!" then revert.

    5. **SC-4: Options-greeks explorer**
       - Verify ~20 concept nodes are visible with 5 category colors.
       - Hover over "Delta" -- tooltip should show description about price sensitivity.
       - Preset filters: click "Core Greeks" -- should show only 5 core Greek nodes.
       - Click "All" to restore all nodes.

    6. **SC-4: Risk-management explorer**
       - Verify ~20 concept nodes are visible with 5 category colors.
       - Hover over "VaR" or "Sharpe Ratio" -- descriptions should be educational and detailed.
       - Preset filters: click "Risk Measurement" -- should show risk measurement nodes.
       - Prompt should reference Finance Guru CLI tools in outro.

    7. **SC-5: Performance**
       - All 3 explorers should load instantly (well under 1 second).
       - No loading spinners, no delayed rendering.
       - Open DevTools Network tab -- zero external requests.

    8. **Progress bar**
       - Set several nodes to "confident" and "mastered".
       - Progress bar should fill proportionally (e.g., "5/20 concepts progressed").
       - Click the expand arrow -- breakdown should show counts per state.

    9. **Reset All**
       - Click "Reset All" button.
       - All nodes should return to "unknown" (red borders).
       - Progress bar should reset to 0.
       - Refresh page -- states should be cleared (localStorage removed).

    10. **Cross-topic isolation**
        - In options-greeks: set some nodes to mastered.
        - Switch to risk-management tab -- nodes should all be unknown (fresh topic).
        - Switch back to options-greeks -- your mastered states should still be there.

    11. **Dividend strategy backward compatibility**
        - Open the dividend explorer.
        - If this is the first time opening after Phase 11 rebuild, nodes should appear as "familiar" (migrated from "fuzzy").
        - All 14 Phase 10 features should still work (hover tooltips, edge highlights, preset filters, auto-layout, drag).

    12. **Mobile/responsive (optional)**
        - Resize browser to mobile width (<768px).
        - Sidebar should move below the graph.
        - Mode selector should center and wrap.
  </how-to-verify>
  <resume-signal>Type "approved" if all features work correctly across all 3 explorers, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Complete Phase 11 verification:
```bash
echo "=== Phase 11 Verification ==="

# 3 explorer files exist
ls -lh src/explorer/dist/*-explorer.html
echo ""

# All standalone
echo "Standalone check:"
for f in src/explorer/dist/*-explorer.html; do
  NAME=$(basename "$f")
  EXT=$(( $(grep -c '<script src=' "$f" 2>/dev/null || echo 0) + $(grep -c '<link.*href=' "$f" 2>/dev/null || echo 0) ))
  test "$EXT" = "0" && echo "  $NAME: STANDALONE" || echo "  $NAME: HAS_EXTERNAL ($EXT)"
done
echo ""

# Phase 11 features present
echo "Phase 11 features:"
for f in src/explorer/dist/*-explorer.html; do
  NAME=$(basename "$f")
  SCORE=0
  grep -q 'KNOWLEDGE_STATES' "$f" && SCORE=$((SCORE+1))
  grep -q 'localStorage' "$f" && SCORE=$((SCORE+1))
  grep -q 'LEARNING_MODES' "$f" && SCORE=$((SCORE+1))
  grep -q 'fallbackCopy' "$f" && SCORE=$((SCORE+1))
  grep -q 'updateProgress' "$f" && SCORE=$((SCORE+1))
  echo "  $NAME: $SCORE/5 features"
done
echo ""

# Topic data integrity
echo "Topic data integrity:"
for explorer in dividend-strategy options-greeks risk-management; do
  bun -e "
    const html = await Bun.file('./src/explorer/dist/${explorer}-explorer.html').text();
    const match = html.match(/const TOPIC_DATA = ({.*?});/s);
    if (!match) { console.error('  ${explorer}: NO TOPIC_DATA'); process.exit(1); }
    const d = JSON.parse(match[1]);
    console.log('  ${explorer}: ' + d.nodes.length + ' nodes, ' + d.edges.length + ' edges, slug=' + d.metadata.slug);
  "
done
```
</verification>

<success_criteria>
1. 3 standalone HTML files generated: dividend-strategy, options-greeks, risk-management
2. Zero external dependencies in any generated file
3. All 3 contain Phase 11 features: 4-state cycling, localStorage, learning modes, clipboard fallback, progress bar
4. Options-greeks explorer: 20 nodes, 22 edges, 5 categories, 4 presets
5. Risk-management explorer: 20 nodes, 22 edges, 5 categories, 5 presets
6. Dividend-strategy backward compatible with state migration (fuzzy -> familiar)
7. Human verification confirms all features work: cycling, persistence, modes, copy, progress, reset
8. All explorers load in under 1 second
9. Cross-topic localStorage isolation works (each topic has independent state)
</success_criteria>

<output>
After completion, create `.planning/phases/11-self-assessment-persistence-topics/11-03-SUMMARY.md`
</output>
