---
phase: 11-self-assessment-persistence-topics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/explorer/schemas/topic-schema.ts
  - src/explorer/topics/options-greeks.json
  - src/explorer/topics/risk-management.json
autonomous: true

must_haves:
  truths:
    - "Zod schema accepts all 7 knowledge values (know, fuzzy, unknown, familiar, confident, mastered) with default 'unknown'"
    - "Options-greeks topic JSON validates against schema with 20 nodes, 22 edges, 5 categories, 4 presets, and a prompt template"
    - "Risk-management topic JSON validates against schema with 20 nodes, 22 edges, 5 categories, 5 presets, and a prompt template"
    - "Every node in both topic files appears in at least one edge (no orphan nodes)"
    - "Existing dividend-strategy.json still validates against the updated schema (backward compatible)"
  artifacts:
    - path: "src/explorer/schemas/topic-schema.ts"
      provides: "Updated Zod schema accepting 4 new knowledge state values"
      contains: "familiar"
    - path: "src/explorer/topics/options-greeks.json"
      provides: "Options Greeks topic data with 20 concepts across 5 categories"
      contains: "delta"
    - path: "src/explorer/topics/risk-management.json"
      provides: "Risk Management topic data with 20 concepts across 5 categories"
      contains: "sharpe-ratio"
  key_links:
    - from: "src/explorer/schemas/topic-schema.ts"
      to: "src/explorer/topics/options-greeks.json"
      via: "Schema validates topic JSON at build time"
      pattern: "TopicSchema.safeParse"
    - from: "src/explorer/schemas/topic-schema.ts"
      to: "src/explorer/topics/risk-management.json"
      via: "Schema validates topic JSON at build time"
      pattern: "TopicSchema.safeParse"
    - from: "src/explorer/schemas/topic-schema.ts"
      to: "src/explorer/topics/dividend-strategy.json"
      via: "Updated schema must still validate existing topic data"
      pattern: "TopicSchema.safeParse"
---

<objective>
Update the Zod topic schema to support the 4-state knowledge model and create two new topic JSON data files (options-greeks, risk-management) with curated concept graphs.

Purpose: The new topic data files are the content that Phase 11's enhanced explorer will render. The schema update enables the build pipeline to validate both legacy 3-state data and new 4-state data. Without this, the build pipeline will reject topic JSONs that use "familiar", "confident", or "mastered" knowledge values.

Output: Updated topic-schema.ts with 7-value knowledge enum, options-greeks.json (20 nodes, 22 edges), risk-management.json (20 nodes, 22 edges), all validated against the schema.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-self-assessment-persistence-topics/11-CONTEXT.md
@.planning/phases/11-self-assessment-persistence-topics/11-RESEARCH.md
@src/explorer/schemas/topic-schema.ts
@src/explorer/topics/dividend-strategy.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Zod schema knowledge enum and create options-greeks.json</name>
  <files>
    src/explorer/schemas/topic-schema.ts
    src/explorer/topics/options-greeks.json
  </files>
  <action>
    **Step 1: Update Zod schema**

    In `src/explorer/schemas/topic-schema.ts`, find the `NodeSchema` knowledge field and extend the enum to accept all 7 values:

    Change from:
    ```typescript
    knowledge: z.enum(["know", "fuzzy", "unknown"]).default("fuzzy")
    ```

    Change to:
    ```typescript
    knowledge: z.enum(["know", "fuzzy", "unknown", "familiar", "confident", "mastered"]).default("unknown")
    ```

    Note: The default changes from "fuzzy" to "unknown" because Phase 11's 4-state model starts at "unknown". The 3 legacy values (know, fuzzy, unknown) remain for backward compatibility with dividend-strategy.json.

    **Step 2: Verify backward compatibility**

    Run the existing dividend-strategy.json through the updated schema to confirm it still validates:
    ```bash
    bun -e "
      import { TopicSchema } from './src/explorer/schemas/topic-schema';
      const data = await Bun.file('./src/explorer/topics/dividend-strategy.json').json();
      const r = TopicSchema.safeParse(data);
      console.log(r.success ? 'BACKWARD COMPAT: OK' : 'BACKWARD COMPAT: FAIL');
      if (!r.success) console.error(r.error.format());
    "
    ```

    **Step 3: Create options-greeks.json**

    Create `src/explorer/topics/options-greeks.json` with the following structure. All data comes from the Phase 11 RESEARCH.md "Topic Data: Options Greeks (EXPL-09a)" section.

    **metadata:**
    ```json
    {
      "title": "Options Greeks Explorer",
      "slug": "options-greeks",
      "version": "1.0.0",
      "description": "Interactive knowledge graph for understanding options Greeks, pricing mechanics, and volatility effects"
    }
    ```

    **categories (5):**
    | ID | Label | Color |
    |----|-------|-------|
    | core-greeks | Core Greeks | #58a6ff |
    | option-fundamentals | Option Fundamentals | #3fb950 |
    | time-effects | Time Effects | #d29922 |
    | volatility-effects | Volatility Effects | #f85149 |
    | strategy-impact | Strategy Impact | #bc8cff |

    **nodes (20):** All from RESEARCH.md. Each node:
    - `id`: kebab-case identifier (e.g., "delta", "gamma", "option-premium")
    - `label`: Display name with `\n` for multi-line (e.g., "Delta\n(Price Sensitivity)")
    - `category`: Category ID from the table above
    - `description`: Full description from RESEARCH.md
    - `knowledge`: "unknown" (default for new topics)
    - `tags`: Relevant tags for preset filtering. Assign tags based on the research's preset filters:
      - Nodes in "core-greeks" category: tag `["core"]`
      - Nodes in "time-effects" or "volatility-effects": tag `["vol-time"]`
      - Nodes in "strategy-impact": tag `["strategy"]`
      - Nodes in "option-fundamentals": tag `["fundamentals"]`

    The 20 nodes from research (create ALL of these):
    1. delta (core-greeks) - "Measures how much option price changes per $1 move in underlying..."
    2. gamma (core-greeks) - "Rate of change of delta..."
    3. theta (core-greeks) - "Daily time decay..."
    4. vega (core-greeks) - "Sensitivity to implied volatility..."
    5. rho (core-greeks) - "Interest rate sensitivity..."
    6. option-premium (option-fundamentals) - "Total price paid for an option..."
    7. intrinsic-value (option-fundamentals) - "What the option is worth if exercised now..."
    8. extrinsic-value (option-fundamentals) - "Time value + volatility premium..."
    9. moneyness (option-fundamentals) - "ITM/ATM/OTM status..."
    10. implied-volatility (option-fundamentals) - "Market's forecast of future volatility..."
    11. time-decay-acceleration (time-effects) - "Theta increases exponentially as expiration approaches..."
    12. expiration-dynamics (time-effects) - "At expiration: extrinsic value goes to zero..."
    13. dte-impact (time-effects) - "Days to expiration affects ALL Greeks..."
    14. iv-crush (volatility-effects) - "Sharp drop in implied volatility after known events..."
    15. iv-skew (volatility-effects) - "OTM puts typically have higher IV than OTM calls..."
    16. vol-regime (volatility-effects) - "Low-vol vs high-vol environments..."
    17. delta-hedging (strategy-impact) - "Maintaining delta-neutral positions..."
    18. gamma-risk (strategy-impact) - "Short gamma positions can suffer catastrophic losses..."
    19. theta-harvesting (strategy-impact) - "Selling options to collect time decay..."
    20. vega-trading (strategy-impact) - "Trading volatility rather than direction..."

    Use the FULL descriptions from RESEARCH.md for each node's description field.

    **edges (22):** All from RESEARCH.md. Each edge has source, target, and label:
    1. delta -> gamma: "accelerated by"
    2. gamma -> delta-hedging: "necessitates"
    3. theta -> time-decay-acceleration: "manifests as"
    4. vega -> implied-volatility: "measures sensitivity to"
    5. option-premium -> intrinsic-value: "composed of"
    6. option-premium -> extrinsic-value: "composed of"
    7. moneyness -> delta: "determines"
    8. moneyness -> gamma: "peaks at ATM"
    9. implied-volatility -> iv-crush: "collapses in"
    10. implied-volatility -> iv-skew: "shapes"
    11. implied-volatility -> vol-regime: "defines environment"
    12. time-decay-acceleration -> expiration-dynamics: "culminates in"
    13. dte-impact -> theta: "scales"
    14. dte-impact -> vega: "scales"
    15. dte-impact -> gamma: "scales inversely"
    16. gamma-risk -> gamma: "drives"
    17. theta-harvesting -> theta: "exploits"
    18. vega-trading -> vega: "targets"
    19. delta-hedging -> gamma-risk: "mitigates"
    20. iv-crush -> vega-trading: "threatens"
    21. vol-regime -> theta-harvesting: "determines effectiveness of"
    22. rho -> dte-impact: "amplified by longer"

    **presets (4):**
    ```json
    [
      { "id": "all", "label": "All", "filter": "all" },
      { "id": "core-greeks", "label": "Core Greeks", "filter": { "categories": ["core-greeks"] } },
      { "id": "vol-time", "label": "Volatility & Time", "filter": { "categories": ["time-effects", "volatility-effects"] } },
      { "id": "strategy", "label": "Strategy Applications", "filter": { "categories": ["strategy-impact"] } }
    ]
    ```

    **promptTemplate:**
    ```json
    {
      "intro": "I'm studying options Greeks and their role in options pricing, hedging, and strategy construction.",
      "knowPrefix": "I understand these concepts well:",
      "fuzzyPrefix": "I'm somewhat familiar with but need clarity on:",
      "unknownPrefix": "I need to learn these from scratch:",
      "edgePrefix": "Key relationships to explore:",
      "outro": "Explain with real-world examples from options trading. Reference specific strategies (covered calls, protective puts, iron condors, straddles) and show how Greeks change with market conditions. Include how Greeks apply to portfolio-level hedging and the SQQQ vs puts comparison. Use concrete numbers."
    }
    ```

    **Step 4: Validate options-greeks.json**
    ```bash
    bun -e "
      import { TopicSchema } from './src/explorer/schemas/topic-schema';
      const data = await Bun.file('./src/explorer/topics/options-greeks.json').json();
      const r = TopicSchema.safeParse(data);
      if (!r.success) { console.error(r.error.format()); process.exit(1); }
      const nodeIds = new Set(r.data.nodes.map(n => n.id));
      for (const e of r.data.edges) {
        if (!nodeIds.has(e.source)) { console.error('Bad source:', e.source); process.exit(1); }
        if (!nodeIds.has(e.target)) { console.error('Bad target:', e.target); process.exit(1); }
      }
      // Check no orphan nodes
      const edgeNodeIds = new Set([...r.data.edges.map(e => e.source), ...r.data.edges.map(e => e.target)]);
      const orphans = r.data.nodes.filter(n => !edgeNodeIds.has(n.id));
      if (orphans.length) { console.error('Orphan nodes:', orphans.map(n => n.id)); process.exit(1); }
      console.log('options-greeks.json: OK -', r.data.nodes.length, 'nodes,', r.data.edges.length, 'edges,', r.data.categories.length, 'categories,', r.data.presets.length, 'presets');
    "
    ```
  </action>
  <verify>
    ```bash
    # Schema compiles
    bun build src/explorer/schemas/topic-schema.ts --outdir /tmp/schema-check --target node 2>&1 | head -5

    # Backward compatibility: dividend-strategy still validates
    bun -e "
      import { TopicSchema } from './src/explorer/schemas/topic-schema';
      const data = await Bun.file('./src/explorer/topics/dividend-strategy.json').json();
      const r = TopicSchema.safeParse(data);
      console.log(r.success ? 'dividend-strategy: PASS' : 'dividend-strategy: FAIL');
    "

    # New topic validates with correct counts
    bun -e "
      import { TopicSchema } from './src/explorer/schemas/topic-schema';
      const data = await Bun.file('./src/explorer/topics/options-greeks.json').json();
      const r = TopicSchema.safeParse(data);
      if (!r.success) { console.error(r.error.format()); process.exit(1); }
      const nodeIds = new Set(r.data.nodes.map(n => n.id));
      const edgeNodeIds = new Set([...r.data.edges.map(e => e.source), ...r.data.edges.map(e => e.target)]);
      const orphans = r.data.nodes.filter(n => !edgeNodeIds.has(n.id));
      if (orphans.length) { console.error('ORPHANS:', orphans.map(n => n.id)); process.exit(1); }
      for (const e of r.data.edges) {
        if (!nodeIds.has(e.source) || !nodeIds.has(e.target)) { console.error('BAD EDGE:', e); process.exit(1); }
      }
      console.log('options-greeks: OK -', r.data.nodes.length, 'nodes,', r.data.edges.length, 'edges');
    "
    ```
    Must output: `dividend-strategy: PASS` and `options-greeks: OK - 20 nodes, 22 edges`
  </verify>
  <done>
    Zod schema updated to accept 7 knowledge values. options-greeks.json created with 20 nodes (5 categories), 22 edges, 4 presets, prompt template. All nodes connected (no orphans). Schema validates both new and existing topic data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create risk-management.json and cross-validate all topics</name>
  <files>src/explorer/topics/risk-management.json</files>
  <action>
    **Step 1: Create risk-management.json**

    Create `src/explorer/topics/risk-management.json` with data from the Phase 11 RESEARCH.md "Topic Data: Risk Management (EXPL-09b)" section.

    **metadata:**
    ```json
    {
      "title": "Risk Management Explorer",
      "slug": "risk-management",
      "version": "1.0.0",
      "description": "Interactive knowledge graph for portfolio risk measurement, performance metrics, position management, and risk control strategies"
    }
    ```

    **categories (5):**
    | ID | Label | Color |
    |----|-------|-------|
    | risk-measurement | Risk Measurement | #f85149 |
    | performance-metrics | Performance Metrics | #58a6ff |
    | position-management | Position Management | #3fb950 |
    | portfolio-diversification | Portfolio Diversification | #d29922 |
    | risk-control-strategies | Risk Control Strategies | #bc8cff |

    **nodes (20):** All from RESEARCH.md. Each node:
    - `id`: kebab-case (e.g., "var", "cvar", "sharpe-ratio")
    - `label`: Display name with `\n` for multi-line (e.g., "VaR\n(Value at Risk)")
    - `category`: Category ID from table above
    - `description`: Full description from RESEARCH.md
    - `knowledge`: "unknown" (default)
    - `tags`: Assign based on preset filters:
      - risk-measurement: `["measurement"]`
      - performance-metrics: `["metrics"]`
      - position-management: `["position"]`
      - portfolio-diversification: `["portfolio"]`
      - risk-control-strategies: `["controls"]`

    The 20 nodes from research (create ALL):
    1. var (risk-measurement) - "Value at Risk: maximum expected loss over a time period..."
    2. cvar (risk-measurement) - "Conditional VaR (Expected Shortfall)..."
    3. volatility (risk-measurement) - "Standard deviation of returns..."
    4. beta (risk-measurement) - "Systematic risk relative to market..."
    5. max-drawdown (risk-measurement) - "Largest peak-to-trough decline..."
    6. sharpe-ratio (performance-metrics) - "Risk-adjusted return: (return - risk-free rate) / volatility..."
    7. sortino-ratio (performance-metrics) - "Like Sharpe but only penalizes DOWNSIDE volatility..."
    8. alpha (performance-metrics) - "Excess return above benchmark after adjusting for risk..."
    9. calmar-ratio (performance-metrics) - "Annualized return divided by max drawdown..."
    10. position-sizing (position-management) - "Determining how much capital to allocate per position..."
    11. kelly-criterion (position-management) - "Mathematical formula for optimal bet size..."
    12. stop-loss (position-management) - "Exit rule to limit losses on a position..."
    13. concentration-risk (position-management) - "Over-exposure to a single position, sector, or factor..."
    14. diversification (portfolio-diversification) - "Spreading investments to reduce unsystematic risk..."
    15. correlation (portfolio-diversification) - "How assets move together..."
    16. asset-allocation (portfolio-diversification) - "Strategic portfolio mix across asset classes..."
    17. rebalancing (portfolio-diversification) - "Adjusting portfolio back to target weights..."
    18. hedging (risk-control-strategies) - "Using offsetting positions to reduce specific risks..."
    19. vol-regime-awareness (risk-control-strategies) - "Markets alternate between low-volatility and high-volatility regimes..."
    20. tail-risk (risk-control-strategies) - "Risk of extreme, rare events..."

    Use the FULL descriptions from RESEARCH.md for each node.

    **edges (22):** All from RESEARCH.md:
    1. var -> cvar: "extended by"
    2. volatility -> var: "input to"
    3. volatility -> sharpe-ratio: "denominator of"
    4. beta -> volatility: "component of systematic"
    5. max-drawdown -> calmar-ratio: "denominator of"
    6. sharpe-ratio -> sortino-ratio: "refined by"
    7. alpha -> sharpe-ratio: "contextualized by"
    8. position-sizing -> concentration-risk: "prevents"
    9. kelly-criterion -> position-sizing: "optimizes"
    10. stop-loss -> max-drawdown: "limits"
    11. diversification -> correlation: "depends on low"
    12. correlation -> asset-allocation: "informs"
    13. asset-allocation -> rebalancing: "maintained by"
    14. hedging -> volatility: "reduces portfolio"
    15. hedging -> tail-risk: "protects against"
    16. vol-regime-awareness -> hedging: "triggers"
    17. vol-regime-awareness -> position-sizing: "adjusts"
    18. tail-risk -> cvar: "measured by"
    19. concentration-risk -> diversification: "solved by"
    20. rebalancing -> concentration-risk: "prevents drift toward"
    21. stop-loss -> position-sizing: "complements"
    22. beta -> alpha: "adjusted for in"

    **presets (5):**
    ```json
    [
      { "id": "all", "label": "All", "filter": "all" },
      { "id": "risk-measurement", "label": "Risk Measurement", "filter": { "categories": ["risk-measurement"] } },
      { "id": "performance", "label": "Performance & Metrics", "filter": { "categories": ["performance-metrics"] } },
      { "id": "position-portfolio", "label": "Position & Portfolio", "filter": { "categories": ["position-management", "portfolio-diversification"] } },
      { "id": "risk-controls", "label": "Risk Controls", "filter": { "categories": ["risk-control-strategies"] } }
    ]
    ```

    **promptTemplate:**
    ```json
    {
      "intro": "I'm studying risk management concepts for portfolio construction, protection, and performance evaluation.",
      "knowPrefix": "I'm confident with these risk concepts:",
      "fuzzyPrefix": "I'm somewhat familiar with but need clarity on:",
      "unknownPrefix": "I'm unfamiliar with these concepts:",
      "edgePrefix": "Key risk relationships to understand:",
      "outro": "Explain with practical portfolio examples using real scenarios (2008 crash, COVID crash, correlation breakdown). Show how these concepts connect to Finance Guru CLI tools (risk_metrics_cli, volatility_cli, correlation_cli). Include specific calculations where applicable. Reference common risk thresholds (Sharpe > 1.0, max position 5-10%, 95% VaR)."
    }
    ```

    **Step 2: Cross-validate ALL topic files**

    Run validation across all 3 topic JSON files to confirm schema compliance, edge integrity, and no orphan nodes:
    ```bash
    for topic in dividend-strategy options-greeks risk-management; do
      bun -e "
        import { TopicSchema } from './src/explorer/schemas/topic-schema';
        const data = await Bun.file('./src/explorer/topics/${topic}.json').json();
        const r = TopicSchema.safeParse(data);
        if (!r.success) { console.error('${topic}: FAIL', r.error.format()); process.exit(1); }
        const nodeIds = new Set(r.data.nodes.map(n => n.id));
        const edgeNodeIds = new Set([...r.data.edges.map(e => e.source), ...r.data.edges.map(e => e.target)]);
        const orphans = r.data.nodes.filter(n => !edgeNodeIds.has(n.id));
        if (orphans.length > 0) { console.error('${topic}: ORPHANS', orphans.map(n => n.id)); process.exit(1); }
        for (const e of r.data.edges) {
          if (!nodeIds.has(e.source) || !nodeIds.has(e.target)) { console.error('${topic}: BAD EDGE', e); process.exit(1); }
        }
        console.log('${topic}:', r.data.nodes.length, 'nodes,', r.data.edges.length, 'edges,', r.data.categories.length, 'categories - OK');
      "
    done
    ```
  </action>
  <verify>
    ```bash
    # Risk management validates with correct counts
    bun -e "
      import { TopicSchema } from './src/explorer/schemas/topic-schema';
      const data = await Bun.file('./src/explorer/topics/risk-management.json').json();
      const r = TopicSchema.safeParse(data);
      if (!r.success) { console.error(r.error.format()); process.exit(1); }
      const nodeIds = new Set(r.data.nodes.map(n => n.id));
      const edgeNodeIds = new Set([...r.data.edges.map(e => e.source), ...r.data.edges.map(e => e.target)]);
      const orphans = r.data.nodes.filter(n => !edgeNodeIds.has(n.id));
      if (orphans.length) { console.error('ORPHANS:', orphans.map(n => n.id)); process.exit(1); }
      for (const e of r.data.edges) {
        if (!nodeIds.has(e.source) || !nodeIds.has(e.target)) { console.error('BAD EDGE:', e); process.exit(1); }
      }
      console.log('risk-management: OK -', r.data.nodes.length, 'nodes,', r.data.edges.length, 'edges');
    "

    # All 3 topics validate
    PASS=0; FAIL=0
    for topic in dividend-strategy options-greeks risk-management; do
      bun -e "
        import { TopicSchema } from './src/explorer/schemas/topic-schema';
        const d = await Bun.file('./src/explorer/topics/${topic}.json').json();
        const r = TopicSchema.safeParse(d);
        console.log('${topic}:', r.success ? 'PASS' : 'FAIL');
        if (!r.success) process.exit(1);
      " && PASS=$((PASS+1)) || FAIL=$((FAIL+1))
    done
    echo "Results: $PASS passed, $FAIL failed"
    ```
    Must output: `risk-management: OK - 20 nodes, 22 edges` and `Results: 3 passed, 0 failed`
  </verify>
  <done>
    risk-management.json created with 20 nodes (5 categories), 22 edges, 5 presets, prompt template. All 3 topic files (dividend-strategy, options-greeks, risk-management) validate against the updated schema. No orphan nodes. No dangling edge references.
  </done>
</task>

</tasks>

<verification>
Complete plan verification:
```bash
# Schema compiles
bun build src/explorer/schemas/topic-schema.ts --outdir /tmp/verify-11-01 --target node 2>&1

# All 3 topics validate
for topic in dividend-strategy options-greeks risk-management; do
  bun -e "
    import { TopicSchema } from './src/explorer/schemas/topic-schema';
    const d = await Bun.file('./src/explorer/topics/${topic}.json').json();
    const r = TopicSchema.safeParse(d);
    if (!r.success) { console.error('${topic}: FAIL'); process.exit(1); }
    console.log('${topic}: PASS -', d.nodes.length, 'nodes');
  "
done

# New knowledge values accepted by schema
bun -e "
  import { z } from 'zod';
  import { TopicSchema } from './src/explorer/schemas/topic-schema';
  const testNode = { id: 'test', label: 'Test', category: 'cat', description: 'Desc', knowledge: 'mastered', tags: [] };
  // Check schema accepts 'mastered'
  console.log('mastered accepted:', TopicSchema.shape ? 'schema loaded' : 'schema missing');
"

# File counts
echo "Topic files: $(ls src/explorer/topics/*.json | wc -l) (expect 3)"
```
</verification>

<success_criteria>
1. Zod schema knowledge enum includes all 7 values: know, fuzzy, unknown, familiar, confident, mastered
2. Schema default changed from "fuzzy" to "unknown"
3. options-greeks.json: 20 nodes, 22 edges, 5 categories, 4 presets, prompt template -- validates
4. risk-management.json: 20 nodes, 22 edges, 5 categories, 5 presets, prompt template -- validates
5. dividend-strategy.json still validates (backward compatible)
6. Zero orphan nodes in any topic file
7. Zero dangling edge references in any topic file
</success_criteria>

<output>
After completion, create `.planning/phases/11-self-assessment-persistence-topics/11-01-SUMMARY.md`
</output>
