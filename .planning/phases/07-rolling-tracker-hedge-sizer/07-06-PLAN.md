---
phase: 07-rolling-tracker-hedge-sizer
plan: 06
type: tdd
wave: 3
depends_on: ["07-01", "07-02", "07-03", "07-04"]
files_modified:
  - tests/python/test_rolling_tracker.py
  - tests/python/test_hedge_sizer.py
autonomous: true

must_haves:
  truths:
    - "Known-answer tests verify calculate_contract_count with specific portfolio values"
    - "Known-answer tests verify allocate_contracts with specific weights and contract counts"
    - "Known-answer tests verify price_american_put applies intrinsic value floor for deep ITM puts"
    - "Tests verify RollingTracker loads empty positions without error"
    - "Tests verify HedgeSizer produces correct sizing for $200k portfolio"
    - "Tests verify rolling_tracker_cli.py --help exits 0"
    - "Tests verify hedge_sizer_cli.py --help exits 0"
    - "All tests pass with uv run pytest"
  artifacts:
    - path: "tests/python/test_rolling_tracker.py"
      provides: "Known-answer tests for RollingTracker, scan_chain_quiet, price_american_put"
      min_lines: 80
    - path: "tests/python/test_hedge_sizer.py"
      provides: "Known-answer tests for HedgeSizer, calculate_contract_count, allocate_contracts"
      min_lines: 80
  key_links:
    - from: "tests/python/test_rolling_tracker.py"
      to: "src/analysis/rolling_tracker.py"
      via: "import RollingTracker, price_american_put"
      pattern: "from src\\.analysis\\.rolling_tracker import"
    - from: "tests/python/test_hedge_sizer.py"
      to: "src/analysis/hedge_sizer.py"
      via: "import HedgeSizer, calculate_contract_count, allocate_contracts"
      pattern: "from src\\.analysis\\.hedge_sizer import"
---

<objective>
Create known-answer test suites for both the rolling tracker and hedge sizer components.

Purpose: These tests validate correctness of the core calculations (sizing formula, contract allocation, American put pricing) using known inputs and expected outputs. They also verify that the CLIs are wired correctly (--help works, imports succeed). This satisfies STD-04 (known-answer tests) and HEDG-13 (incremental test coverage).

Output:
- `tests/python/test_rolling_tracker.py` with known-answer tests for tracker components
- `tests/python/test_hedge_sizer.py` with known-answer tests for sizer components
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-rolling-tracker-hedge-sizer/07-RESEARCH.md

# Plan SUMMARYs (what was built)
@.planning/phases/07-rolling-tracker-hedge-sizer/07-01-SUMMARY.md
@.planning/phases/07-rolling-tracker-hedge-sizer/07-02-SUMMARY.md
@.planning/phases/07-rolling-tracker-hedge-sizer/07-03-SUMMARY.md
@.planning/phases/07-rolling-tracker-hedge-sizer/07-04-SUMMARY.md

# Source files under test
@src/analysis/rolling_tracker.py
@src/analysis/hedge_sizer.py
@src/analysis/rolling_tracker_cli.py
@src/analysis/hedge_sizer_cli.py

# Existing test patterns
@tests/python/test_risk_metrics.py
@.planning/codebase/TESTING.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test_rolling_tracker.py with known-answer tests</name>
  <files>tests/python/test_rolling_tracker.py</files>
  <action>
Create `tests/python/test_rolling_tracker.py` following the existing test file patterns.

**Module docstring:**
```python
"""
Known-answer tests for Rolling Tracker components.

Tests price_american_put(), RollingTracker YAML loading,
position enrichment, and CLI help output.

ARCHITECTURE NOTE: Tests Layer 2 (rolling_tracker.py) and Layer 3 (rolling_tracker_cli.py)
"""
```

**Test categories:**

**1. price_american_put() known-answer tests:**
- `test_american_put_deep_itm_applies_floor`: spot=400, strike=500, days=1, vol=0.30 -> price >= 100.0 (intrinsic floor dominates)
- `test_american_put_otm_uses_bs_price`: spot=500, strike=400, days=30, vol=0.30 -> price > 0 but < 100 (BS price, intrinsic=0)
- `test_american_put_atm`: spot=450, strike=450, days=30, vol=0.30 -> price > 0 (intrinsic=0, so BS price used)
- `test_american_put_zero_dte`: spot=400, strike=500, days=1, vol=0.30 -> price >= 100.0 (near-expiry deep ITM still has floor)
- `test_american_put_non_negative`: price is always >= 0 for any inputs

**2. RollingTracker YAML loading tests (mock filesystem):**
- `test_load_positions_empty_file`: positions.yaml with `positions: []` returns empty list
- `test_load_positions_missing_file`: non-existent file returns empty list (no crash)
- `test_load_positions_none_yaml`: positions.yaml that is empty (parses to None) returns empty list
- `test_load_positions_valid_entry`: positions.yaml with one valid HedgePosition returns list of length 1

For YAML tests, use `tmp_path` fixture to create temporary YAML files. Patch HEDGING_DIR to point to tmp_path.

**3. RollingTracker instantiation tests:**
- `test_tracker_default_config`: RollingTracker() uses default HedgeConfig (budget=500, window=7)
- `test_tracker_custom_config`: RollingTracker(config=custom) uses provided config

**4. CLI smoke tests (no live data):**
- `test_tracker_cli_help_exits_zero`: Run `uv run python src/analysis/rolling_tracker_cli.py --help` via subprocess, assert exit code 0
- `test_tracker_cli_status_help`: Run `uv run python src/analysis/rolling_tracker_cli.py status --help`, assert exit code 0
- `test_tracker_cli_suggest_roll_help`: same for suggest-roll
- `test_tracker_cli_log_roll_help`: same for log-roll
- `test_tracker_cli_history_help`: same for history

**Test patterns:**
- Use `pytest` fixtures: `tmp_path` for temp files, `monkeypatch` for patching
- Use `subprocess.run` for CLI tests (avoids import side effects)
- Known-answer style: `assert result == expected_value`
- Group tests in classes: `TestAmericanPutPricing`, `TestPositionLoading`, `TestTrackerCLI`
- Follow existing test file conventions from tests/python/

**IMPORTANT:**
- Do NOT test functions that require live market data (get_status, suggest_rolls) -- those need mocking of yfinance which is out of scope
- DO test all pure functions (price_american_put, YAML loading with mocked paths)
- DO test CLI --help (smoke test that imports work)
  </action>
  <verify>
```bash
uv run pytest tests/python/test_rolling_tracker.py -v
```
All tests should pass. Expected: 10-15 tests, all green.
  </verify>
  <done>
test_rolling_tracker.py exists with known-answer tests for price_american_put (deep ITM floor, OTM, ATM), YAML loading (empty, missing, valid), tracker instantiation, and CLI --help smoke tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create test_hedge_sizer.py with known-answer tests</name>
  <files>tests/python/test_hedge_sizer.py</files>
  <action>
Create `tests/python/test_hedge_sizer.py` following the existing test file patterns.

**Module docstring:**
```python
"""
Known-answer tests for Hedge Sizer components.

Tests calculate_contract_count(), allocate_contracts(),
HedgeSizer.size(), and CLI help output.

ARCHITECTURE NOTE: Tests Layer 2 (hedge_sizer.py) and Layer 3 (hedge_sizer_cli.py)
"""
```

**Test categories:**

**1. calculate_contract_count() known-answer tests (STD-04):**
- `test_200k_portfolio`: calculate_contract_count(200000) == 4
- `test_50k_portfolio`: calculate_contract_count(50000) == 1
- `test_under_50k`: calculate_contract_count(49999) == 0
- `test_175k_floor`: calculate_contract_count(175000) == 3 (floor, not round)
- `test_zero_portfolio`: calculate_contract_count(0) == 0
- `test_negative_portfolio`: calculate_contract_count(-100000) == 0
- `test_custom_ratio`: calculate_contract_count(200000, ratio_per_contract=100000) == 2
- `test_zero_ratio`: calculate_contract_count(200000, ratio_per_contract=0) == 0
- `test_1m_portfolio`: calculate_contract_count(1000000) == 20

**2. allocate_contracts() known-answer tests:**
- `test_two_underlyings_60_40`: allocate_contracts(4, {"QQQ": 0.6, "SPY": 0.4}) -- QQQ gets 2-3, SPY gets 1-2, total=4
- `test_single_underlying`: allocate_contracts(5, {"QQQ": 1.0}) == {"QQQ": 5}
- `test_zero_contracts`: allocate_contracts(0, {"QQQ": 0.6, "SPY": 0.4}) -- all zeros, total=0
- `test_three_underlyings`: allocate_contracts(6, {"QQQ": 0.5, "SPY": 0.3, "IWM": 0.2}) -- total=6
- `test_remainder_to_largest`: allocate_contracts(3, {"QQQ": 0.5, "SPY": 0.5}) -- one gets 2, other gets 1 (remainder to first)
- `test_total_preserved`: For any allocation, sum of values must equal total_contracts

**3. HedgeSizer.size() tests:**
- `test_size_200k_two_underlyings`: HedgeSizer().size(HedgeSizeRequest(portfolio_value=200000, underlyings=["QQQ", "SPY"], budget=500)) -> total_contracts=4, allocation sums to 4
- `test_size_with_target_override`: HedgeSizeRequest with target_contracts=6 -> total_contracts=6 regardless of portfolio_value
- `test_size_returns_required_keys`: result has portfolio_value, total_contracts, allocation, weights_used

**4. CLI smoke tests:**
- `test_sizer_cli_help_exits_zero`: Run `uv run python src/analysis/hedge_sizer_cli.py --help` via subprocess, exit code 0
- `test_sizer_cli_skip_budget`: Run `uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ --skip-budget`, exit code 0, output contains "4" or "contract"
- `test_sizer_cli_json_output`: Run with `--output json --skip-budget`, verify output is valid JSON

**Test patterns:**
- Known-answer style: exact expected values for pure functions
- Use `subprocess.run` for CLI tests
- Group in classes: `TestContractCount`, `TestContractAllocation`, `TestHedgeSizer`, `TestSizerCLI`
- Use `--skip-budget` flag in CLI tests to avoid live market data

**IMPORTANT:**
- Do NOT test validate_budget() (requires live yfinance data)
- DO test all pure functions with exact known answers
- DO test CLI with --skip-budget flag
  </action>
  <verify>
```bash
uv run pytest tests/python/test_hedge_sizer.py -v
```
All tests should pass. Expected: 15-20 tests, all green.

Then run both test files together:
```bash
uv run pytest tests/python/test_rolling_tracker.py tests/python/test_hedge_sizer.py -v
```

And verify existing tests still pass (no regressions):
```bash
uv run pytest tests/python/ --tb=short -q
```
  </verify>
  <done>
test_hedge_sizer.py exists with known-answer tests for calculate_contract_count (9 cases), allocate_contracts (6 cases), HedgeSizer.size (3 cases), and CLI smoke tests (3 cases). All passing.
  </done>
</task>

</tasks>

<verification>
```bash
# 1. Both test files exist
ls tests/python/test_rolling_tracker.py tests/python/test_hedge_sizer.py

# 2. All new tests pass
uv run pytest tests/python/test_rolling_tracker.py tests/python/test_hedge_sizer.py -v

# 3. No regressions in existing tests
uv run pytest tests/python/ --tb=short -q

# 4. Test count reasonable (25+ tests across both files)
uv run pytest tests/python/test_rolling_tracker.py tests/python/test_hedge_sizer.py -v --co | wc -l
```
</verification>

<success_criteria>
1. test_rolling_tracker.py has known-answer tests for price_american_put, YAML loading, CLI --help (STD-04, HEDG-13)
2. test_hedge_sizer.py has known-answer tests for calculate_contract_count, allocate_contracts, HedgeSizer.size, CLI --skip-budget (STD-04, HEDG-13)
3. All new tests pass with `uv run pytest`
4. No regressions in existing test suite
5. Total test count: 25+ across both files
</success_criteria>

<output>
After completion, create `.planning/phases/07-rolling-tracker-hedge-sizer/07-06-SUMMARY.md`
</output>
