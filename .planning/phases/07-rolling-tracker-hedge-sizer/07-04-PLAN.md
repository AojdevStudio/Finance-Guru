---
phase: 07-rolling-tracker-hedge-sizer
plan: 04
type: execute
wave: 2
depends_on: ["07-02"]
files_modified:
  - src/analysis/hedge_sizer_cli.py
autonomous: true

must_haves:
  truths:
    - "uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY outputs contract counts with allocation and budget utilization"
    - "--output json produces valid JSON with sizing and budget data"
    - "--help shows complete usage examples"
    - "Missing --portfolio flag produces clear error message"
    - "Educational disclaimer on all output"
    - "Budget validation shows estimated cost, monthly budget, utilization %, and within-budget status"
  artifacts:
    - path: "src/analysis/hedge_sizer_cli.py"
      provides: "Hedge sizer CLI with standard flat argparse (not subcommands)"
      exports: ["main"]
      min_lines: 100
  key_links:
    - from: "src/analysis/hedge_sizer_cli.py"
      to: "src/analysis/hedge_sizer.py"
      via: "import HedgeSizer, calculate_contract_count"
      pattern: "from src\\.analysis\\.hedge_sizer import"
    - from: "src/analysis/hedge_sizer_cli.py"
      to: "src/config/config_loader.py"
      via: "import load_hedge_config for CLI override chain"
      pattern: "from src\\.config\\.config_loader import"
    - from: "src/analysis/hedge_sizer_cli.py"
      to: "src/models/hedging_inputs.py"
      via: "import HedgeSizeRequest to build validated request"
      pattern: "from src\\.models\\.hedging_inputs import HedgeSizeRequest"
---

<objective>
Build the hedge_sizer_cli.py (Layer 3) -- a standard flat argparse CLI matching the existing 15-tool pattern.

Purpose: This is the user-facing interface for the hedge sizer. Unlike the rolling tracker (which uses subcommands), the sizer is a single operation: size contracts, validate budget, output results. It follows the established flat argparse pattern used by all other CLIs.

Output:
- `src/analysis/hedge_sizer_cli.py` with --portfolio, --underlyings, --budget flags and JSON/human output
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-rolling-tracker-hedge-sizer/07-RESEARCH.md

# Plan 02 SUMMARY (Layer 2 this CLI wraps)
@.planning/phases/07-rolling-tracker-hedge-sizer/07-02-SUMMARY.md

# Existing CLI pattern reference (THE template to follow for flat argparse)
@src/analysis/risk_metrics_cli.py
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hedge_sizer_cli.py with flat argparse pattern</name>
  <files>src/analysis/hedge_sizer_cli.py</files>
  <action>
Create `src/analysis/hedge_sizer_cli.py` following the standard flat argparse CLI pattern.

**Module docstring:**
```python
#!/usr/bin/env python3
"""
Hedge Sizer CLI for Finance Guru(tm)

Calculate optimal hedge contract counts and validate against monthly budget.

ARCHITECTURE NOTE: Layer 3 of our 3-layer architecture.
Uses standard flat argparse (matching 15 existing CLIs).

Usage:
    uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY
    uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY,IWM --budget 800
    uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ --output json
    uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ --skip-budget
"""
```

**Imports:**
```python
import argparse
import json
import sys
from pathlib import Path

project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

from src.analysis.hedge_sizer import HedgeSizer
from src.config.config_loader import load_hedge_config
from src.models.hedging_inputs import HedgeSizeRequest
```

**DISCLAIMER constant:**
```python
DISCLAIMER = (
    "\nDISCLAIMER: For educational purposes only. Not investment advice. "
    "Consult a qualified financial professional before executing any trades."
)
```

**parse_args() function:**
- Create parser with description, RawDescriptionHelpFormatter, epilog with __doc__
- Arguments:
  - `--portfolio` type=float, required=True, help="Total portfolio value in dollars"
  - `--underlyings` type=str, required=True, help="Comma-separated underlying tickers (e.g., QQQ,SPY,IWM)"
  - `--budget` type=float, default=None, help="Monthly hedge budget override (default: from config)"
  - `--target-contracts` type=int, default=None, help="Override auto-calculated contract count"
  - `--skip-budget` action='store_true', help="Skip budget validation (no live market data fetch)"
  - `--output` choices=['human', 'json'], default='human'
  - `--config` type=str, default=None, help="Path to user-profile.yaml"

**main() function:**
1. Parse args
2. Build config from load_hedge_config with CLI overrides (budget from --budget)
3. Split --underlyings by comma, strip whitespace, uppercase each
4. Create HedgeSizeRequest(portfolio_value=args.portfolio, underlyings=underlyings, budget=config.monthly_budget, target_contracts=args.target_contracts)
5. Create HedgeSizer(config)
6. Call sizer.size(request) to get sizing result
7. If not --skip-budget: call sizer.validate_budget(result['allocation']) for budget data

**Human output format:**
```
Hedge Sizing Analysis
=====================
Portfolio Value: $200,000.00
Total Contracts: 4

Contract Allocation:
  QQQ: 3 contracts (weight: 60.0%)
  SPY: 1 contract  (weight: 40.0%)

Sizing Formula: floor($200,000 / $50,000) = 4 contracts

[If budget validation run:]
Budget Analysis:
  Monthly Budget:    $500.00
  Spent This Month:  $0.00
  Remaining:         $500.00

  Estimated Cost:    $340.00
  Utilization:       68.0%
  Status:            WITHIN BUDGET

  Per Underlying:
    QQQ: 3 contracts x $8.50/contract x 100 = $2,550.00
    SPY: 1 contract  x $7.90/contract x 100 = $790.00

  Note: Estimated cost based on current mid-price. Actual premium may differ.

DISCLAIMER: For educational purposes only...
```

**JSON output:**
Combine sizing result and budget result (if available) into a single dict. Use json.dumps with indent=2 and default=str for date serialization.

**Error handling:**
- Catch ValueError (invalid portfolio value, bad tickers) and print to stderr with exit code 1
- Catch Exception for unexpected errors

**IMPORTANT:**
- Do NOT use subcommands (anti-pattern from research) -- this is a single operation
- Parse --underlyings as comma-separated string, split and uppercase in the CLI (not in Layer 2)
- Layer 3 does NO calculations -- just I/O formatting
  </action>
  <verify>
Test help output:
```bash
uv run python src/analysis/hedge_sizer_cli.py --help
```

Test basic sizing:
```bash
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY --skip-budget
```

Test JSON output:
```bash
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ --skip-budget --output json | python -m json.tool
```

Test missing required args:
```bash
uv run python src/analysis/hedge_sizer_cli.py 2>&1 | grep -i "required\|error" && echo "Missing args handled"
```

Test with custom target contracts:
```bash
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY --target-contracts 6 --skip-budget
```
  </verify>
  <done>
hedge_sizer_cli.py exists with flat argparse pattern, --portfolio and --underlyings required flags, --skip-budget for offline mode, JSON/human output, educational disclaimer, and complete --help examples.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify CLI end-to-end with sizing and budget validation</name>
  <files>src/analysis/hedge_sizer_cli.py</files>
  <action>
Run end-to-end verification of the hedge sizer CLI.

1. Test basic sizing (no live data needed):
```bash
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY --skip-budget
```
Verify: Shows 4 total contracts, allocation for QQQ and SPY.

2. Test JSON output:
```bash
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY --skip-budget --output json
```
Verify: Valid JSON with total_contracts=4, allocation dict.

3. Test single underlying:
```bash
uv run python src/analysis/hedge_sizer_cli.py --portfolio 100000 --underlyings QQQ --skip-budget
```
Verify: Shows 2 contracts, all allocated to QQQ.

4. Test with budget validation (requires live market data -- may take a few seconds):
```bash
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ --budget 800
```
Verify: Shows sizing AND budget analysis with estimated cost and utilization %.

5. Verify disclaimer appears in all human output:
```bash
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ --skip-budget 2>/dev/null | grep -i "disclaimer"
```

6. Verify the success criteria from the roadmap:
```bash
# This MUST match: "outputs contract counts (1 per $50k) with budget utilization percentage"
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY --skip-budget
```
  </action>
  <verify>
```bash
# Exit code 0 for valid inputs
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ --skip-budget; echo "Exit: $?"

# Exit code non-zero for missing args
uv run python src/analysis/hedge_sizer_cli.py 2>/dev/null; echo "Exit: $?"
```
  </verify>
  <done>
Hedge sizer CLI works end-to-end: sizing with --skip-budget shows allocations without live data, full mode with budget validation shows estimated costs and utilization. JSON output is valid. Disclaimer present. Matches roadmap success criteria.
  </done>
</task>

</tasks>

<verification>
```bash
# 1. Help text complete
uv run python src/analysis/hedge_sizer_cli.py --help | head -20

# 2. Required flags enforced
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 2>&1 | grep -i "required\|error" && echo "Missing underlyings caught"

# 3. Layer 3 purity
grep -c "math\.\|numpy\|pandas\|scipy" src/analysis/hedge_sizer_cli.py && echo "WARNING: Calculator code in CLI" || echo "Layer 3 purity OK"

# 4. Both CLIs have --help working
uv run python src/analysis/rolling_tracker_cli.py --help > /dev/null 2>&1 && echo "Tracker help: OK"
uv run python src/analysis/hedge_sizer_cli.py --help > /dev/null 2>&1 && echo "Sizer help: OK"
```
</verification>

<success_criteria>
1. `hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY` outputs contract counts with allocation (HEDG-05, HS-01, HS-03)
2. Budget validation shows estimated cost and utilization % (HS-02)
3. `--output json` produces valid JSON (STD-01)
4. `--help` shows complete examples (STD-03)
5. Educational disclaimer on all output (STD-02)
6. No business logic in CLI file (Layer 3 purity)
7. Flat argparse pattern (not subcommands) matching existing 15 CLIs
</success_criteria>

<output>
After completion, create `.planning/phases/07-rolling-tracker-hedge-sizer/07-04-SUMMARY.md`
</output>
