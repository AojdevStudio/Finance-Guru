---
phase: 09-template-engine-dividend-topic-port
plan: 03
type: execute
wave: 3
depends_on: ["09-01", "09-02"]
files_modified:
  - src/explorer/build.ts
autonomous: false

must_haves:
  truths:
    - "Running `bun run src/explorer/build.ts src/explorer/topics/dividend-strategy.json` produces a single standalone HTML file"
    - "The generated HTML file has zero external dependencies (no CDN links, no script src, no link href)"
    - "Opening the generated HTML in a browser shows an interactive knowledge graph with all 14 features working"
    - "Running the build with an invalid JSON file produces a clear validation error and exits with non-zero code"
    - "Running the build with a DIFFERENT topic JSON file produces a different explorer (reusable template engine)"
  artifacts:
    - path: "src/explorer/build.ts"
      provides: "Two-stage build pipeline: validate JSON, bundle JS/CSS, inline into HTML"
      min_lines: 40
    - path: "src/explorer/dist/dividend-strategy-explorer.html"
      provides: "Generated standalone HTML explorer"
      contains: "cytoscape"
  key_links:
    - from: "src/explorer/build.ts"
      to: "src/explorer/schemas/topic-schema.ts"
      via: "Import TopicSchema for validation"
      pattern: "import.*TopicSchema.*from.*topic-schema"
    - from: "src/explorer/build.ts"
      to: "src/explorer/template/template.html"
      via: "Read template and inject bundled assets"
      pattern: "template.html"
    - from: "src/explorer/build.ts"
      to: "src/explorer/template/explorer.ts"
      via: "Bun.build bundles explorer into IIFE JS"
      pattern: 'entrypoints.*explorer.ts'
    - from: "src/explorer/build.ts"
      to: "src/explorer/template/styles.css"
      via: "Read and inline CSS into template"
      pattern: "styles.css"
    - from: "src/explorer/build.ts"
      to: "src/explorer/template/explorer.ts"
      via: "Injected TOPIC_DATA structure must match explorer.ts declare const TOPIC_DATA shape"
      pattern: "const TOPIC_DATA = .*JSON\\.stringify"
---

<objective>
Create the two-stage Bun build pipeline that assembles all artifacts into a standalone HTML file, then verify the complete end-to-end pipeline with human visual confirmation.

Purpose: This plan ties together all Phase 9 artifacts into the working build pipeline that is the phase's primary deliverable. The build script is the reusable engine -- changing only the input JSON file produces a different explorer.

Output: build.ts script that validates JSON, bundles JS/CSS, and inlines everything into a standalone HTML. Plus verified output file.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-template-engine-dividend-topic-port/09-RESEARCH.md
@.planning/phases/09-template-engine-dividend-topic-port/09-01-SUMMARY.md
@.planning/phases/09-template-engine-dividend-topic-port/09-02-SUMMARY.md
@src/explorer/schemas/topic-schema.ts
@src/explorer/template/template.html
@src/explorer/template/explorer.ts
@src/explorer/template/styles.css
@src/explorer/topics/dividend-strategy.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create two-stage Bun build pipeline</name>
  <files>src/explorer/build.ts</files>
  <action>
    Create `src/explorer/build.ts` implementing the two-stage build pipeline from the research. The script:

    **Usage:** `bun run src/explorer/build.ts <topic.json>`

    **Stage 0: Validate topic JSON**
    1. Read topic JSON file path from `process.argv[2]`
    2. If no argument, print usage and exit(1)
    3. Read and parse JSON with `await Bun.file(topicPath).json()`
    4. Validate with `TopicSchema.safeParse(rawJson)`
    5. If validation fails: print formatted errors (path + message for each issue), exit(1)
    6. Cross-validate: every edge source/target must reference a valid node ID
    7. If cross-validation fails: print which edge references unknown node, exit(1)

    **Stage 1: Bundle JS and CSS**
    1. Bundle explorer.ts into IIFE:
       ```typescript
       const jsBundle = await Bun.build({
         entrypoints: ['./src/explorer/template/explorer.ts'],
         format: 'iife',
         target: 'browser',
         minify: true,
         define: {
           'process.env.NODE_ENV': '"production"',
         },
       });
       ```
    2. Check `jsBundle.success`. If false, print logs and exit(1).
    3. Get bundled JS text: `await jsBundle.outputs[0].text()`
    4. Read CSS: `await Bun.file('./src/explorer/template/styles.css').text()`

    **Stage 2: Assemble standalone HTML**
    1. Read template: `await Bun.file('./src/explorer/template/template.html').text()`
    2. Replace injection points:
       - `__TOPIC_TITLE__` -> `topic.metadata.title` (use replaceAll for both occurrences)
       - `/* __INJECT_CSS__ */` -> CSS content
       - `/* __INJECT_TOPIC_DATA__ */` -> `const TOPIC_DATA = ${JSON.stringify(topic)};`
       - `/* __INJECT_APP_JS__ */` -> bundled JS content
    3. Write output: `./src/explorer/dist/${topic.metadata.slug}-explorer.html`
    4. Create dist directory if it doesn't exist: `await Bun.write()` handles this automatically, but ensure the directory exists with `import { mkdir } from 'node:fs/promises'` and `await mkdir('./src/explorer/dist', { recursive: true })`.
    5. Print success: file path and size in KB

    **Import:**
    ```typescript
    import { TopicSchema } from './schemas/topic-schema';
    import { mkdir } from 'node:fs/promises';
    ```

    **Error handling:**
    - File not found: let Bun's file read throw naturally, catch and print friendly message
    - Invalid JSON: catch JSON.parse error, print "Invalid JSON: {error message}"
    - Schema validation: use safeParse, print formatted errors
    - Build failure: check jsBundle.success, print logs

    **Cross-plan wiring check: TOPIC_DATA structure**
    The build pipeline injects `const TOPIC_DATA = ${JSON.stringify(topic)};` where `topic` is the Zod-validated TopicData object. The explorer.ts `declare const TOPIC_DATA` must match this structure. Verify wiring by checking:
    1. The injected JSON includes all top-level keys that explorer.ts accesses: `metadata`, `categories`, `nodes`, `edges`, `presets`, `promptTemplate`
    2. Each node has fields: `id`, `label`, `category`, `description`, `knowledge`, `tags`
    3. Each edge has fields: `source`, `target`, `label`
    Add a build-time structural assertion after Zod validation:
    ```typescript
    // Verify injected structure matches explorer.ts expectations
    const sample = topic.nodes[0];
    if (!sample || !('id' in sample && 'label' in sample && 'category' in sample && 'description' in sample && 'knowledge' in sample && 'tags' in sample)) {
      console.error('TOPIC_DATA node structure does not match explorer.ts expectations');
      process.exit(1);
    }
    ```
    This is a belt-and-suspenders check -- Zod schema already enforces this, but this makes the contract between build.ts and explorer.ts explicit.

    **Test the build:**
    ```bash
    bun run src/explorer/build.ts src/explorer/topics/dividend-strategy.json
    ```
    Should produce `src/explorer/dist/dividend-strategy-explorer.html`

    **Test error handling:**
    ```bash
    # Missing argument
    bun run src/explorer/build.ts
    # Should print usage and exit(1)

    # Invalid JSON
    echo '{"bad": true}' > /tmp/bad-topic.json
    bun run src/explorer/build.ts /tmp/bad-topic.json
    # Should print validation errors and exit(1)
    ```

    **Verify standalone:**
    After building, check the output file:
    ```bash
    # No external script or link tags (everything inlined)
    grep -c '<script src=' src/explorer/dist/dividend-strategy-explorer.html  # Must be 0
    grep -c '<link rel="stylesheet" href=' src/explorer/dist/dividend-strategy-explorer.html  # Must be 0

    # Contains cytoscape (bundled)
    grep -c 'cytoscape' src/explorer/dist/dividend-strategy-explorer.html  # Must be > 0

    # Contains topic data
    grep -c 'TOPIC_DATA' src/explorer/dist/dividend-strategy-explorer.html  # Must be > 0

    # File size (should be ~400-600KB due to bundled Cytoscape.js)
    ls -lh src/explorer/dist/dividend-strategy-explorer.html
    ```
  </action>
  <verify>
    ```bash
    # Build succeeds
    bun run src/explorer/build.ts src/explorer/topics/dividend-strategy.json 2>&1

    # Output exists
    test -f src/explorer/dist/dividend-strategy-explorer.html && echo "Output: OK" || echo "Output: MISSING"

    # Standalone check (no external deps)
    grep -c '<script src=' src/explorer/dist/dividend-strategy-explorer.html   # 0
    grep -c '<link.*href=' src/explorer/dist/dividend-strategy-explorer.html   # 0

    # Contains bundled cytoscape
    grep -q 'cytoscape' src/explorer/dist/dividend-strategy-explorer.html && echo "Cytoscape: BUNDLED" || echo "Cytoscape: MISSING"

    # Cross-plan wiring: TOPIC_DATA structure matches explorer.ts expectations
    grep -q 'TOPIC_DATA' src/explorer/dist/dividend-strategy-explorer.html && echo "TOPIC_DATA: INJECTED" || echo "TOPIC_DATA: MISSING"
    # Verify injected data has required top-level keys
    bun -e "
      const html = await Bun.file('./src/explorer/dist/dividend-strategy-explorer.html').text();
      const match = html.match(/const TOPIC_DATA = ({.*?});/s);
      if (!match) { console.error('WIRING: FAIL - no TOPIC_DATA found'); process.exit(1); }
      const data = JSON.parse(match[1]);
      const required = ['metadata','categories','nodes','edges','presets'];
      const missing = required.filter(k => !(k in data));
      if (missing.length) { console.error('WIRING: FAIL - missing keys:', missing); process.exit(1); }
      const node = data.nodes[0];
      const nodeKeys = ['id','label','category','description','knowledge','tags'];
      const missingNode = nodeKeys.filter(k => !(k in node));
      if (missingNode.length) { console.error('WIRING: FAIL - node missing keys:', missingNode); process.exit(1); }
      console.log('WIRING: OK - TOPIC_DATA structure matches explorer.ts contract');
    "

    # Error handling: invalid JSON produces error
    echo '{}' > /tmp/bad-topic.json
    bun run src/explorer/build.ts /tmp/bad-topic.json 2>&1 | grep -i "fail\|error\|invalid" | head -3

    # Error handling: no args produces usage
    bun run src/explorer/build.ts 2>&1 | grep -i "usage" | head -1

    # File size
    ls -lh src/explorer/dist/dividend-strategy-explorer.html
    ```
  </verify>
  <done>
    Build pipeline produces a standalone HTML file from topic JSON. Output contains bundled Cytoscape.js, inlined CSS, injected topic data, and bundled application JS. No external dependencies. Invalid JSON input produces clear build errors. Missing argument prints usage.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete explorer build pipeline. Running `bun run src/explorer/build.ts src/explorer/topics/dividend-strategy.json` produces a standalone HTML knowledge explorer at `src/explorer/dist/dividend-strategy-explorer.html`.
  </what-built>
  <how-to-verify>
    1. Open the generated file in a browser:
       ```bash
       open src/explorer/dist/dividend-strategy-explorer.html
       ```

    2. **Graph visualization:** Verify you see a knowledge graph with ~21 colored nodes arranged by Cytoscape CoSE layout. Nodes should have category-colored borders and text labels.

    3. **Knowledge cycling:** Click any node. Its knowledge state should cycle (fuzzy -> know -> unknown) with the border color changing (yellow -> green -> red). The sidebar badge and stats should update.

    4. **Sidebar:** Left sidebar should show:
       - How to Use instructions
       - Category legend with colored dots
       - Concept list with knowledge badges
       - Action buttons (Auto-Layout, All Know, All Fuzzy, All Unknown, Reset)

    5. **Preset filters:** Click "Core Strategy" preset in the header. Only core-tagged nodes should be visible. Click "All" to restore.

    6. **Tooltips:** Hover over a node. A tooltip should appear with the concept name, description, and category. Connected edges should highlight with labels visible.

    7. **Prompt generation:** Set some nodes to "unknown" and "fuzzy". The bottom prompt panel should show a learning prompt mentioning those concepts.

    8. **Copy button:** Click "Copy" in the prompt panel. Paste somewhere to verify the prompt text was copied.

    9. **Feature parity comparison:** Open the original prototype side-by-side:
       ```bash
       open .dev/playgrounds/dividend-strategy-explorer.html
       ```
       The new explorer should have the same concepts, categories, and interactions. The visual style may differ slightly (Cytoscape rendering vs Canvas) but functionality should match.

    10. **Standalone verification:** Disconnect from the internet (or check Network tab in DevTools). The explorer should work fully offline with no failed requests.
  </how-to-verify>
  <resume-signal>Type "approved" if the explorer works correctly with all features, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Complete pipeline verification:
```bash
# Build produces output
bun run src/explorer/build.ts src/explorer/topics/dividend-strategy.json
test -f src/explorer/dist/dividend-strategy-explorer.html && echo "BUILD: PASS" || echo "BUILD: FAIL"

# Output is standalone (zero external deps)
EXTERNAL_SCRIPTS=$(grep -c '<script src=' src/explorer/dist/dividend-strategy-explorer.html)
EXTERNAL_CSS=$(grep -c '<link.*href=' src/explorer/dist/dividend-strategy-explorer.html)
test "$EXTERNAL_SCRIPTS" = "0" && test "$EXTERNAL_CSS" = "0" && echo "STANDALONE: PASS" || echo "STANDALONE: FAIL"

# Output contains required content
grep -q 'TOPIC_DATA' src/explorer/dist/dividend-strategy-explorer.html && echo "DATA_INJECTED: PASS" || echo "DATA_INJECTED: FAIL"
grep -q 'cytoscape' src/explorer/dist/dividend-strategy-explorer.html && echo "CYTOSCAPE_BUNDLED: PASS" || echo "CYTOSCAPE_BUNDLED: FAIL"

# Error handling works
echo '{}' > /tmp/bad.json
! bun run src/explorer/build.ts /tmp/bad.json 2>/dev/null && echo "VALIDATION_ERROR: PASS" || echo "VALIDATION_ERROR: FAIL"

# Reusability: different slug produces different filename
# (Would need a second topic JSON to fully test, but build script logic derives filename from slug)
```
</verification>

<success_criteria>
1. `bun run src/explorer/build.ts src/explorer/topics/dividend-strategy.json` succeeds and produces `src/explorer/dist/dividend-strategy-explorer.html`
2. Generated HTML is a single file with zero external dependencies (verified: no `<script src>` or `<link href>`)
3. Generated HTML contains bundled Cytoscape.js, inlined CSS, injected topic data
4. Opening the HTML in a browser shows a working interactive knowledge graph matching the prototype
5. Invalid JSON input produces clear build errors (not a broken HTML)
6. Human verification confirms all 14 features work correctly
7. Build pipeline is reusable: changing only the topic JSON file changes the explorer content
</success_criteria>

<output>
After completion, create `.planning/phases/09-template-engine-dividend-topic-port/09-03-SUMMARY.md`
</output>
