---
phase: 01-git-history-scrub-security-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - scripts/qa/pii-replacements.txt
  - scripts/qa/author-mailmap.txt
autonomous: false

must_haves:
  truths:
    - "Running PII grep with actual values from private pii-replacements.txt returns 0 on the filtered clone"
    - "Running `git log --all --format='%an <%ae>' | sort -u` shows no personal email addresses (<DOMAIN_1>, <DOMAIN_2>)"
    - "The Bright Data API token (9424526a...) does not appear anywhere in git history"
    - "All prior commits exist in the rewritten history (commit count preserved, only content changed)"
  artifacts:
    - path: "scripts/qa/pii-replacements.txt"
      provides: "Comprehensive PII replacement expressions for git-filter-repo"
    - path: "scripts/qa/author-mailmap.txt"
      provides: "Author identity mailmap for git-filter-repo"
  key_links:
    - from: "pii-replacements.txt"
      to: "git-filter-repo --replace-text"
      via: "Expressions file consumed by git-filter-repo"
      pattern: "literal:.*==>REDACTED"
    - from: "author-mailmap.txt"
      to: "git-filter-repo --mailmap"
      via: "Mailmap file consumed by git-filter-repo"
      pattern: "Finance Guru Developer.*<old@email>"
---

<objective>
Build the PII replacement expressions file and run git-filter-repo to scrub all PII from the entire git history.

Purpose: This is the irreversible, one-shot operation that removes all PII from 157 commits containing 1,645+ pattern matches. The expressions file must be comprehensive BEFORE running -- any missed pattern is permanently exposed once the clean repo is pushed publicly. This plan also rewrites author metadata to remove personal email addresses.

Output: A freshly filtered git clone with zero PII in any commit, blob, message, or author field. Verified by comprehensive grep audit.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-git-history-scrub-security-foundation/01-RESEARCH.md
@.planning/phases/01-git-history-scrub-security-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive PII replacement expressions file and author mailmap</name>
  <files>
    scripts/qa/pii-replacements.txt
    scripts/qa/author-mailmap.txt
  </files>
  <action>
    Create two files that will drive git-filter-repo.

    **File 1: `scripts/qa/pii-replacements.txt`**

    This is the git-filter-repo expressions file. Format: `literal:PATTERN==>REPLACEMENT` or `regex:PATTERN==>REPLACEMENT`.

    Include ALL of these patterns (from the research audit):

    ```
    # === CRITICAL: Account Numbers ===
    literal:<REAL_ACCOUNT_NUMBER>==>REDACTED_ACCOUNT
    regex:Z0\d{7,}==>REDACTED_ACCOUNT

    # === CRITICAL: API Tokens ===
    literal:<REAL_API_TOKEN>==>REDACTED_API_TOKEN

    # === HIGH: Google Sheets ID ===
    literal:<REAL_SPREADSHEET_ID>==>REDACTED_SPREADSHEET_ID

    # === HIGH: LLC Names ===
    literal:<REAL_LLC_NAME> LLC==>REDACTED_LLC
    literal:<REAL_LLC_SHORT>==>REDACTED_LLC

    # === MEDIUM: Employer Names ===
    literal:<REAL_EMPLOYER_NAME>==>REDACTED_EMPLOYER

    # === MEDIUM: Personal Names ===
    literal:<REAL_FULL_NAME>==>REDACTED_NAME
    literal:<REAL_FIRST_NAME>==>REDACTED_NAME

    # === HIGH: Email Addresses (in content, not author -- author handled by mailmap) ===
    literal:<REAL_EMAIL_1>==>redacted@example.com
    literal:<REAL_EMAIL_2>==>redacted@example.com

    # === MEDIUM: Financial Amounts (from user-profile.yaml in history) ===
    literal:<AMOUNT_1>==>REDACTED_AMOUNT
    literal:<AMOUNT_2>==>REDACTED_AMOUNT
    literal:<AMOUNT_3>==>REDACTED_AMOUNT

    # === HIGH: File path patterns with account numbers ===
    regex:Balances_for_Account_Z\d+==>Balances_for_Account_REDACTED
    regex:History_for_Account_Z\d+==>History_for_Account_REDACTED
    regex:Portfolio_Positions_\w+-\d+-\d+\.csv==>Portfolio_Positions_REDACTED.csv

    # NOTE: Actual PII values are in the PRIVATE (untracked) scripts/qa/pii-replacements.txt
    # This plan shows the template format only. See pii-replacements.template.txt for structure.
    ```

    **IMPORTANT on CBN:** Do NOT add a blanket `literal:CBN==>REDACTED` replacement. "CBN" is only 3 characters and would cause collateral damage. Instead, use context-specific patterns:
    ```
    literal:<EMPLOYER_SHORT> 401(k)==>REDACTED_EMPLOYER 401(k)
    literal:<EMPLOYER_SHORT> 401k==>REDACTED_EMPLOYER 401k
    ```

    **Before finalizing:** Run a dry audit on the current repo to check for any additional PII patterns not in the research. Search for:
    - Dollar amounts with $ sign (e.g., `$192,000`, `$365,139`)
    - Social security number patterns (`\d{3}-\d{2}-\d{4}`)
    - Phone number patterns
    - Any other account-like patterns

    Add any newly discovered patterns to the expressions file.

    **File 2: `scripts/qa/author-mailmap.txt`**

    ```
    # Actual emails/names sourced from private config — not stored in tracked plan docs
    Finance Guru Developer <dev@example.com> <OLD_USERNAME> <OLD_EMAIL_1>
    Finance Guru Developer <dev@example.com> <OLD_USERNAME> <OLD_EMAIL_2>
    Finance Guru Developer <dev@example.com> <REAL_NAME> <OLD_EMAIL_1>
    Finance Guru Developer <dev@example.com> <REAL_NAME> <OLD_EMAIL_2>
    ```

    Commit both files to main before proceeding to Task 2:
    ```bash
    git add scripts/qa/pii-replacements.txt scripts/qa/author-mailmap.txt
    git commit -m "security(01-02): add PII replacement expressions and author mailmap

    - Comprehensive expressions file for git-filter-repo --replace-text
    - Author mailmap to genericize commit metadata
    - Covers: account numbers, API tokens, spreadsheet IDs, LLC names, employer names, personal names, emails, financial amounts"
    ```
  </action>
  <verify>
    ```bash
    # Expressions file exists and has content
    wc -l scripts/qa/pii-replacements.txt  # Should be 20+ lines (excluding comments)

    # Mailmap file exists and has content
    wc -l scripts/qa/author-mailmap.txt  # Should be 4 lines

    # Key patterns are present
    grep "REDACTED_ACCOUNT" scripts/qa/pii-replacements.txt  # Must find account replacement rules
    grep "REDACTED_API_TOKEN" scripts/qa/pii-replacements.txt  # Must find API token replacement
    grep "dev@example.com" scripts/qa/author-mailmap.txt  # Must find canonical email mapping
    ```
  </verify>
  <done>
    Comprehensive expressions file covers all PII categories from the audit (account numbers, API tokens, spreadsheet IDs, LLC names, employer names, personal names, emails, financial amounts, file path patterns). Author mailmap covers all personal email addresses found in git log. Both files committed to main.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run git-filter-repo on fresh clone and verify zero PII</name>
  <files>None (operates on a separate clone directory)</files>
  <action>
    This is the irreversible history rewrite. Follow this EXACT sequence:

    **Step 1: Create fresh clone for filtering**
    ```bash
    cd /tmp
    git clone /path/to/family-office family-office-clean
    cd family-office-clean
    ```
    Note: Clone from local to avoid network issues. The expressions files are already committed.

    **Step 2: Copy expressions and mailmap to a location OUTSIDE the clone**
    ```bash
    cp scripts/qa/pii-replacements.txt /tmp/pii-replacements.txt
    cp scripts/qa/author-mailmap.txt /tmp/author-mailmap.txt
    ```

    **Step 3: Run git-filter-repo**
    ```bash
    git filter-repo \
      --replace-text /tmp/pii-replacements.txt \
      --replace-message /tmp/pii-replacements.txt \
      --mailmap /tmp/author-mailmap.txt \
      --force
    ```

    **Step 4: Verify scrub is complete -- SPECIFIC known PII (MUST be zero)**
    ```bash
    # Build grep pattern from actual values in private scripts/qa/pii-replacements.txt
    # Format: extract literal: values, join with | for grep -E alternation
    SPECIFIC_COUNT=$(git log --all -p | grep -ciE "<ACTUAL_PII_VALUES_FROM_PRIVATE_CONFIG>" || true)
    echo "Specific PII matches: $SPECIFIC_COUNT"
    # MUST be 0. If not 0, DO NOT PROCEED.
    ```

    **Step 5: Verify author metadata is clean**
    ```bash
    git log --all --format='%an <%ae>' | sort -u
    # Must NOT contain <DOMAIN_1> or <DOMAIN_2> emails
    ```

    **Step 6: Verify broader patterns and review any remaining matches**
    ```bash
    BROAD_COUNT=$(git log --all -p | grep -ciE "account|brokerage|Z057|net.worth|LLC" || true)
    echo "Broad pattern matches: $BROAD_COUNT"
    # Some matches are expected (e.g., "account" in generic code comments).
    # Review any remaining matches to confirm they are NOT PII.
    # If any are PII, add to expressions file and re-run from Step 1.
    ```

    **Step 7: Verify code integrity**
    ```bash
    # Check that the repo still has the expected structure
    ls -la src/ tests/ .claude/
    # Run a basic import check
    uv run python -c "import src" 2>/dev/null || echo "Import check: manual verification needed"
    ```

    **Step 8: Verify commit count**
    ```bash
    git rev-list --count HEAD
    # Should be close to 157 (original count). Some empty commits may be pruned.
    ```

    **IF any specific PII is found in Step 4:** DO NOT proceed. Update pii-replacements.txt, re-clone, and re-run. This is a blocking gate.

    **IF the scrub is clean:** Report the verification results and proceed to the checkpoint.
  </action>
  <verify>
    All of these must pass:
    ```bash
    # Zero specific PII — source actual values from private pii-replacements.txt
    # Build grep pattern from literal: entries in the private file
    git log --all -p | grep -ciE "<ACTUAL_PII_VALUES_FROM_PRIVATE_CONFIG>" | head -1
    # Must output: 0

    # No personal emails in author metadata — check for old domain names
    git log --all --format='%ae' | grep -iE "<OLD_EMAIL_DOMAINS>" | wc -l
    # Must output: 0

    # Repo structure intact
    test -d src && test -d tests && echo "PASS" || echo "FAIL"
    ```
  </verify>
  <done>
    Fresh filtered clone at /tmp/family-office-clean has zero specific PII in any commit blob, commit message, or author metadata. Broader pattern matches reviewed and confirmed non-PII. Repo structure and code integrity preserved.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Git history has been scrubbed of all PII using git-filter-repo. A filtered clone exists at /tmp/family-office-clean with:
    - Zero matches for specific PII patterns (account numbers, API tokens, spreadsheet IDs, LLC names, emails)
    - Author metadata rewritten to generic "Finance Guru Developer" identity
    - All 157 commits preserved (content cleaned, history intact)
  </what-built>
  <how-to-verify>
    1. Navigate to the filtered clone: `cd /tmp/family-office-clean`
    2. Run the full PII audit:
       ```bash
       # Source actual PII values from private pii-replacements.txt to build grep pattern
       git log --all -p | grep -ciE "<ACTUAL_PII_VALUES_FROM_PRIVATE_CONFIG>"
       ```
       Must return 0.
    3. Check author identities: `git log --all --format='%an <%ae>' | sort -u`
       Must NOT show old personal email domains.
    4. Spot-check a few recent commits: `git log --oneline -10` -- look for any PII in messages.
    5. Spot-check the working tree: `grep -rE "Z0[0-9]{7,}" . 2>/dev/null` -- must return nothing.

    **CRITICAL DECISION:** After verification, the next step is to:
    - Delete the old GitHub repo (`AojdevStudio/Finance-Guru`)
    - Create a new GitHub repo
    - Push the filtered clone to the new repo
    - Delete ALL old local clones (they retain PII in .git)

    This is irreversible. Confirm you are ready to proceed.
  </how-to-verify>
  <resume-signal>Type "approved" to proceed to Plan 03 (prevention hooks and CI). If issues found, describe them for re-scrub.</resume-signal>
</task>

</tasks>

<verification>
Complete PII audit on the filtered clone:
```bash
cd /tmp/family-office-clean

# Tier 1: Specific known PII (MUST be 0)
# Source actual PII values from private pii-replacements.txt to build grep pattern
# Include: account numbers, API tokens, spreadsheet IDs, LLC names, emails
git log --all -p | grep -ciE "<ACTUAL_PII_VALUES_FROM_PRIVATE_CONFIG>"

# Tier 2: Author metadata (MUST be 0)
# Check for old personal email domains
git log --all --format='%ae' | grep -ciE "<OLD_EMAIL_DOMAINS>"

# Tier 3: Broader patterns (review, not zero target)
git log --all -p | grep -ciE "account|brokerage|Z057|net.worth|LLC"
# Review remaining matches for false positives
```
</verification>

<success_criteria>
1. Comprehensive expressions file covers all 14 PII categories from the audit
2. git-filter-repo completes successfully on fresh clone
3. Zero specific PII matches in entire filtered git history
4. Zero personal email addresses in author metadata
5. Broader pattern matches reviewed and confirmed as non-PII
6. Repo structure and code integrity preserved post-filter
7. Human verification checkpoint passed
</success_criteria>

<output>
After completion, create `.planning/phases/01-git-history-scrub-security-foundation/01-02-SUMMARY.md`
</output>
