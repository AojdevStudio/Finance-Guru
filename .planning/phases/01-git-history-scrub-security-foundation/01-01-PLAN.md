---
phase: 01-git-history-scrub-security-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/hooks/load-fin-core-config.ts
  - .claude/skills/PortfolioSyncing/SKILL.md
  - .claude/skills/PortfolioSyncing/workflows/SyncPortfolio.md
  - .claude/skills/TransactionSyncing/SKILL.md
  - .claude/skills/TransactionSyncing/workflows/SyncTransactions.md
  - .claude/skills/fin-core/SKILL.md
  - .claude/skills/margin-management/SKILL.md
  - .planning/research/PITFALLS.md
  - .planning/research/SUMMARY.md
  - docs/hooks.md
  - fin-guru/tasks/load-portfolio-context.md
  - tests/integration/gitignore-protection.test.ts
  - tests/integration/test_gitignore_protection.sh
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "No tracked file in the working tree contains the literal account number {account_id}"
    - "No tracked file contains hardcoded personal names except template variable references like {user_name}"
    - "No tracked file contains the Google Sheets spreadsheet ID {spreadsheet_id}"
    - "No tracked file contains employer names ({employer_name}, CBN) in PII context"
    - ".gitignore covers .onboarding-progress.json and user-profile.yaml broadly"
  artifacts:
    - path: ".gitignore"
      provides: "Comprehensive private data protection"
      contains: ".onboarding-progress.json"
  key_links:
    - from: "working tree files"
      to: "git-filter-repo expressions file (Plan 02)"
      via: "Clean tree must be committed before history rewrite"
      pattern: "All PII replaced with template variables before SEC-01 runs"
---

<objective>
Clean all PII from the working tree and harden .gitignore before the irreversible git history rewrite.

Purpose: The working tree must be PII-free BEFORE running git-filter-repo (Plan 02). Any PII remaining in tracked files would survive the history rewrite and end up in the clean repository. This plan also closes .gitignore gaps so no private data can be accidentally committed going forward.

Output: All 21+ tracked files with PII replaced by template variables/placeholders. Updated .gitignore with complete coverage. Committed to main, ready for history rewrite.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-git-history-scrub-security-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace all PII in tracked working tree files</name>
  <files>
    .claude/hooks/load-fin-core-config.ts
    .claude/skills/PortfolioSyncing/SKILL.md
    .claude/skills/PortfolioSyncing/workflows/SyncPortfolio.md
    .claude/skills/TransactionSyncing/SKILL.md
    .claude/skills/TransactionSyncing/workflows/SyncTransactions.md
    .claude/skills/fin-core/SKILL.md
    .claude/skills/margin-management/SKILL.md
    .planning/research/PITFALLS.md
    .planning/research/SUMMARY.md
    docs/hooks.md
    fin-guru/tasks/load-portfolio-context.md
    tests/integration/gitignore-protection.test.ts
    tests/integration/test_gitignore_protection.sh
  </files>
  <action>
    Replace PII in all 13+ tracked files using these substitution rules:

    **Account numbers:**
    - `{account_id}` -> `{account_id}` in code/config files, `EXAMPLE_ACCOUNT_123` in docs/examples
    - `Balances_for_Account_{account_id}` -> `Balances_for_Account_{account_id}`
    - `History_for_Account_{account_id}` -> `History_for_Account_{account_id}`

    **Google Sheets spreadsheet ID:**
    - `{spreadsheet_id}` -> `{spreadsheet_id}` in code, `YOUR_SPREADSHEET_ID` in docs

    **Personal names:**
    - `{user_name}` -> `{user_name}` in code/templates, remove from docs or replace with generic "the user"
    - The owner's first name (standalone, in PII context) -> `{user_name}` in code, generic reference in docs
    - Be CAREFUL: Do NOT replace "the owner's name" inside file paths that reference this as a username on disk (those are already in .gitignore or will be excluded). Only replace in content that would appear in the public repo.

    **Employer names:**
    - `{employer_name}` -> `{employer_name}` or remove from context
    - `CBN` in employer context (e.g., "{employer_name} 401(k)", "{employer_name} 401k") -> `{employer_name}` or remove. Do NOT replace standalone "CBN" that is not in employer context.

    **LLC names (if in working tree):**
    - `{llc_name}` -> `{llc_name}` or remove
    - `{llc_name}` -> `{llc_name}` or remove

    **Approach:**
    1. First, run `git ls-files | xargs grep -l "{account_id}"` to get the current list of affected files (research found 13).
    2. Also run `git ls-files | xargs grep -l "{spreadsheet_id}"` for spreadsheet ID files.
    3. Also run `git ls-files | xargs grep -l "{user_name}\|{user_last}"` for personal name files.
    4. Also run `git ls-files | xargs grep -l "{employer_name}\|CBN"` for employer name files.
    5. Read each file, replace PII using the rules above, write back.
    6. For test files (gitignore-protection.test.ts, test_gitignore_protection.sh): Replace the actual account number with a test pattern like `EXAMPLE_ACCOUNT_123` or `{account_id}`. The tests should verify that gitignore PATTERNS work, not that specific real account numbers are protected.
    7. Verify no tracked file still contains PII after replacements.

    **Do NOT modify:**
    - Files in .gitignore'd directories (fin-guru-private/, fin-guru/data/, research/, notebooks/)
    - The .planning/phases/01-*/01-RESEARCH.md file (it documents the problem, will be handled by git-filter-repo)
    - Files that only mention "the owner's name" in an OS-level path context (like `/Users/ossieirondi/`)
  </action>
  <verify>
    Run ALL of these and verify zero matches:
    ```bash
    git ls-files | xargs grep -l "{account_id}" 2>/dev/null | wc -l  # Must be 0
    git ls-files | xargs grep -l "{spreadsheet_id}" 2>/dev/null | wc -l  # Must be 0
    git ls-files | xargs grep -rl "\b{employer_name}\b" 2>/dev/null | wc -l  # Must be 0
    ```
    For personal names, check:
    ```bash
    git ls-files | xargs grep -l "{user_name}\|{user_last}" 2>/dev/null
    ```
    Review remaining matches -- some may be legitimate (e.g., git author config references in CLAUDE.md). Flag any that cannot be resolved and document why.
  </verify>
  <done>
    Zero tracked files contain the Fidelity account number, Google Sheets ID, or employer names. Personal name references are either removed or replaced with template variables. Any remaining "the owner's name" references are documented with justification (e.g., in git config, author attribution).
  </done>
</task>

<task type="auto">
  <name>Task 2: Harden .gitignore with complete private data coverage</name>
  <files>.gitignore</files>
  <action>
    Update .gitignore to close the gaps identified in research:

    1. **Add `.onboarding-progress.json`** -- the requirements specify this filename (currently only `.onboarding-state.json` is covered)
    2. **Broaden user-profile.yaml coverage** -- currently only covers `fin-guru/data/user-profile.yaml` (specific path). Add `**/user-profile.yaml` to catch it anywhere in the repo tree.
    3. **Verify existing coverage** -- confirm these are already present (do not duplicate):
       - `.env` and variants -- PRESENT
       - `*.csv` -- PRESENT
       - `fin-guru-private/` -- PRESENT
       - `.mcp.json` -- PRESENT
       - `.onboarding-state.json` -- PRESENT

    Add the new entries in the "Family Office - Private financial documents and user data" section of .gitignore.

    After updating, verify with:
    ```bash
    git check-ignore .onboarding-progress.json  # Must return the path
    git check-ignore some/nested/user-profile.yaml  # Must return the path
    ```
  </action>
  <verify>
    ```bash
    # All of these must return the path (meaning gitignored):
    git check-ignore .onboarding-progress.json
    git check-ignore fin-guru/data/user-profile.yaml
    git check-ignore nested/dir/user-profile.yaml
    git check-ignore .env
    git check-ignore test.csv
    git check-ignore fin-guru-private/anything
    git check-ignore .mcp.json
    git check-ignore .onboarding-state.json
    ```
  </verify>
  <done>
    .gitignore covers all file patterns specified in ONBD-15: user-profile.yaml (any location), .env, .onboarding-progress.json, .onboarding-state.json, fin-guru-private/, CSV exports, and .mcp.json. Verified with git check-ignore for each pattern.
  </done>
</task>

<task type="auto">
  <name>Task 3: Commit clean working tree to main</name>
  <files>All files modified in Tasks 1-2</files>
  <action>
    Stage and commit all PII-cleaned files and the updated .gitignore to main:

    ```bash
    git add -A  # Stage all changes (PII replacements + .gitignore update)
    git status   # Review what's being committed
    git commit -m "security(01-01): remove all PII from working tree and harden .gitignore

    - Replace account numbers, spreadsheet IDs, employer names with template variables
    - Replace personal name references with {user_name} placeholders
    - Add .onboarding-progress.json and broadened user-profile.yaml to .gitignore
    - Closes ONBD-14, ONBD-15
    - Prepares working tree for git-filter-repo history rewrite (SEC-01)"
    ```

    This commit MUST happen before Plan 02 runs git-filter-repo. The history rewrite will scrub PII from ALL prior commits, but the HEAD commit must already be clean.
  </action>
  <verify>
    ```bash
    git status  # Must show clean working tree (nothing to commit)
    git log --oneline -1  # Must show the security commit
    ```
  </verify>
  <done>
    All PII-cleaned files and .gitignore updates are committed to main. Working tree is clean and ready for git-filter-repo in Plan 02.
  </done>
</task>

</tasks>

<verification>
Run the full PII audit against the working tree:
```bash
# Specific known PII (must be zero)
git ls-files | xargs grep -rlE "{account_id}|{spreadsheet_id}|admin@kamdental|admin@unifiedental" 2>/dev/null | wc -l

# Employer names in PII context (must be zero)
git ls-files | xargs grep -rl "\b{employer_name}\b" 2>/dev/null | wc -l

# .gitignore coverage
git check-ignore .onboarding-progress.json && echo "PASS" || echo "FAIL"
git check-ignore any/path/user-profile.yaml && echo "PASS" || echo "FAIL"

# Clean working tree
git status --porcelain | wc -l  # Must be 0
```
</verification>

<success_criteria>
1. Zero tracked files contain {account_id}, the Google Sheets spreadsheet ID, or employer names
2. Personal name references replaced with template variables or removed (documented exceptions allowed)
3. .gitignore covers all ONBD-15 patterns, verified with git check-ignore
4. All changes committed to main with clean working tree
5. Ready for Plan 02 (git-filter-repo history rewrite)
</success_criteria>

<output>
After completion, create `.planning/phases/01-git-history-scrub-security-foundation/01-01-SUMMARY.md`
</output>
