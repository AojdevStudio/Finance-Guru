---
phase: 08-rolling-tracker-hedge-sizer
plan: 04
type: execute
wave: 2
depends_on: ["08-02"]
files_modified:
  - src/analysis/hedge_sizer_cli.py
autonomous: true

must_haves:
  truths:
    - "uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY outputs contract counts with budget utilization"
    - "Portfolio value auto-detected from latest CSV when --portfolio flag omitted"
    - "--output json produces structured JSON with contracts, allocations, costs, and budget validation"
    - "--help shows complete usage examples including multi-underlying and ratio override"
    - "Educational disclaimer appears on all output"
    - "--ratio flag overrides the default $50k per contract"
    - "Budget utilization percentage displayed with 80% warning threshold"
  artifacts:
    - path: "src/analysis/hedge_sizer_cli.py"
      provides: "Flat argparse CLI for hedge sizing with --portfolio, --underlyings, --ratio, --budget, --output"
      exports: ["main"]
  key_links:
    - from: "src/analysis/hedge_sizer_cli.py"
      to: "src/analysis/hedge_sizer.py"
      via: "import HedgeSizer"
      pattern: "from src\\.analysis\\.hedge_sizer import HedgeSizer"
    - from: "src/analysis/hedge_sizer_cli.py"
      to: "src/config/config_loader.py"
      via: "import load_hedge_config for CLI override chain"
      pattern: "from src\\.config import"
---

<objective>
Create the hedge sizer CLI (Layer 3) with flat argparse arguments for contract sizing, multi-underlying allocation, and budget validation display.

Purpose: This CLI follows the established single-command argparse pattern (matching all 15+ existing CLIs), providing the user-facing interface for hedge sizing. It combines portfolio auto-detection, contract calculation, allocation, and budget validation into one command.

Output: `src/analysis/hedge_sizer_cli.py` with --portfolio, --underlyings, --ratio, --budget, --output flags.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-rolling-tracker-hedge-sizer/08-RESEARCH.md
@.planning/phases/08-rolling-tracker-hedge-sizer/08-CONTEXT.md
@.planning/phases/08-rolling-tracker-hedge-sizer/08-02-SUMMARY.md

# Pattern references
@src/analysis/risk_metrics_cli.py
@src/analysis/hedge_sizer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hedge sizer CLI with all arguments and display logic</name>
  <files>src/analysis/hedge_sizer_cli.py</files>
  <action>
Create `src/analysis/hedge_sizer_cli.py` following the existing flat argparse CLI pattern from `risk_metrics_cli.py`.

**Module docstring:**
```python
#!/usr/bin/env python3
"""
Hedge Sizer CLI for Finance Guruâ„¢

ARCHITECTURE NOTE: Layer 3 of our 3-layer architecture.

Calculates hedge contract counts for your portfolio, distributes across
multiple underlyings by weight, and validates against monthly budget.

Usage:
    uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY
    uv run python src/analysis/hedge_sizer_cli.py --underlyings QQQ --ratio 40000
    uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY,IWM --budget 800 --output json

Portfolio value auto-detected from latest Fidelity CSV if --portfolio omitted.
Default sizing: 1 contract per $50,000 portfolio value.
"""
```

**Imports:**
```python
import argparse
import json
import sys
from pathlib import Path

project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

from src.analysis.hedge_sizer import HedgeSizer
from src.config import load_hedge_config
```

**DISCLAIMER constant:**
```python
DISCLAIMER = (
    "\n--- EDUCATIONAL NOTE ---\n"
    "This tool provides hedge sizing estimates for educational purposes only.\n"
    "It is NOT investment advice. Premium estimates may differ from actual market prices.\n"
    "Consult with a financial professional before trading options.\n"
    "Options involve significant risk of loss.\n"
)
```

**parse_args() function:**
```python
def parse_args():
    parser = argparse.ArgumentParser(
        description="Hedge Sizer - Calculate contract counts for portfolio protection",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=__doc__,
    )
    parser.add_argument(
        "--portfolio", type=float, default=None,
        help="Portfolio value in dollars (auto-detected from CSV if omitted)"
    )
    parser.add_argument(
        "--underlyings", type=str, required=True,
        help="Comma-separated underlying tickers (e.g., QQQ,SPY,IWM)"
    )
    parser.add_argument(
        "--ratio", type=float, default=None,
        help="Override sizing ratio (default: 50000 = 1 contract per $50k)"
    )
    parser.add_argument(
        "--budget", type=float, default=None,
        help="Override monthly hedge budget in dollars (default: from config)"
    )
    parser.add_argument(
        "--output", choices=["text", "json"], default="text",
        help="Output format (default: text)"
    )
    return parser.parse_args()
```

**main() function:**

Implementation:
1. Parse args
2. Split underlyings: `underlyings = [t.strip().upper() for t in args.underlyings.split(",")]`
3. Load config with CLI overrides: `config = load_hedge_config(cli_overrides={"monthly_budget": args.budget})`
4. Create sizer: `sizer = HedgeSizer(config=config, sizing_ratio=args.ratio)`
5. Resolve portfolio value:
   - If args.portfolio provided, use it
   - Else try auto-detect: `sizer.detect_portfolio_value()`
   - If still None, print error "Portfolio value required. Use --portfolio or ensure Portfolio_Positions_*.csv exists in notebooks/updates/", exit 1
6. Call `sizer.size_hedges(portfolio_value, underlyings, args.ratio, args.budget)`
7. Output formatting (see below)

**Text output format:**

```
=== Hedge Sizing Report ===

Portfolio Value: $200,000
Sizing Ratio:   1 contract per $50,000
Total Contracts: 4

--- Allocation ---
  QQQ: 3 contracts (75.0%)
  SPY: 1 contract  (25.0%)

--- Estimated Costs ---
  QQQ: 3 x $850 = $2,550 (strike $420, exp 2026-04-17)
  SPY: 1 x $620 = $620   (strike $480, exp 2026-04-17)

--- Budget Validation ---
  Estimated Total: $3,170
  Monthly Budget:  $800
  Utilization:     396% [OVER BUDGET]
  WARNING: Estimated cost significantly exceeds monthly budget.
  Consider reducing contracts or spreading across multiple months.

[disclaimer]
```

If a premium estimate is a fallback (not from live chain), label it as "(estimated)".

**JSON output:**
Print the complete result dict from `sizer.size_hedges()` via `json.dumps(result, indent=2, default=str)`.

**Error handling:**
```python
try:
    # ... main logic ...
except ValueError as e:
    print(f"Error: {e}", file=sys.stderr)
    sys.exit(1)
except KeyboardInterrupt:
    print("\nOperation cancelled by user", file=sys.stderr)
    sys.exit(130)
except Exception as e:
    print(f"Unexpected error: {e}", file=sys.stderr)
    sys.exit(1)
```

**if __name__ == "__main__": main()**
  </action>
  <verify>
```bash
# Verify help
uv run python src/analysis/hedge_sizer_cli.py --help

# Test with explicit portfolio value
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY

# Test with single underlying
uv run python src/analysis/hedge_sizer_cli.py --portfolio 100000 --underlyings QQQ

# Test with ratio override
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ --ratio 40000

# Test JSON output
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY --output json

# Verify JSON parses correctly
uv run python -c "
import subprocess, json
result = subprocess.run(
    ['uv', 'run', 'python', 'src/analysis/hedge_sizer_cli.py', '--portfolio', '200000', '--underlyings', 'QQQ,SPY', '--output', 'json'],
    capture_output=True, text=True
)
data = json.loads(result.stdout)
assert data['total_contracts'] == 4, f'Expected 4 contracts, got {data[\"total_contracts\"]}'
print(f'JSON OK: {data[\"total_contracts\"]} contracts, allocations: {data[\"allocations\"]}')
"

# Verify missing --underlyings gives error
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 2>&1 | grep -i "required"
```
  </verify>
  <done>hedge_sizer_cli.py exists with --portfolio, --underlyings, --ratio, --budget, --output flags. Displays contract counts, allocation weights, estimated costs, and budget utilization with 80% warning. Educational disclaimer included. HEDG-05 complete.</done>
</task>

</tasks>

<verification>
Full integration check:

```bash
# 1. CLI runs without crashing
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY

# 2. JSON output is valid
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY --output json | python3 -m json.tool

# 3. Help shows examples
uv run python src/analysis/hedge_sizer_cli.py --help | grep -c "uv run"

# 4. Three underlyings
uv run python src/analysis/hedge_sizer_cli.py --portfolio 300000 --underlyings QQQ,SPY,IWM

# 5. Ratio override
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ --ratio 40000

# 6. Verify disclaimer in text output
uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ | grep -i "educational"
```
</verification>

<success_criteria>
1. `src/analysis/hedge_sizer_cli.py` exists following flat argparse pattern (matching existing 15 CLIs)
2. --portfolio accepts manual value, auto-detects from CSV when omitted
3. --underlyings accepts comma-separated tickers
4. --ratio overrides default $50k per contract
5. --budget overrides monthly budget from config
6. --output json produces valid, parseable JSON (STD-01)
7. Text output shows allocation table, cost estimates, budget utilization
8. Budget utilization shows percentage with 80% warning (HS-02)
9. Educational disclaimer on all output (STD-02, XC-05)
10. --help shows complete usage examples (STD-03)
</success_criteria>

<output>
After completion, create `.planning/phases/08-rolling-tracker-hedge-sizer/08-04-SUMMARY.md`
</output>
