---
phase: 08-rolling-tracker-hedge-sizer
plan: 04
type: execute
wave: 2
depends_on: ["08-02"]
files_modified:
  - src/analysis/hedge_sizer_cli.py
autonomous: true

must_haves:
  truths:
    - "running `uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY` outputs contract counts with budget utilization"
    - "`--ratio` flag overrides the default $50k per contract"
    - "`--output json` produces structured JSON output"
    - "`--help` shows complete usage examples"
    - "Coverage ratio shows notional value vs portfolio value"
    - "Budget warning shows when estimated cost exceeds monthly budget (does NOT scale down)"
    - "Portfolio value cascade works: CSV auto-read -> config -> --portfolio flag"
  artifacts:
    - path: "src/analysis/hedge_sizer_cli.py"
      provides: "CLI interface for hedge contract sizing"
      exports: ["main"]
  key_links:
    - from: "src/analysis/hedge_sizer_cli.py"
      to: "src/analysis/hedge_sizer.py"
      via: "HedgeSizer import"
      pattern: "from src.analysis.hedge_sizer import HedgeSizer"
    - from: "src/analysis/hedge_sizer_cli.py"
      to: "src/config/config_loader.py"
      via: "load_hedge_config for CLI override chain"
      pattern: "from src.config.config_loader import load_hedge_config"
---

<objective>
Build the Hedge Sizer CLI (Layer 3) with standard flat argparse pattern matching all 15+ existing CLIs. Provides --portfolio, --underlyings, --ratio, --budget, and --output flags.

Purpose: User-facing interface for determining how many hedge contracts to buy, across which underlyings, and whether the cost fits the monthly budget. HEDG-05 requirement.

Output: `src/analysis/hedge_sizer_cli.py` -- standard flat argparse CLI
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/08-rolling-tracker-hedge-sizer/08-02-SUMMARY.md
@src/analysis/hedge_sizer.py
@src/config/config_loader.py
@src/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hedge_sizer_cli.py with flat argparse and formatted output</name>
  <files>src/analysis/hedge_sizer_cli.py</files>
  <action>
Create `src/analysis/hedge_sizer_cli.py` using the standard flat argparse pattern (matching the 15+ existing CLIs).

**Argparse flags:**

- `--portfolio` / `--portfolio-value` (float, optional): Portfolio value to protect. If omitted, uses cascade: Fidelity CSV -> config.
- `--underlyings` (str, optional): Comma-separated tickers, e.g., "QQQ,SPY". Defaults to config's underlying_weights keys.
- `--ratio` (float, optional): Dollars per contract. Default 50000 from config / Pydantic default. LOCKED: configurable via flag and config.
- `--budget` (float, optional): Monthly hedge budget override (overrides config's monthly_budget).
- `--output` (choices: human/json, default human): Output format. STD-01.
- `--config` (str, optional): Path to user-profile.yaml.
- `--skip-budget` (flag): Skip the live budget validation (useful when no API access).

**epilog with complete examples (STD-03):**

```
Examples:
  %(prog)s --portfolio 200000 --underlyings QQQ,SPY
  %(prog)s --portfolio 200000 --underlyings QQQ,SPY,IWM --ratio 40000
  %(prog)s --portfolio 200000 --underlyings QQQ --budget 800
  %(prog)s --output json
  %(prog)s --skip-budget
```

**Main flow:**

1. Parse args
2. Load config with CLI overrides:
   ```python
   cli_overrides = {
       "monthly_budget": args.budget,
   }
   config = load_hedge_config(profile_path=config_path, cli_overrides=cli_overrides)
   ```
3. Resolve portfolio value:
   ```python
   sizer = HedgeSizer(config)
   portfolio_value, source = sizer.resolve_portfolio_value(args.portfolio)
   ```
4. Parse underlyings: `args.underlyings.upper().split(",")` if provided, else None (use config defaults)
5. Calculate sizing: `result = sizer.calculate(portfolio_value, underlyings, args.ratio)`
6. Optionally validate budget: `budget = sizer.validate_budget(result["allocations"], config)` unless `--skip-budget`

**Human output format:**

```
Hedge Sizer - Contract Sizing Recommendation
=============================================
Portfolio Value: $200,000.00 (source: cli_flag)
Sizing Ratio: 1 contract per $50,000
Total Contracts: 4

Allocation:
  QQQ: 3 contracts (weight: 60.0%)
  SPY: 1 contract  (weight: 40.0%)

Coverage: 4 contracts cover ~$200,000 notional (100.0% of $200,000 portfolio)

Budget Analysis:
  Estimated Monthly Cost: $720.00
  Monthly Budget: $500.00
  Utilization: 144.0%
  WARNING: Recommended cost exceeds budget by $220.00 (44.0% over)

  Per Underlying:
    QQQ: 3 contracts x $180.00 premium = $540.00/mo
    SPY: 1 contract  x $180.00 premium = $180.00/mo

Note: Premium estimates based on current mid-prices. Actual costs may vary.

DISCLAIMER: For educational purposes only. Not investment advice.
Consult a qualified financial professional before executing any trades.
```

**JSON output:**
- Merge sizing result and budget result into single dict
- Add `source`, `disclaimer` fields
- `json.dumps(output, indent=2, default=str)`

**Important conventions:**
- Standard flat argparse (NOT subcommands) -- sizer is a single operation (LOCKED)
- Educational disclaimer at end of human output (STD-02, XC-05)
- Error handling: try/except with clean error message and exit(1)
- Handle case where portfolio value cannot be resolved (no CSV, no config, no flag) with clear error message
- Parse comma-separated underlyings with `.upper()` to enforce uppercase
- When budget validation scan fails for an underlying, show "estimate unavailable" instead of crashing
  </action>
  <verify>
    Run `uv run python src/analysis/hedge_sizer_cli.py --help` to verify help text shows all flags and examples.
    Run `uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY --skip-budget` to verify sizing without API calls.
    Run `uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY --skip-budget --output json` to verify JSON output.
    Run `uv run ruff check src/analysis/hedge_sizer_cli.py` passes with zero errors.
  </verify>
  <done>
    hedge_sizer_cli.py exists with standard flat argparse pattern.
    --portfolio, --underlyings, --ratio, --budget, --output, --skip-budget flags work.
    Human output shows allocation table, coverage ratio, and budget analysis.
    JSON output is well-structured.
    Educational disclaimer included.
    Error handling for missing portfolio value is clean.
  </done>
</task>

</tasks>

<verification>
- `uv run python src/analysis/hedge_sizer_cli.py --help` shows complete help with examples
- `uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY --skip-budget` shows 4 contracts (3 QQQ + 1 SPY with default weights, or 2+2 with equal weights)
- `uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ --ratio 40000 --skip-budget` shows 5 contracts
- `uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ --skip-budget --output json` returns valid JSON
- `uv run ruff check src/analysis/hedge_sizer_cli.py` exits 0
</verification>

<success_criteria>
- Flat argparse CLI matching codebase standard
- Contract sizing displayed with allocation breakdown
- Coverage ratio shown
- Budget validation warns but does not scale down
- --output json works
- Educational disclaimer present
- Portfolio value cascade functional (CSV -> config -> flag)
</success_criteria>

<output>
After completion, create `.planning/phases/08-rolling-tracker-hedge-sizer/08-04-SUMMARY.md`
</output>
