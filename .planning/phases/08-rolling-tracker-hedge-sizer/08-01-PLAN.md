---
phase: 08-rolling-tracker-hedge-sizer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/analysis/rolling_tracker.py
autonomous: true

must_haves:
  truths:
    - "RollingTracker.get_status() returns enriched position data with DTE, current value, P&L, and roll status"
    - "RollingTracker.suggest_rolls() identifies positions within 7-day DTE window and returns top-1 replacement per position"
    - "RollingTracker.log_roll() moves old position to roll-history.yaml and adds new position to positions.yaml"
    - "RollingTracker.get_history() returns roll history from roll-history.yaml"
    - "scan_chain_quiet() wraps scan_chain() with stderr suppressed"
    - "price_american_put() applies intrinsic value floor to Black-Scholes pricing"
    - "Expired positions are auto-archived when get_status() is called"
  artifacts:
    - path: "src/analysis/rolling_tracker.py"
      provides: "RollingTracker calculator class with all position management methods"
      exports: ["RollingTracker", "scan_chain_quiet", "price_american_put"]
  key_links:
    - from: "src/analysis/rolling_tracker.py"
      to: "src/models/hedging_inputs.py"
      via: "HedgePosition, RollSuggestion imports"
      pattern: "from src.models.hedging_inputs import"
    - from: "src/analysis/rolling_tracker.py"
      to: "src/config/config_loader.py"
      via: "HedgeConfig, load_hedge_config imports"
      pattern: "from src.config.config_loader import"
    - from: "src/analysis/rolling_tracker.py"
      to: "src/analysis/options_chain_cli.py"
      via: "scan_chain import wrapped by scan_chain_quiet"
      pattern: "from src.analysis.options_chain_cli import scan_chain"
    - from: "src/analysis/rolling_tracker.py"
      to: "src/analysis/options.py"
      via: "price_option import for American put pricing"
      pattern: "from src.analysis.options import price_option"
---

<objective>
Build the RollingTracker calculator class (Layer 2) that manages options hedge positions: status display with live pricing, roll suggestions, roll logging, and history. Includes the scan_chain_quiet wrapper and price_american_put helper.

Purpose: This is the business logic layer for the Rolling Tracker CLI. It wires together existing options chain scanning, BS pricing, config loading, and YAML state management into a cohesive position management engine.

Output: `src/analysis/rolling_tracker.py` -- a single calculator class with helper functions
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/models/hedging_inputs.py
@src/config/config_loader.py
@src/analysis/options.py
@src/analysis/options_chain_cli.py
@src/models/options_inputs.py
@src/utils/market_data.py
@src/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RollingTracker calculator with helpers and all methods</name>
  <files>src/analysis/rolling_tracker.py</files>
  <action>
Create `src/analysis/rolling_tracker.py` following the established Layer 2 calculator pattern (see `src/analysis/risk_metrics.py` for reference).

**Helper functions (module-level):**

1. `scan_chain_quiet(ticker, option_type, otm_min, otm_max, days_min, days_max, budget=None, target_contracts=1) -> OptionsChainOutput`:
   - Import `scan_chain` from `src.analysis.options_chain_cli`
   - Use `contextlib.redirect_stderr(io.StringIO())` to suppress the 12 stderr print statements
   - Pass through all arguments identically to `scan_chain()`
   - Return the `OptionsChainOutput` result

2. `price_american_put(spot, strike, days_to_expiry, volatility, risk_free_rate=0.045, dividend_yield=0.0) -> float`:
   - Import `price_option` from `src.analysis.options`
   - Call `price_option()` with `option_type="put"` and all passed args
   - Calculate `intrinsic_value = max(strike - spot, 0.0)`
   - Return `max(greeks.option_price, intrinsic_value)`
   - Add a docstring explaining BS limitation on American-style options and the intrinsic value floor (BS-01)

3. `load_positions() -> list[HedgePosition]`:
   - Read `fin-guru-private/hedging/positions.yaml`
   - Use `yaml.safe_load(f) or {}` for empty file safety (Pitfall 5 from research)
   - Parse each entry through `HedgePosition(**entry)`, skip invalid with stderr warning
   - Return list of valid positions

4. `save_positions(positions: list[HedgePosition]) -> None`:
   - Write positions back using `model_dump(mode="json")` for date serialization
   - Create parent dirs if needed

5. `load_roll_history() -> list[dict]`:
   - Read `fin-guru-private/hedging/roll-history.yaml`
   - Return list of roll records

6. `save_roll_history(history: list[dict]) -> None`:
   - Write roll history back to YAML

**RollingTracker class:**

Constructor: `__init__(self, config: HedgeConfig)` -- stores config, sets `PROJECT_ROOT` and `HEDGING_DIR` paths.

Methods:

1. `get_status(self) -> dict`:
   - Load positions via `load_positions()`
   - Auto-archive expired positions: if `position.expiry` and `position.expiry < date.today()`, move to roll-history with reason "expired" and remove from active positions. Save both files.
   - For each remaining position:
     - Calculate DTE: `(position.expiry - date.today()).days` if expiry exists, else None
     - For puts: fetch spot price via `get_prices(position.ticker)`, then calculate current value using `price_american_put()` with default IV of 0.30. Use Finnhub API via market_data if available, fall back to yfinance.
     - For inverse_etf: fetch current price via `get_prices(position.ticker)`
     - Calculate P&L: `current_total - entry_cost` where entry_cost = premium_paid * (100 * quantity for puts, quantity for ETFs)
     - Determine status label: "ROLL" if DTE <= 7, "EXPIRING" if DTE <= 14, "OK" otherwise
     - Determine DTE color: "red" if DTE < 7, "yellow" if 7-14, "green" if > 14
   - Build summary: total_hedge_cost, total_current_value, total_pnl, position count
   - Return dict with "positions" list and "summary" dict. Each position dict has: ticker, hedge_type, strike, expiry, dte, entry_premium, current_value, p_and_l, status, dte_color, contract_symbol, quantity

2. `suggest_rolls(self) -> list[dict]`:
   - Load positions, filter to puts with `dte <= 7` (fixed 7-day roll window, LOCKED decision)
   - For each expiring position, call `scan_chain_quiet()` with config's OTM and DTE targets
   - From scan results, rank by closest match to configured targets (target OTM midpoint, target DTE midpoint)
   - Pick top 1 best match per position
   - Calculate estimated roll cost: `new_premium - remaining_value` where remaining_value is the current put value from `price_american_put()`
   - Return list of dicts, each containing: current_position info, suggested contract (from OptionContractData), estimated_roll_cost, new_premium, remaining_value
   - If scan_chain_quiet raises or returns empty, include the position with a "no candidates found" message

3. `log_roll(self, ticker: str, new_strike: float, new_expiry: date, new_premium: float) -> dict`:
   - Load positions, find the put position matching `ticker` (auto-detect from positions.yaml by ticker -- LOCKED decision)
   - If not found, raise ValueError
   - Archive old position to roll-history (append to history list with roll_date, old_position data, reason="rolled")
   - Create new HedgePosition with the new parameters, same quantity as old
   - Replace old position in positions list with new
   - Save both positions.yaml and roll-history.yaml
   - Return dict with old_position, new_position, and roll_date

4. `get_history(self) -> list[dict]`:
   - Load and return roll history from roll-history.yaml
   - Return empty list if file doesn't exist or is empty

**Important implementation notes:**
- Use `from __future__ import annotations` for forward references
- Handle Finnhub/yfinance API errors gracefully: if price fetch fails for a position, return entry_cost as current_value with a warning flag "pricing_error: true" (LOCKED: Claude's discretion on Finnhub error handling)
- All methods should work with empty positions.yaml (return empty lists/dicts)
- Use `PROJECT_ROOT = Path(__file__).parent.parent.parent` for path resolution (matches config_loader.py pattern)
- Add module-level docstring with BS-01 documentation about American-style options limitation
- Include educational disclaimer in module docstring
  </action>
  <verify>
    Run `uv run python -c "from src.analysis.rolling_tracker import RollingTracker, scan_chain_quiet, price_american_put; print('imports OK')"` to verify module loads.
    Run `uv run python -c "from src.analysis.rolling_tracker import price_american_put; p = price_american_put(100.0, 120.0, 30, 0.30); print(f'American put: {p:.2f}'); assert p >= 20.0, 'Intrinsic floor failed'"` to verify American put pricing floor.
    Run `uv run ruff check src/analysis/rolling_tracker.py` passes with zero errors.
  </verify>
  <done>
    RollingTracker class exists with get_status, suggest_rolls, log_roll, get_history methods.
    scan_chain_quiet wrapper suppresses stderr from scan_chain.
    price_american_put applies intrinsic value floor to BS pricing.
    Module loads without errors and passes ruff linting.
  </done>
</task>

</tasks>

<verification>
- `from src.analysis.rolling_tracker import RollingTracker` works
- `price_american_put(100, 120, 30, 0.30)` returns >= 20.0 (intrinsic floor for deep ITM put)
- `price_american_put(100, 80, 30, 0.30)` returns BS price (OTM, no floor needed)
- `RollingTracker(config).get_status()` returns a dict with "positions" and "summary" keys (may be empty if no positions.yaml)
- `uv run ruff check src/analysis/rolling_tracker.py` exits 0
</verification>

<success_criteria>
- RollingTracker calculator class is complete with all 4 methods: get_status, suggest_rolls, log_roll, get_history
- Helper functions scan_chain_quiet, price_american_put, load_positions, save_positions exist and work
- American put pricing floor is documented (BS-01) and functional
- All imports from Phase 6 models and existing analysis modules resolve correctly
</success_criteria>

<output>
After completion, create `.planning/phases/08-rolling-tracker-hedge-sizer/08-01-SUMMARY.md`
</output>
