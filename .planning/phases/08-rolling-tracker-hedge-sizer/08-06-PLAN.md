---
phase: 08-rolling-tracker-hedge-sizer
plan: 06
type: tdd
wave: 3
depends_on: ["08-01", "08-02", "08-03", "08-04"]
files_modified:
  - tests/python/test_rolling_tracker.py
  - tests/python/test_hedge_sizer.py
autonomous: true

must_haves:
  truths:
    - "Known-answer tests verify contract sizing formula: floor(200000/50000) == 4"
    - "Known-answer tests verify contract allocation with remainder: 5 contracts, 60/40 split -> 3+2"
    - "Known-answer tests verify American put intrinsic floor: deep ITM put >= intrinsic value"
    - "Known-answer tests verify DTE calculation and roll status labeling"
    - "Known-answer tests verify portfolio value cascade"
    - "Tests use synthetic data (no real API calls) following Phase 5 pattern"
    - "All tests pass with `uv run pytest tests/python/test_rolling_tracker.py tests/python/test_hedge_sizer.py`"
  artifacts:
    - path: "tests/python/test_rolling_tracker.py"
      provides: "Known-answer tests for RollingTracker calculator"
      contains: "test_price_american_put"
    - path: "tests/python/test_hedge_sizer.py"
      provides: "Known-answer tests for HedgeSizer calculator"
      contains: "test_calculate_contract_count"
  key_links:
    - from: "tests/python/test_rolling_tracker.py"
      to: "src/analysis/rolling_tracker.py"
      via: "import RollingTracker, price_american_put"
      pattern: "from src.analysis.rolling_tracker import"
    - from: "tests/python/test_hedge_sizer.py"
      to: "src/analysis/hedge_sizer.py"
      via: "import HedgeSizer, calculate_contract_count, allocate_contracts"
      pattern: "from src.analysis.hedge_sizer import"
---

<objective>
Write known-answer tests for both calculators and verify CLIs work via subprocess. Follows STD-04 and HEDG-13 requirements using TDD RED-GREEN-REFACTOR cycle.

Purpose: Validates correctness of financial calculations with deterministic expected values. All tests use synthetic data -- zero real API calls -- following the Phase 5 testing pattern.

Output: Two test files with comprehensive unit tests
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/08-rolling-tracker-hedge-sizer/08-01-SUMMARY.md
@.planning/phases/08-rolling-tracker-hedge-sizer/08-02-SUMMARY.md
@src/analysis/rolling_tracker.py
@src/analysis/hedge_sizer.py
@tests/python/test_risk_metrics.py
@src/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write known-answer tests for RollingTracker</name>
  <files>tests/python/test_rolling_tracker.py</files>
  <action>
Create `tests/python/test_rolling_tracker.py` with known-answer tests following the Phase 5 testing pattern (synthetic data, no API calls).

**Test categories:**

1. **price_american_put tests:**
   - `test_price_american_put_deep_itm()`: spot=100, strike=120, DTE=30, vol=0.30 -> result >= 20.0 (intrinsic floor)
   - `test_price_american_put_otm()`: spot=100, strike=80, DTE=30, vol=0.30 -> result > 0 and result < 5.0 (OTM, no floor needed, small time value)
   - `test_price_american_put_atm()`: spot=100, strike=100, DTE=30, vol=0.30 -> result > 0 (ATM has time value)
   - `test_price_american_put_zero_dte()`: spot=100, strike=120, DTE=1, vol=0.30 -> result >= 20.0 (intrinsic floor at expiry)

2. **Position loading tests (mocked YAML):**
   - `test_load_positions_empty_file()`: empty YAML returns empty list (Pitfall 5)
   - `test_load_positions_valid()`: mock YAML with 2 positions, verify HedgePosition models returned
   - `test_load_positions_invalid_entry()`: one valid + one invalid entry -> returns 1 valid position with warning

3. **Status calculation tests (mocked market data):**
   - `test_get_status_empty_positions()`: no positions -> empty positions list, zero summary
   - `test_get_status_with_position()`: mock position with known values, mock get_prices -> verify DTE, P&L calculation
   - `test_expired_position_auto_archive()`: position with past expiry -> moved to history, removed from active
   - `test_dte_status_labels()`: DTE=5 -> "ROLL", DTE=10 -> "EXPIRING", DTE=20 -> "OK"
   - `test_dte_color_coding()`: DTE=5 -> "red", DTE=10 -> "yellow", DTE=20 -> "green"

4. **Roll suggestion tests (mocked scan_chain):**
   - `test_suggest_rolls_no_expiring()`: all positions have DTE > 7 -> empty suggestions list
   - `test_suggest_rolls_with_expiring()`: position with DTE=3 -> returns suggestion with roll cost

5. **Log-roll tests (mocked YAML):**
   - `test_log_roll_success()`: valid ticker found in positions -> old archived, new created
   - `test_log_roll_ticker_not_found()`: invalid ticker -> raises ValueError

6. **CLI integration tests (subprocess):**
   - `test_cli_help()`: `--help` exits 0 and shows "status", "suggest-roll", "log-roll", "history"
   - `test_cli_status_json()`: `status --output json` exits 0 and returns valid JSON

**Mocking strategy:**
- Use `unittest.mock.patch` to mock:
  - `src.analysis.rolling_tracker.get_prices` (market data)
  - `src.analysis.rolling_tracker.scan_chain` (options chain)
  - YAML file I/O (use tmp_path fixtures)
- Use `pytest.mark.integration` for tests that actually call APIs (skip by default)
- All known-answer tests are pure unit tests with synthetic data

**Test fixtures:**
- `sample_put_position`: HedgePosition with known values (QQQ, put, strike=420, expiry=future_date, qty=2, premium=8.50)
- `sample_config`: HedgeConfig with defaults
- `tmp_positions_yaml`: tmp_path with sample positions.yaml
  </action>
  <verify>
    Run `uv run pytest tests/python/test_rolling_tracker.py -v` -- all tests pass.
    Run `uv run ruff check tests/python/test_rolling_tracker.py` -- no lint errors.
  </verify>
  <done>
    Known-answer tests for RollingTracker cover: American put pricing, position loading, status calculation, DTE labeling, roll suggestions, log-roll, and CLI integration.
    All tests use synthetic data with mocked market data calls.
    All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write known-answer tests for HedgeSizer</name>
  <files>tests/python/test_hedge_sizer.py</files>
  <action>
Create `tests/python/test_hedge_sizer.py` with known-answer tests.

**Test categories:**

1. **Contract sizing formula tests:**
   - `test_calculate_contract_count_200k()`: 200000 / 50000 = 4
   - `test_calculate_contract_count_175k()`: 175000 / 50000 = 3 (floor)
   - `test_calculate_contract_count_49k()`: 49999 / 50000 = 0 (below threshold)
   - `test_calculate_contract_count_zero()`: 0 -> 0
   - `test_calculate_contract_count_custom_ratio()`: 200000 / 40000 = 5

2. **Contract allocation tests:**
   - `test_allocate_equal_split()`: 4 contracts, {"QQQ": 0.5, "SPY": 0.5} -> {"QQQ": 2, "SPY": 2}
   - `test_allocate_with_remainder()`: 5 contracts, {"QQQ": 0.6, "SPY": 0.4} -> {"QQQ": 3, "SPY": 2}
   - `test_allocate_single_underlying()`: 4 contracts, {"QQQ": 1.0} -> {"QQQ": 4}
   - `test_allocate_three_underlyings()`: 7 contracts, {"QQQ": 0.5, "SPY": 0.3, "IWM": 0.2} -> verify total = 7, QQQ gets remainder
   - `test_allocate_zero_contracts()`: 0 contracts -> all zeros

3. **Portfolio value cascade tests (mocked CSV):**
   - `test_resolve_portfolio_cli_flag()`: CLI value provided -> uses it, source="cli_flag"
   - `test_resolve_portfolio_csv()`: no CLI value, CSV exists with $202,000 -> uses CSV, source="fidelity_csv"
   - `test_resolve_portfolio_no_source()`: no CLI, no CSV, no config -> raises ValueError

4. **Full calculate() tests:**
   - `test_calculate_basic()`: 200k portfolio, QQQ+SPY -> 4 contracts allocated
   - `test_calculate_custom_ratio()`: 200k portfolio, ratio=40000 -> 5 contracts
   - `test_calculate_coverage_ratio()`: verify coverage_pct calculation

5. **Budget validation tests (mocked scan_chain):**
   - `test_validate_budget_within()`: estimated cost < budget -> within_budget=True
   - `test_validate_budget_over()`: estimated cost > budget -> within_budget=False, warning shows full recommendation
   - `test_validate_budget_scan_failure()`: scan_chain fails -> per_underlying shows "estimate_unavailable"

6. **CLI integration tests (subprocess):**
   - `test_cli_help()`: `--help` exits 0 and shows "--portfolio", "--underlyings"
   - `test_cli_sizing_skip_budget()`: `--portfolio 200000 --underlyings QQQ,SPY --skip-budget` exits 0
   - `test_cli_json_output()`: `--portfolio 200000 --underlyings QQQ --skip-budget --output json` returns valid JSON

**Test fixtures:**
- `sample_config`: HedgeConfig with defaults
- `tmp_csv`: tmp_path with mock Fidelity balance CSV

**Known-answer emphasis:** Every test with financial calculations has the exact expected result hardcoded and documented (e.g., "floor(200000/50000) = 4"). This is STD-04.
  </action>
  <verify>
    Run `uv run pytest tests/python/test_hedge_sizer.py -v` -- all tests pass.
    Run `uv run ruff check tests/python/test_hedge_sizer.py` -- no lint errors.
    Run `uv run pytest tests/python/test_rolling_tracker.py tests/python/test_hedge_sizer.py -v` -- all tests from both files pass together.
  </verify>
  <done>
    Known-answer tests for HedgeSizer cover: sizing formula, allocation, portfolio cascade, full calculate, budget validation, and CLI integration.
    All tests use synthetic data with mocked API calls.
    All tests pass.
    Combined test run with rolling_tracker tests passes.
  </done>
</task>

</tasks>

<verification>
- `uv run pytest tests/python/test_rolling_tracker.py tests/python/test_hedge_sizer.py -v` -- all tests pass
- `uv run pytest tests/python/test_rolling_tracker.py tests/python/test_hedge_sizer.py --co` -- lists 25+ tests
- `uv run ruff check tests/python/test_rolling_tracker.py tests/python/test_hedge_sizer.py` -- exits 0
- No tests marked `@pytest.mark.integration` are run by default (API tests skipped)
</verification>

<success_criteria>
- Both test files exist with comprehensive unit tests
- All known-answer tests verify exact expected values
- All tests use synthetic data (no real API calls)
- Combined test suite passes: `uv run pytest tests/python/test_rolling_tracker.py tests/python/test_hedge_sizer.py`
- Tests cover: sizing formula, allocation, American put pricing, DTE labeling, budget validation, CLI help/JSON
</success_criteria>

<output>
After completion, create `.planning/phases/08-rolling-tracker-hedge-sizer/08-06-SUMMARY.md`
</output>
