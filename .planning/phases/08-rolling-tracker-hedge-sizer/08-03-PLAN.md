---
phase: 08-rolling-tracker-hedge-sizer
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/analysis/rolling_tracker_cli.py
autonomous: true

must_haves:
  truths:
    - "uv run python src/analysis/rolling_tracker_cli.py status displays positions with P&L, DTE, current value, and roll status"
    - "uv run python src/analysis/rolling_tracker_cli.py suggest-roll identifies positions within DTE window and shows replacement candidates"
    - "uv run python src/analysis/rolling_tracker_cli.py log-roll --old SYMBOL --new SYMBOL --cost N records a roll"
    - "uv run python src/analysis/rolling_tracker_cli.py history displays roll history"
    - "--output json produces valid JSON for all subcommands"
    - "--help shows complete examples for all subcommands"
    - "All output includes educational disclaimer"
  artifacts:
    - path: "src/analysis/rolling_tracker_cli.py"
      provides: "Rolling tracker CLI with argparse subcommands (status, suggest-roll, log-roll, history)"
      exports: ["main"]
      min_lines: 150
  key_links:
    - from: "src/analysis/rolling_tracker_cli.py"
      to: "src/analysis/rolling_tracker.py"
      via: "import RollingTracker"
      pattern: "from src\\.analysis\\.rolling_tracker import RollingTracker"
    - from: "src/analysis/rolling_tracker_cli.py"
      to: "src/config/config_loader.py"
      via: "import load_hedge_config for CLI override chain"
      pattern: "from src\\.config\\.config_loader import load_hedge_config"
---

<objective>
Build the rolling_tracker_cli.py (Layer 3) -- the first argparse subcommand CLI in the codebase.

Purpose: This is the user-facing interface for the rolling tracker. It introduces the argparse subcommand pattern (HEDG-04) with four commands: status, suggest-roll, log-roll, history. It connects the RollingTracker calculator to CLI arguments, output formatting, and the config override chain.

Output:
- `src/analysis/rolling_tracker_cli.py` with 4 subcommands and JSON/human output
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-rolling-tracker-hedge-sizer/08-RESEARCH.md

# Plan 01 SUMMARY (Layer 2 this CLI wraps)
@.planning/phases/08-rolling-tracker-hedge-sizer/08-01-SUMMARY.md

# Existing CLI pattern reference (THE template to follow)
@src/analysis/risk_metrics_cli.py
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rolling_tracker_cli.py with argparse subcommands</name>
  <files>src/analysis/rolling_tracker_cli.py</files>
  <action>
Create `src/analysis/rolling_tracker_cli.py` following the Layer 3 CLI pattern with a NEW subcommand pattern.

**Module docstring:**
```python
#!/usr/bin/env python3
"""
Rolling Tracker CLI for Finance Guru(tm)

Monitor hedge positions, get roll alerts, and log position rolls.

ARCHITECTURE NOTE: Layer 3 of our 3-layer architecture.
This is the FIRST argparse subcommand CLI in the codebase.

Usage:
    uv run python src/analysis/rolling_tracker_cli.py status
    uv run python src/analysis/rolling_tracker_cli.py suggest-roll
    uv run python src/analysis/rolling_tracker_cli.py suggest-roll --window 14
    uv run python src/analysis/rolling_tracker_cli.py log-roll --old QQQ260417P00420000 --new QQQ260619P00440000 --cost 8.50
    uv run python src/analysis/rolling_tracker_cli.py history
    uv run python src/analysis/rolling_tracker_cli.py history --output json
"""
```

**Imports:**
```python
import argparse
import json
import sys
from pathlib import Path

# Add project root to path
project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

from src.analysis.rolling_tracker import RollingTracker
from src.config.config_loader import load_hedge_config
```

**DISCLAIMER constant:**
```python
DISCLAIMER = (
    "\nDISCLAIMER: For educational purposes only. Not investment advice. "
    "Consult a qualified financial professional before executing any trades."
)
```

**Parser setup (follow research Pattern 1 exactly):**
- Create main parser with description, RawDescriptionHelpFormatter, epilog with examples
- Add shared top-level arguments:
  - `--output` choices=['human', 'json'], default='human'
  - `--config` type=str, default=None, help for path to user-profile.yaml
- Create subparsers with `dest='command'`, `required=True`

**Subcommand: status**
- Parser: `subparsers.add_parser('status', help='Display current hedge positions with P&L')`
- Handler `cmd_status(args)`:
  - Build config from load_hedge_config with CLI overrides
  - Create RollingTracker(config)
  - Call tracker.get_status()
  - If no positions: print "No active hedge positions found." and return 0
  - Human output: formatted table with columns: Ticker | Type | Strike | Expiry | DTE | Entry | Current | P&L | Status
  - JSON output: `json.dumps(positions, indent=2, default=str)`
  - Append DISCLAIMER
  - Return 0

**Subcommand: suggest-roll**
- Parser: add `--window` type=int, default=None, help for custom roll window days
- Handler `cmd_suggest_roll(args)`:
  - Build config, create tracker
  - Call tracker.suggest_rolls(window_override=args.window)
  - If no suggestions: print "No positions currently need rolling." and return 0
  - Human output: for each suggestion, show:
    - Current: {ticker} {contract_symbol} (DTE: {dte})
    - Suggested: Strike ${strike} Expiry {expiry} (Est. cost: ${cost}/contract)
    - Reason: {reason}
  - JSON output: serialize suggestions using model_dump(mode="json")
  - Append DISCLAIMER
  - Return 0

**Subcommand: log-roll**
- Parser: add `--old` required=True, `--new` required=True, `--cost` type=float required=True, `--received` type=float default=0.0
- Handler `cmd_log_roll(args)`:
  - Build config, create tracker
  - Call tracker.log_roll(old_symbol=args.old, new_symbol=args.new, cost=args.cost, received=args.received)
  - Human output: "Roll logged successfully." with summary
  - JSON output: json.dumps result
  - Return 0

**Subcommand: history**
- Parser: no extra args
- Handler `cmd_history(args)`:
  - Build config, create tracker
  - Call tracker.get_history()
  - If no history: print "No roll history found."
  - Human output: formatted list of rolls with dates, symbols, net costs
  - JSON output: json.dumps
  - Return 0

**main() function:**
```python
def main():
    parser = build_parser()
    args = parser.parse_args()

    try:
        return args.func(args)
    except ValueError as e:
        print(f"Error: {e}", file=sys.stderr)
        return 1
    except Exception as e:
        print(f"Unexpected error: {e}", file=sys.stderr)
        return 1

if __name__ == '__main__':
    sys.exit(main() or 0)
```

**IMPORTANT conventions:**
- Use `set_defaults(func=handler)` for dispatch (not if/elif chain)
- Use `required=True` on subparsers
- Hyphenated subcommand names: `suggest-roll`, `log-roll`
- Each handler returns int (0 success, 1 error)
- Error handling in main() wraps all handlers
- No business logic -- all calculation is in rolling_tracker.py (Layer 2)
- Human output uses aligned columns; JSON uses model_dump_json or json.dumps
- DISCLAIMER appended to all human output
  </action>
  <verify>
Test help output:
```bash
uv run python src/analysis/rolling_tracker_cli.py --help
uv run python src/analysis/rolling_tracker_cli.py status --help
uv run python src/analysis/rolling_tracker_cli.py suggest-roll --help
uv run python src/analysis/rolling_tracker_cli.py log-roll --help
uv run python src/analysis/rolling_tracker_cli.py history --help
```

Test status with empty positions (should not error):
```bash
uv run python src/analysis/rolling_tracker_cli.py status
uv run python src/analysis/rolling_tracker_cli.py status --output json
```

Test history with empty history:
```bash
uv run python src/analysis/rolling_tracker_cli.py history
uv run python src/analysis/rolling_tracker_cli.py history --output json
```

Test suggest-roll with empty positions:
```bash
uv run python src/analysis/rolling_tracker_cli.py suggest-roll
```

Verify JSON output is valid:
```bash
uv run python src/analysis/rolling_tracker_cli.py status --output json | python -m json.tool > /dev/null 2>&1 && echo "Valid JSON" || echo "Note: may return empty-positions message instead of JSON"
```
  </verify>
  <done>
rolling_tracker_cli.py exists with 4 argparse subcommands (status, suggest-roll, log-roll, history), JSON/human output formats, educational disclaimer, and complete --help examples. First subcommand CLI in the codebase.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify CLI end-to-end with sample position data</name>
  <files>src/analysis/rolling_tracker_cli.py</files>
  <action>
Create a temporary test positions.yaml with sample data and verify the full CLI flow works end-to-end.

1. Write a sample position to fin-guru-private/hedging/positions.yaml:
```yaml
positions:
  - ticker: QQQ
    hedge_type: put
    strike: 420.00
    expiry: "2026-04-17"
    quantity: 2
    premium_paid: 8.50
    entry_date: "2026-02-01"
    contract_symbol: "QQQ260417P00420000"
```

2. Run `uv run python src/analysis/rolling_tracker_cli.py status` -- verify it shows the position with DTE, current value, P&L
3. Run `uv run python src/analysis/rolling_tracker_cli.py status --output json` -- verify valid JSON with all fields
4. Run `uv run python src/analysis/rolling_tracker_cli.py suggest-roll` -- verify it either suggests a roll (if DTE within window) or says no rolls needed
5. Run `uv run python src/analysis/rolling_tracker_cli.py history` -- verify empty history message

6. Restore positions.yaml to its original state (empty positions list) after testing:
```yaml
positions: []
```

NOTE: The sample position expiry (2026-04-17) is far enough out that suggest-roll should say "no rolls needed" with default 7-day window. To test roll detection, you could also add a position with expiry close to today's date and verify it shows up.

7. Verify disclaimer appears in human output for each subcommand.
  </action>
  <verify>
```bash
# All subcommands should exit with code 0
uv run python src/analysis/rolling_tracker_cli.py status; echo "Exit: $?"
uv run python src/analysis/rolling_tracker_cli.py suggest-roll; echo "Exit: $?"
uv run python src/analysis/rolling_tracker_cli.py history; echo "Exit: $?"
```

Verify disclaimer is present:
```bash
uv run python src/analysis/rolling_tracker_cli.py status 2>/dev/null | grep -i "disclaimer" && echo "Disclaimer found" || echo "WARNING: No disclaimer in output"
```
  </verify>
  <done>
Rolling tracker CLI works end-to-end: status shows positions with live data, suggest-roll checks DTE window, log-roll records rolls, history shows records. JSON output is valid. Disclaimer present.
  </done>
</task>

</tasks>

<verification>
```bash
# 1. Help text is complete
uv run python src/analysis/rolling_tracker_cli.py --help | head -20

# 2. All 4 subcommands exist
for cmd in status suggest-roll log-roll history; do
  uv run python src/analysis/rolling_tracker_cli.py $cmd --help > /dev/null 2>&1 && echo "$cmd: OK" || echo "$cmd: FAIL"
done

# 3. Missing subcommand gives error (not silent)
uv run python src/analysis/rolling_tracker_cli.py 2>&1 | grep -i "required\|error" && echo "Missing subcommand handled" || echo "WARNING"

# 4. Layer 3 has no calculator logic
grep -c "math\.\|numpy\|pandas\|scipy" src/analysis/rolling_tracker_cli.py && echo "WARNING: Calculator code found in CLI" || echo "Layer 3 purity OK"
```
</verification>

<success_criteria>
1. `rolling_tracker_cli.py status` displays positions table with P&L, DTE, current value (RT-01)
2. `rolling_tracker_cli.py suggest-roll` identifies positions within DTE window (RT-02, RT-03)
3. `rolling_tracker_cli.py log-roll --old X --new Y --cost Z` records a roll (HEDG-04)
4. `rolling_tracker_cli.py history` shows roll records (HEDG-04)
5. `--output json` produces valid JSON for all subcommands (STD-01)
6. `--help` shows complete examples (STD-03)
7. Educational disclaimer on all output (STD-02)
8. Argparse subcommand pattern with set_defaults(func=handler) (HEDG-04)
</success_criteria>

<output>
After completion, create `.planning/phases/08-rolling-tracker-hedge-sizer/08-03-SUMMARY.md`
</output>
