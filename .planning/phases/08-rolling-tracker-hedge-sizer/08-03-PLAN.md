---
phase: 08-rolling-tracker-hedge-sizer
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/analysis/rolling_tracker_cli.py
autonomous: true

must_haves:
  truths:
    - "uv run python src/analysis/rolling_tracker_cli.py status displays ASCII table with Ticker, Strike, Expiry, DTE, Qty, Cost, Current Value, P&L, P&L% columns"
    - "uv run python src/analysis/rolling_tracker_cli.py suggest-roll shows positions within 7-day DTE window with top 3 replacement candidates"
    - "uv run python src/analysis/rolling_tracker_cli.py log-position --ticker QQQ --type put --strike 420 --expiry 2026-04-17 --quantity 2 --premium 8.50 adds a position"
    - "uv run python src/analysis/rolling_tracker_cli.py import-csv --file path/to/fidelity.csv imports options positions from CSV"
    - "uv run python src/analysis/rolling_tracker_cli.py log-roll --close-index 0 --ticker QQQ --strike 450 --expiry 2026-05-15 --quantity 2 --premium 10.00 records a roll"
    - "uv run python src/analysis/rolling_tracker_cli.py history displays all historical rolls"
    - "All subcommands support --output json for programmatic use"
    - "--help shows complete usage examples for each subcommand"
    - "DTE urgency rendering: no marker for DTE>7, [ROLL] for 3<DTE<=7 (red), [EXPIRING] for 0<DTE<=3 (red), [EXPIRED] for DTE<=0; color: Green >14, Yellow 7-14, Red <7"
  artifacts:
    - path: "src/analysis/rolling_tracker_cli.py"
      provides: "CLI with 6 argparse subcommands: status, suggest-roll, log-position, import-csv, log-roll, history"
      exports: ["main"]
  key_links:
    - from: "src/analysis/rolling_tracker_cli.py"
      to: "src/analysis/rolling_tracker.py"
      via: "import RollingTracker"
      pattern: "from src\\.analysis\\.rolling_tracker import RollingTracker"
    - from: "src/analysis/rolling_tracker_cli.py"
      to: "src/config/config_loader.py"
      via: "import load_hedge_config for CLI override chain"
      pattern: "from src\\.config import"
---

<objective>
Create the rolling tracker CLI (Layer 3) with argparse subcommands for position management: status, suggest-roll, log-position, import-csv, log-roll, and history.

Purpose: This is the first argparse subcommand CLI in the codebase (HEDG-04), establishing the pattern for future tools that need multiple operations. It provides the user-facing interface for all position lifecycle operations (including Fidelity CSV import), with both human-readable ASCII tables and JSON output.

Output: `src/analysis/rolling_tracker_cli.py` with 6 subcommands and --output json support.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-rolling-tracker-hedge-sizer/08-RESEARCH.md
@.planning/phases/08-rolling-tracker-hedge-sizer/08-CONTEXT.md
@.planning/phases/08-rolling-tracker-hedge-sizer/08-01-SUMMARY.md

# Pattern references
@src/analysis/risk_metrics_cli.py
@src/analysis/rolling_tracker.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CLI skeleton with status and suggest-roll subcommands</name>
  <files>src/analysis/rolling_tracker_cli.py</files>
  <action>
Create `src/analysis/rolling_tracker_cli.py` as the first subcommand CLI in the codebase.

**Module docstring:**
```python
#!/usr/bin/env python3
"""
Rolling Tracker CLI for Finance Guruâ„¢

ARCHITECTURE NOTE: Layer 3 of our 3-layer architecture.
This is the first argparse subcommand CLI in the codebase.

Monitors hedge positions, alerts on upcoming expirations,
suggests replacement contracts, and logs position changes.

Usage:
    uv run python src/analysis/rolling_tracker_cli.py status
    uv run python src/analysis/rolling_tracker_cli.py suggest-roll
    uv run python src/analysis/rolling_tracker_cli.py log-position --ticker QQQ --type put --strike 420 --expiry 2026-04-17 --quantity 2 --premium 8.50
    uv run python src/analysis/rolling_tracker_cli.py import-csv --file path/to/fidelity-export.csv
    uv run python src/analysis/rolling_tracker_cli.py log-roll --close-index 0 --ticker QQQ --strike 450 --expiry 2026-05-15 --quantity 2 --premium 10.00
    uv run python src/analysis/rolling_tracker_cli.py history

All commands support --output json for programmatic use.
"""
```

**Imports:**
```python
import argparse
import json
import sys
from pathlib import Path

project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

from src.analysis.rolling_tracker import RollingTracker
from src.config import load_hedge_config
```

**DISCLAIMER constant:**
```python
DISCLAIMER = (
    "\n--- EDUCATIONAL NOTE ---\n"
    "This tool provides position tracking and roll suggestions for educational purposes.\n"
    "It is NOT investment advice. Consult with a financial professional before trading options.\n"
    "Past performance does not indicate future results. Options involve significant risk.\n"
)
```

**Parser setup using argparse subcommands pattern from RESEARCH.md:**
```python
def build_parser() -> argparse.ArgumentParser:
    parser = argparse.ArgumentParser(
        description="Rolling Tracker - Monitor and manage hedge positions",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=__doc__,
    )
    parser.add_argument(
        "--output", choices=["text", "json"], default="text",
        help="Output format (default: text)"
    )

    subparsers = parser.add_subparsers(dest="command", required=True)
    # ... add subcommands (see below)
    return parser
```

**status subcommand:**
Add subparser "status" with description "Display current hedge positions with P&L, DTE, and value".
No additional arguments needed.

Handler `cmd_status(args, tracker)`:
1. Call `tracker.get_status()`
2. If no positions, print "No active hedge positions found." and return
3. If --output json: print `json.dumps(status_list, indent=2, default=str)`
4. If --output text: render ASCII table with columns:
   - Ticker | Strike | Expiry | DTE | Qty | Cost | Current | P&L | P&L% | Status
5. DTE urgency rendering -- use the `urgency` field from `get_status()` directly:
   - DTE > 14: Green text (no marker) -- safe, well outside roll window
   - 7 < DTE <= 14: Yellow text (no marker) -- approaching but NOT in roll window yet
   - 3 < DTE <= 7: Red text, "[ROLL]" marker -- inside the 7-day roll window, action needed
   - 0 < DTE <= 3: Red text, "[EXPIRING]" marker -- critical, expiration imminent
   - DTE <= 0: "[EXPIRED]" marker -- past expiration
   Color implementation: Check if terminal supports ANSI codes (sys.stdout.isatty()), apply \033 escape sequences for green/yellow/red. Fall back to plain text with markers only if no TTY.
   The Status column renders the urgency field value directly from get_status() -- do NOT re-derive logic here.
6. Summary row at bottom: Total Hedge Cost, Total Current Value, Total P&L, Portfolio Coverage %
7. Print DISCLAIMER

ASCII table format: Use simple string formatting with fixed-width columns. Do NOT add any new dependencies (no rich, no tabulate). Use f-strings with alignment:
```python
header = f"{'Ticker':<8} {'Strike':>8} {'Expiry':<12} {'DTE':>5} {'Qty':>4} {'Cost':>8} {'Current':>10} {'P&L':>10} {'P&L%':>7} {'Status':<10}"
print(header)
print("-" * len(header))
```

**suggest-roll subcommand:**
Add subparser "suggest-roll" with description "Find positions needing a roll and suggest replacements".
Optional argument: `--max-suggestions N` (default 3).

Handler `cmd_suggest_roll(args, tracker)`:
1. Call `tracker.suggest_roll(max_suggestions=args.max_suggestions)`
2. If no positions need rolling, print "No positions within roll window."
3. If --output json: print JSON
4. If --output text: For each position needing a roll:
   - Print position summary (ticker, strike, expiry, DTE)
   - Print "Replacement Candidates:" header
   - For each suggestion: strike, expiry, DTE, estimated cost, per-day cost, reason
5. Print DISCLAIMER
  </action>
  <verify>
```bash
# Verify help works
uv run python src/analysis/rolling_tracker_cli.py --help

# Verify status subcommand help
uv run python src/analysis/rolling_tracker_cli.py status --help

# Verify suggest-roll subcommand help
uv run python src/analysis/rolling_tracker_cli.py suggest-roll --help

# Verify status runs (may show "No active positions" if positions.yaml is empty)
uv run python src/analysis/rolling_tracker_cli.py status

# Verify JSON output
uv run python src/analysis/rolling_tracker_cli.py status --output json
```
  </verify>
  <done>rolling_tracker_cli.py exists with argparse subcommands skeleton, status shows ASCII table with correct DTE rendering (no marker >7, [ROLL] 3-7, [EXPIRING] 0-3, [EXPIRED] <=0; colors Green >14, Yellow 7-14, Red <7), suggest-roll shows replacement candidates, both support --output json</done>
</task>

<task type="auto">
  <name>Task 2: Add log-position, import-csv, log-roll, and history subcommands</name>
  <files>src/analysis/rolling_tracker_cli.py</files>
  <action>
Add four more subcommands to the rolling tracker CLI.

**log-position subcommand:**
Add subparser "log-position" with description "Add a new hedge position".
Arguments:
- `--ticker` (required): Underlying ticker symbol
- `--type` (required): choices=["put", "inverse_etf"], help="Hedge type"
- `--strike` (optional): float, help="Strike price (required for puts)"
- `--expiry` (optional): str, help="Expiry date YYYY-MM-DD (required for puts)"
- `--quantity` (required): int, help="Number of contracts or shares"
- `--premium` (required): float, help="Premium paid per contract/share"
- `--contract-symbol` (optional): str, help="Full OCC contract symbol (e.g., QQQ260417P00420000)"
- `--reason` (optional): str, help="Reason for this hedge"
- `--layer` (optional): str, help="Portfolio layer this protects"

Handler `cmd_log_position(args, tracker)`:
1. Build position_data dict from args
2. If type == "put", validate that strike and expiry are provided (error if missing)
3. Set entry_date to today
4. Call `tracker.log_position(position_data)`
5. If --output json: print JSON
6. If --output text: print "Position logged: {ticker} {type} {strike} {expiry}"
7. Print DISCLAIMER

**import-csv subcommand:**
Add subparser "import-csv" with description "Import options positions from a Fidelity CSV export".
Arguments:
- `--file` (required): str, help="Path to Fidelity CSV export file"

Handler `cmd_import_csv(args, tracker)`:
1. Resolve file path: `csv_path = Path(args.file).resolve()`
2. Validate file exists: if not csv_path.exists(), print error and exit 1
3. Call `tracker.import_from_csv(csv_path)`
4. If --output json: print `json.dumps({"imported": imported_positions, "count": len(imported_positions)}, indent=2, default=str)`
5. If --output text:
   - Print "Imported {N} options position(s) from {filename}:"
   - For each imported position: "  {ticker} {hedge_type} {strike} {expiry} x{quantity}"
   - If 0 imported: "No options positions found in CSV file."
6. Print DISCLAIMER

**log-roll subcommand:**
Add subparser "log-roll" with description "Record closing one position and opening another".
Arguments:
- `--close-index` (required): int, help="Index of position to close (from status output, 0-based)"
- `--ticker` (required): str, help="New position ticker"
- `--strike` (required): float, help="New position strike"
- `--expiry` (required): str, help="New position expiry YYYY-MM-DD"
- `--quantity` (required): int, help="New position quantity"
- `--premium` (required): float, help="New position premium paid"
- `--contract-symbol` (optional): str, help="New position OCC symbol"

Handler `cmd_log_roll(args, tracker)`:
1. Build new_position_data dict from args with hedge_type="put", entry_date=today
2. Call `tracker.log_roll(args.close_index, new_position_data)`
3. If --output json: print JSON roll record
4. If --output text: print "Roll recorded: closed index {i}, opened {ticker} {strike} {expiry}"
5. Print DISCLAIMER

**history subcommand:**
Add subparser "history" with description "Display roll history".
No additional arguments needed.

Handler `cmd_history(args, tracker)`:
1. Call `tracker.get_history()`
2. If no history, print "No roll history found."
3. If --output json: print JSON
4. If --output text: For each roll:
   - Date, closed position summary, opened position summary, net cost
   - Formatted as a simple list, not a table (rolls have varying structure)
5. Print DISCLAIMER

**Wire subcommands to handlers using set_defaults(func=handler):**
```python
status_parser.set_defaults(func=cmd_status)
suggest_parser.set_defaults(func=cmd_suggest_roll)
log_pos_parser.set_defaults(func=cmd_log_position)
import_csv_parser.set_defaults(func=cmd_import_csv)
log_roll_parser.set_defaults(func=cmd_log_roll)
history_parser.set_defaults(func=cmd_history)
```

**main() function:**
```python
def main():
    parser = build_parser()
    args = parser.parse_args()
    try:
        config = load_hedge_config()
        tracker = RollingTracker(config=config)
        args.func(args, tracker)
    except ValueError as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)
    except KeyboardInterrupt:
        print("\nOperation cancelled by user", file=sys.stderr)
        sys.exit(130)
    except Exception as e:
        print(f"Unexpected error: {e}", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()
```
  </action>
  <verify>
```bash
# Verify all subcommand helps work
uv run python src/analysis/rolling_tracker_cli.py log-position --help
uv run python src/analysis/rolling_tracker_cli.py import-csv --help
uv run python src/analysis/rolling_tracker_cli.py log-roll --help
uv run python src/analysis/rolling_tracker_cli.py history --help

# Test log-position
uv run python src/analysis/rolling_tracker_cli.py log-position --ticker QQQ --type put --strike 420 --expiry 2026-04-17 --quantity 2 --premium 8.50

# Test import-csv (will show "file not found" error with fake path, verifying arg parsing)
uv run python src/analysis/rolling_tracker_cli.py import-csv --file /tmp/nonexistent.csv 2>&1 | grep -i "error\|not found"

# Test history (may show empty)
uv run python src/analysis/rolling_tracker_cli.py history

# Test JSON output on history
uv run python src/analysis/rolling_tracker_cli.py history --output json

# Verify status now shows the logged position
uv run python src/analysis/rolling_tracker_cli.py status
```
  </verify>
  <done>rolling_tracker_cli.py has all 6 subcommands (status, suggest-roll, log-position, import-csv, log-roll, history) with --output json support, educational disclaimer, and proper error handling. HEDG-04 complete.</done>
</task>

</tasks>

<verification>
Full integration check:

```bash
# 1. All 6 subcommands have --help
for cmd in status suggest-roll log-position import-csv log-roll history; do
    uv run python src/analysis/rolling_tracker_cli.py $cmd --help > /dev/null 2>&1 && echo "$cmd: OK" || echo "$cmd: FAIL"
done

# 2. Main --help shows all subcommands
uv run python src/analysis/rolling_tracker_cli.py --help | grep -E "status|suggest-roll|log-position|import-csv|log-roll|history"

# 3. JSON output parses correctly
uv run python -c "
import subprocess, json
result = subprocess.run(
    ['uv', 'run', 'python', 'src/analysis/rolling_tracker_cli.py', 'status', '--output', 'json'],
    capture_output=True, text=True
)
data = json.loads(result.stdout)
print(f'JSON output type: {type(data).__name__}')
print('JSON parsing OK')
"

# 4. Missing required args gives clear error
uv run python src/analysis/rolling_tracker_cli.py log-position 2>&1 | grep -i "required"

# 5. import-csv arg parsing works
uv run python src/analysis/rolling_tracker_cli.py import-csv --help | grep -i "file"
```
</verification>

<success_criteria>
1. `src/analysis/rolling_tracker_cli.py` exists as the first subcommand CLI in the codebase (HEDG-04)
2. 6 subcommands work: status, suggest-roll, log-position, import-csv, log-roll, history
3. status displays ASCII table with correct DTE urgency: no marker >7, [ROLL] 3<DTE<=7, [EXPIRING] 0<DTE<=3, [EXPIRED] <=0; colors Green >14, Yellow 7-14, Red <7 (RT-01, RT-02)
4. suggest-roll shows top 3 replacement candidates per position (RT-03)
5. log-position adds positions with optional metadata (reason, layer)
6. import-csv accepts --file path and imports options positions from Fidelity CSV
7. log-roll closes old position and opens new one
8. history shows all historical rolls
9. All subcommands support --output json (STD-01)
10. Educational disclaimer on all output (STD-02, XC-05)
11. --help shows complete examples (STD-03)
</success_criteria>

<output>
After completion, create `.planning/phases/08-rolling-tracker-hedge-sizer/08-03-SUMMARY.md`
</output>
