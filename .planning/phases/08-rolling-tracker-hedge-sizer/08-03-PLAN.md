---
phase: 08-rolling-tracker-hedge-sizer
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/analysis/rolling_tracker_cli.py
autonomous: true

must_haves:
  truths:
    - "running `uv run python src/analysis/rolling_tracker_cli.py status` displays positions with P&L, DTE, value, and roll status labels"
    - "running `uv run python src/analysis/rolling_tracker_cli.py suggest-roll` identifies positions within 7-day DTE window"
    - "running `uv run python src/analysis/rolling_tracker_cli.py log-roll --ticker QQQ --strike 440 --expiry 2026-06-19 --premium 8.50` records a roll"
    - "running `uv run python src/analysis/rolling_tracker_cli.py history` displays roll history"
    - "all subcommands support `--output json` for programmatic use"
    - "`--help` shows complete examples for all subcommands"
    - "DTE color coding: green >14, yellow 7-14, red <7"
    - "Text markers [ROLL], [EXPIRING] appear alongside colors for accessibility"
    - "Summary row shows total hedge cost, current value, P&L, and portfolio coverage"
  artifacts:
    - path: "src/analysis/rolling_tracker_cli.py"
      provides: "CLI with argparse subcommands for hedge position management"
      exports: ["main"]
  key_links:
    - from: "src/analysis/rolling_tracker_cli.py"
      to: "src/analysis/rolling_tracker.py"
      via: "RollingTracker import"
      pattern: "from src.analysis.rolling_tracker import RollingTracker"
    - from: "src/analysis/rolling_tracker_cli.py"
      to: "src/config/config_loader.py"
      via: "load_hedge_config for CLI override chain"
      pattern: "from src.config.config_loader import load_hedge_config"
---

<objective>
Build the Rolling Tracker CLI (Layer 3) with argparse subcommands: status, suggest-roll, log-roll, history. This is the first subcommand-pattern CLI in the codebase.

Purpose: Provides the user-facing interface for monitoring hedge positions, getting roll alerts, and managing position transitions. Follows HEDG-04 requirement for subcommand-based CLI.

Output: `src/analysis/rolling_tracker_cli.py` -- CLI with 4 subcommands
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/08-rolling-tracker-hedge-sizer/08-01-SUMMARY.md
@src/analysis/rolling_tracker.py
@src/config/config_loader.py
@src/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rolling_tracker_cli.py with argparse subcommands and formatted output</name>
  <files>src/analysis/rolling_tracker_cli.py</files>
  <action>
Create `src/analysis/rolling_tracker_cli.py` as the first argparse subcommand CLI in the codebase (HEDG-04).

**Argparse structure (from research Pattern 1):**

```python
parser = argparse.ArgumentParser(
    description='Rolling Tracker - Monitor and manage hedge positions',
    formatter_class=argparse.RawDescriptionHelpFormatter,
    epilog="""Examples: ...""",
)

# Shared top-level arguments
parser.add_argument('--output', choices=['human', 'json'], default='human')
parser.add_argument('--config', type=str, default=None)

# Subcommands
subparsers = parser.add_subparsers(dest='command', required=True, help='Available commands')
```

**Four subcommands with `set_defaults(func=handler)` dispatch:**

1. `status` subcommand:
   - No additional args
   - Calls `RollingTracker(config).get_status()`
   - Human output: formatted table with columns: Ticker, Type, Strike, Expiry, DTE, Entry$, Current$, P&L, Status
   - DTE color coding using ANSI escape codes:
     - Red (`\033[91m`): DTE < 7 days
     - Yellow (`\033[93m`): DTE 7-14 days
     - Green (`\033[92m`): DTE > 14 days
     - Reset: `\033[0m`
   - Text markers alongside color: `[ROLL]` for DTE <= 7, `[EXPIRING]` for DTE 8-14, blank for > 14 (LOCKED: accessibility for piped output)
   - Summary row at bottom: "Total: X positions | Cost: $X | Value: $X | P&L: $X"
   - JSON output: `json.dumps(status_dict, indent=2, default=str)`

2. `suggest-roll` subcommand:
   - No additional args (LOCKED: fixed 7-day window, not configurable)
   - Calls `RollingTracker(config).suggest_rolls()`
   - Human output per expiring position:
     ```
     --- Roll Needed: QQQ Put $420 exp 2026-04-17 (DTE: 5) ---
     Suggested: QQQ260619P00440000 | Strike: $440 | Expiry: 2026-06-19 | DTE: 68
     Roll cost: $X.XX (new premium $Y.YY - remaining value $Z.ZZ)
     ```
   - If no positions need rolling: "No positions within the 7-day roll window."
   - JSON output: list of suggestion dicts

3. `log-roll` subcommand:
   - Required args: `--ticker` (str), `--strike` (float), `--expiry` (str, YYYY-MM-DD), `--premium` (float)
   - LOCKED: auto-detects old position from positions.yaml by ticker
   - Calls `RollingTracker(config).log_roll(ticker, strike, expiry_date, premium)`
   - Human output: "Rolled QQQ put: $420 exp 2026-04-17 -> $440 exp 2026-06-19 (premium: $8.50)"
   - JSON output: roll result dict

4. `history` subcommand:
   - No additional args
   - Calls `RollingTracker(config).get_history()`
   - Human output: table of past rolls with Date, Ticker, Old Strike, New Strike, Old Expiry, New Expiry, Reason
   - JSON output: list of history dicts

**Config loading pattern (from research):**

```python
cli_overrides = {}  # rolling tracker has no config-overrideable CLI flags currently
config_path = Path(args.config) if args.config else None
config = load_hedge_config(profile_path=config_path, cli_overrides=cli_overrides)
```

**Important conventions:**
- Educational disclaimer at the end of human output: "DISCLAIMER: For educational purposes only. Not investment advice."
- Error handling: wrap main in try/except, print error message and exit(1)
- Use `sys.exit(main() or 0)` pattern from existing CLIs
- Date parsing for `--expiry`: use `datetime.strptime(args.expiry, "%Y-%m-%d").date()`
- Each handler function returns 0 on success, 1 on error
- Complete `--help` text with examples for all subcommands in the epilog
- Follow existing CLI naming pattern: snake_case filename, descriptive help text
  </action>
  <verify>
    Run `uv run python src/analysis/rolling_tracker_cli.py --help` to verify help text shows all subcommands and examples.
    Run `uv run python src/analysis/rolling_tracker_cli.py status --help` to verify status subcommand help.
    Run `uv run python src/analysis/rolling_tracker_cli.py status --output json` to verify JSON output works (may return empty positions).
    Run `uv run ruff check src/analysis/rolling_tracker_cli.py` passes with zero errors.
  </verify>
  <done>
    rolling_tracker_cli.py exists with 4 subcommands: status, suggest-roll, log-roll, history.
    All subcommands support --output json.
    --help shows complete examples.
    DTE color coding and text markers implemented.
    Summary row displays at bottom of status output.
    Educational disclaimer included.
  </done>
</task>

</tasks>

<verification>
- `uv run python src/analysis/rolling_tracker_cli.py --help` shows all 4 subcommands
- `uv run python src/analysis/rolling_tracker_cli.py status` works (empty or populated)
- `uv run python src/analysis/rolling_tracker_cli.py status --output json` returns valid JSON
- `uv run python src/analysis/rolling_tracker_cli.py suggest-roll` works
- `uv run python src/analysis/rolling_tracker_cli.py history` works
- `uv run python src/analysis/rolling_tracker_cli.py log-roll --help` shows --ticker, --strike, --expiry, --premium
- `uv run ruff check src/analysis/rolling_tracker_cli.py` exits 0
</verification>

<success_criteria>
- First argparse subcommand CLI in the codebase is established
- All 4 subcommands dispatch correctly via set_defaults(func=handler)
- Status output has DTE color coding (red/yellow/green) and text markers ([ROLL], [EXPIRING])
- Summary row at bottom of status output
- JSON output works for all subcommands
- Educational disclaimer present in human output
</success_criteria>

<output>
After completion, create `.planning/phases/08-rolling-tracker-hedge-sizer/08-03-SUMMARY.md`
</output>
