---
phase: 10-self-assessment-persistence-topics
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/explorer/template/explorer.ts
  - src/explorer/template/styles.css
  - src/explorer/template/template.html
autonomous: true

must_haves:
  truths:
    - "Clicking a concept node cycles through 4 knowledge states: unknown -> familiar -> confident -> mastered -> unknown"
    - "Knowledge states persist in localStorage and survive page refresh"
    - "Learning mode selector shows 3 options (guided/standard/yolo) and changes prompt complexity"
    - "Copy prompt button copies text to clipboard on Chrome, Safari, and Firefox"
    - "Canvas interactions work with touch (tap to cycle, drag nodes) and mouse equally"
    - "Sidebar collapses to bottom drawer on screens narrower than 768px"
    - "localStorage failure (private browsing, quota) degrades silently without breaking the app"
  artifacts:
    - path: "src/explorer/template/explorer.ts"
      provides: "Enhanced explorer application with persistence, learning modes, and mobile support"
      contains: "saveState, loadState, cycleKnowledge, LEARNING_MODES, copyPrompt, pointerdown"
    - path: "src/explorer/template/styles.css"
      provides: "Enhanced styles with responsive layout, knowledge state colors, and mode selector"
      contains: "@media (max-width: 768px), .mode-selector, .knowledge-unknown, touch-action: none"
    - path: "src/explorer/template/template.html"
      provides: "Updated HTML shell with learning mode selector and export button"
      contains: "mode-selector, copy-btn, export-btn"
  key_links:
    - from: "src/explorer/template/explorer.ts"
      to: "localStorage"
      via: "saveState/loadState with version-keyed storage per topic"
      pattern: "localStorage\\.(get|set)Item"
    - from: "src/explorer/template/explorer.ts"
      to: "navigator.clipboard"
      via: "copyPrompt function with textarea fallback"
      pattern: "navigator\\.clipboard\\.writeText"
    - from: "src/explorer/template/explorer.ts"
      to: "Cytoscape.js events"
      via: "tap event for knowledge cycling"
      pattern: "cy\\.on.*tap.*node"
    - from: "src/explorer/template/styles.css"
      to: "src/explorer/template/template.html"
      via: "CSS classes for knowledge states and responsive layout"
      pattern: "mode-selector|knowledge-"
---

<objective>
Enhance the Phase 9 template engine with localStorage persistence, 4-state knowledge cycling, learning mode selector, cross-browser clipboard copy, pointer events for mobile, and responsive sidebar layout.

Purpose: Deliver the core interaction loop for the knowledge explorer -- users can self-assess, persist progress, choose learning depth, and use the explorer on mobile. Covers EXPL-05, EXPL-06, EXPL-08, EXPL-15, EXPL-16.
Output: Enhanced template files that produce interactive explorers with persistence when built.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-self-assessment-persistence-topics/10-RESEARCH.md
@.planning/phases/09-template-engine-dividend-topic-port/09-RESEARCH.md

Phase 9 SUMMARY (when available) provides the exact template structure this plan modifies.
Phase 10 research provides verified code patterns for all 6 architecture patterns.

Key integration points with Phase 9:
- explorer.ts: Cytoscape.js application code -- add persistence, knowledge cycling, learning modes, clipboard
- styles.css: Dark theme CSS -- add responsive layout, knowledge state colors, mode selector styles
- template.html: HTML shell -- add learning mode selector buttons, export button, mobile meta tags

Phase 9 research confirms:
- Cytoscape.js 3.33.x with Canvas renderer
- Cytoscape.js tap events for node interaction: cy.on("tap", "node", ...)
- Knowledge levels stored as node data: node.data("knowledge")
- CoSE layout with dark theme styling
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add localStorage persistence and 4-state knowledge cycling</name>
  <files>src/explorer/template/explorer.ts, src/explorer/template/styles.css</files>
  <action>
Modify the Phase 9 template engine files to add localStorage persistence and upgrade knowledge cycling to 4 states.

**In explorer.ts, add/modify:**

1. **Safe localStorage wrapper** (from research Pattern 1):
   - `STORAGE_PREFIX = 'fin-guru-explorer'` and `STORAGE_VERSION = 'v1'`
   - `storageKey(topicId)` returns `${STORAGE_PREFIX}.${STORAGE_VERSION}.${topicId}`
   - `isStorageAvailable()` with try/catch test write
   - `saveState(topicId, state)` serializes knowledge map + learning mode to localStorage
   - `loadState(topicId)` deserializes from localStorage, returns null on failure
   - Version check in loadState for future migration
   - All localStorage access wrapped in try/catch -- never throw on storage failure

2. **4-state knowledge cycling** (from research Pattern 2):
   - Replace Phase 9's 3-state cycle (know/fuzzy/unknown) with 4 states: `['unknown', 'familiar', 'confident', 'mastered']`
   - State colors: unknown=#f85149 (red), familiar=#d29922 (yellow), confident=#58a6ff (blue), mastered=#3fb950 (green)
   - `cycleKnowledge(nodeId)` advances state and calls saveState + re-render
   - On Cytoscape tap event: call cycleKnowledge for the tapped node
   - Update Cytoscape node style to reflect knowledge state via border color and badge
   - Update sidebar concept list to show knowledge state badge per node

3. **State restore on load:**
   - On DOMContentLoaded, after Cytoscape init, call loadState(topicId)
   - If state exists: apply knowledge levels to all nodes, apply learning mode
   - If state is null: use defaults (all "fuzzy" from Phase 9 schema defaults -- NOTE: Phase 10 changes default to "unknown" for new topics, but existing dividend topic keeps "fuzzy" for backward compatibility)
   - Debounce saves: create `debouncedSave` with 500ms delay per research debounce utility

4. **JSON export fallback** (EXPL-05 requirement "with try/catch + JSON export fallback"):
   - `exportStateAsJSON(topicId)` function creates Blob and triggers download of `{topicId}-progress.json`
   - Add "Export Progress" button visible when localStorage is unavailable, or always available as secondary action
   - Uses Blob + URL.createObjectURL + anchor click pattern from research

5. **Stats display update:**
   - Update stats counter to show 4 states instead of 3: "N unknown, N familiar, N confident, N mastered"
   - Update stats colors to match the 4 state colors

**In styles.css, add:**

6. **Knowledge state colors:**
   - `.knowledge-unknown { --state-color: #f85149; }`
   - `.knowledge-familiar { --state-color: #d29922; }`
   - `.knowledge-confident { --state-color: #58a6ff; }`
   - `.knowledge-mastered { --state-color: #3fb950; }`
   - Badge styling for concept list in sidebar

**IMPORTANT: Do NOT remove or break any existing Phase 9 functionality.** This is additive modification. The Cytoscape graph, CoSE layout, sidebar concept list, presets, tooltips, and prompt generation must all continue working.

**Anti-patterns to avoid (from research):**
- Do NOT save to localStorage on every pointer move -- only on knowledge state change + debounce
- Do NOT block initial render on localStorage load -- render immediately, apply persisted state after
- Do NOT use topic-specific JavaScript -- all logic must work generically with any topic JSON
  </action>
  <verify>
1. Read explorer.ts and confirm:
   - `saveState`, `loadState`, `isStorageAvailable` functions exist
   - `KNOWLEDGE_STATES` array has exactly 4 entries: ['unknown', 'familiar', 'confident', 'mastered']
   - `cycleKnowledge` function exists and calls saveState
   - `debouncedSave` utility exists
   - `exportStateAsJSON` function exists
   - Cytoscape tap handler calls cycleKnowledge

2. Read styles.css and confirm:
   - Knowledge state color CSS classes exist for all 4 states
   - No hardcoded topic references

3. Build check (TypeScript compiles):
```bash
cd /Users/ossieirondi/Documents/Irondi-Household/family-office && bun build src/explorer/template/explorer.ts --outdir /tmp/build-check --format iife --target browser 2>&1
```
  </verify>
  <done>
- 4-state knowledge cycling works via Cytoscape tap events
- localStorage persistence saves/loads state with version-keyed keys per topic
- Storage failures degrade silently (app works without persistence)
- JSON export fallback exists for environments without localStorage
- Debounced save prevents excessive writes
- Stats display shows all 4 knowledge states
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add learning mode selector, clipboard copy, and mobile responsive support</name>
  <files>src/explorer/template/explorer.ts, src/explorer/template/styles.css, src/explorer/template/template.html</files>
  <action>
Add three remaining features: learning mode selector, cross-browser clipboard, and responsive mobile layout.

**In template.html, add:**

1. **Learning mode selector** in header:
   ```html
   <div class="mode-selector">
     <button class="mode-btn" data-mode="guided" title="Step-by-step explanations">Guided</button>
     <button class="mode-btn active" data-mode="standard" title="Balanced depth">Standard</button>
     <button class="mode-btn" data-mode="yolo" title="Dense, technical">YOLO</button>
   </div>
   ```
   Place in the header-controls area, between presets and action buttons.

2. **Export button** near copy button:
   ```html
   <button id="export-btn" class="action-btn" title="Download progress as JSON">Export</button>
   ```

**In explorer.ts, add/modify:**

3. **Learning mode system** (from research Pattern 3):
   - `LEARNING_MODES` object with 3 tiers: guided, standard, yolo
   - Each tier has: label, description, promptStyle with prefix/unknownVerb/fuzzyVerb/suffix/maxRelationships
   - Guided: beginner-friendly ("I'm a beginner learning about...", analogies, max 4 relationships)
   - Standard: balanced ("I'm studying...", practical examples, max 8 relationships)
   - YOLO: dense technical ("Advanced study of...", edge cases, mathematical foundations, max 12 relationships)
   - `setLearningMode(mode)` updates active button, stores in state, regenerates prompt
   - Learning mode persisted in localStorage alongside knowledge state
   - On load: restore learning mode from state, default to "standard"
   - Update prompt generation to use the active learning mode's promptStyle:
     - Use mode prefix as prompt intro
     - Use unknownVerb/fuzzyVerb for concepts based on their knowledge state
     - Use mode suffix as prompt closing
     - Limit included relationships to maxRelationships
   - Wire mode-btn click handlers: querySelectorAll('.mode-btn'), set active class, call setLearningMode

4. **Cross-browser clipboard copy** (from research Pattern 4):
   - `copyPrompt()` async function:
     - Get prompt text from the prompt panel element
     - Try `navigator.clipboard.writeText(text)` first
     - On failure or if navigator.clipboard is unavailable, call `fallbackCopy(text)`
     - `fallbackCopy(text)` creates hidden textarea, selects, execCommand('copy'), removes
     - Update copy button text to "Copied!" for 1500ms, then back to "Copy"
   - IMPORTANT: Call copyPrompt directly from click handler (not nested async) to preserve user gesture context for clipboard API
   - Wire copy button: `document.getElementById('copy-btn').addEventListener('click', copyPrompt)`

5. **Pointer events for mobile** (from research Pattern 5):
   - NOTE: Cytoscape.js already handles pointer events internally for its graph canvas. The Phase 9 template uses Cytoscape's built-in drag/tap/zoom which works with touch.
   - What Phase 10 adds:
     - Ensure `touch-action: none` is set on the Cytoscape container via CSS
     - Ensure canvas interactions (tap to cycle knowledge) work on touch via Cytoscape's tap event (which already handles pointer events)
     - Sidebar touch scrolling must work normally (do NOT prevent default on sidebar)
     - Add viewport meta tag if not already present: `<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">`
   - Do NOT add custom pointer event listeners on the Cytoscape container -- Cytoscape manages its own events. Only add event listeners for non-Cytoscape UI elements (buttons, sidebar).

**In styles.css, add:**

6. **Learning mode selector styles** (from research):
   ```css
   .mode-selector { display: flex; gap: 2px; background: var(--bg); border-radius: 6px; padding: 2px; }
   .mode-btn { padding: 4px 10px; font-size: 12px; ... }
   .mode-btn.active { background: var(--accent); color: #000; font-weight: 600; }
   ```

7. **Responsive sidebar** (from research Pattern 6):
   ```css
   @media (max-width: 768px) {
     .main { flex-direction: column; }
     .sidebar { width: 100%; max-height: 40vh; border-right: none; border-bottom: 1px solid var(--border); order: 1; }
     .canvas-container { order: 0; min-height: 50vh; }
     .prompt-panel { order: 2; }
   }
   ```

8. **Touch action on Cytoscape container:**
   ```css
   #cy { touch-action: none; }
   ```

**IMPORTANT: Prompt generation integration:**
The Phase 9 template has existing prompt generation logic. Modify it to:
- Accept the current learning mode as input
- Use the learning mode's promptStyle for vocabulary and structure
- Respect maxRelationships to limit prompt size based on mode
- Keep the existing knowledge-gap-based concept selection logic
- This is the key integration point between learning modes and the prompt panel

**Anti-patterns to avoid (from research):**
- Do NOT mix touch event listeners with pointer event listeners on the same element
- Do NOT call navigator.clipboard.writeText from inside a promise chain -- call it directly in the click handler
- Topic-specific logic MUST NOT appear anywhere -- all code works generically with any TOPIC_DATA
  </action>
  <verify>
1. Read explorer.ts and confirm:
   - `LEARNING_MODES` object exists with 3 tiers (guided, standard, yolo)
   - `setLearningMode` function exists
   - `copyPrompt` async function exists with fallback
   - `fallbackCopy` function exists with textarea approach
   - Prompt generation uses learning mode's promptStyle
   - Mode button click handlers wired

2. Read template.html and confirm:
   - Mode selector div with 3 buttons exists in header
   - Export button exists

3. Read styles.css and confirm:
   - `.mode-selector` and `.mode-btn` styles exist
   - `@media (max-width: 768px)` responsive rules exist
   - `#cy { touch-action: none; }` exists

4. Build check:
```bash
cd /Users/ossieirondi/Documents/Irondi-Household/family-office && bun build src/explorer/template/explorer.ts --outdir /tmp/build-check-2 --format iife --target browser 2>&1
```
  </verify>
  <done>
- Learning mode selector with 3 tiers renders in header and changes prompt complexity
- Copy button uses navigator.clipboard.writeText with textarea fallback
- Responsive sidebar collapses to bottom on screens < 768px
- Cytoscape container has touch-action: none for mobile support
- Prompt generation integrates with learning mode vocabulary and relationship limits
- All features work generically with any topic JSON
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. TypeScript compiles: `bun build src/explorer/template/explorer.ts --format iife --target browser` succeeds
2. No topic-specific references in template code (grep for hardcoded concept IDs returns zero)
3. All 6 research patterns implemented: localStorage wrapper, 4-state cycling, learning modes, clipboard copy, pointer events, responsive sidebar
4. All 7 requirements addressed: EXPL-05 (localStorage + export fallback), EXPL-06 (learning modes), EXPL-08 (touch + responsive), EXPL-15 (clipboard + fallback), EXPL-16 (zero external runtime deps)
</verification>

<success_criteria>
- Template engine produces explorers with persistent knowledge tracking
- 4 knowledge states cycle correctly and persist across page refresh
- 3 learning modes produce meaningfully different prompts
- Clipboard copy works with modern API and has legacy fallback
- Explorer is usable on mobile (responsive layout, touch interactions)
- Zero new external runtime dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/10-self-assessment-persistence-topics/10-02-SUMMARY.md`
</output>
