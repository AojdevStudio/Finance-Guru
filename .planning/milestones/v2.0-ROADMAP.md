# Milestone v2.0: Hedging & Portfolio Protection

**Status:** SHIPPED 2026-02-18
**Phases:** 6-9
**Total Plans:** 13

## Overview

Four institutional-grade hedging CLI tools built on a shared Pydantic model foundation and config loader, enabling portfolio protection analysis through total return comparison, options position tracking, contract sizing, and SQQQ vs puts scenario modeling. All tools follow the established 3-layer architecture (Models → Calculators → CLIs) and integrate with the Finance Guru agent system via knowledge base files.

## Phases

### Phase 6: Config Loader & Shared Hedging Models

**Goal**: All four hedging CLI tools have a shared foundation of validated Pydantic models and config access
**Depends on**: Phase 3 (user-profile.yaml schema must be stable)
**Requirements**: HEDG-01, HEDG-02, HEDG-03, HEDG-08, CFG-01, CFG-02, CFG-03
**Cross-cutting**: XC-02, XC-03
**Completed**: 2026-02-17

**Success Criteria** (what must be TRUE):
  1. `config_loader.py` reads user-profile.yaml and returns a validated HedgeConfig with hedging preferences (budget, roll window, underlying weights)
  2. CLI flags override any value from the config file (e.g., `--budget 800` overrides the YAML budget of $500)
  3. Running any hedging CLI without user-profile.yaml works using only CLI flags (graceful fallback, no crash)
  4. fin-guru-private/hedging/ directory exists with positions.yaml, roll-history.yaml, and budget-tracker.yaml templates
  5. All shared Pydantic models (HedgePosition, RollSuggestion, HedgeSizeRequest, TotalReturnInput, DividendRecord, TickerReturn) pass validation tests with known inputs

Plans:
- [x] 06-01-PLAN.md -- Shared Pydantic models: hedging_inputs.py + total_return_inputs.py + __init__.py exports (HEDG-02, HEDG-03)
- [x] 06-02-PLAN.md -- Config loader + private hedging data templates (CFG-01, CFG-02, CFG-03, HEDG-01, HEDG-08)
- [x] 06-03-PLAN.md -- TDD tests for all models + config loader override chain

---

### Phase 7: Total Return Calculator

**Goal**: User can compare total returns (price + dividends) across tickers with DRIP modeling
**Depends on**: Phase 6 (shared models and config loader)
**Requirements**: HEDG-07, TR-01, TR-02, TR-03
**Cross-cutting**: STD-01, STD-02, STD-03, STD-04, XC-03, XC-04, XC-05
**Completed**: 2026-02-17

**Success Criteria** (what must be TRUE):
  1. `uv run python src/analysis/total_return_cli.py SCHD --days 252` outputs three distinct numbers: price return, dividend return, and total return
  2. `uv run python src/analysis/total_return_cli.py SCHD JEPI VYM --days 252` compares all three tickers side-by-side
  3. DRIP mode shows growing share count over time as dividends are reinvested at ex-date close prices
  4. When yfinance dividend data has gaps, the output includes a data quality warning (not silent wrong numbers)
  5. `--output json` produces structured JSON and `--help` shows complete usage examples

Plans:
- [x] 07-01-PLAN.md -- TDD: TotalReturnCalculator class with DRIP modeling, data quality validation, dividend schedule config (Layer 2 + tests)
- [x] 07-02-PLAN.md -- Total return CLI with verdict display, league table, DRIP side-by-side, Finnhub, CSV auto-read, CLI tests (Layer 3)

---

### Phase 8: Rolling Tracker & Hedge Sizer

**Goal**: User can monitor options positions, get roll alerts, and size new hedge contracts against their portfolio
**Depends on**: Phase 6 (shared models and config loader)
**Requirements**: HEDG-04, HEDG-05, RT-01, RT-02, RT-03, HS-01, HS-02, HS-03, BS-01, HEDG-09, HEDG-10
**Cross-cutting**: STD-01, STD-02, STD-03, STD-04, XC-03, XC-04, XC-05
**Completed**: 2026-02-17

**Success Criteria** (what must be TRUE):
  1. `uv run python src/analysis/rolling_tracker_cli.py status` displays current hedge positions with P&L, DTE, and current value from positions.yaml
  2. `uv run python src/analysis/rolling_tracker_cli.py suggest-roll` identifies positions within the DTE roll window (default 7 days) and scans the options chain for replacement candidates
  3. `uv run python src/analysis/hedge_sizer_cli.py --portfolio 200000 --underlyings QQQ,SPY` outputs contract counts (1 per $50k) with budget utilization percentage
  4. Knowledge base files (hedging-strategies.md, options-insurance-framework.md) exist and Strategy Advisor, Teaching Specialist, and Quant Analyst agent definitions reference them
  5. Black-Scholes limitation on American-style options is documented with intrinsic value floor applied to put pricing

Plans:
- [x] 08-01-PLAN.md -- RollingTracker calculator: scan_chain_quiet wrapper, American put pricing, position status, roll suggestions, log-roll, history (Layer 2)
- [x] 08-02-PLAN.md -- HedgeSizer calculator: contract sizing formula, multi-underlying allocation, budget validation (Layer 2)
- [x] 08-03-PLAN.md -- Rolling tracker CLI with argparse subcommands: status, suggest-roll, log-roll, history (Layer 3)
- [x] 08-04-PLAN.md -- Hedge sizer CLI with flat argparse: --portfolio, --underlyings, budget validation (Layer 3)
- [x] 08-05-PLAN.md -- Knowledge base files (hedging-strategies.md, options-insurance-framework.md) and agent definition updates
- [x] 08-06-PLAN.md -- Known-answer tests for both calculators and CLIs (TDD)

---

### Phase 9: SQQQ vs Puts Comparison

**Goal**: User can compare SQQQ hedging vs protective puts with accurate decay modeling and breakeven analysis
**Depends on**: Phase 6 (shared models); benefits from Phase 8 (options infrastructure) but not strictly required
**Requirements**: HEDG-06, HC-01, HC-02, HC-03, HC-04, HC-05, HEDG-11, HEDG-12
**Cross-cutting**: STD-01, STD-02, STD-03, STD-04, XC-03, XC-04, XC-05
**Completed**: 2026-02-18

**Success Criteria** (what must be TRUE):
  1. `uv run python src/analysis/hedge_comparison_cli.py --scenarios -5,-10,-20,-40` outputs SQQQ vs puts payoff for each market drop scenario
  2. SQQQ simulation uses day-by-day compounding with volatility drag (NOT simple -3x multiplication) and results are validated against historical SQQQ data
  3. Breakeven analysis shows at what percentage drop each hedge strategy becomes profitable
  4. IV expansion estimate uses VIX-SPX regression to model put repricing during crashes
  5. All 4 hedging CLI tools pass integration test: `uv run python src/analysis/<tool>_cli.py --help` works for total_return, rolling_tracker, hedge_sizer, and hedge_comparison
  6. Architecture diagram (.mmd) shows all new M2 components and their data flow

Plans:
- [x] 09-01-PLAN.md -- Pydantic models and HedgeComparisonCalculator with SQQQ day-by-day simulation, IV expansion, and breakeven analysis
- [x] 09-02-PLAN.md -- CLI interface with --scenarios/--output json, known-answer test suite (15 tests), M2 architecture diagram, and integration verification

---

## Milestone Summary

**Key Decisions:**
- Converted src/config.py to src/config/ package for config_loader.py colocation
- American put pricing uses intrinsic value floor (BS-01 documented)
- Winner comparison uses absolute dollar PnL, not percentage returns
- SQQQ breakeven uses gradual decline path for deterministic brentq root-finding
- argv preprocessor for argparse dash-prefix compatibility (--scenarios -5,-10)
- Portfolio value cascade: CLI flag > Fidelity CSV > ValueError (no config fallback)
- Over-budget warning shows full recommendation, does NOT scale down contracts

**Issues Resolved:**
- scan_chain stderr noise suppressed via contextlib.redirect_stderr
- Deep ITM puts causing GreeksOutput validation errors handled with intrinsic value fallback
- Dividend data quality gaps detected and surfaced rather than silently producing wrong numbers

**Issues Deferred:**
- RollSuggestion model as typed return (Phase 8 returns raw dicts)
- Historical SQQQ backtesting validation (uses known-answer tests instead)
- Cross-tool integration (total return feeding hedge comparison)
- Portfolio-aware margin-interest-adjusted hedge cost

**Technical Debt Incurred:**
- Global coverage at 31.3% vs 80% gate (pre-existing, not M2-introduced)
- Phase 7/9 plans show unchecked boxes in ROADMAP.md (cosmetic — summaries and verifications confirm completion)

---

_For current project status, see .planning/ROADMAP.md_
