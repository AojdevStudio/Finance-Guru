# Finance Guru™ Architecture

> Auto-generated by codebase mapper

## Overview

Finance Guru™ implements a strict 3-layer type-safe architecture for financial analysis: Pydantic Models (validation) → Calculator Classes (business logic) → CLI Interfaces (agent integration). This architecture enables modularity, testability, and seamless integration with Claude agents while maintaining strict type safety across all components.

## 3-Layer Architecture Pattern

### Layer 1: Pydantic Models (Data Validation)

**Location**: `src/models/`

Pydantic models provide type-safe, validated data structures for all inputs and outputs. Each analysis module has a corresponding input/output model file.

**Key Files**:
- `src/models/__init__.py` - Central export hub for all models
- `src/models/risk_inputs.py` - Risk calculation models (PriceDataInput, RiskMetricsOutput, RiskCalculationConfig)
- `src/models/momentum_inputs.py` - Momentum indicator models (MomentumDataInput, RSIOutput, MACDOutput, StochasticOutput, WilliamsROutput, ROCOutput, AllMomentumOutput)
- `src/models/volatility_inputs.py` - Volatility metrics models (VolatilityDataInput, BollingerBandsOutput, ATROutput, HistoricalVolatilityOutput, KeltnerChannelsOutput)
- `src/models/correlation_inputs.py` - Correlation/covariance models (PortfolioPriceData, CorrelationMatrixOutput, CovarianceMatrixOutput)
- `src/models/backtest_inputs.py` - Backtesting models (BacktestConfig, TradeSignal, BacktestResults, BacktestPerformanceMetrics)
- `src/models/moving_avg_inputs.py` - Moving average models (MovingAverageDataInput, MovingAverageOutput, CrossoverOutput)
- `src/models/portfolio_inputs.py` - Portfolio optimization models (PortfolioDataInput, OptimizationConfig, OptimizationOutput)
- `src/models/itc_risk_inputs.py` - ITC Risk API models (ITCRiskRequest, RiskBand, ITCRiskResponse)
- `src/models/options_inputs.py` - Options pricing models (OptionInput, BlackScholesInput, GreeksOutput, ImpliedVolOutput, OptionContractData, OptionsChainOutput)
- `src/models/factors_inputs.py` - Factor analysis models
- `src/models/validation_inputs.py` - Data validation models
- `src/models/dashboard_inputs.py` - UI/dashboard models
- `src/models/screener_inputs.py` - Stock screener models
- `src/models/yaml_generation_inputs.py` - YAML output models

**Model Pattern**:
```python
# Example from src/models/risk_inputs.py
from pydantic import BaseModel, Field, validator
import pandas as pd

class PriceDataInput(BaseModel):
    """Input data for risk calculations."""
    ticker: str
    prices: pd.Series
    benchmark_prices: pd.Series | None = None

    class Config:
        arbitrary_types_allowed = True  # Required for pandas types

class RiskMetricsOutput(BaseModel):
    """Output from risk calculations."""
    var_95: float = Field(..., description="95% Value at Risk")
    cvar_95: float = Field(..., description="95% Conditional VaR")
    sharpe_ratio: float
    sortino_ratio: float
    max_drawdown: float
    calmar_ratio: float
    annual_volatility: float
    beta: float | None = None
    alpha: float | None = None
```

**Key Principles**:
- Type safety through Pydantic validation
- Descriptive field names with documentation
- Support for pandas/numpy types via `arbitrary_types_allowed`
- Field validators for business logic constraints
- Optional fields using `| None` syntax
- Comprehensive error messages

### Layer 2: Calculator Classes (Business Logic)

**Locations**:
- `src/analysis/` - Analysis calculators (risk, correlation, options, factors, ITC risk)
- `src/strategies/` - Strategy calculators (backtester, optimizer)
- `src/utils/` - Utility calculators (momentum, volatility, moving averages, screener, market data)

Each calculator operates on Pydantic models from Layer 1 and returns validated Pydantic models.

**Core Calculator Classes**:

1. **Risk Analysis** (`src/analysis/risk_metrics.py`)
   - `RiskCalculator` class
   - Metrics: VaR (95%, parametric/historical), CVaR, Sharpe ratio, Sortino ratio, max drawdown, Calmar ratio, volatility, beta, alpha
   - Input: `PriceDataInput` with optional benchmark
   - Output: `RiskMetricsOutput`

2. **Momentum Indicators** (`src/utils/momentum.py`)
   - `MomentumIndicators` class
   - Indicators: RSI, MACD, Stochastic, Williams %R, ROC
   - Input: `MomentumDataInput`
   - Output: `AllMomentumOutput` (aggregates all indicators)

3. **Volatility Metrics** (`src/utils/volatility.py`)
   - `VolatilityCalculator` class
   - Metrics: Bollinger Bands, ATR, historical volatility, Keltner channels, standard deviation, volatility regime
   - Input: `VolatilityDataInput`
   - Output: `VolatilityMetricsOutput`

4. **Correlation Analysis** (`src/analysis/correlation.py`)
   - `CorrelationCalculator` class
   - Metrics: Pearson correlation matrix, covariance matrix, rolling correlation, diversification ratio
   - Input: `PortfolioPriceData` (multi-ticker)
   - Output: `PortfolioCorrelationOutput`

5. **Backtesting Engine** (`src/strategies/backtester.py`)
   - `Backtester` class
   - Strategies: RSI mean reversion, SMA crossover, buy-hold benchmark
   - Input: `BacktestConfig` with OHLC data
   - Output: `BacktestResults` with trade signals and performance metrics

6. **Portfolio Optimizer** (`src/strategies/optimizer.py`)
   - `PortfolioOptimizer` class
   - Methods: Max Sharpe, Risk Parity, Min Variance, Mean-Variance, Black-Litterman
   - Input: `PortfolioDataInput` with expected returns/covariance
   - Output: `OptimizationOutput` with efficient frontier

7. **Moving Averages** (`src/utils/moving_averages.py`)
   - `MovingAverageCalculator` class
   - Types: SMA, EMA, WMA, HMA
   - Patterns: Golden/Death cross detection
   - Input: `MovingAverageDataInput`
   - Output: `MovingAverageAnalysis`

8. **ITC Risk Assessment** (`src/analysis/itc_risk.py`)
   - `ITCRiskClient` class
   - Metrics: ITC Risk Score, Risk Bands, High Risk Threshold
   - Input: `ITCRiskRequest`
   - Output: `ITCRiskResponse`

9. **Options Pricing** (`src/analysis/options.py`)
   - `OptionsPricer` class
   - Methods: Black-Scholes, Greeks calculation, implied volatility
   - Input: `BlackScholesInput`, `OptionContractData`
   - Output: `GreeksOutput`, `OptionsChainOutput`

10. **Screener** (`src/utils/screener.py`)
    - `StockScreener` class
    - Filters: Momentum, volatility, correlation criteria
    - Input: `PortfolioScreenerInput`
    - Output: `ScreenerResults`

**Calculator Pattern**:
```python
# src/analysis/risk_metrics.py
from src.models.risk_inputs import PriceDataInput, RiskCalculationConfig, RiskMetricsOutput

class RiskCalculator:
    """Layer 2: Business logic for risk calculations."""

    def __init__(self, config: RiskCalculationConfig):
        self.config = config

    def calculate_var(self, data: PriceDataInput) -> float:
        """Calculate Value at Risk using historical method."""
        returns = data.prices.pct_change().dropna()
        return np.percentile(returns, (1 - self.config.confidence_level) * 100)

    def calculate_all(self, data: PriceDataInput) -> RiskMetricsOutput:
        """Calculate all risk metrics (returns validated Pydantic model)."""
        return RiskMetricsOutput(
            var_95=self.calculate_var(data),
            sharpe_ratio=self.calculate_sharpe(data),
            # ... other metrics
        )
```

**Key Principles**:
- Accept Pydantic models as input (ensures validation happened)
- Return Pydantic models as output (ensures validation before consumption)
- Private methods (`_method_name`) for internal calculations
- Pure functions with no side effects
- No I/O operations (left to CLI layer)
- Comprehensive docstrings with WHAT/WHY/HOW structure
- Type hints on all parameters and returns

### Layer 3: CLI Interfaces (Agent Integration)

**Locations**:
- `src/analysis/*_cli.py` - CLI for analysis tools
- `src/strategies/*_cli.py` - CLI for strategy tools
- `src/utils/*_cli.py` - CLI for utility tools
- `src/cli/fin_guru.py` - Main CLI dispatcher

**Core CLI Files** (16 total):
- `src/analysis/risk_metrics_cli.py` - Risk metrics interface
- `src/analysis/correlation_cli.py` - Correlation analysis interface
- `src/analysis/itc_risk_cli.py` - ITC Risk assessment interface
- `src/analysis/options_cli.py` - Options pricing interface
- `src/analysis/options_chain_cli.py` - Options chain analysis interface
- `src/analysis/factors_cli.py` - Factor analysis interface
- `src/strategies/backtester_cli.py` - Backtesting interface
- `src/strategies/optimizer_cli.py` - Portfolio optimization interface
- `src/utils/momentum_cli.py` - Momentum indicators interface
- `src/utils/volatility_cli.py` - Volatility metrics interface
- `src/utils/moving_averages_cli.py` - Moving averages interface
- `src/utils/screener_cli.py` - Stock screener interface
- `src/utils/data_validator_cli.py` - Data validation interface
- `src/utils/input_validation_cli.py` - Input validation interface
- `src/utils/yaml_generator_cli.py` - YAML report generation
- `src/utils/market_data.py` - Market data fetching (utility)

**CLI Pattern**:
```python
#!/usr/bin/env python3
"""
Risk Metrics CLI for Finance Guru™ Agents

ARCHITECTURE NOTE: Layer 3 of our 3-layer architecture

USAGE:
    uv run python src/analysis/risk_metrics_cli.py TSLA --days 90 --output json
"""
import argparse
from src.utils.market_data import get_prices
from src.models.risk_inputs import PriceDataInput, RiskCalculationConfig
from src.analysis.risk_metrics import RiskCalculator

def parse_args():
    parser = argparse.ArgumentParser(description='Calculate risk metrics')
    parser.add_argument('ticker', help='Stock ticker symbol')
    parser.add_argument('--days', type=int, default=90)
    parser.add_argument('--benchmark', default='SPY')
    parser.add_argument('--output', choices=['text', 'json'], default='text')
    parser.add_argument('--save-to', help='Save to file')
    return parser.parse_args()

def main():
    args = parse_args()

    try:
        # Layer 1+2: Fetch, validate, and calculate
        prices = get_prices(args.ticker, days=args.days)
        benchmark_prices = get_prices(args.benchmark, days=args.days)

        data = PriceDataInput(
            ticker=args.ticker,
            prices=prices,
            benchmark_prices=benchmark_prices
        )

        calculator = RiskCalculator(config=RiskCalculationConfig())
        result = calculator.calculate_all(data)

        # Layer 3: Format and output
        if args.output == 'json':
            print(result.model_dump_json(indent=2))
            if args.save_to:
                with open(args.save_to, 'w') as f:
                    f.write(result.model_dump_json(indent=2))
        else:
            print(f"Risk Metrics for {args.ticker}")
            print(f"Sharpe Ratio: {result.sharpe_ratio:.2f}")

    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)

if __name__ == '__main__':
    main()
```

**Common Flags**:
- `--days N` - Number of days of data (90=quarter, 252=year)
- `--output {text|json}` - Output format
- `--benchmark TICKER` - Benchmark ticker (for beta/alpha)
- `--save-to PATH` - Save JSON output to file
- Strategy/tool-specific flags (e.g., `--strategy rsi`, `--method max-sharpe`)

**Key Principles**:
- Use `argparse` for all argument handling
- No business logic (calculations are in Layer 2)
- Multiple output formats (text + JSON)
- Sensible defaults for all options
- Comprehensive error handling with exit codes
- Help text with usage examples
- Path safety (no arbitrary file paths)

## Data Flow

```
User Input (CLI arguments)
    ↓
Layer 3: CLI Parser
    ↓ fetch_prices() from src/utils/market_data.py
    ↓
Market Data (yfinance, Finnhub)
    ↓
Layer 1: Pydantic Model Validation
    ↓ Validation fails → Exception with clear error message
    ↓ Validation succeeds → Validated model instance
    ↓
Layer 2: Calculator Class
    ↓ Business logic (pure functions, numpy/pandas operations)
    ↓
Layer 2: Output Model Creation
    ↓ Validation fails → Exception (should not happen if Layer 2 is correct)
    ↓
Layer 3: Output Formatting
    ↓
User Output (text or JSON, optionally saved to file)
```

## Agent Integration

### Entry Point: Finance Orchestrator

**Location**: `.claude/commands/fin-guru/agents/finance-orchestrator.md`

The Finance Orchestrator (Cassandra Holt) is the master agent that:
1. Loads temporal context (date/time)
2. Routes user requests to specialist agents
3. Manages multi-agent workflows
4. Maintains compliance and audit trails

### Specialist Agents

**Location**: `.claude/commands/fin-guru/agents/`

Each specialist agent has:
- Persona and expertise (15+ years institutional experience)
- Primary tools from the financial analysis suite
- Specific use cases and workflows
- Integration with Finance Orchestrator

**Available Agents**:
1. **Market Researcher** (`market-researcher.md`) - Dr. Aleksandr Petrov
   - Tools: Momentum, Moving Averages, Risk Metrics, ITC Risk
   - Use cases: Trend identification, quick scans, risk assessment

2. **Quant Analyst** (`quant-analyst.md`)
   - Tools: All analysis tools, custom parameters, optimization
   - Use cases: Deep analysis, factor analysis, model validation

3. **Strategy Advisor** (`strategy-advisor.md`)
   - Tools: Optimizer, Backtesting, Correlation, ITC Risk
   - Use cases: Portfolio construction, rebalancing, diversification

4. **Compliance Officer** (`compliance-officer.md`)
   - Tools: Volatility, Risk Metrics, Backtesting
   - Use cases: Position limits, risk profiles, strategy approval

5. **Margin Specialist** (`margin-specialist.md`)
   - Tools: Volatility (ATR-based)
   - Use cases: Leverage assessment, position sizing

6. **Dividend Specialist** (`dividend-specialist.md`)
   - Tools: Income analysis, dividend screening
   - Use cases: Dividend income strategy, yield analysis

7. **Teaching Specialist** (`teaching-specialist.md`)
   - Role: Financial education
   - Use cases: Explaining metrics, teaching strategies

8. **Builder** (`builder.md`)
   - Role: Document and artifact creation
   - Use cases: Report generation, analysis summaries

9. **QA Advisor** (`qa-advisor.md`)
   - Role: Quality assurance
   - Use cases: Verification, validation, edge cases

### CLI Command Patterns

**Base Pattern**:
```bash
uv run python <script> <ticker(s)> [flags]
```

**Examples**:
```bash
# Single ticker analysis
uv run python src/analysis/risk_metrics_cli.py TSLA --days 90

# With benchmark and JSON output
uv run python src/analysis/risk_metrics_cli.py TSLA --benchmark SPY --output json

# Portfolio analysis (multiple tickers)
uv run python src/analysis/correlation_cli.py TSLA PLTR NVDA --rolling 30

# With backtesting
uv run python src/strategies/backtester_cli.py TSLA --strategy rsi --capital 100000

# Options analysis
uv run python src/analysis/options_chain_cli.py TSLA --exp-date 2025-02-21
```

**Ticker Examples**: TSLA, PLTR, NVDA, SPY, AAPL, COIN, MSTR, SOFI (Layer 1 growth holdings)

## Key Abstractions

### Market Data Fetching

**Location**: `src/utils/market_data.py`

```python
from src.utils.market_data import get_prices

# Single ticker
prices = get_prices('TSLA', days=90)

# Multiple tickers (returns dict)
portfolio = {
    ticker: get_prices(ticker, days=90)
    for ticker in ['TSLA', 'PLTR', 'NVDA']
}
```

Uses yfinance as primary source, with Finnhub integration for real-time data.

### Configuration Management

**Location**: `src/config.py`

```python
from src.config import FinGuruConfig

# Portfolio layer definitions
layers = FinGuruConfig.load_layers()
# Returns: {'layer1': ['PLTR', 'TSLA', ...], 'layer2': [...], 'layer3': [...]}

# Project paths
project_root = FinGuruConfig.PROJECT_ROOT
portfolio_dir = FinGuruConfig.PORTFOLIO_DIR
```

### Validation Framework

**Location**: `src/utils/input_validation.py` and `src/utils/data_validator.py`

Validates:
- Ticker symbols exist
- Date ranges are valid
- Price data has sufficient history
- Configuration parameters are in valid ranges
- Benchmark tickers are valid

## Dependency Graph

```
src/
├── models/                 # Layer 1: No dependencies
│   ├── risk_inputs.py
│   ├── momentum_inputs.py
│   ├── ... (10+ input modules)
│   └── __init__.py        # Exports all models
│
├── analysis/              # Layer 2: Depends on models/
│   ├── risk_metrics.py       → Imports from src.models.risk_inputs
│   ├── risk_metrics_cli.py   → Imports RiskCalculator, models, market_data
│   ├── correlation.py        → Imports from src.models.correlation_inputs
│   ├── correlation_cli.py    → Imports CorrelationCalculator, models, market_data
│   ├── itc_risk.py
│   ├── itc_risk_cli.py
│   ├── options.py
│   ├── options_cli.py
│   ├── options_chain_cli.py
│   ├── factors.py
│   └── factors_cli.py
│
├── strategies/            # Layer 2: Depends on models/
│   ├── backtester.py        → Imports from src.models.backtest_inputs
│   ├── backtester_cli.py    → Imports Backtester, models, market_data
│   ├── optimizer.py         → Imports from src.models.portfolio_inputs
│   └── optimizer_cli.py     → Imports PortfolioOptimizer, models, market_data
│
├── utils/                 # Layer 2: Depends on models/
│   ├── market_data.py       → yfinance, Finnhub (NO model dependencies)
│   ├── momentum.py          → Imports from src.models.momentum_inputs
│   ├── momentum_cli.py      → Imports MomentumIndicators, models, market_data
│   ├── volatility.py        → Imports from src.models.volatility_inputs
│   ├── volatility_cli.py    → Imports VolatilityCalculator, models, market_data
│   ├── moving_averages.py   → Imports from src.models.moving_avg_inputs
│   ├── moving_averages_cli.py
│   ├── screener.py
│   ├── screener_cli.py
│   ├── data_validator.py
│   ├── data_validator_cli.py
│   ├── input_validation.py
│   ├── input_validation_cli.py
│   ├── yaml_generator.py
│   └── yaml_generator_cli.py
│
├── cli/                   # Layer 3: Depends on everything
│   └── fin_guru.py        → Main dispatcher, integrates all CLIs
│
├── ui/                    # Separate Streamlit app
│   ├── app.py             → Streamlit dashboard
│   ├── services/
│   │   ├── portfolio_loader.py
│   │   └── analysis_runner.py
│   └── widgets/
│       ├── ticker_input.py
│       ├── portfolio_header.py
│       └── results_panel.py
│
├── data/                  # Data directory (schemas, cache)
├── reports/               # Report generation utilities
└── config.py              # Configuration management
```

**Key Constraint**: No circular dependencies. Layer 3 depends on Layer 2 depends on Layer 1.

## Testing Strategy

**Test Locations**: `tests/python/`

Tests are organized by module:
- `test_risk_metrics.py` - Unit tests for RiskCalculator
- `test_momentum.py` - Unit tests for MomentumIndicators
- `test_correlation.py` - Unit tests for CorrelationCalculator
- `test_backtester.py` - Unit tests for Backtester
- `test_optimizer.py` - Unit tests for PortfolioOptimizer
- `test_volatility.py` - Unit tests for VolatilityCalculator
- `test_moving_averages.py` - Unit tests for MovingAverageCalculator

**Running Tests**:
```bash
# All unit tests
uv run pytest tests/python/

# Specific test file
uv run pytest tests/python/test_risk_metrics.py

# With coverage
uv run pytest --cov=src tests/python/
```

## Package Management

**Package Manager**: `uv` (fast Python package manager)

**Key Dependencies**:
- `pandas` - Data manipulation
- `numpy` - Numerical computing
- `scipy` - Scientific calculations (stats, optimization)
- `scikit-learn` - Machine learning models
- `yfinance` - Stock market data
- `streamlit` - UI dashboard
- `beautifulsoup4` - Web scraping
- `requests` - HTTP requests
- `pydantic` - Data validation
- `python-dotenv` - Environment configuration

**Common Commands**:
```bash
uv sync                    # Install all dependencies
uv add package_name        # Add new package
uv remove package_name     # Remove package
uv lock                    # Update lock file
```

## Code Style Guidelines

**Type Hints**: Always use on all functions and methods
**Docstrings**: Google-style with WHAT/WHY/HOW structure
**Naming**:
- Classes: `PascalCase` (e.g., `RiskCalculator`)
- Functions/methods: `snake_case` (e.g., `calculate_var`)
- Constants: `UPPER_SNAKE_CASE` (e.g., `TRADING_DAYS_PER_YEAR = 252`)
- Private methods: `_leading_underscore` (e.g., `_calculate_returns`)

**Imports**: Group as (1) stdlib, (2) third-party, (3) local

**Import Order Example**:
```python
# Standard library
import argparse
import sys
from datetime import date, timedelta

# Third-party
import numpy as np
import pandas as pd
from scipy import stats

# Local
from src.models.risk_inputs import PriceDataInput, RiskMetricsOutput
from src.utils.market_data import get_prices
```

## Educational Compliance

All tools include:
- EDUCATIONAL NOTE headers explaining metrics/methods
- Risk disclaimers: "This is educational analysis, not investment advice"
- Compliance mandate: "Consult with financial professionals before deploying"
- Risk disclosure in all recommendations
- "Maintained in private family office context"

## Version Info

- **Finance Guru™**: v2.0.0
- **BMAD-CORE™**: v6.0.0
- **Python**: 3.12+
- **Build**: 2025-10-08
- **Tools**: 8/11 complete (risk, momentum, volatility, correlation, backtesting, optimizer, moving averages, ITC risk)
