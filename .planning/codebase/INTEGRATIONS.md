# External Integrations & APIs
> Auto-generated by codebase mapper

## Overview
Finance Guru™ integrates with market data providers, financial risk APIs, banking aggregation platforms, and AI/automation services. Data flows through a 3-layer architecture (Models → Calculators → CLI/UI) with type-safe Pydantic validation at each boundary.

## Market Data APIs

### 1. Yahoo Finance (yfinance)
**Status**: Primary, always active
**Library**: `yfinance>=0.2.66`
**Type**: Python library (no API key required)
**Rate Limits**: Implicit (Yahoo Finance rate limiting)

**Usage**: End-of-day OHLC data, price history, options chains
**Files**:
- `src/utils/market_data.py` — Unified data fetching interface
- All `*_cli.py` files — Reference yfinance for fallback data
- `src/analysis/itc_risk.py:239` — Price enrichment for tradfi assets
- `src/analysis/options_chain_cli.py` — Live options chain scanning

**Code Pattern**:
```python
import yfinance as yf
prices = yf.download(ticker, period='3mo')['Close']
```

**Features**:
- Single & multi-ticker support
- OHLC data, volume, adjusted close
- Options chains (live, bid-ask spreads)
- Market hours detection

**Error Handling**: Graceful fallback when unavailable

---

### 2. Finnhub (Real-Time Market Data)
**Status**: Optional, real-time enhancement
**API Key**: `FINNHUB_API_KEY` (environment variable)
**Rate Limit**: 60 calls/minute (free tier)
**Type**: REST API

**Usage**: Real-time stock prices during market hours
**Files**:
- `src/utils/market_data.py:39-67` — Real-time price fetching
- `src/utils/momentum_cli.py` — `--realtime` flag
- `src/utils/volatility_cli.py` — `--realtime` flag
- `src/analysis/risk_metrics_cli.py` — `--realtime` flag

**Code Pattern**:
```python
# From src/utils/market_data.py
if realtime:
    # Use Finnhub API for real-time (60/min rate limit)
    headers = {"X-Finnhub-Token": os.getenv("FINNHUB_API_KEY")}
    response = requests.get(f"https://finnhub.io/api/v1/quote?symbol={symbol}", headers=headers)
```

**Integration Points**:
- Market data enrichment during trading hours
- Portfolio monitoring (real-time updates)
- Risk recalculation triggers

**Fallback**: Reverts to yfinance if API fails or key not set

---

### 3. ITC Risk Models API (Into The Cryptoverse)
**Status**: Optional, specialized risk scoring
**API Key**: `ITC_API_KEY` (paid subscription)
**Base URL**: `https://app.intothecryptoverse.com/api/v2`
**Rate Limit**: 10 requests per time window
**Type**: REST API (JSON)

**Usage**: Market-implied risk scores for crypto & tradfi assets
**Files**:
- `src/analysis/itc_risk.py:40-246` — ITCRiskCalculator class
- `src/analysis/itc_risk_cli.py` — CLI interface
- `src/models/itc_risk_inputs.py` — Pydantic models

**Supported Assets**:
```python
# TradFi (13 assets)
SUPPORTED_TRADFI = [
    "TSLA", "AAPL", "MSTR", "NFLX",  # Stocks
    "SP500",                           # Index
    "DXY",                             # Currency
    "XAUUSD", "XAGUSD", "XPDUSD", "PL", "HG", "NICKEL"  # Commodities
]

# Crypto (29 assets)
SUPPORTED_CRYPTO = [
    "BTC", "ETH", "BNB", "SOL", "XRP", "ADA", "DOGE", "LINK",
    "AVAX", "DOT", "SHIB", "LTC", "AAVE", "ATOM", "POL", "ALGO",
    "HBAR", "RENDER", "VET", "TRX", "TON", "SUI", "XLM", "XMR",
    "XTZ", "SKY",
    "BTC.D", "TOTAL", "TOTAL6"  # Meta metrics
]
```

**Code Pattern**:
```python
from src.analysis.itc_risk import ITCRiskCalculator

calc = ITCRiskCalculator(api_key="your_key")
result = calc.get_risk_score("TSLA", "tradfi")
print(f"Risk Score: {result.current_risk_score:.2f}")  # 0-1 scale
```

**Retry Logic**: Exponential backoff (1s, 2s, 4s delays) for transient errors

**Data Enrichment**:
- Current prices from yfinance (tradfi only)
- Risk bands for technical levels
- Price-based risk interpretation

**Error Handling**:
- Gracefully handles API unavailability
- Falls back to internal risk metrics (VaR/Sharpe)
- Logs errors without stopping analysis

---

## Banking & Aggregation APIs

### 4. Plaid Link (Bank Account Aggregation)
**Status**: Active, core integration
**Library**: `react-plaid-link@3.6.0` (frontend)
**SDK**: `plaid@29.0.0` (backend)
**Type**: OAuth + REST API

**Usage**: Connect bank accounts, fetch balances & transactions
**Files**:
- `apps/plaid-dashboard/dashboard/` — React Plaid Link UI
- `apps/plaid-dashboard/engine/` — Hono backend with Plaid SDK
- `apps/plaid-dashboard/db/src/schema.ts` — Database schema

**Database Schema**:
```typescript
// Bank connections (Plaid Link installations)
bankConnections {
  id: UUID (primary key)
  institutionId: string      // Financial institution ID
  itemId: string (unique)    // Plaid's item_id (connection)
  accessToken: string        // Encrypted in production
  name: string               // Institution name (e.g., "Chase")
  status: "connected" | "disconnected"
  lastSyncedAt: timestamp
  createdAt/updatedAt: timestamp
}

// Accounts per connection
bankAccounts {
  id: UUID
  bankConnectionId: UUID (foreign key → bankConnections)
  accountId: string (unique)  // Plaid's account_id
  name: string
  type: "depository" | "credit" | "loan" | "investment" | "other"
  mask: string               // Last 4 digits
  currentBalance: decimal
  availableBalance: decimal
}

// Transactions
transactions {
  id: UUID
  bankAccountId: UUID (foreign key → bankAccounts)
  transactionId: string (unique)  // Plaid transaction ID
  amount: decimal
  status: "pending" | "posted"
  method: enum (payment, card_purchase, ach, wire, etc.)
  date: date
}
```

**Flow**:
1. React Link UI → OAuth flow with financial institution
2. Plaid returns `access_token` & `item_id`
3. Backend stores encrypted tokens in DB
4. Periodic syncs fetch updated balances & transactions

**Environment Variable**:
- `PLAID_CLIENT_ID` (backend)
- `PLAID_SECRET` (backend)
- `PLAID_ENV` (e.g., 'sandbox', 'production')

**Backend Integration** (`apps/plaid-dashboard/engine/`):
```typescript
import { Configuration, PlaidApi, PlaidEnvironments } from 'plaid';

const client = new PlaidApi(new Configuration({
  basePath: PlaidEnvironments.production,
  baseOptions: { headers: { 'PLAID-CLIENT-ID': process.env.PLAID_CLIENT_ID } }
}));
```

---

## AI & Automation Services

### 5. Model Context Protocol (MCP) Servers
**Status**: Active
**Config File**: `.mcp.json`
**Type**: Anthropic Claude integration

**Configured MCP Servers**:

#### 5a. Bright Data MCP
```json
{
  "command": "bunx",
  "args": ["@brightdata/mcp"],
  "env": {
    "API_TOKEN": "$BRIGHTDATA_API_TOKEN"
  }
}
```
**Purpose**: Web scraping, data collection
**Usage**: Market research, sentiment analysis

#### 5b. Perplexity AI MCP
```json
{
  "type": "stdio",
  "command": "npx",
  "args": ["-y", "perplexity-mcp"],
  "env": {
    "PERPLEXITY_API_KEY": "$PERPLEXITY_API_KEY"
  }
}
```
**Purpose**: AI-powered search and reasoning
**Usage**: Market analysis, strategy evaluation

#### 5c. Linear MCP
```json
{
  "command": "npx",
  "args": ["-y", "mcp-remote", "https://mcp.linear.app/mcp"],
  "env": {
    "LINEAR_API_KEY": "$LINEAR_API_KEY"
  }
}
```
**Purpose**: Issue tracking and project management
**Usage**: Task creation, progress tracking
**Note**: Always invoke LINEAR SKILL when using this tool

#### 5d. Nano Banana Pro MCP (Gemini)
```json
{
  "command": "npx",
  "args": ["-y", "@rafarafarafa/nano-banana-pro-mcp"],
  "env": {
    "GEMINI_API_KEY": "$GEMINI_API_KEY"
  }
}
```
**Purpose**: AI-powered content creation, image generation
**Usage**: Report generation, visualization

**Integration Point**: `src/analysis/` agents use these services for enrichment

---

### 6. Anthropic Claude API (Optional)
**API Key**: `OPENAI_API_KEY` (legacy naming, actually for OpenAI)
**Type**: REST API
**Status**: Optional for specific agent tasks
**Files**: Referenced in `.env.example`

**Usage**: Custom AI analysis, report generation
**Note**: Finance Guru prioritizes MCP servers over direct API calls

---

## Email & Notification Services

### 7. SMTP (Email Reporting)
**Status**: Optional
**Config**:
```env
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
EMAIL_FROM=your_email@example.com
EMAIL_PASSWORD=your_app_password_here
```
**Files**: Referenced in `.env.example`
**Purpose**: Send analysis reports, alerts

---

### 8. Slack Webhooks
**Status**: Optional
**Config**:
```env
SLACK_WEBHOOK_URL=your_slack_webhook_here
```
**Files**: Referenced in `.env.example`
**Purpose**: Portfolio alerts, rebalance notifications

---

## Database

### 9. PostgreSQL
**Connection String**: `DATABASE_URL` environment variable
**Format**: `postgresql://user:pass@host:5432/dbname`
**ORM**: Drizzle ORM 0.38.0
**Connection Pool**: 10 connections (postgres.js)

**Usage**:
- Plaid bank connections storage
- Account balances & transaction history
- User preferences & portfolio settings

**File**: `apps/plaid-dashboard/db/src/client.ts`

---

## Data File Integrations

### 10. CSV Import Mappings (Broker Statements)
**Status**: Active
**Files**: `docs/csv-mappings/*.json`
**Type**: Configuration-based import

**Supported Brokers**:
- Vanguard (`vanguard-mapping.json`)
- TD Ameritrade (`tdameritrade-mapping.json`)
- E*TRADE (`etrade-mapping.json`)
- Fidelity (`fidelity-mapping.json`)
- Charles Schwab (`schwab-mapping.json`)
- Robinhood (`robinhood-mapping.json`)
- Generic template (`generic-mapping-template.json`)

**Purpose**: Normalize broker CSV exports into standard format

**Example Mapping**:
```json
{
  "account_identifier": "Account Number",
  "date": "Trade Date",
  "ticker": "Symbol",
  "quantity": "Quantity",
  "price": "Price",
  "amount": "Amount"
}
```

---

## Configuration & Environment

### Environment Variables
**File**: `.env` (not committed), `.env.example` (template)

**Categories**:

**1. Market Data APIs**
```env
FINNHUB_API_KEY=your_finnhub_key
ITC_API_KEY=your_itc_key
```

**2. AI Services**
```env
OPENAI_API_KEY=your_openai_key
```

**3. Database**
```env
DATABASE_URL=sqlite:///family_office.db
```

**4. Email**
```env
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
EMAIL_FROM=your_email@example.com
EMAIL_PASSWORD=your_app_password
```

**5. Notifications**
```env
SLACK_WEBHOOK_URL=your_slack_webhook
```

**6. Portfolio Settings**
```env
DEFAULT_RISK_TOLERANCE=aggressive
REBALANCE_THRESHOLD=0.05
TAX_RATE=0.25
```

---

## API Authentication Patterns

### Environment Variable Loading
**File**: `src/utils/market_data.py:26-27`
```python
from dotenv import load_dotenv
load_dotenv()
```

### ITC Risk API Authentication
**File**: `src/analysis/itc_risk.py:103-130`
```python
def __init__(self, api_key: Optional[str] = None):
    self.api_key = api_key or os.getenv("ITC_API_KEY")
    if not self.api_key:
        raise ValueError("ITC_API_KEY required but not found in environment")
```

### Plaid Authentication
**Files**:
- Backend: `apps/plaid-dashboard/engine/` (SDK initialization)
- Frontend: `apps/plaid-dashboard/dashboard/` (Link component with public token)

---

## Data Flow Diagrams

### Market Data Pipeline
```
User CLI
  ↓
src/analysis/*_cli.py (Layer 3)
  ↓
src/models/*_inputs.py (Layer 1: Pydantic validation)
  ↓
src/analysis/*.py (Layer 2: Calculators)
  ↓
src/utils/market_data.py (Data layer)
  ↓
├─→ yfinance (primary)
├─→ Finnhub (realtime, optional)
└─→ ITC Risk API (specialized scoring)
```

### Bank Integration Pipeline
```
User clicks "Connect Bank"
  ↓
apps/plaid-dashboard/dashboard/ (React + Plaid Link)
  ↓
Plaid OAuth flow → access_token + item_id
  ↓
apps/plaid-dashboard/engine/ (Hono + Plaid SDK)
  ↓
PostgreSQL (via Drizzle ORM)
  ├─ bank_connections (store tokens)
  ├─ bank_accounts (balances)
  └─ transactions (history)
```

### AI Enrichment Pipeline
```
Analysis results
  ↓
MCP Server (.mcp.json)
  ├─ Bright Data (web scraping)
  ├─ Perplexity (AI reasoning)
  ├─ Linear (task tracking)
  └─ Nano Banana (content generation)
  ↓
Enriched report
```

---

## Rate Limiting & Quotas

| Service | Limit | Enforcement | Fallback |
|---------|-------|------------|----------|
| **yfinance** | Implicit | Yahoo Finance throttling | None (cached data) |
| **Finnhub** | 60 calls/min | Rate headers | Revert to yfinance |
| **ITC Risk** | 10 req/window | API response | Internal metrics (VaR/Sharpe) |
| **Plaid** | Varies by plan | Plan-based | Graceful degradation |
| **Slack** | 1 msg/sec | Rate limit header | Queue and retry |

---

## Error Handling Patterns

### ITC Risk API Retry Logic
**File**: `src/analysis/itc_risk.py:160-200`
```python
# Exponential backoff: 1s, 2s, 4s delays
for attempt in range(3):
    try:
        response = requests.get(url, headers={"Authorization": f"Bearer {self.api_key}"})
        return response.json()
    except Exception as e:
        if attempt < 2:
            time.sleep(2 ** attempt)  # 1s, 2s, 4s
        else:
            raise
```

### Graceful Degradation
**Pattern**:
1. Try primary data source (ITC, Finnhub, etc.)
2. Log warning if unavailable
3. Fall back to secondary source (yfinance internal metrics)
4. Continue analysis with available data

---

## Security Considerations

### API Key Management
- **Never commit** `.env` or actual keys
- **Use** `.env.example` as template
- **Store** production keys in secret manager (GitHub Secrets, etc.)
- **Rotate** keys regularly

### Plaid Token Encryption
- Access tokens stored in DB encrypted at rest (production)
- Keys rotated on disconnection
- PII never logged or exposed

### MCP Server Configuration
- Keys loaded from `.mcp.json` environment variables
- Never hardcode in source
- Use GitHub Secrets for CI/CD

---

## Testing Integration APIs

### ITC Risk Integration Tests
**File**: `tests/python/test_itc_risk.py`

**Marker**: `@pytest.mark.integration`
**Skip Condition**: `ITC_API_KEY` not set
**Command**: `uv run pytest -m "not integration"` (skip integration tests)

```python
@pytest.mark.integration
def test_live_tsla_risk_score(self, api_key):
    calc = ITCRiskCalculator(api_key=api_key)
    result = calc.get_risk_score("TSLA", "tradfi")
    assert result.current_risk_score is not None
```

### Plaid Integration
**Setup**: Docker Compose for local testing
**File**: `apps/plaid-dashboard/.env` (sandbox keys)

---

## Documentation References

| Topic | File |
|-------|------|
| Risk metrics tool guide | `fin-guru-private/guides/risk-metrics-tool-guide.md` |
| Python architecture | `src/CLAUDE.md` |
| API key acquisition | `docs/api-keys.md` |
| Finance Guru system | `CLAUDE.md` (root) |

---

## Summary Matrix

| Integration | Type | Status | Key Required | Fallback | Purpose |
|------------|------|--------|--------------|----------|---------|
| yfinance | Data API | Active | No | N/A | OHLC data, options |
| Finnhub | Data API | Optional | Yes | yfinance | Real-time prices |
| ITC Risk | Risk API | Optional | Yes | Internal metrics | Risk scoring |
| Plaid | Banking API | Active | Yes (separate) | None | Account aggregation |
| Bright Data | Web API | Optional | Yes | Skip enrichment | Market research |
| Perplexity | AI API | Optional | Yes | Skip enrichment | Analysis reasoning |
| Linear | Task API | Optional | Yes | Manual tracking | Project management |
| Nano Banana | AI API | Optional | Yes | Skip enrichment | Content generation |
| SMTP | Email | Optional | Yes | Skip sending | Report delivery |
| Slack | Webhooks | Optional | Yes | Skip sending | Notifications |
| PostgreSQL | Database | Core | Yes | SQLite (dev) | Account storage |
